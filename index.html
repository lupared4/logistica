<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Stocks & Logistica Luciano </title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        /* üé® TEMA OSCURO/CLARO */
        :root {
            --bg-primary: #ffffff; --bg-secondary: #f1f5f9; --bg-tertiary: #e2e8f0;
            --text-primary: #1e293b; --text-secondary: #64748b; --border-color: #cbd5e1;
            --header-bg: #ffffff; --card-bg: #ffffff; --table-row-bg: #ffffff;
        }
        body.dark-theme {
            --bg-primary: #1a1f2e; --bg-secondary: #242938; --bg-tertiary: #2d3344;
            --text-primary: #f8fafc; --text-secondary: #a1a8b8; --border-color: #3d4455;
            --header-bg: #242938; --card-bg: #2a3142; --table-row-bg: #2a3142;
        }
        
        /* === TEMA OSCURO - ESTILOS COMPLETOS === */
        body.dark-theme { background-color: var(--bg-secondary) !important; }
        body.dark-theme .bg-white { background-color: var(--card-bg) !important; }
        body.dark-theme .bg-slate-100, body.dark-theme .bg-slate-50 { background-color: var(--bg-secondary) !important; }
        body.dark-theme .bg-gray-50, body.dark-theme .bg-gray-100, body.dark-theme .bg-gray-200 { background-color: var(--bg-tertiary) !important; }
        
        /* Textos con buen contraste */
        body.dark-theme .text-slate-700, body.dark-theme .text-slate-800, body.dark-theme .text-slate-900,
        body.dark-theme .text-gray-700, body.dark-theme .text-gray-800, body.dark-theme .text-gray-900 { color: #f1f5f9 !important; }
        body.dark-theme .text-slate-500, body.dark-theme .text-slate-600,
        body.dark-theme .text-gray-500, body.dark-theme .text-gray-600 { color: #b0b8c8 !important; }
        body.dark-theme .text-black { color: #f8fafc !important; }
        
        /* Bordes visibles */
        body.dark-theme .border-slate-200, body.dark-theme .border-slate-300,
        body.dark-theme .border-gray-200, body.dark-theme .border-gray-300 { border-color: #3d4455 !important; }
        
        /* Inputs y selects legibles */
        body.dark-theme input, body.dark-theme select, body.dark-theme textarea { 
            background-color: #353b4d !important; color: #f1f5f9 !important; border-color: #4a5266 !important; 
        }
        body.dark-theme input::placeholder { color: #8891a5 !important; }
        
        /* Sombras suaves */
        body.dark-theme .shadow, body.dark-theme .shadow-sm, body.dark-theme .shadow-md, body.dark-theme .shadow-lg { 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important; 
        }
        
        /* Gradientes del header */
        body.dark-theme .from-slate-800 { --tw-gradient-from: #2d3344 !important; }
        body.dark-theme .to-slate-900 { --tw-gradient-to: #1a1f2e !important; }
        body.dark-theme .bg-gradient-to-r { background: linear-gradient(to right, #2d3344, #1a1f2e) !important; }
        
        /* Tarjetas y contenedores */
        body.dark-theme .rounded-xl, body.dark-theme .rounded-lg, body.dark-theme .rounded-md { 
            background-color: var(--card-bg) !important; 
        }
        
        /* Botones */
        body.dark-theme button:not(.tab-active):not([class*="bg-blue"]):not([class*="bg-green"]):not([class*="bg-red"]):not([class*="bg-yellow"]) { 
            background-color: #353b4d !important; color: #f1f5f9 !important; 
        }
        
        /* Divisores */
        body.dark-theme .divide-slate-200 > * + *, body.dark-theme .divide-gray-200 > * + * { border-color: #3d4455 !important; }
        
        /* Tabla - filas legibles */
        body.dark-theme table { background-color: var(--card-bg) !important; }
        body.dark-theme tbody tr { background-color: var(--table-row-bg) !important; }
        body.dark-theme tbody tr:nth-child(even) { background-color: #252a3a !important; }
        body.dark-theme td { color: #e8ecf4 !important; border-color: #3d4455 !important; background-color: inherit !important; }
        body.dark-theme th { background-color: #1e2433 !important; color: #f1f5f9 !important; }
        
        /* Hover de filas m√°s visible */
        body.dark-theme tr:hover td { background-color: #3a4158 !important; }
        
        /* Cards de m√©tricas */
        body.dark-theme [class*="bg-gradient"] { background: linear-gradient(135deg, #2d3344 0%, #353b4d 100%) !important; }
        body.dark-theme .text-white { color: #f8fafc !important; }
        
        /* Tabs */
        body.dark-theme .tab-inactive { color: #a1a8b8 !important; background: transparent !important; }
        body.dark-theme .tab-active { background: var(--card-bg) !important; color: #60a5fa !important; border-color: #60a5fa !important; }
        
        /* Dropdowns y filtros */
        body.dark-theme .filter-dropdown { background-color: #2a3142 !important; border-color: #4a5266 !important; }
        body.dark-theme .filter-dropdown label { color: #e8ecf4 !important; }
        
        /* Scroll bars */
        body.dark-theme ::-webkit-scrollbar { background-color: #1a1f2e; }
        body.dark-theme ::-webkit-scrollbar-thumb { background-color: #4a5266; }
        body.dark-theme ::-webkit-scrollbar-thumb:hover { background-color: #5a6276; }
        
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-secondary); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; }
        [x-cloak] { display: none !important; }

        th { background-color: #1e293b; color: white; font-size: 10px; text-transform: uppercase; position: sticky; top: 0; z-index: 10; white-space: nowrap; padding: 8px; }
        td { font-size: 11px; border-bottom: 1px solid var(--border-color); padding: 4px 8px; white-space: nowrap; color: var(--text-primary); position: relative; height: 35px; }
        tr:hover td { background-color: #f0f9ff; cursor: pointer; }
        header { background-color: var(--header-bg) !important; color: var(--text-primary) !important; border-color: var(--border-color) !important; }

        .data-bar-bg { position: absolute; left: 0; top: 2px; bottom: 2px; z-index: 0; opacity: 0.25; pointer-events: none; transition: width 0.3s ease; }
        .cell-content { position: relative; z-index: 1; display: flex; align-items: center; height: 100%; width: 100%; }
        
        .sparkline-container { width: 60px; height: 25px; display: flex; align-items: center; justify-content: center; margin-right: 8px; flex-shrink: 0; }
        .sparkline-container svg { display: block; width: 100%; height: 100%; }

        .sticky-left { position: sticky; left: 0; z-index: 20; background-color: inherit; border-right: 2px solid var(--border-color); }
        .tab-active { background: var(--card-bg); border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: bold; }
        .tab-inactive { color: var(--text-secondary); background: transparent; }
        .table-container { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 3px; }
        .filter-dropdown { position: absolute; top: 100%; left: 0; background: var(--card-bg); border: 1px solid var(--border-color); box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 4px; padding: 8px; z-index: 50; min-width: 180px; max-height: 250px; overflow-y: auto; color: var(--text-primary); font-weight: normal; text-transform: none; }

        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); cursor: pointer; transition: all 0.2s ease-in-out; }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #2563eb; cursor: pointer; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #cbd5e1; border-radius: 2px; }

        .chat-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        .slide-over { transform: translateX(100%); transition: transform 0.3s ease-in-out; }
        .slide-over.open { transform: translateX(0); }

        .fab-enter { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden" x-data="inventoryApp()" x-init="initApp()" x-cloak>

    <!-- üîê PANTALLA DE LOGIN -->
    <div x-show="!isAuthenticated" class="fixed inset-0 z-[100] bg-gradient-to-br from-indigo-900 via-purple-900 to-slate-900 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-96 max-w-[90vw]">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">üì¶</span>
                </div>
                <h1 class="text-2xl font-black text-slate-800">STOCKS LOGISTICA</h1>
                <p class="text-sm text-slate-500 mt-1">Dashboard de Inventario</p>
            </div>
            
            <form @submit.prevent="handleLogin()" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-1">üë§ Usuario</label>
                    <input type="text" x-model="loginUser" 
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors"
                        placeholder="Ingrese su usuario" autocomplete="username">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-1">üîí Contrase√±a</label>
                    <input type="password" x-model="loginPass" 
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors"
                        placeholder="Ingrese su contrase√±a" autocomplete="current-password">
                </div>
                
                <div x-show="loginError" class="bg-red-50 border border-red-200 text-red-600 text-sm p-3 rounded-lg flex items-center gap-2">
                    <span>‚ö†Ô∏è</span>
                    <span x-text="loginError"></span>
                </div>
                
                <button type="submit" 
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                    <span>Ingresar</span>
                </button>
            </form>
            
            <div class="mt-6 text-center text-xs text-slate-400">
                ¬© 2026 - Sistema de Gesti√≥n de Inventario
            </div>
        </div>
    </div>

    <header x-show="isAuthenticated" class="bg-white border-b px-4 py-2 flex justify-between items-center shadow-sm shrink-0 z-30" :style="`background-color: var(--header-bg); border-color: var(--border-color);`">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-700 text-white font-bold px-2 py-1 rounded text-xs shadow">STOCKS LOGISTICA</div>
            <div>
                <h1 class="text-sm font-bold" :style="`color: var(--text-primary);`">Dashboard</h1>
                <div class="text-[10px] flex items-center gap-1" x-show="lastUpdate" :style="`color: var(--text-secondary);`">
                    <span>üïí Datos al:</span>
                    <span class="font-bold text-indigo-600" x-text="lastUpdate"></span>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <button @click="toggleTheme()" class="p-1.5 hover:bg-slate-200 dark:hover:bg-slate-700 rounded transition text-lg" title="Alternar tema oscuro/claro">
                <span x-show="!darkMode">üåô</span>
                <span x-show="darkMode">‚òÄÔ∏è</span>
            </button>
            <button @click="handleLogout()" class="p-1.5 hover:bg-red-100 text-red-500 rounded transition text-sm" title="Cerrar sesi√≥n">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
            </button>
        </div>

        <div class="flex items-center gap-4 px-3 py-1 rounded border" x-show="dataReady" :style="`background-color: var(--bg-tertiary); border-color: var(--border-color);`">
            <div class="flex flex-col" x-show="currentTab !== 'otros_depositos'">
                <label class="text-[9px] font-bold uppercase" :style="`color: var(--text-secondary);`">Cobertura Compra</label>
                <div class="flex items-center gap-1">
                    <input type="number" x-model.number="params.diasCompra" @change="recalculateGlobal" class="w-12 text-xs border rounded text-center font-bold text-emerald-600" min="1">
                    <span class="text-[10px]">d√≠as</span>
                </div>
            </div>
            <div class="w-px h-6 bg-slate-300" x-show="currentTab !== 'otros_depositos'"></div>
            
            <!-- üîÑ SWITCH: M√©todo de c√°lculo VTAR vs VPD -->
            <div class="flex flex-col" x-show="currentTab !== 'otros_depositos'">
                <label class="text-[9px] font-bold uppercase" :style="`color: var(--text-secondary);`">Base Compra</label>
                <div class="flex items-center gap-1">
                    <button @click="calcMethod = 'vtar'; recalculateGlobal()" 
                        class="px-2 py-0.5 text-[10px] font-bold rounded-l border transition-all"
                        :class="calcMethod === 'vtar' ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-white text-slate-500 border-slate-300 hover:bg-slate-100'"
                        title="VTAR: Venta Real Promedio Hist√≥rica">
                        VTAR
                    </button>
                    <button @click="calcMethod = 'vpd'; recalculateGlobal()" 
                        class="px-2 py-0.5 text-[10px] font-bold rounded-r border-t border-r border-b transition-all"
                        :class="calcMethod === 'vpd' ? 'bg-purple-600 text-white border-purple-600' : 'bg-white text-slate-500 border-slate-300 hover:bg-slate-100'"
                        title="VPD_Cpra: Venta Proyectada Diaria">
                        VPD
                    </button>
                </div>
            </div>
            <div class="w-px h-6 bg-slate-300" x-show="currentTab !== 'otros_depositos'"></div>
            <div class="flex flex-col" x-show="currentTab !== 'otros_depositos'">
                <label class="text-[9px] font-bold text-slate-500 uppercase">Dep√≥sitos</label>
                <div class="flex items-center gap-1">
                    <input type="number" x-model.number="params.diasSuc" @change="recalculateGlobal" class="w-12 text-xs border rounded text-center font-bold text-blue-600" min="1">
                    <span class="text-[10px]">d√≠as</span>
                </div>
            </div>
            
            <button @click="recalculateGlobal" class="bg-blue-100 text-blue-600 hover:bg-blue-200 px-2 py-1 rounded text-xs font-bold transition">‚Üª Recalcular</button>
        
            <button @click="focusMode = !focusMode" 
                class="transition-all duration-300 border px-3 py-1.5 rounded text-xs font-bold flex gap-2 items-center shadow mr-2"
                :class="focusMode ? 'bg-slate-800 text-white border-slate-900 ring-2 ring-slate-400' : 'bg-white text-slate-600 border-slate-300 hover:bg-slate-100'">
                <span>   </span> <span x-text="focusMode ? 'MODO FOCUS: ACTIVO' : 'Modo Focus'"></span>
            </button>
        </div>

        <div class="flex items-center gap-2">
            <button @click="copySkus" :disabled="!dataReady" class="bg-slate-700 hover:bg-slate-800 text-white font-bold py-1.5 px-3 rounded text-xs flex gap-2 items-center shadow transition">
                <span x-text="copyFeedback ? '‚úÖ COPIADO' : 'üìã Copiar SKUs'"></span>
            </button>
            <button @click="exportExcel" :disabled="!dataReady" class="bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 text-white font-bold py-1.5 px-3 rounded text-xs flex gap-2 items-center shadow transition">
                <span>üìä</span> Excel
            </button>
            <label class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-4 rounded shadow text-xs flex gap-2 items-center transition">
                <span x-text="dataReady ? 'üîÑ ACTUALIZAR' : 'üìÇ CARGAR EXCEL'"></span>
                <input type="file" class="hidden" accept=".xlsx, .xls, .xlsb" @change="handleFile">
            </label>
            <button @click="loadLocalExcel" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-1.5 px-3 rounded shadow text-xs flex gap-2 items-center transition" title="Cargar ENVIOS LUCIANO.xlsx o .xlsb desde carpeta local">
                <span>üì• Traer Datos Directamente</span>
            </button>
            <button @click="resetApp" class="text-slate-400 hover:text-red-500 p-1.5 transition" title="Borrar datos y reiniciar">üóëÔ∏è</button>
        </div>
    </header>

    <main x-show="isAuthenticated" class="flex-1 flex flex-col p-4 overflow-hidden bg-slate-100 relative">

        <div x-show="isLoading" class="absolute inset-0 bg-white/90 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-3"></div>
            <span class="text-sm font-bold text-blue-800 animate-pulse" x-text="loadingMsg">PROCESANDO DATOS...</span>
        </div>

        <div x-show="!dataReady && !isLoading" class="flex-1 flex flex-col items-center justify-center text-slate-300">
            <div class="text-6xl mb-4">üíæ</div>
            <p class="text-lg font-medium">No hay datos guardados</p>
            <p class="text-sm">Sube tu archivo Excel para comenzar.</p>
        </div>

        <div class="flex-1 flex flex-col bg-white rounded-lg border shadow-sm overflow-hidden relative" x-show="dataReady">

            <div class="flex border-b px-4 pt-3 gap-6 shrink-0 bg-slate-50 overflow-x-auto">
                <template x-for="tab in tabs" :key="tab.id">
                    <button @click="switchTab(tab.id)"
                        class="pb-2 text-xs uppercase tracking-wider font-bold transition-colors relative whitespace-nowrap"
                        :class="currentTab === tab.id ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-400 hover:text-slate-600'">
                        <span x-text="tab.label"></span>
                    </button>
                </template>
            </div>

            <div class="bg-indigo-50 border-b px-4 py-2 flex justify-between items-center text-xs sticky top-0 z-20" x-show="currentTab !== 'metricas' && currentTab !== 'dashboard' && currentTab !== 'simplex'">
                <div class="font-bold text-indigo-800 uppercase tracking-wide flex items-center gap-2">
                    <span class="text-lg">üìç</span> <span x-text="getHeaderTitle()"></span>
                </div>
                <div class="flex gap-6 text-indigo-700 font-medium">
                    <span x-html="getHeaderStats()"></span>
                </div>
            </div>

            <div class="p-2 border-b bg-white flex gap-3 items-center shrink-0" x-show="currentTab !== 'metricas' && currentTab !== 'dashboard' && currentTab !== 'simplex'">
                <div class="relative">
                    <span class="absolute left-2 top-1.5 text-slate-400">üîç</span>
                    <input type="text" x-model="search" @input="clearTimeout(searchTimeout); searchTimeout = setTimeout(() => $nextTick(), 300)" placeholder="Buscar SKU, Nombre, Marca, Proveedor..." class="border rounded pl-7 pr-3 py-1.5 text-xs w-64 focus:outline-none focus:border-blue-400 shadow-sm">
                </div>

                <button x-show="currentTab === 'inmovilizado'" @click="showLiquidationModal = true" class="bg-red-100 text-red-700 hover:bg-red-200 px-3 py-1.5 rounded border border-red-200 text-xs font-bold transition flex items-center gap-1">
                    <span>üí∏</span> Calc. Liquidaci√≥n
                </button>
                <button x-show="currentTab === 'dep80'" @click="filterMLUrgencies = !filterMLUrgencies" 
                    class="px-3 py-1.5 rounded border text-xs font-bold transition flex items-center gap-1 shadow-sm"
                    :class="filterMLUrgencies ? 'bg-red-600 text-white border-red-700 ring-2 ring-red-300' : 'bg-white text-slate-600 border-slate-300 hover:bg-slate-50'">
                    <span>üö®</span> <span x-text="filterMLUrgencies ? 'Viendo Urgencias ML' : 'Filtrar Urgencias ML'"></span>
                </button>

                <div class="relative" x-data="{ openDates: false }" x-show="currentTab !== 'vencimientos'">
                    <button @click="openDates = !openDates" @click.outside="openDates = false"
                        class="flex items-center justify-between gap-2 bg-blue-50 px-3 py-1.5 rounded border border-blue-100 text-xs text-blue-800 font-bold hover:bg-blue-100 transition w-48"
                        :class="selectedEnvioFechas.length > 0 ? 'ring-2 ring-blue-300' : ''">
                        <span x-text="selectedEnvioFechas.length === 0 ? 'üìÖ Filtrar por Fecha' : selectedEnvioFechas.length + ' fechas activas'"></span>
                        <span class="text-[10px]">‚ñº</span>
                    </button>
                    <div x-show="openDates" class="absolute top-full left-0 mt-1 w-64 bg-white border rounded shadow-xl z-50 max-h-80 overflow-y-auto scrollbar-thin flex flex-col">
                        <div class="p-2 border-b bg-slate-50 flex justify-between items-center sticky top-0 z-10">
                            <span class="text-[10px] font-bold text-slate-500">Selecciona Fechas</span>
                            <button @click="selectedEnvioFechas = []" class="text-[9px] text-red-500 hover:underline">Borrar Todo</button>
                        </div>
                        <div class="p-1">
                            <template x-for="fecha in uniqueEnvioFechas" :key="fecha">
                                <label class="flex items-center gap-2 px-2 py-1.5 hover:bg-blue-50 rounded cursor-pointer text-xs transition-colors" @click.stop>
                                    <input type="checkbox" :value="fecha" x-model="selectedEnvioFechas" class="rounded border-slate-300 text-blue-600 focus:ring-0 w-4 h-4">
                                    <span x-text="fecha" class="text-slate-700 font-medium"></span>
                                </label>
                            </template>
                        </div>
                        <div class="p-2 border-t bg-slate-50 sticky bottom-0 z-10 text-center">
                            <button @click="openDates = false" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 w-full">Cerrar</button>
                        </div>
                    </div>
                </div>

                <div x-show="currentTab === 'vencimientos'" class="flex items-center gap-2 bg-orange-50 px-2 py-1 rounded border border-orange-100 flex-wrap">
                    <label class="text-[10px] font-bold text-orange-700 uppercase">Vencimiento:</label>
                    <div class="flex gap-2 flex-wrap">
                        <label class="flex items-center gap-1 cursor-pointer hover:bg-orange-100 px-1.5 py-0.5 rounded transition-colors">
                            <input type="checkbox" value="0-30" x-model="filterLotesRanges" class="rounded border-red-400 text-red-600 focus:ring-0 w-3 h-3">
                            <span class="text-[10px] text-red-700 font-medium">üî¥ Cr√≠tico (0-30d)</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer hover:bg-orange-100 px-1.5 py-0.5 rounded transition-colors">
                            <input type="checkbox" value="31-60" x-model="filterLotesRanges" class="rounded border-orange-400 text-orange-600 focus:ring-0 w-3 h-3">
                            <span class="text-[10px] text-orange-700 font-medium">üü† Riesgo (31-60d)</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer hover:bg-orange-100 px-1.5 py-0.5 rounded transition-colors">
                            <input type="checkbox" value="61-90" x-model="filterLotesRanges" class="rounded border-yellow-400 text-yellow-600 focus:ring-0 w-3 h-3">
                            <span class="text-[10px] text-yellow-700 font-medium">üü° Alerta (61-90d)</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer hover:bg-orange-100 px-1.5 py-0.5 rounded transition-colors">
                            <input type="checkbox" value="91-120" x-model="filterLotesRanges" class="rounded border-lime-400 text-lime-600 focus:ring-0 w-3 h-3">
                            <span class="text-[10px] text-lime-700 font-medium">üü¢ Moderado (91-120d)</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer hover:bg-orange-100 px-1.5 py-0.5 rounded transition-colors">
                            <input type="checkbox" value="121-150" x-model="filterLotesRanges" class="rounded border-green-400 text-green-600 focus:ring-0 w-3 h-3">
                            <span class="text-[10px] text-green-700 font-medium">üü¢ Seguro (121-150d)</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer hover:bg-orange-100 px-1.5 py-0.5 rounded transition-colors">
                            <input type="checkbox" value="150+" x-model="filterLotesRanges" class="rounded border-emerald-400 text-emerald-600 focus:ring-0 w-3 h-3">
                            <span class="text-[10px] text-emerald-700 font-medium">üü¢ √ìptimo (+150d)</span>
                        </label>
                    </div>
                    <button @click="filterLotesRanges = []" x-show="filterLotesRanges.length > 0" class="text-[10px] text-red-600 hover:text-red-800 ml-2 underline">Limpiar</button>
                </div>

                <div x-show="currentTab === 'otros_depositos'" class="flex items-center gap-2 bg-purple-50 px-2 py-1 rounded border border-purple-100">
                    <label class="text-[10px] font-bold text-purple-700 uppercase">Dep√≥sitos:</label>
                    <div class="flex gap-2">
                        <template x-for="d in availableOtherDeps" :key="d">
                            <label class="flex items-center gap-1 cursor-pointer hover:bg-purple-100 px-1 rounded transition-colors">
                                <input type="checkbox" :value="d" x-model="selectedOtherDeps" class="rounded border-purple-300 text-purple-600 focus:ring-0 w-3 h-3">
                                <span x-text="d" class="text-xs text-purple-800 font-bold"></span>
                            </label>
                        </template>
                    </div>
                </div>

                <!-- üìä BOT√ìN REPORTE CARGOS ML -->
                <div x-show="currentTab === 'cargos'" class="flex items-center gap-2 bg-amber-50 px-3 py-2 rounded border border-amber-200">
                    <button @click="generateCargosReport()" 
                        class="bg-gradient-to-r from-amber-600 to-amber-700 text-white px-4 py-2 rounded-lg font-bold text-xs hover:from-amber-700 hover:to-amber-800 transition-all shadow-md hover:shadow-lg flex items-center gap-2">
                        <span>üìä</span>
                        <span>Generar Reporte Completo de Cargos ML</span>
                    </button>
                    <div class="text-[10px] text-amber-700 font-medium">
                        <div>‚úì Informe por Analista y Fecha</div>
                        <div>‚úì Detalle de SKUs con Cargos</div>
                    </div>
                </div>

                <div class="flex items-center gap-2 flex-wrap" x-show="Object.keys(activeFilters).length > 0">
                    <span class="text-[10px] text-slate-400 font-bold uppercase">Filtros Activos:</span>
                    <template x-for="(vals, key) in activeFilters" :key="key">
                        <span class="bg-slate-100 border text-slate-600 text-[10px] px-2 py-0.5 rounded flex items-center gap-1">
                            <span x-text="getColLabel(key) + ': ' + vals.length"></span>
                            <button @click="clearFilter(key)" class="hover:text-red-500 font-bold">√ó</button>
                        </span>
                    </template>
                    <button @click="activeFilters = {}" class="text-[9px] text-red-500 hover:underline">Borrar todos</button>
                </div>

                <div class="flex-1 flex justify-end items-center gap-2">
                    <span class="text-[10px] text-slate-500 uppercase font-bold mr-2" x-text="filteredData.length + ' Filas'"></span>
                    <button @click="prevPage" :disabled="currentPage===1" class="p-1 px-2 bg-slate-100 border rounded hover:bg-slate-200 disabled:opacity-50 text-xs">‚óÄ</button>
                    <span class="text-xs font-mono w-12 text-center" x-text="currentPage + '/' + totalPages"></span>
                    <button @click="nextPage" :disabled="currentPage>=totalPages" class="p-1 px-2 bg-slate-100 border rounded hover:bg-slate-200 disabled:opacity-50 text-xs">‚ñ∂</button>
                </div>
            </div>

            <div class="flex-1 overflow-auto table-container relative bg-white" x-show="currentTab !== 'metricas' && currentTab !== 'dashboard' && currentTab !== 'simplex'">
                <div x-show="filterOpportunityCost" class="bg-red-50 text-red-800 px-4 py-2 text-xs font-bold border-b border-red-100 flex justify-between items-center animate-in slide-in-from-top duration-300">
                    <div class="flex items-center gap-2">
                        <span class="text-lg animate-pulse">üî•</span>
                        <span>MODO ALERTA: Mostrando productos con Venta Perdida (Stock 0 + Activos).</span>
                    </div>
                    <button @click="filterOpportunityCost = false" class="text-[10px] underline hover:text-red-950 bg-white px-2 py-1 rounded border border-red-100 hover:bg-red-50 transition">
                        Mostrar Todo
                    </button>
                </div>
                <div x-show="currentTab === 'dep80' && selectedEnvioFechas.length > 0" class="bg-yellow-50 text-yellow-800 px-4 py-2 text-xs font-bold border-b border-yellow-100 flex justify-between items-center">
                    <span>‚ö†Ô∏è FILTRANDO POR FECHAS SELECCIONADAS: Mostrando solo SKUs enviados en las fechas marcadas.</span>
                    <button @click="selectedEnvioFechas = []" class="underline hover:text-yellow-900">Limpiar Fechas</button>
                </div>
                <div x-show="currentTab === 'otros_depositos' && selectedEnvioFechas.length > 0" class="bg-yellow-50 text-yellow-800 px-4 py-2 text-xs font-bold border-b border-yellow-100 flex justify-between items-center">
                    <span>‚ö†Ô∏è ENVIOS FILTRADOS: La columna "ENVIOS REALIZADO" muestra cantidades de las fechas seleccionadas.</span>
                    <button @click="selectedEnvioFechas = []" class="underline hover:text-yellow-900">Limpiar Fechas</button>
                </div>

                <div x-show="filterAging" class="bg-indigo-50 text-indigo-800 px-4 py-2 text-xs font-bold border-b border-indigo-100 flex justify-between items-center animate-in slide-in-from-top duration-300">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">üê¢</span>
                        <span>FILTRO ANTIG√úEDAD: Mostrando stock con antig√ºedad <span x-text="filterAging" class="bg-white px-1 rounded border border-indigo-200 ml-1"></span></span>
                    </div>
                    <button @click="filterAging = null" class="text-[10px] underline hover:text-indigo-950 bg-white px-2 py-1 rounded border border-indigo-100 hover:bg-indigo-50 transition">
                        Borrar Filtro
                    </button>
                </div>

                <div x-show="filterArbitrage" class="bg-purple-50 text-purple-800 px-4 py-2 text-xs font-bold border-b border-purple-100 flex justify-between items-center animate-in slide-in-from-top duration-300">
                    <div class="flex items-center gap-2">
                        <span class="text-lg animate-pulse">ÔøΩ</span>
                        <span>ENVIAR A FULL: Mostrando SKUs para enviar urgente (Hay en Central -> Falta en Full).</span>
                    </div>
                    <button @click="filterArbitrage = false" class="text-[10px] underline hover:text-purple-950 bg-white px-2 py-1 rounded border border-purple-100 hover:bg-purple-50 transition">
                        Mostrar Todo
                    </button>
                </div>

                <div x-show="kpiFilter === 'criticos'" class="bg-red-100 text-red-900 px-4 py-2 text-xs font-bold border-b border-red-200 flex justify-between items-center animate-in slide-in-from-top duration-300">
                    <div class="flex items-center gap-2">
                        <span class="text-lg animate-pulse">üî¥</span>
                        <span>FILTRO KPI DASHBOARD: Mostrando SKUs CR√çTICOS (Stock < 5 d√≠as + Demanda alta).</span>
                    </div>
                    <button @click="kpiFilter = null" class="text-[10px] underline hover:text-red-950 bg-white px-2 py-1 rounded border border-red-200 hover:bg-red-50 transition">
                        Mostrar Todo
                    </button>
                </div>

                <div x-show="kpiFilter === 'stockSinVenta'" class="bg-purple-100 text-purple-900 px-4 py-2 text-xs font-bold border-b border-purple-200 flex justify-between items-center animate-in slide-in-from-top duration-300">
                    <div class="flex items-center gap-2">
                        <span class="text-lg animate-pulse">üì¶</span>
                        <span>FILTRO STOCK SIN VENTA: Mostrando SKUs con d√≠as de stock en rangos: <span x-text="stockSinVentaFilters.join(', ')"></span></span>
                    </div>
                    <button @click="kpiFilter = null; stockSinVentaFilters = []" class="text-[10px] underline hover:text-purple-950 bg-white px-2 py-1 rounded border border-purple-200 hover:bg-purple-50 transition">
                        Mostrar Todo
                    </button>
                </div>

                <table class="w-full border-collapse">
                    <thead class="bg-slate-800 text-white">
                        <tr>
                            <th class="sticky-left z-20 w-8 bg-slate-800 px-2">
                                <input type="checkbox" @change="toggleSelectAll($event)" class="rounded border-slate-500 bg-slate-700 text-blue-500 focus:ring-0">
                            </th>

                            <template x-for="col in getColumns()" :key="col.key">
                                <th class="text-left group transition relative" :class="col.key === 'sku' || col.key === 'prov' ? 'sticky-left bg-slate-800' : ''">
                                    <div class="flex items-center justify-between gap-1">
                                        <div class="flex items-center gap-1 cursor-pointer hover:text-blue-300" @click="sortBy(col.key)">
                                            <span x-text="col.label"></span>
                                            <span x-show="sortCol === col.key" x-text="sortAsc ? '‚ñ≤' : '‚ñº'" class="text-yellow-400 text-[9px]"></span>
                                        </div>
                                        
                                        <div x-show="isFilterable(col.key)" class="relative">
                                            <button @click.stop="toggleFilterMenu(col.key)" class="p-1 hover:bg-slate-600 rounded text-slate-400 hover:text-white transition" :class="activeFilters[col.key] ? 'text-blue-400 font-bold' : ''">‚ñº</button>
                                            <div x-show="filterMenuOpen === col.key" @click.outside="filterMenuOpen = null" class="filter-dropdown text-left">
                                                <div class="mb-2 pb-2 border-b flex justify-between items-center sticky top-0 bg-white">
                                                    <span class="text-[10px] font-bold text-slate-500">Filtrar por <span x-text="col.label"></span></span>
                                                    <button @click="clearFilter(col.key); filterMenuOpen=null" class="text-[9px] text-red-500 hover:underline">Limpiar</button>
                                                </div>
                                                <div class="flex flex-col gap-1 max-h-40 overflow-y-auto scrollbar-thin">
                                                    <template x-for="val in getUniqueValues(col.key)" :key="val">
                                                        <label class="flex items-center gap-2 px-1 hover:bg-slate-50 cursor-pointer text-xs">
                                                            <input type="checkbox" :checked="isFilterChecked(col.key, val)" @change="toggleFilter(col.key, val)" class="rounded border-slate-300 text-blue-600 focus:ring-0 w-3 h-3">
                                                            <span x-text="val === '' ? '(Vac√≠o)' : val" class="truncate"></span>
                                                        </label>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </th>
                            </template>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="row in paginatedData" :key="row.id + '_' + (row.comprarU||0) + '_' + (row.diasEstrategia || 'def') + '_' + row.stockGrafana">
                            <tr class="group transition-colors hover:bg-blue-50 border-l-4" 
                                :class="[
                                    selectedIds.includes(row.id) ? 'bg-blue-100' : '',
                                    row.alerta?.nivel === 'CR√çTICO' ? 'border-l-red-600 bg-red-50' : 
                                    row.alerta?.nivel === 'ATENCI√ìN' ? 'border-l-yellow-500 bg-yellow-50' : 
                                    'border-l-green-500 bg-green-50'
                                ]">
                                
                                <td class="sticky-left bg-inherit border-r border-slate-200 text-center px-2">
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" :value="row.id" x-model="selectedIds" class="rounded border-slate-300 text-blue-600 focus:ring-0">
                                        <span class="text-lg" :title="row.alerta?.texto" x-text="row.alerta?.icono"></span>
                                    </div>
                                </td>

                                <template x-for="col in getColumns()">
                                    <td class="border-r border-slate-100 group-hover:border-blue-200 relative overflow-hidden"
                                        :class="[getCellClass(col, row), (col.key === 'sku' || col.key === 'prov' && currentTab === 'proveedores') ? 'sticky-left group-hover:bg-blue-50 bg-white' : '']"
                                        @click="if(!isEditable(col.key) && col.key !== 'actions') openModal(row)"
                                        @dblclick="startEdit(row, col.key)"
                                        :title="getTooltip(col, row)">

                                        <div class="data-bar-bg" :style="getBarStyle(col, row)"></div>

                                        <div class="cell-content w-full flex items-center" :class="col.key === 'vtarTotal' ? 'justify-end' : ''">
                                            
                                            <template x-if="col.key === 'vtarTotal' && row.trendHistory && row.trendHistory.length > 1">
                                                <div class="sparkline-container" x-html="renderSparkline(row.trendHistory?.slice(-30), 60, 25)"></div>
                                            </template>

                                            <template x-if="col.key === 'sku'">
                                                <div class="flex items-center gap-2 w-full">
                                                    <span x-show="row.bloqueado" class="text-sm" title="‚ö†Ô∏è BLOQUEADO (Canasta)">üö©</span>
                                                    <span x-text="row.sku" class="font-bold text-slate-700"></span>
                                                    <span x-show="row.impulsar" class="text-[10px] bg-orange-100 text-orange-700 px-1 rounded border border-orange-200" title="Impulsar">üöÄ</span>
                                                    <span x-show="row.criticalGap" class="text-sm ml-2" title="‚ö†Ô∏è QUIEBRE INEVITABLE">üíÄ</span>
                                                    <span x-show="row.isAnomaly" class="text-sm ml-2 cursor-help" title="üëÅÔ∏è IA: Anomal√≠a">üëÅÔ∏è</span>
                                                </div>
                                            </template>

                                            <template x-if="col.key === 'actions' && currentTab === 'proveedores'">
                                                <button @click.stop="exportProviderOrder(row.prov)" class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-1 rounded hover:bg-emerald-200 border border-emerald-300 font-bold flex items-center gap-1 shadow-sm">
                                                    üì• Orden
                                                </button>
                                            </template>

                                            <template x-if="isEditing(row, col.key)">
                                                <input type="number" class="w-full h-full text-right border-2 border-blue-500 rounded px-1 text-xs bg-white absolute inset-0 z-50" :value="row[col.key]" @blur="saveEdit(row, col.key, $event.target.value)" @keydown.enter="saveEdit(row, col.key, $event.target.value)" x-init="$el.focus()">
                                            </template>

                                            <template x-if="col.key === 'statusVisual'">
                                                <div class="flex justify-center w-full">
                                                    <span x-html="formatCell(col, row)"></span>
                                                </div>
                                            </template>

                                            <span x-show="!isEditing(row, col.key) && col.key !== 'sku' && col.key !== 'statusVisual' && col.key !== 'actions'" x-text="formatCell(col, row)"></span>
                                        </div>
                                    </td>
                                </template>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <div x-show="selectedIds.length > 0" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl z-50 flex items-center gap-4 fab-enter">
                <span class="font-bold text-sm"><span x-text="selectedIds.length"></span> seleccionados</span>
                <div class="h-4 w-px bg-slate-600"></div>
                <button @click="applyBulkEdit('diasEstrategia')" class="hover:text-blue-300 text-xs font-bold">üìÖ Cambiar D√≠as Est.</button>
                <div class="h-4 w-px bg-slate-600"></div>
                <button @click="selectedIds = []" class="text-slate-400 hover:text-white text-xs">Cancelar</button>
            </div>

            <!-- üéØ DASHBOARD KPI EJECUTIVO -->
            <div class="flex-1 overflow-y-auto bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 p-6" x-show="currentTab === 'dashboard'">
                <div class="max-w-7xl mx-auto">
                    <h1 class="text-3xl font-bold text-white mb-2">üìä Dashboard Ejecutivo</h1>
                    <p class="text-slate-400 text-sm mb-6">Indicadores clave y acciones recomendadas</p>

                    <!-- KPI WIDGETS (3 columnas) -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <!-- Cr√≠ticos -->
                        <div @click="goToCriticos()" 
                             class="bg-gradient-to-br from-red-600 to-red-700 rounded-lg p-6 shadow-lg text-white cursor-pointer hover:scale-[1.02] hover:shadow-2xl transition-all duration-200"
                             title="Click para ver detalle de SKUs cr√≠ticos">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-red-100 text-sm font-medium">üî¥ SKUs CR√çTICOS</p>
                                    <p class="text-4xl font-bold mt-2" x-text="kpiDashboard?.criticos || 0"></p>
                                </div>
                                <div class="bg-red-500 bg-opacity-30 p-3 rounded-lg">‚ö†Ô∏è</div>
                            </div>
                            <p class="text-xs text-red-100">Stock < 5 d√≠as + Demanda alta</p>
                            <p class="text-[10px] text-red-200 mt-2 opacity-80">üëÜ Click para ver detalle</p>
                        </div>

                        <!-- Stock Viejo > 45 d√≠as -->
                        <div class="bg-gradient-to-br from-orange-600 to-orange-700 rounded-lg p-6 shadow-lg text-white">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-orange-100 text-sm font-medium">üí∞ STOCK VIEJO</p>
                                    <p class="text-3xl font-bold mt-2">$<span x-text="Math.round(getStockViejoValue()).toLocaleString()"></span></p>
                                </div>
                                <div class="bg-orange-500 bg-opacity-30 p-3 rounded-lg">üßä</div>
                            </div>
                            
                            <!-- Selector m√∫ltiple de d√≠as -->
                            <div class="mb-3" @click.stop>
                                <p class="text-[10px] text-orange-200 mb-2">üìÖ Filtrar por antig√ºedad:</p>
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="opt in ['>30', '>45', '>60', '>90', '>120']" :key="opt">
                                        <label class="flex items-center gap-1.5 cursor-pointer bg-orange-500/30 hover:bg-orange-500/50 px-2 py-1 rounded transition-colors" @click.stop>
                                            <input type="checkbox" 
                                                   :value="opt" 
                                                   x-model="stockViejoFilters"
                                                   @click.stop
                                                   class="w-4 h-4 rounded border-2 border-orange-300 text-orange-500 focus:ring-orange-400 cursor-pointer">
                                            <span class="text-xs text-white font-medium" x-text="opt + 'd'"></span>
                                        </label>
                                    </template>
                                </div>
                            </div>
                            
                            <p class="text-xs text-orange-100">
                                <span x-text="stockViejoFilters.length > 0 ? 'Filtrado: ' + stockViejoFilters.join(', ') : 'Mostrando: >45 d√≠as (default)'"></span>
                            </p>
                            <button @click="applyStockViejoFilter()" 
                                    class="mt-2 text-[10px] bg-orange-500 hover:bg-orange-400 px-3 py-1 rounded font-bold transition-colors">
                                üëÜ Ver detalle
                            </button>
                        </div>

                        <!-- üÜï STOCK SIN VENTA (por d√≠as desde √∫ltima venta) -->
                        <div class="bg-gradient-to-br from-purple-600 to-purple-700 rounded-lg p-6 shadow-lg text-white">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-purple-100 text-sm font-medium">üì¶ STOCK SIN VENTA</p>
                                    <p class="text-3xl font-bold mt-2"><span x-text="getStockSinVentaCount()"></span> <span class="text-lg">SKUs</span></p>
                                </div>
                                <div class="bg-purple-500 bg-opacity-30 p-3 rounded-lg">üõë</div>
                            </div>
                            <!-- Selector m√∫ltiple de rangos de d√≠as sin venta -->
                            <div class="mb-3" @click.stop>
                                <p class="text-[10px] text-purple-200 mb-2">üìÖ Seleccionar rangos de d√≠as SIN VENTA:</p>
                                <div class="grid grid-cols-2 gap-1">
                                    <template x-for="opt in ['20-30', '31-40', '41-50', '>51']" :key="opt">
                                        <label class="flex items-center gap-1 cursor-pointer bg-purple-500/30 hover:bg-purple-500/50 px-2 py-1 rounded transition-colors" @click.stop>
                                            <input type="checkbox" 
                                                   :value="opt" 
                                                   x-model="stockSinVentaFilters"
                                                   @click.stop
                                                   class="w-3.5 h-3.5 rounded border-2 border-purple-300 text-purple-500 focus:ring-purple-400 cursor-pointer">
                                            <span class="text-[11px] text-white font-medium" x-text="opt + ' d√≠as'"></span>
                                        </label>
                                    </template>
                                </div>
                            </div>
                            <p class="text-xs text-purple-100">
                                <span x-text="stockSinVentaFilters.length > 0 ? 'Seleccionados: ' + stockSinVentaFilters.join(', ') + ' d√≠as sin venta' : 'Selecciona rangos arriba'"/>
                            </p>
                            <button @click="applyStockSinVentaFilter()" 
                                    :disabled="stockSinVentaFilters.length === 0"
                                    :class="stockSinVentaFilters.length === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-purple-400'"
                                    class="mt-2 text-[10px] bg-purple-500 px-3 py-1 rounded font-bold transition-colors">
                                üëÜ Ver detalle
                            </button>
                        </div>
                    </div>

                    <!-- üÜï SEGUNDA FILA: KPIs OPERATIVOS -->
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                        <!-- Forecast: VTAR vs VPD (cumplimiento objetivo) -->
                        <div class="bg-gradient-to-br from-cyan-600 to-cyan-700 rounded-lg p-4 shadow-lg text-white">
                            <p class="text-cyan-100 text-xs font-medium">üéØ CUMPLIMIENTO VPD</p>
                            <p class="text-2xl font-bold mt-1" x-text="(kpiDashboard?.forecastRatio || 0).toFixed(1) + '%'"></p>
                            <p class="text-[10px] text-cyan-200 mt-1">
                                <span x-text="'VTAR: ' + (kpiDashboard?.vtarTotalSum || 0).toFixed(0)"></span> / 
                                <span x-text="'VPD: ' + (kpiDashboard?.vpdTotalSum || 0).toFixed(0)"></span>
                            </p>
                            <p class="text-[9px] text-cyan-300 mt-0.5" x-text="(kpiDashboard?.forecastRatio || 0) >= 100 ? '‚úÖ Objetivo superado' : '‚ö†Ô∏è Por debajo del objetivo'"></p>
                        </div>
                        <!-- Venta Perdida -->
                        <div class="bg-gradient-to-br from-rose-600 to-rose-700 rounded-lg p-4 shadow-lg text-white">
                            <p class="text-rose-100 text-xs font-medium">üí∏ VENTA PERDIDA</p>
                            <p class="text-2xl font-bold mt-1">$<span x-text="Math.round(kpiDashboard?.ventaPerdidaTotal || 0).toLocaleString()"></span></p>
                            <p class="text-[10px] text-rose-200 mt-1">Por quiebres de stock</p>
                        </div>
                        <!-- Cargos ML -->
                        <div class="bg-gradient-to-br from-amber-600 to-amber-700 rounded-lg p-4 shadow-lg text-white">
                            <p class="text-amber-100 text-xs font-medium">‚ö° CARGOS ML</p>
                            <p class="text-2xl font-bold mt-1">$<span x-text="Math.round(kpiDashboard?.deudaTotal || 0).toLocaleString()"></span></p>
                            <p class="text-[10px] text-amber-200 mt-1">Cargos pendientes</p>
                        </div>
                    </div>

                    <!-- AN√ÅLISIS COMPARATIVO CON GR√ÅFICAS -->
                    <div class="mb-8 bg-slate-800 rounded-lg p-6 shadow-lg">
                        <h2 class="text-xl font-bold text-white mb-4">üìä An√°lisis Comparativo (√öltimos 60 d√≠as)</h2>
                        
                        <!-- Selector de tipo de an√°lisis -->
                        <div class="mb-6">
                            <label class="text-white text-sm font-bold block mb-2">üìå Analizar por:</label>
                            <div class="flex gap-3">
                                <label class="flex items-center gap-2 cursor-pointer text-slate-300 hover:text-white">
                                    <input type="radio" x-model="dashboardAnalysisType" value="sku" @change="dashboardSearchText=''; dashboardSearchResults=[]; updateDashboardAnalysis()" class="w-4 h-4">
                                    <span>SKU Individual</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer text-slate-300 hover:text-white">
                                    <input type="radio" x-model="dashboardAnalysisType" value="marca" @change="dashboardSearchText=''; dashboardSearchResults=[]; updateDashboardAnalysis()" class="w-4 h-4">
                                    <span>Marca</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer text-slate-300 hover:text-white">
                                    <input type="radio" x-model="dashboardAnalysisType" value="proveedor" @change="dashboardSearchText=''; dashboardSearchResults=[]; updateDashboardAnalysis()" class="w-4 h-4">
                                    <span>Proveedor</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Buscador con autocomplete -->
                        <div class="mb-6">
                            <label class="text-white text-sm font-bold block mb-2 flex justify-between items-center">
                                <span>
                                    üîç Buscar y agregar (1-5): 
                                    <span class="text-slate-400 text-xs font-normal">
                                        Por SKU / Descripci√≥n / Marca / Proveedor
                                    </span>
                                </span>
                                <div class="flex gap-2 items-center">
                                    <span x-show="(this.masterData?.length || 0) === 0 && (this.rawData?.grafana?.length || 0) <= 1" class="text-red-400 text-xs font-bold animate-pulse">‚ö†Ô∏è Sin datos</span>
                                    <span x-show="(this.masterData?.length || 0) > 0" class="text-green-400 text-xs font-bold">‚úì <span x-text="(this.masterData?.length || 0)"></span> SKUs</span>
                                    <span x-show="(this.masterData?.length || 0) === 0 && (this.rawData?.grafana?.length || 0) > 1" class="text-blue-400 text-xs font-bold">‚úì Excel cargado</span>
                                    <button @click="
                                        const masterCount = this.masterData?.length || 0;
                                        const grafanaCount = this.rawData?.grafana?.length || 0;
                                        
                                        if(masterCount === 0 && grafanaCount <= 1) {
                                            alert('‚ùå PRIMERO CARGA EL EXCEL\n\n1. Clickea el bot√≥n EXCEL en la parte superior\n2. Selecciona tu archivo\n3. Espera a que se procese\n4. Luego podr√°s buscar SKUs');
                                        } else if(masterCount > 0) {
                                            alert('‚úì Total SKUs cargados: ' + masterCount + '\n\nPrimeros 5:\n' + (this.masterData?.slice(0, 5).map(m => m.sku).join('\n') || 'N/D'));
                                        } else {
                                            alert('‚úì Excel cargado desde Grafana: ' + (grafanaCount-1) + ' filas\n\nPuedes buscar SKUs ahora');
                                        }
                                    " 
                                    class="text-slate-400 hover:text-white text-xs font-normal bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded">üìä Ver SKUs</button>
                                </div>
                            </label>
                            <div class="relative">
                                <div class="flex gap-2">
                                    <input type="text" 
                                        x-model="dashboardSearchText" 
                                        @input="searchDashboardItems()"
                                        @keydown.enter="handleDashboardSearchEnter()"
                                        @keydown.escape="dashboardSearchResults = []"
                                        @focus="dashboardSearchText.length > 0 && searchDashboardItems()"
                                        placeholder="Ej: 140006024BA, motor, UNILEV, CAFELV, proveedor..."
                                        class="flex-1 bg-slate-700 text-white p-3 rounded border border-slate-600 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <button @click="handleDashboardSearchEnter()" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded border-0 transition-colors font-bold text-sm">‚èé Buscar</button>
                                    <button @click="dashboardSearchText = ''; dashboardSearchResults = [];" class="bg-slate-700 hover:bg-slate-600 text-slate-400 hover:text-white px-3 rounded border border-slate-600 transition-colors">‚úï</button>
                                </div>
                                
                                <!-- Mensaje de carga de Excel requerida -->
                                <!-- Mensaje de carga de Excel requerida (solo si no hay nada) -->
                                <div x-show="dashboardSearchText.length > 0 && (this.masterData?.length || 0) === 0 && (this.rawData?.grafana?.length || 0) <= 1"
                                    class="absolute top-full left-0 right-0 mt-1 bg-red-900 border-2 border-red-600 rounded shadow-lg z-50 p-3">
                                    <p class="text-red-300 text-sm font-bold">üî¥ PRIMERO CARGA EL EXCEL</p>
                                    <p class="text-red-200 text-xs mt-1">Pasos:</p>
                                    <ol class="text-red-200 text-xs ml-3 mt-1 list-decimal">
                                        <li>Clickea el bot√≥n <span class="font-bold text-white">üìä Excel</span> en la parte superior</li>
                                        <li>Selecciona tu archivo de Excel</li>
                                        <li>Espera a que se procese (ver√°s los widgets KPI con datos)</li>
                                        <li>Luego podr√°s usar el buscador aqu√≠</li>
                                    </ol>
                                </div>
                                
                                <!-- Dropdown de resultados -->
                                <div x-show="dashboardSearchText.length > 0 && dashboardSearchResults.length > 0" 
                                    @click.away="dashboardSearchResults = []"
                                    class="absolute top-full left-0 right-0 mt-1 bg-slate-700 border-2 border-green-500 rounded shadow-xl z-50 max-h-72 overflow-y-auto">
                                    <div class="bg-slate-800 p-2 border-b border-green-500 text-xs text-slate-300 sticky top-0 font-bold">
                                        ‚úì <span x-text="dashboardSearchResults.length + ' resultado(s) encontrado(s)'"></span> ‚Ä¢ Click para agregar
                                    </div>
                                    <template x-for="(item, idx) in dashboardSearchResults" :key="item.sku">
                                        <div @click="addDashboardItem(item)" 
                                            :class="[
                                                dashboardSelectedItems.some(s => s.sku === item.sku) ? 'bg-green-700 border-l-4 border-green-400' : (idx === 0 ? 'bg-blue-900 border-l-4 border-blue-400' : 'hover:bg-slate-600'),
                                                'p-3 border-b border-slate-600 cursor-pointer transition-colors'
                                            ]">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <div class="text-white font-mono text-sm font-bold flex items-center gap-2">
                                                        <span x-show="item.bloqueado" class="text-sm" title="‚ö†Ô∏è BLOQUEADO">üö©</span>
                                                        <span x-text="item.sku"></span>
                                                        <span x-show="idx === 0" class="text-xs bg-blue-500 px-1 rounded">1er resultado</span>
                                                    </div>
                                                    <div class="text-slate-300 text-xs truncate" x-text="(item.desc?.substring(0, 40) || 'S/D')"></div>
                                                    <!-- C√≥digos adicionales: EAN y MLA -->
                                                    <div class="flex gap-3 mt-1" x-show="item.ean || item.mla">
                                                        <span x-show="item.ean" class="text-slate-500 text-[10px] font-mono" x-text="'EAN: ' + item.ean"></span>
                                                        <span x-show="item.mla" class="text-blue-400 text-[10px] font-mono" x-text="'MLA: ' + item.mla"></span>
                                                    </div>
                                                </div>
                                                <div class="text-slate-400 text-xs text-right ml-2">
                                                    <div x-text="'Stock: ' + ((item.stockGrafana || item.stock || 0))"></div>
                                                </div>
                                            </div>
                                            <div class="text-slate-400 text-xs flex justify-between mt-1">
                                                <span x-text="'üì¶ ' + (item.marca || 'S/D')"></span>
                                                <span x-text="'üöö ' + (item.prov || 'S/D')"></span>
                                            </div>
                                            <div x-show="dashboardSelectedItems.some(s => s.sku === item.sku)" class="text-green-300 text-xs mt-1 font-bold">‚úì Ya agregado</div>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Mensaje cuando no hay resultados -->
                                <div x-show="dashboardSearchText.length > 0 && dashboardSearchResults.length === 0 && (this.masterData?.length || 0) > 0"
                                    class="absolute top-full left-0 right-0 mt-1 bg-slate-700 border-2 border-orange-500 rounded shadow-lg z-50 p-3">
                                    <p class="text-orange-400 text-xs font-bold">‚ö†Ô∏è No se encontraron resultados para: "<span x-text="dashboardSearchText"></span>"</p>
                                    <p class="text-slate-400 text-xs mt-1">Intenta con:</p>
                                    <ul class="text-slate-400 text-xs ml-3 mt-1 list-disc">
                                        <li>Parte del SKU (ej: primeros 6 d√≠gitos)</li>
                                        <li>Nombre de la marca</li>
                                        <li>Proveedor</li>
                                        <li>Palabra de la descripci√≥n</li>
                                    </ul>
                                    <button @click="console.log('[DEBUG] masterData:', this.masterData?.length || 0); console.log('[DEBUG] flatData:', this.flatData?.length || 0); console.log('[DEBUG] rawData.grafana:', this.rawData?.grafana?.length || 0); alert('‚úì Ver consola (F12) para debugging')" 
                                        class="mt-2 bg-slate-600 hover:bg-slate-500 text-white text-xs px-2 py-1 rounded">üîç Ver datos en consola</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Items seleccionados (tabla) -->
                        <div class="mb-6 bg-slate-700 rounded-lg p-4" x-show="dashboardSelectedItems.length > 0">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-white font-bold text-sm">üìã Seleccionados (<span x-text="dashboardSelectedItems.length"></span>/5)</h3>
                                <button @click="dashboardSelectedItems = []; updateDashboardAnalysis()" class="text-red-400 hover:text-red-300 text-xs font-bold">Limpiar todo</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-xs text-slate-300 border-collapse">
                                    <thead>
                                        <tr class="border-b border-slate-600">
                                            <th class="text-left p-2">SKU</th>
                                            <th class="text-left p-2">DESCRIPCI√ìN</th>
                                            <th class="text-left p-2">MARCA</th>
                                            <th class="text-left p-2">PROVEEDOR</th>
                                            <th class="text-right p-2">VTAR</th>
                                            <th class="text-right p-2">STOCK</th>
                                            <th class="p-2">Acci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="item in dashboardSelectedItems" :key="item.sku">
                                            <tr class="border-b border-slate-600 hover:bg-slate-600">
                                                <td class="p-2 font-mono"><span x-show="item.bloqueado" class="mr-1" title="‚ö†Ô∏è BLOQUEADO">üö©</span><span x-text="item.sku"></span></td>
                                                <td class="p-2 text-slate-400" x-text="item.desc?.substring(0, 30) + (item.desc?.length > 30 ? '...' : '')"></td>
                                                <td class="p-2" x-text="item.marca || 'S/D'"></td>
                                                <td class="p-2" x-text="item.prov || 'S/D'"></td>
                                                <td class="p-2 text-right" x-text="(item.vtarTotal || 0).toFixed(2)"></td>
                                                <td class="p-2 text-right" x-text="(item.stockGrafana || 0).toLocaleString()"></td>
                                                <td class="p-2 text-center">
                                                    <button @click="removeDashboardItem(item.sku)" class="text-red-400 hover:text-red-300 font-bold text-lg">√ó</button>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Gr√°fica -->
                        <div class="bg-slate-700 rounded-lg p-4" x-show="dashboardSelectedItems.length > 0">
                            <canvas id="dashboardChart" height="80"></canvas>
                        </div>
                        
                        <div x-show="dashboardSelectedItems.length === 0" class="bg-slate-700 rounded-lg p-8 text-center text-slate-400">
                            <p>üëÜ Busca y selecciona 1-5 items para ver la gr√°fica de comparaci√≥n</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto bg-slate-50 p-6" x-show="currentTab === 'metricas'">

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div @click="switchTab('consolidado'); filterOpportunityCost = true;" 
                     class="bg-red-50 p-4 rounded-lg border-l-4 border-l-red-600 shadow-sm card-hover border border-red-100 relative overflow-hidden group cursor-pointer transition-transform hover:scale-[1.02]" 
                     title="Clic para ver detalle de p√©rdidas">
                        <div class="absolute right-2 top-2 text-2xl opacity-20 group-hover:scale-125 transition-transform">üî•</div>
                        <div class="text-[10px] font-bold text-red-800 uppercase tracking-wider">Flujo Perdido (Costo)</div>
                        <div class="text-2xl font-black text-red-600 mt-1" x-text="formatMoney(kpis.ventaPerdidaTotal)"></div>
                        <div class="text-[9px] text-red-500 font-bold mt-1 bg-red-100 inline-block px-1 rounded">Diario ¬∑ Solo Activos</div>
                    </div>


                    <div @click="switchTab('consolidado'); filterArbitrage = true;" 
                         class="bg-purple-50 p-4 rounded-lg border-l-4 border-l-purple-600 shadow-sm card-hover border border-purple-100 relative overflow-hidden group cursor-pointer transition-transform hover:scale-[1.02]" 
                         title="Clic para ver oportunidades de movimiento de stock">
                        <div class="absolute right-2 top-2 text-2xl opacity-20 group-hover:scale-125 transition-transform">ÔøΩ</div>
                        <div class="text-[10px] font-bold text-purple-800 uppercase tracking-wider">Enviar a Full</div>
                        <div class="text-2xl font-black text-purple-600 mt-1" x-text="formatMoney(kpis.arbitrageTotal)"></div>
                        <div class="text-[9px] text-purple-500 font-bold mt-1 bg-purple-100 inline-block px-1 rounded">Mover Central -> Full</div>
                    </div>
                    


                    <div class="bg-white p-4 rounded-lg border-l-4 border-l-emerald-500 shadow-sm card-hover" @click="switchTab('resumen')">
                        <div class="text-xs font-bold text-slate-400 uppercase">Inversi√≥n Sugerida para Compras</div>
                        <div class="text-2xl font-bold text-emerald-700" x-text="formatMoney(kpis.compra)"></div>
                        <div class="text-xs text-emerald-600" x-text="kpis.skusCompra + ' SKUs a pedir'"></div>
                    </div>

                    <div class="bg-white p-4 rounded-lg border-l-4 border-l-purple-500 shadow-sm card-hover" @click="switchTab('dep80')">
                        <div class="text-xs font-bold text-slate-400 uppercase">A Enviar Dep 80</div>
                        <div class="text-2xl font-bold text-purple-700" x-text="kpis.envios.toLocaleString() + ' u.'"></div>
                        <div class="text-xs text-purple-600" x-text="formatMoney(kpis.valorEnvios)"></div>
                    </div>

                    <div class="bg-white p-4 rounded-lg border-l-4 border-l-blue-500 shadow-sm card-hover" @click="switchTab('resumen')">
                        <div class="text-xs font-bold text-slate-400 uppercase">En Camino</div>
                        <div class="text-2xl font-bold text-blue-700" x-text="kpis.enCamino.toLocaleString() + ' u.'"></div>
                        <div class="text-xs text-slate-400">Mercader√≠a Comprada</div>
                    </div>

                    <div class="bg-white p-4 rounded-lg border-l-4 border-l-purple-500 shadow-sm card-hover" @click="switchTab('inmovilizado')">
                        <div class="text-xs font-bold text-slate-400 uppercase">Costo Sobrestock</div>
                        <div class="text-2xl font-bold text-purple-700" x-text="formatMoney(kpis.inmovilizado)"></div>
                        <div class="text-xs text-purple-600">Unidades excedentes > 45 d√≠as</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-7xl mx-auto">
                    <div class="flex flex-col gap-6">
                        <div class="bg-white p-4 rounded-lg shadow border flex flex-col gap-4">
                            <div class="flex justify-between items-center border-b pb-2">
                                <h3 class="text-sm font-bold text-red-700 uppercase">Cargos por Analista</h3>
                                <div class="text-right"><div class="text-[9px] text-slate-400 uppercase">Total Cargos Acumulados</div><div class="text-lg font-bold text-red-600" x-text="formatMoney(metrics.totalDeudaAnalistas)"></div></div>
                            </div>
                            <div class="h-48 w-full"><canvas id="chartAnalista"></canvas></div>

                            <div class="overflow-x-auto max-h-48 border rounded mt-2">
                                <table class="w-full text-xs">
                                    <thead class="bg-slate-100 font-bold text-slate-600 sticky top-0"><tr><td class="p-2">Analista</td><td class="p-2 text-center">SKUs</td><td class="p-2 text-center">Unidades</td><td class="p-2 text-right">Cargos Total</td></tr></thead>
                                    <tbody class="divide-y">
                                        <template x-for="a in metrics.analistasTable" :key="a.name">
                                            <tr class="hover:bg-red-50 cursor-pointer" @click="switchTab('cargos'); activeFilters['analista'] = [a.name];">
                                                <td class="p-2 font-medium text-slate-700" x-text="a.name"></td>
                                                <td class="p-2 text-center" x-text="a.count"></td>
                                                <td class="p-2 text-center" x-text="a.units"></td>
                                                <td class="p-2 text-right font-bold text-red-600" x-text="formatMoney(a.debt)"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>

                           

                            <div class="border-t pt-4 mt-2">
                                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Evoluci√≥n Cargos Total (Hist√≥rico)</h4>
                                <div class="h-32 w-full"><canvas id="chartDeudaHistory"></canvas></div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow border border-indigo-200">
                            <h3 class="text-sm font-bold text-indigo-800 uppercase border-b pb-2 mb-3 flex justify-between items-center">
                                <span>üß† Matriz Estrat√©gica ABC-XYZ</span>
                                <span class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded">Valor vs. Variabilidad</span>
                            </h3>
                            <div class="grid grid-cols-4 gap-1 text-center text-xs">
                                <div class="col-start-2 font-bold text-slate-500">X (Estable)</div>
                                <div class="font-bold text-slate-500">Y (Variable)</div>
                                <div class="font-bold text-slate-500">Z (Err√°tico)</div>

                                <div class="font-bold text-slate-500 flex items-center justify-center h-20">A (Alto)</div>
                                <div class="bg-green-100 p-2 rounded border border-green-200 flex flex-col justify-center h-20 cursor-pointer hover:bg-green-200 transition" @click="filterMatrix('AX')">
                                    <div class="font-bold text-green-800 text-lg">AX</div>
                                    <div class="text-[10px]" x-text="matrixCounts['AX'] || 0"></div>
                                </div>
                                <div class="bg-green-50 p-2 rounded border border-green-100 flex flex-col justify-center h-20 cursor-pointer hover:bg-green-100 transition" @click="filterMatrix('AY')">
                                    <div class="font-bold text-green-700 text-lg">AY</div>
                                    <div class="text-[10px]" x-text="matrixCounts['AY'] || 0"></div>
                                </div>
                                <div class="bg-yellow-50 p-2 rounded border border-yellow-100 flex flex-col justify-center h-20 cursor-pointer hover:bg-yellow-100 transition" @click="filterMatrix('AZ')">
                                    <div class="font-bold text-yellow-700 text-lg">AZ</div>
                                    <div class="text-[10px]" x-text="matrixCounts['AZ'] || 0"></div>
                                </div>

                                <div class="font-bold text-slate-500 flex items-center justify-center h-20">B (Medio)</div>
                                <div class="bg-blue-50 p-2 rounded border border-blue-100 flex flex-col justify-center h-20 cursor-pointer hover:bg-blue-100 transition" @click="filterMatrix('BX')">
                                    <div class="font-bold text-blue-700 text-lg">BX</div>
                                    <div class="text-[10px]" x-text="matrixCounts['BX'] || 0"></div>
                                </div>
                                <div class="bg-slate-50 p-2 rounded border border-slate-200 flex flex-col justify-center h-20 cursor-pointer hover:bg-slate-100 transition" @click="filterMatrix('BY')">
                                    <div class="font-bold text-slate-600 text-lg">BY</div>
                                    <div class="text-[10px]" x-text="matrixCounts['BY'] || 0"></div>
                                </div>
                                <div class="bg-orange-50 p-2 rounded border border-orange-100 flex flex-col justify-center h-20 cursor-pointer hover:bg-orange-100 transition" @click="filterMatrix('BZ')">
                                    <div class="font-bold text-orange-700 text-lg">BZ</div>
                                    <div class="text-[10px]" x-text="matrixCounts['BZ'] || 0"></div>
                                </div>

                                <div class="font-bold text-slate-500 flex items-center justify-center h-20">C (Bajo)</div>
                                <div class="bg-slate-50 p-2 rounded border border-slate-200 flex flex-col justify-center h-20 cursor-pointer hover:bg-slate-100 transition" @click="filterMatrix('CX')">
                                    <div class="font-bold text-slate-400 text-lg">CX</div>
                                    <div class="text-[10px]" x-text="matrixCounts['CX'] || 0"></div>
                                </div>
                                <div class="bg-slate-50 p-2 rounded border border-slate-200 flex flex-col justify-center h-20 cursor-pointer hover:bg-slate-100 transition" @click="filterMatrix('CY')">
                                    <div class="font-bold text-slate-400 text-lg">CY</div>
                                    <div class="text-[10px]" x-text="matrixCounts['CY'] || 0"></div>
                                </div>
                                <div class="bg-red-50 p-2 rounded border border-red-100 flex flex-col justify-center h-20 cursor-pointer hover:bg-red-100 transition" @click="filterMatrix('CZ')">
                                    <div class="font-bold text-red-400 text-lg">CZ</div>
                                    <div class="text-[10px]" x-text="matrixCounts['CZ'] || 0"></div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="flex flex-col gap-6">

                        <div class="bg-white p-4 rounded-lg shadow border border-indigo-100">
                            <h3 class="text-sm font-bold text-indigo-700 uppercase border-b pb-2 mb-3">Matriz de Calidad: ABC vs Salud (Capital Invertido) <span class="text-[10px] font-normal text-slate-500">üëÜ Click en celda para filtrar</span></h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-[10px] border-collapse">
                                    <thead>
                                        <tr class="bg-slate-100 font-bold text-center">
                                            <th class="p-2 text-left text-slate-600">Clase</th>
                                            <th class="p-2 text-red-700 border-l">Quiebre (1-10)</th>
                                            <th class="p-2 text-orange-600 border-l">Pre-Quiebre</th>
                                            <th class="p-2 text-green-700 border-l">Saludable</th>
                                            <th class="p-2 text-yellow-600 border-l">Alerta</th>
                                            <th class="p-2 text-purple-700 border-l">Sobrestock</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="row in ['A', 'B', 'C']" :key="row">
                                            <tr class="border-b hover:bg-slate-50">
                                                <td class="p-2 font-bold text-center bg-slate-50 cursor-pointer hover:bg-indigo-100" 
                                                    @click="filterMatrixByAbc(row)" 
                                                    :title="'Click para ver todos los ' + row"
                                                    x-text="row"></td>
                                                <td class="p-2 text-right font-mono border-l cursor-pointer hover:ring-2 hover:ring-red-400" 
                                                    :class="metrics.matrix[row].q > 0 ? 'bg-red-100 font-bold text-red-800' : ''" 
                                                    @click="filterMatrixCell(row, 'Quiebre')" 
                                                    :title="metrics.matrix[row].q > 0 ? 'Click para filtrar ' + row + ' + Quiebre' : ''"
                                                    x-text="formatMoney(metrics.matrix[row].q)"></td>
                                                <td class="p-2 text-right font-mono border-l cursor-pointer hover:ring-2 hover:ring-orange-400" 
                                                    :class="metrics.matrix[row].pq > 0 ? 'bg-orange-50' : ''" 
                                                    @click="filterMatrixCell(row, 'Por Quebrar')" 
                                                    :title="metrics.matrix[row].pq > 0 ? 'Click para filtrar ' + row + ' + Por Quebrar' : ''"
                                                    x-text="formatMoney(metrics.matrix[row].pq)"></td>
                                                <td class="p-2 text-right font-mono border-l cursor-pointer hover:ring-2 hover:ring-green-400" 
                                                    :class="metrics.matrix[row].s > 0 ? 'bg-green-50' : ''" 
                                                    @click="filterMatrixCell(row, 'Saludable')" 
                                                    :title="metrics.matrix[row].s > 0 ? 'Click para filtrar ' + row + ' + Saludable' : ''"
                                                    x-text="formatMoney(metrics.matrix[row].s)"></td>
                                                <td class="p-2 text-right font-mono border-l cursor-pointer hover:ring-2 hover:ring-yellow-400" 
                                                    :class="metrics.matrix[row].a > 0 ? 'bg-yellow-50' : ''" 
                                                    @click="filterMatrixCell(row, 'Alerta')" 
                                                    :title="metrics.matrix[row].a > 0 ? 'Click para filtrar ' + row + ' + Alerta' : ''"
                                                    x-text="formatMoney(metrics.matrix[row].a)"></td>
                                                <td class="p-2 text-right font-mono border-l cursor-pointer hover:ring-2 hover:ring-purple-400" 
                                                    :class="metrics.matrix[row].o > 0 ? 'bg-purple-100 font-bold text-purple-800' : ''" 
                                                    @click="filterMatrixCell(row, 'Sobrestock')" 
                                                    :title="metrics.matrix[row].o > 0 ? 'Click para filtrar ' + row + ' + Sobrestock' : ''"
                                                    x-text="formatMoney(metrics.matrix[row].o)"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow border">
                            <h3 class="text-sm font-bold text-blue-700 uppercase border-b pb-2">Estado de Salud Inventario</h3>
                            <div class="flex items-center gap-4 mt-2">
                                <div class="h-40 w-40 shrink-0"><canvas id="chartHealth"></canvas></div>
                                <div class="text-xs space-y-2 flex-1">
                                    <div class="flex justify-between"><span class="text-red-900 font-bold">‚óè Quiebres (1-10)</span> <b x-text="metrics.health.q"></b></div>
                                    <div class="flex justify-between"><span class="text-red-600 font-bold">‚óè Por Quebrar (11-17)</span> <b x-text="metrics.health.pq"></b></div>
                                    <div class="flex justify-between"><span class="text-green-600 font-bold">‚óè Saludable (18-30)</span> <b x-text="metrics.health.s"></b></div>
                                    <div class="flex justify-between"><span class="text-yellow-600 font-bold">‚óè Alerta (31-45)</span> <b x-text="metrics.health.a"></b></div>
                                    <div class="flex justify-between"><span class="text-purple-600 font-bold">‚óè Sobrestock (>45)</span> <b x-text="metrics.health.o"></b></div>
                                </div>
                            </div>
                        </div>

                <div class="bg-white p-4 rounded-lg shadow border border-slate-200 mb-6">
                    <h3 class="text-sm font-bold text-slate-700 uppercase border-b pb-2 mb-3 flex justify-between items-center">
                        <span>ü¶Å Distribuci√≥n por Perfil Estrat√©gico</span>
                        <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded">Origen: Grafana</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs">
                                <thead class="bg-slate-50 text-slate-500 font-bold uppercase">
                                    <tr>
                                        <td class="p-2">Perfil</td>
                                        <td class="p-2 text-center">SKUs</td>
                                        <td class="p-2 text-right">Capital ($)</td>
                                        <td class="p-2 text-right">%</td>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    <template x-for="p in metrics.profiles" :key="p.name">
                                        <tr class="hover:bg-blue-50 cursor-pointer" @click="switchTab('consolidado'); activeFilters['perfil'] = [p.name];">
                                            <td class="p-2 font-bold">
                                                <span x-text="p.name === 'Killer' ? 'ü¶Å ' + p.name : (p.name === 'Sin Clasificar' ? '‚ùì ' + p.name : 'üì¶ ' + p.name)"></span>
                                            </td>
                                            <td class="p-2 text-center" x-text="p.count"></td>
                                            <td class="p-2 text-right font-mono text-slate-700" x-text="formatMoney(p.money)"></td>
                                            <td class="p-2 text-right">
                                                <div class="flex items-center justify-end gap-2">
                                                    <span x-text="p.pct + '%'" class="text-[10px] font-bold text-slate-500"></span>
                                                    <div class="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                                        <div class="h-full bg-blue-500" :style="'width: ' + p.pct + '%'"></div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                        <div class="h-48 w-full relative">
                            <canvas id="chartProfiles"></canvas>
                        </div>
                    </div>
                </div>

                     <div class="bg-white p-4 rounded-lg shadow border border-slate-200 mb-6">
                    <h3 class="text-sm font-bold text-slate-700 uppercase border-b pb-2 mb-3 flex justify-between items-center">
                        <span>üóìÔ∏è Proyecci√≥n de Flujo de Caja (Cash Flow)</span>
                        <span class="text-[10px] bg-green-50 text-green-700 px-2 py-1 rounded border border-green-100">Necesidad de Pago Estimada</span>
                    </h3>
                    <div class="h-64 w-full relative">
                        <canvas id="chartCashFlow"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-4 gap-2 text-center text-[10px]">
                        <div class="bg-red-50 p-2 rounded border border-red-100">
                            <div class="font-bold text-red-700">Semana 1 (Urgente)</div>
                            <div class="text-xs font-black" x-text="formatMoney(metrics.cashFlow?.w1 || 0)"></div>
                            <div class="text-slate-400">Stock < 7 d√≠as</div>
                        </div>
                        <div class="bg-orange-50 p-2 rounded border border-orange-100">
                            <div class="font-bold text-orange-700">Semana 2</div>
                            <div class="text-xs font-black" x-text="formatMoney(metrics.cashFlow?.w2 || 0)"></div>
                            <div class="text-slate-400">Stock 7-14 d√≠as</div>
                        </div>
                        <div class="bg-yellow-50 p-2 rounded border border-yellow-100">
                            <div class="font-bold text-yellow-700">Semana 3</div>
                            <div class="text-xs font-black" x-text="formatMoney(metrics.cashFlow?.w3 || 0)"></div>
                            <div class="text-slate-400">Stock 14-21 d√≠as</div>
                        </div>
                        <div class="bg-blue-50 p-2 rounded border border-blue-100">
                            <div class="font-bold text-blue-700">Semana 4+</div>
                            <div class="text-xs font-black" x-text="formatMoney(metrics.cashFlow?.w4 || 0)"></div>
                            <div class="text-slate-400">Reposici√≥n</div>
                        </div>
                    </div>
                </div>
                

                    </div>

                    <!-- üéØ NUEVA M√âTRICA: Sub_Perfil + Cobertura en Dep80 -->
                    <div class="bg-white p-4 rounded-lg shadow border border-emerald-200 mb-6">
                        <h3 class="text-sm font-bold text-emerald-700 uppercase border-b pb-2 mb-3 flex justify-between items-center">
                            <span>üéØ An√°lisis Sub_Perfil + Cobertura Dep√≥sito 80</span>
                            <span class="text-[10px] bg-emerald-50 text-emerald-700 px-2 py-1 rounded border border-emerald-100">Killer, Normal, Baja Rotaci√≥n, Verano</span>
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs">
                                <thead class="bg-emerald-50 text-emerald-800 font-bold uppercase sticky top-0">
                                    <tr>
                                        <td class="p-2">Sub_Perfil</td>
                                        <td class="p-2 text-center">SKUs</td>
                                        <td class="p-2 text-center">%</td>
                                        <td class="p-2 text-right">Stock Dep80</td>
                                        <td class="p-2 text-right">VTAR Total</td>
                                        <td class="p-2 text-center">D√≠as Stock</td>
                                        <td class="p-2 text-center">Estado</td>
                                        <td class="p-2 text-right">Sobrestock</td>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    <template x-for="sp in metrics.subPerfilCoverage" :key="sp.subPerfil">
                                        <tr class="hover:bg-emerald-50 cursor-pointer transition-colors" 
                                            @click="switchTab('dep80'); activeFilters['subPerfil'] = [sp.subPerfil];">
                                            <td class="p-2 font-bold text-slate-700" x-text="sp.subPerfil"></td>
                                            <td class="p-2 text-center font-bold text-slate-800" x-text="sp.cantProductos"></td>
                                            <td class="p-2 text-center">
                                                <span class="bg-emerald-100 text-emerald-800 px-1.5 py-0.5 rounded text-[10px] font-bold" x-text="sp.porcentajeProductos + '%'"></span>
                                            </td>
                                            <td class="p-2 text-right font-mono text-slate-700" x-text="sp.stockDep80.toLocaleString()"></td>
                                            <td class="p-2 text-right font-mono text-slate-600" x-text="parseFloat(sp.vtarTotal).toFixed(2)"></td>
                                            <td class="p-2 text-center">
                                                <span class="font-bold text-base" 
                                                      :class="sp.coberturaDias > 45 ? 'text-purple-600' : (sp.coberturaDias >= 30 ? 'text-green-600' : (sp.coberturaDias >= 15 ? 'text-yellow-600' : 'text-red-600'))"
                                                      x-text="sp.coberturaDias + 'd'"></span>
                                            </td>
                                            <td class="p-2 text-center">
                                                <span class="px-2 py-1 rounded text-[10px] font-bold"
                                                      :class="sp.coberturaDias > 45 ? 'bg-purple-100 text-purple-800' : (sp.coberturaDias >= 30 ? 'bg-green-100 text-green-800' : (sp.coberturaDias >= 15 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'))"
                                                      x-text="sp.coberturaDias > 45 ? 'üü£ Sobrestock' : (sp.coberturaDias >= 30 ? '‚úÖ Saludable' : (sp.coberturaDias >= 15 ? '‚ö†Ô∏è Alerta' : 'üî¥ Cr√≠tico'))"></span>
                                            </td>
                                            <td class="p-2 text-right">
                                                <template x-if="sp.unidadesSobrestock > 0">
                                                    <span class="font-bold text-purple-700 bg-purple-50 px-2 py-1 rounded border border-purple-200" 
                                                          x-text="'+' + sp.unidadesSobrestock.toLocaleString() + ' u.'"></span>
                                                </template>
                                                <template x-if="sp.unidadesSobrestock <= 0">
                                                    <span class="text-slate-400">-</span>
                                                </template>
                                            </td>
                                        </tr>
                                    </template>
                                    <tr x-show="!metrics.subPerfilCoverage || metrics.subPerfilCoverage.length === 0">
                                        <td colspan="8" class="py-4 text-center text-slate-400">Cargando datos...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3 text-[9px] text-slate-500 bg-slate-50 p-2 rounded border border-slate-100 grid grid-cols-4 gap-2 text-center">
                            <div><span class="inline-block w-3 h-3 rounded bg-red-500 mr-1"></span><strong class="text-red-600">< 15d</strong> Cr√≠tico</div>
                            <div><span class="inline-block w-3 h-3 rounded bg-yellow-500 mr-1"></span><strong class="text-yellow-600">15-30d</strong> Alerta</div>
                            <div><span class="inline-block w-3 h-3 rounded bg-green-500 mr-1"></span><strong class="text-green-600">30-45d</strong> Saludable</div>
                            <div><span class="inline-block w-3 h-3 rounded bg-purple-500 mr-1"></span><strong class="text-purple-600">> 45d</strong> Sobrestock</div>
                        </div>
                        <div class="mt-2 text-[9px] text-slate-500 bg-purple-50 p-2 rounded border border-purple-100">
                            <strong>üì¶ Sobrestock:</strong> Unidades que exceden los 45 d√≠as de cobertura. F√≥rmula: <code class="bg-white px-1 rounded">Stock - (VTAR √ó 45)</code>
                        </div>
                    </div>

                    <!-- üéØ HEALTH SCORE DEL INVENTARIO -->
                    <div class="bg-white p-4 rounded-lg shadow border border-indigo-200 mb-6">
                        <h3 class="text-sm font-bold text-indigo-700 uppercase border-b pb-2 mb-3">üè• Health Score del Inventario</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Score Principal -->
                            <div class="flex flex-col items-center justify-center p-6 bg-indigo-50 rounded-lg">
                                <div class="text-6xl font-black" 
                                     :style="`color: ${metrics.healthScore?.overall >= 75 ? '#16a34a' : (metrics.healthScore?.overall >= 50 ? '#f59e0b' : '#dc2626')}`"
                                     x-text="metrics.healthScore?.overall || 0"></div>
                                <div class="text-2xl font-bold text-indigo-700 mt-2">/100</div>
                                <div class="text-lg font-bold mt-3" x-show="metrics.healthScore?.overall >= 75">‚úÖ SALUDABLE</div>
                                <div class="text-lg font-bold mt-3 text-yellow-700" x-show="metrics.healthScore?.overall >= 50 && metrics.healthScore?.overall < 75">‚ö†Ô∏è MODERADO</div>
                                <div class="text-lg font-bold mt-3 text-red-700" x-show="metrics.healthScore?.overall < 50">üö® CR√çTICO</div>
                                <div class="text-sm text-slate-600 mt-2" x-text="metrics.healthScore?.trend === '‚Üë' ? '‚ÜóÔ∏è Mejorando' : (metrics.healthScore?.trend === '‚Üì' ? '‚ÜòÔ∏è Empeorando' : '‚Üí Estable')"></div>
                            </div>
                            
                            <!-- Desglose de Componentes -->
                            <div class="space-y-3">
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs text-slate-600">Cobertura (40%) <span class="text-[9px] text-slate-400">SKUs con 15-45 d√≠as stock</span></span>
                                        <span class="text-sm font-bold" :style="`color: ${metrics.healthScore?.components?.cobertura >= 75 ? '#16a34a' : (metrics.healthScore?.components?.cobertura >= 50 ? '#f59e0b' : '#dc2626')}`" x-text="metrics.healthScore?.components?.cobertura + '%'"></span>
                                    </div>
                                    <div class="w-full h-2.5 bg-slate-200 rounded-full overflow-hidden">
                                        <div class="h-full bg-blue-500 transition-all" :style="`width: ${metrics.healthScore?.components?.cobertura}%`"></div>
                                    </div>
                                    <div class="text-[9px] text-slate-400 mt-0.5" x-text="(metrics.healthScore?.details?.skusSaludables || 0) + ' de ' + (metrics.healthScore?.details?.skusConStock || 0) + ' SKUs'"></div>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs text-slate-600">Rotaci√≥n (25%) <span class="text-[9px] text-slate-400">SKUs con venta activa</span></span>
                                        <span class="text-sm font-bold" :style="`color: ${metrics.healthScore?.components?.rotacion >= 75 ? '#16a34a' : (metrics.healthScore?.components?.rotacion >= 50 ? '#f59e0b' : '#dc2626')}`" x-text="metrics.healthScore?.components?.rotacion + '%'"></span>
                                    </div>
                                    <div class="w-full h-2.5 bg-slate-200 rounded-full overflow-hidden">
                                        <div class="h-full bg-purple-500 transition-all" :style="`width: ${metrics.healthScore?.components?.rotacion}%`"></div>
                                    </div>
                                    <div class="text-[9px] text-slate-400 mt-0.5" x-text="(metrics.healthScore?.details?.skusActivos || 0) + ' SKUs activos'"></div>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs text-slate-600">Eficiencia Capital (20%) <span class="text-[9px] text-slate-400">$ en stock ‚â§45 d√≠as</span></span>
                                        <span class="text-sm font-bold" :style="`color: ${metrics.healthScore?.components?.capital >= 75 ? '#16a34a' : (metrics.healthScore?.components?.capital >= 50 ? '#f59e0b' : '#dc2626')}`" x-text="metrics.healthScore?.components?.capital + '%'"></span>
                                    </div>
                                    <div class="w-full h-2.5 bg-slate-200 rounded-full overflow-hidden">
                                        <div class="h-full bg-emerald-500 transition-all" :style="`width: ${metrics.healthScore?.components?.capital}%`"></div>
                                    </div>
                                    <div class="text-[9px] text-slate-400 mt-0.5" x-text="formatMoney(metrics.healthScore?.details?.capitalSaludable || 0) + ' de ' + formatMoney(metrics.healthScore?.details?.capitalTotal || 0)"></div>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs text-slate-600">Gesti√≥n Cargos (15%) <span class="text-[9px] text-slate-400">Menos cargos = mejor</span></span>
                                        <span class="text-sm font-bold" :style="`color: ${metrics.healthScore?.components?.deuda >= 75 ? '#16a34a' : (metrics.healthScore?.components?.deuda >= 50 ? '#f59e0b' : '#dc2626')}`" x-text="metrics.healthScore?.components?.deuda + '%'"></span>
                                    </div>
                                    <div class="w-full h-2.5 bg-slate-200 rounded-full overflow-hidden">
                                        <div class="h-full bg-orange-500 transition-all" :style="`width: ${metrics.healthScore?.components?.deuda}%`"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 text-[9px] text-slate-500 bg-slate-50 p-2 rounded border border-slate-100 grid grid-cols-3 gap-2 text-center">
                            <div><span class="inline-block w-3 h-3 rounded bg-red-500 mr-1"></span><strong>< 50</strong> Cr√≠tico</div>
                            <div><span class="inline-block w-3 h-3 rounded bg-yellow-500 mr-1"></span><strong>50-74</strong> Moderado</div>
                            <div><span class="inline-block w-3 h-3 rounded bg-green-500 mr-1"></span><strong>‚â• 75</strong> Saludable</div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow border border-slate-200 lg:col-span-2">
                    <h3 class="text-sm font-bold text-slate-700 uppercase border-b pb-2 mb-3 flex justify-between items-center">
                        <span>üê¢ Envejecimiento de Stock (Aging)</span>
                        <span class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded border border-gray-200">Capital Inmovilizado por Antig√ºedad</span>
                    </h3>
                    <div class="h-64 w-full relative">
                        <canvas id="chartAging"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-5 gap-1 text-center text-[9px]">
                        <div class="bg-green-50 p-2 rounded border border-green-100">
                            <div class="font-bold text-green-700">0-30d</div>
                            <div class="text-xs font-black" x-text="formatMoney(metrics.aging?.f0_30 || 0)"></div>
                            <div class="text-slate-400">Fresco</div>
                        </div>
                        <div class="bg-yellow-50 p-2 rounded border border-yellow-100">
                            <div class="font-bold text-yellow-700">31-60d</div>
                            <div class="text-xs font-black" x-text="formatMoney(metrics.aging?.f31_60 || 0)"></div>
                            <div class="text-slate-400">Alerta</div>
                        </div>
                        <div class="bg-orange-50 p-2 rounded border border-orange-100">
                            <div class="font-bold text-orange-700">61-90d</div>
                            <div class="text-xs font-black" x-text="formatMoney(metrics.aging?.f61_90 || 0)"></div>
                            <div class="text-slate-400">Riesgo</div>
                        </div>
                        <div class="bg-red-50 p-2 rounded border border-red-100">
                            <div class="font-bold text-red-700">91-180d</div>
                            <div class="text-xs font-black" x-text="formatMoney(metrics.aging?.f91_180 || 0)"></div>
                            <div class="text-slate-400">Cr√≠tico</div>
                        </div>
                        <div class="bg-slate-100 p-2 rounded border border-slate-300">
                            <div class="font-bold text-slate-700">>180d</div>
                            <div class="text-xs font-black" x-text="formatMoney(metrics.aging?.f180 || 0)"></div>
                            <div class="text-slate-500">Muerto</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- üìä TAB SIMPLEX - Ventas por Mes (2025/2026) -->
        <div class="flex-1 overflow-y-auto bg-gradient-to-b from-emerald-50 to-white p-4" x-show="currentTab === 'simplex'">
            <div class="max-w-7xl mx-auto">
                <!-- KPIs Compactos arriba -->
                <div class="grid grid-cols-4 gap-2 mb-3">
                    <div class="bg-white rounded-lg shadow-sm p-2 border-l-4 border-emerald-500 flex items-center justify-between">
                        <div class="text-xs text-slate-500 font-bold">SKUs</div>
                        <div class="text-lg font-bold text-emerald-700" x-text="(simplexData2025.length + simplexData2026.length) || 0"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm p-2 border-l-4 border-blue-500 flex items-center justify-between">
                        <div class="text-xs text-slate-500 font-bold">Unidades</div>
                        <div class="text-lg font-bold text-blue-700" x-text="[...simplexData2025, ...simplexData2026].reduce((a,d) => a + d.qTotal, 0).toLocaleString()"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm p-2 border-l-4 border-purple-500 flex items-center justify-between">
                        <div class="text-xs text-slate-500 font-bold">Venta</div>
                        <div class="text-lg font-bold text-purple-700" x-text="formatMoney([...simplexData2025, ...simplexData2026].reduce((a,d) => a + d.ventaTotal, 0))"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm p-2 border-l-4 border-orange-500 flex items-center justify-between">
                        <div class="text-xs text-slate-500 font-bold">Marcas</div>
                        <div class="text-lg font-bold text-orange-700" x-text="[...new Set([...simplexData2025, ...simplexData2026].map(d => d.marca))].length"></div>
                    </div>
                </div>

                <!-- Barra de controles compacta -->
                <div class="bg-white rounded-lg shadow-sm border border-emerald-200 p-3 mb-3">
                    <div class="flex flex-wrap items-center gap-3">
                        <!-- Buscar por -->
                        <div class="flex items-center gap-1">
                            <span class="text-xs font-bold text-slate-600">Buscar:</span>
                            <label class="cursor-pointer px-2 py-1 rounded-full text-xs transition-colors"
                                :class="simplexSearchType === 'sku' ? 'bg-emerald-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                                <input type="radio" x-model="simplexSearchType" value="sku" class="hidden"> SKU
                            </label>
                            <label class="cursor-pointer px-2 py-1 rounded-full text-xs transition-colors"
                                :class="simplexSearchType === 'marca' ? 'bg-emerald-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                                <input type="radio" x-model="simplexSearchType" value="marca" class="hidden"> Marca
                            </label>
                            <label class="cursor-pointer px-2 py-1 rounded-full text-xs transition-colors"
                                :class="simplexSearchType === 'proveedor' ? 'bg-emerald-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                                <input type="radio" x-model="simplexSearchType" value="proveedor" class="hidden"> Proveedor
                            </label>
                        </div>

                        <div class="h-6 w-px bg-slate-300"></div>

                        <!-- A√±os -->
                        <div class="flex items-center gap-1">
                            <span class="text-xs font-bold text-slate-600">A√±o:</span>
                            <label class="cursor-pointer px-2 py-1 rounded text-xs transition-colors flex items-center gap-1"
                                :class="simplexYears.y2025 ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                                <input type="checkbox" x-model="simplexYears.y2025" @change="updateSimplexActiveData()" class="hidden"> 2025
                            </label>
                            <label class="cursor-pointer px-2 py-1 rounded text-xs transition-colors flex items-center gap-1"
                                :class="simplexYears.y2026 ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                                <input type="checkbox" x-model="simplexYears.y2026" @change="updateSimplexActiveData()" class="hidden"> 2026
                            </label>
                        </div>

                        <div class="h-6 w-px bg-slate-300"></div>

                        <!-- M√©trica -->
                        <div class="flex items-center gap-1">
                            <span class="text-xs font-bold text-slate-600">Mostrar:</span>
                            <label class="cursor-pointer px-2 py-1 rounded text-xs transition-colors"
                                :class="simplexMetric === 'unidades' ? 'bg-teal-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                                <input type="radio" x-model="simplexMetric" value="unidades" class="hidden"> Unidades
                            </label>
                            <label class="cursor-pointer px-2 py-1 rounded text-xs transition-colors"
                                :class="simplexMetric === 'importe' ? 'bg-teal-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                                <input type="radio" x-model="simplexMetric" value="importe" class="hidden"> Importe
                            </label>
                            <label class="cursor-pointer px-2 py-1 rounded text-xs transition-colors"
                                :class="simplexMetric === 'ambos' ? 'bg-teal-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                                <input type="radio" x-model="simplexMetric" value="ambos" class="hidden"> Ambos
                            </label>
                        </div>

                        <div class="h-6 w-px bg-slate-300"></div>

                        <!-- Vista -->
                        <div class="flex items-center gap-1">
                            <span class="text-xs font-bold text-slate-600">Vista:</span>
                            <label class="cursor-pointer px-2 py-1 rounded text-xs transition-colors"
                                :class="simplexViewMode === 'horizontal' ? 'bg-purple-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                                <input type="radio" x-model="simplexViewMode" value="horizontal" class="hidden"> ‚ÜîÔ∏è Tabla
                            </label>
                            <label class="cursor-pointer px-2 py-1 rounded text-xs transition-colors"
                                :class="simplexViewMode === 'vertical' ? 'bg-purple-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                                <input type="radio" x-model="simplexViewMode" value="vertical" class="hidden"> ‚ÜïÔ∏è Cards
                            </label>
                        </div>

                        <!-- Buscador -->
                        <div class="flex-1 flex gap-2">
                            <div class="relative flex-1">
                                <span class="absolute left-2 top-1.5 text-emerald-400 text-sm">üîç</span>
                                <input type="text" 
                                    x-model="simplexSearchText"
                                    @input="filterSimplexData(); updateSimplexChart()"
                                    @keydown.enter="filterSimplexData(); updateSimplexChart()"
                                    :placeholder="simplexSearchType === 'sku' ? 'Buscar SKU...' : simplexSearchType === 'marca' ? 'Buscar Marca...' : 'Buscar Proveedor...'"
                                    class="w-full pl-7 pr-3 py-1.5 rounded border border-slate-300 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-500">
                            </div>
                            <button @click="filterSimplexData(); updateSimplexChart()" 
                                class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded font-bold text-xs">
                                Buscar
                            </button>
                            <button @click="simplexSearchText=''; simplexFilteredData=[]; updateSimplexChart()" 
                                class="bg-slate-200 hover:bg-slate-300 text-slate-600 px-2 py-1.5 rounded text-xs">
                                ‚úï
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Gr√°fico de evoluci√≥n (arriba de resultados) -->
                <div x-show="simplexFilteredData.length > 0" class="bg-white rounded-lg shadow-sm border border-slate-200 p-3 mb-3">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-slate-700">üìà Evoluci√≥n Mensual</h3>
                        <div class="text-xs text-slate-500">
                            <span x-show="simplexYears.y2025 && simplexYears.y2026">Comparando 2025 vs 2026</span>
                            <span x-show="simplexYears.y2025 && !simplexYears.y2026">A√±o 2025</span>
                            <span x-show="!simplexYears.y2025 && simplexYears.y2026">A√±o 2026</span>
                        </div>
                    </div>
                    <div class="h-48">
                        <canvas id="simplexEvolutionChart"></canvas>
                    </div>
                </div>

                <!-- Resultados -->
                <div x-show="simplexFilteredData.length > 0" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-slate-100 px-3 py-2 border-b flex justify-between items-center">
                        <div class="text-sm font-bold text-slate-700">
                            üìä <span class="text-emerald-600" x-text="simplexFilteredData.length"></span> registros
                        </div>
                        <div class="text-xs text-slate-500 flex items-center gap-2">
                            <span x-show="simplexYears.y2025 && simplexYears.y2026">2025 + 2026</span>
                            <span x-show="simplexYears.y2025 && !simplexYears.y2026">2025</span>
                            <span x-show="!simplexYears.y2025 && simplexYears.y2026">2026</span>
                            <span>|</span>
                            <span x-text="simplexMetric === 'unidades' ? 'Unidades' : simplexMetric === 'importe' ? 'Importe' : 'Ambos'"></span>
                        </div>
                    </div>

                    <!-- VISTA HORIZONTAL (meses en columnas) -->
                    <div x-show="simplexViewMode === 'horizontal'" class="overflow-x-auto max-h-[400px]">
                        <table class="w-full text-xs">
                            <thead class="bg-emerald-100 sticky top-0 z-10">
                                <tr>
                                    <template x-for="col in getSimplexColumns()" :key="col.key">
                                        <th class="p-1.5 text-left font-bold text-emerald-800 border-b border-emerald-200 whitespace-nowrap"
                                            :class="[...simplexMeses2025, ...simplexMeses2026].includes(col.key) ? 'bg-emerald-200 text-center min-w-[80px]' : ''">
                                            <span x-text="col.label"></span>
                                        </th>
                                    </template>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <template x-for="(row, idx) in simplexFilteredData" :key="idx">
                                    <tr class="hover:bg-emerald-50 transition-colors"
                                        :class="row.year === 2026 ? 'bg-indigo-50/30' : ''">
                                        <template x-for="col in getSimplexColumns()" :key="col.key">
                                            <td class="p-1.5 border-b border-slate-100"
                                                :class="{
                                                    'font-bold text-slate-800': col.key === 'sku' || col.key === 'marca' || col.key === 'prov',
                                                    'text-center bg-slate-50': [...simplexMeses2025, ...simplexMeses2026].includes(col.key),
                                                    'text-right font-mono': col.key === 'qTotal' || col.key === 'ventaTotal',
                                                    'text-center font-bold': col.key === 'year'
                                                }">
                                                <span x-text="getSimplexCellValue(row, col)"></span>
                                            </td>
                                        </template>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <!-- VISTA VERTICAL (meses en filas) -->
                    <div x-show="simplexViewMode === 'vertical'" class="overflow-y-auto max-h-[600px] p-4">
                        <template x-for="(row, idx) in simplexFilteredData" :key="idx">
                            <div class="mb-4 bg-slate-50 rounded-lg border border-slate-200 overflow-hidden">
                                <!-- Header del registro -->
                                <div class="text-white px-4 py-2 flex justify-between items-center"
                                    :class="row.year === 2026 ? 'bg-indigo-600' : 'bg-emerald-600'">
                                    <div class="flex items-center gap-2">
                                        <span class="bg-white/20 px-2 py-0.5 rounded text-xs font-bold" x-text="row.year || '2025'"></span>
                                        <span class="font-bold" x-text="row.sku || row.marca || row.prov"></span>
                                        <span x-show="row.desc" class="text-white/70 text-sm" x-text="'- ' + row.desc"></span>
                                    </div>
                                    <div class="text-right text-sm">
                                        <span class="font-bold" x-text="(row.qTotal || 0).toLocaleString() + ' u'"></span>
                                        <span class="text-white/70 ml-2" x-text="formatMoney(row.ventaTotal || 0)"></span>
                                    </div>
                                </div>
                                
                                <!-- Tabla de meses vertical compacta -->
                                <div class="p-2">
                                    <table class="w-full text-xs">
                                        <thead class="bg-slate-100">
                                            <tr>
                                                <th class="p-1.5 text-left font-bold text-slate-600">MES</th>
                                                <th x-show="simplexMetric !== 'importe'" class="p-1.5 text-right font-bold text-slate-600">UNIDADES</th>
                                                <th x-show="simplexMetric !== 'unidades'" class="p-1.5 text-right font-bold text-slate-600">VENTA ($)</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y">
                                            <template x-for="mes in (row.year === 2026 ? simplexMeses2026 : simplexMeses2025)" :key="mes">
                                                <tr class="hover:bg-emerald-50" :class="(row[mes]?.q || 0) > 0 ? '' : 'opacity-40'">
                                                    <td class="p-1.5 font-bold text-slate-700 uppercase" x-text="mes"></td>
                                                    <td x-show="simplexMetric !== 'importe'" class="p-1.5 text-right font-mono" 
                                                        :class="(row[mes]?.q || 0) > 0 ? 'text-emerald-700 font-bold' : 'text-slate-400'"
                                                        x-text="(row[mes]?.q || 0).toLocaleString()"></td>
                                                    <td x-show="simplexMetric !== 'unidades'" class="p-1.5 text-right font-mono"
                                                        :class="(row[mes]?.venta || 0) > 0 ? 'text-blue-700 font-bold' : 'text-slate-400'"
                                                        x-text="formatMoney(row[mes]?.venta || 0)"></td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Sin resultados -->
                <div x-show="simplexSearchText.length >= 2 && simplexFilteredData.length === 0" class="bg-yellow-50 rounded-lg shadow-sm p-6 text-center border border-yellow-200">
                    <div class="text-3xl mb-2">üîç</div>
                    <h3 class="text-sm font-bold text-yellow-700 mb-1">No se encontraron resultados</h3>
                    <p class="text-yellow-600 text-xs">No hay datos para "<span x-text="simplexSearchText" class="font-bold"></span>"</p>
                </div>

                <!-- Estado inicial (sin b√∫squeda) -->
                <div x-show="simplexSearchText.length < 2 && simplexFilteredData.length === 0" class="bg-slate-50 rounded-lg p-6 text-center border border-dashed border-slate-300">
                    <div class="text-3xl mb-2">üîç</div>
                    <p class="text-slate-500 text-sm">Ingresa al menos 2 caracteres para buscar</p>
                </div>
            </div>
        </div>
    </main>

    <div x-show="showSeasonalityModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm" x-cloak>
        <div class="bg-white rounded-lg shadow-2xl p-6 w-96">
            <h2 class="text-lg font-bold text-orange-600 mb-4">Configuraci√≥n Estacional</h2>
            <div class="mb-4">
                <label class="block text-xs font-bold text-slate-500 mb-1">Nombre Etiqueta</label>
                <input type="text" placeholder="Ej: Verano" class="w-full border rounded p-2 text-xs mb-2">
                <label class="block text-xs font-bold text-slate-500 mb-1">Multiplicador (1.0 = Normal)</label>
                <input type="number" step="0.1" x-model.number="seasonalFactorInput" class="w-full border rounded p-2 text-xs">
            </div>
            <div class="flex justify-end gap-2">
                <button @click="showSeasonalityModal=false" class="text-slate-500 text-xs font-bold px-3 py-1">Cancelar</button>
                <button @click="applyBulkEdit('seasonalMult', seasonalFactorInput); showSeasonalityModal=false" class="bg-orange-600 text-white text-xs font-bold px-4 py-2 rounded">Aplicar a Seleccionados</button>
            </div>
        </div>
    </div>

    <div x-show="showLiquidationModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm" x-cloak>
        <div class="bg-white rounded-lg shadow-2xl p-6 w-96">
            <h2 class="text-lg font-bold text-red-600 mb-4">Calculadora de Liquidaci√≥n</h2>
            <div class="space-y-3 mb-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500">Descuento Propuesto (%)</label>
                    <input type="number" x-model.number="liqParams.discount" class="w-full border rounded p-2 text-xs">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500">Elasticidad (Aumento Venta est.)</label>
                    <input type="number" step="0.1" x-model.number="liqParams.elasticity" class="w-full border rounded p-2 text-xs" title="1.5 significa que si bajas 10% el precio, la venta sube 15%">
                </div>
                <div class="bg-slate-100 p-3 rounded">
                    <div class="text-[10px] uppercase text-slate-500 font-bold">Capital a Recuperar</div>
                    <div class="text-xl font-bold text-slate-800" x-text="formatMoney(calculateLiquidation().recovery)"></div>
                    <div class="text-[10px] text-red-500 mt-1">P√©rdida asumida: <span x-text="formatMoney(calculateLiquidation().loss)"></span></div>
                </div>
            </div>
            <div class="flex justify-end">
                <button @click="showLiquidationModal=false" class="bg-slate-800 text-white text-xs font-bold px-4 py-2 rounded">Cerrar</button>
            </div>
        </div>
    </div>

    <div x-show="showSimulator" class="fixed inset-0 z-40 bg-black/20 backdrop-blur-sm" @click="showSimulator=false" x-transition.opacity></div>
    <div x-show="showSimulator" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-50 flex flex-col border-l border-slate-200 transform transition-transform" 
         :class="showSimulator ? 'translate-x-0' : 'translate-x-full'" style="transition: transform 0.3s ease-in-out;">
        <div class="p-4 bg-purple-700 text-white flex justify-between items-center shadow-md">
            <h2 class="font-bold text-sm uppercase">üéõÔ∏è Simulador Financiero</h2>
            <button @click="showSimulator=false" class="text-white hover:text-purple-200">‚úï</button>
        </div>
        <div class="flex-1 p-6 overflow-y-auto space-y-6 bg-slate-50">
            <div class="bg-white p-4 rounded border shadow-sm">
                <label class="text-xs font-bold text-slate-500 block mb-2">D√≠as de Cobertura Simulados</label>
                <input type="range" min="15" max="120" step="5" x-model.number="simParams.days" class="w-full mb-2">
                <div class="text-center font-bold text-purple-600 text-xl" x-text="simParams.days + ' d√≠as'"></div>
            </div>

            <div class="bg-white p-4 rounded border shadow-sm">
                <div class="text-[10px] uppercase font-bold text-slate-400 mb-2">Impacto en Inversi√≥n</div>
                <div class="flex justify-between items-end mb-2">
                    <span class="text-xs text-slate-600">Actual:</span>
                    <span class="font-bold text-slate-800" x-text="formatMoney(kpis.compra)"></span>
                </div>
                <div class="flex justify-between items-end mb-4 border-b pb-2">
                    <span class="text-xs text-purple-600 font-bold">Simulado:</span>
                    <span class="font-bold text-purple-700 text-lg" x-text="formatMoney(getSimulationResults().total)"></span>
                </div>
                <div class="text-center text-xs">
                    Diferencia: 
                    <span class="font-bold px-2 py-1 rounded" :class="getSimulationResults().diff > 0 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'" x-text="(getSimulationResults().diff > 0 ? '+' : '') + formatMoney(getSimulationResults().diff)"></span>
                </div>
            </div>
            
            <div class="text-[10px] text-slate-400 text-center italic">
                *Este simulador calcula la compra necesaria para alcanzar X d√≠as de stock, sin modificar la base de datos real.
            </div>
        </div>
        <div class="p-4 border-t bg-white">
            <button @click="params.diasCompra = simParams.days; recalculateGlobal(); showSimulator=false" class="w-full bg-purple-600 text-white py-2 rounded font-bold shadow hover:bg-purple-700 transition text-xs">
                Aplicar a Realidad
            </button>
        </div>
    </div>

    <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end" x-cloak>
        <div x-show="chatOpen" class="bg-white w-80 sm:w-96 h-[500px] rounded-xl shadow-2xl border border-slate-200 flex flex-col mb-4 overflow-hidden chat-enter">
            <div class="bg-indigo-600 text-white p-3 flex justify-between items-center shadow-sm">
                <div class="flex items-center gap-2">
                    <span class="text-xl">ü§ñ</span>
                    <div>
                        <div class="font-bold text-sm">Asistente de Inventario</div>
                        <div class="text-[10px] opacity-80">Online | Responde al instante</div>
                    </div>
                </div>
                <button @click="toggleChat" class="text-white hover:bg-indigo-700 rounded p-1">‚úï</button>
            </div>

            <div class="flex-1 bg-slate-50 p-4 overflow-y-auto space-y-3" id="chat-messages">
                <template x-for="(msg, index) in chatMessages" :key="index">
                    <div :class="msg.type === 'bot' ? 'flex justify-start' : 'flex justify-end'">
                        <div :class="msg.type === 'bot' ? 'bg-white text-slate-700 rounded-bl-none' : 'bg-indigo-600 text-white rounded-br-none'"
                             class="max-w-[85%] rounded-2xl px-4 py-2 text-xs shadow-sm border border-slate-100">
                            <div x-html="msg.html || msg.text"></div>
                        </div>
                    </div>
                </template>
                <div x-show="isTyping" class="flex justify-start">
                    <div class="bg-white p-3 rounded-2xl rounded-bl-none shadow-sm flex gap-1">
                        <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                    </div>
                </div>
            </div>

            <div class="p-3 bg-white border-t">
                <div class="flex gap-2 overflow-x-auto pb-2 mb-1 scrollbar-thin">
                    <button @click="sendQuickMsg('Quiebres')" class="whitespace-nowrap px-3 py-1 bg-red-50 text-red-600 rounded-full text-[10px] border border-red-100 hover:bg-red-100">üö® Quiebres</button>
                    <button @click="sendQuickMsg('Vencimientos')" class="whitespace-nowrap px-3 py-1 bg-orange-50 text-orange-600 rounded-full text-[10px] border border-orange-100 hover:bg-orange-100">üìÖ Vencimientos</button>
                    <button @click="sendQuickMsg('Dinero')" class="whitespace-nowrap px-3 py-1 bg-emerald-50 text-emerald-600 rounded-full text-[10px] border border-emerald-100 hover:bg-emerald-100">üí∞ Dinero</button>
                </div>
                <div class="flex gap-2">
                    <input type="text" x-model="chatInput" @keydown.enter="sendMessage" placeholder="Escribe SKU, Marca o duda..." class="flex-1 text-xs border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-slate-50">
                    <button @click="sendMessage" class="bg-indigo-600 text-white rounded-full p-2 hover:bg-indigo-700 transition shadow-sm">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
            </div>
        </div>

        <button @click="toggleChat" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-full p-4 shadow-lg transition-transform hover:scale-105 flex items-center justify-center group relative">
            <span class="text-2xl group-hover:hidden">üí¨</span>
            <span class="text-xl hidden group-hover:block">üëã</span>
            <span class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center animate-bounce">1</span>
        </button>
    </div>

    <div x-show="modalOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4" x-transition.opacity x-cloak @keydown.escape.window="modalOpen = false">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl overflow-hidden flex flex-col max-h-[90vh]" @click.away="modalOpen = false">
            <div class="bg-slate-900 text-white px-6 py-4 flex justify-between items-center shrink-0">
                <div>
                    <div class="flex items-center gap-2">
                        <h2 class="text-2xl font-bold" x-text="selectedRow?.sku"></h2>
                        <span x-show="selectedRow?.impulsar" class="bg-orange-500 text-white text-xs px-2 py-1 rounded font-bold animate-pulse">üöÄ IMPULSAR</span>
                    </div>
                    <div class="text-slate-400 text-sm" x-text="selectedRow?.desc"></div>
                    <!-- C√≥digos EAN y MLA -->
                    <div class="flex gap-4 mt-1" x-show="selectedRow?.ean || selectedRow?.mla">
                        <span x-show="selectedRow?.ean" class="text-slate-500 text-xs font-mono flex items-center gap-1">
                            <span class="text-slate-600">EAN:</span> <span x-text="selectedRow?.ean" class="text-slate-300"></span>
                        </span>
                        <span x-show="selectedRow?.mla" class="text-blue-400 text-xs font-mono flex items-center gap-1">
                            <span class="text-blue-500">MLA:</span> <span x-text="selectedRow?.mla" class="text-blue-300"></span>
                        </span>
                    </div>
                </div>
                <button @click="modalOpen = false" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            
            <div class="p-6 overflow-y-auto bg-slate-50 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div x-show="selectedRow?.ventaPerdida > 0" class="md:col-span-3 bg-red-100 border-l-4 border-red-600 text-red-800 p-3 rounded shadow-sm flex justify-between items-center animate-pulse">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">üõë</span>
                        <div>
                            <p class="font-bold text-sm uppercase">Quiebre de Stock (Activo)</p>
                            <p class="text-[10px]">Este producto deber√≠a estar fluyendo pero est√° en 0.</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-[9px] uppercase font-bold opacity-70">Costo Frenado (Diario)</p>
                        <p class="text-xl font-black" x-text="formatMoney(selectedRow?.ventaPerdida)"></p>
                    </div>
                </div>

                <div class="md:col-span-3 bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                    <h3 class="text-xs font-bold text-slate-500 uppercase border-b pb-2 mb-3 flex items-center gap-2">
                        <span>‚è±Ô∏è Tendencia de Venta (Velocidad de Salida)</span>
                        <span class="text-[9px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded border border-blue-100">Unidades x D√≠a Promedio</span>
                    </h3>
                    
                    <div class="grid grid-cols-4 gap-4 text-center">
                        <div class="flex flex-col items-center justify-center p-2 rounded border bg-slate-50 border-slate-100 opacity-70">
                            <span class="text-[9px] font-bold text-slate-400 uppercase mb-1">Hace 60 D√≠as</span>
                            <div class="text-lg font-bold text-slate-600" x-text="(selectedRow?.vtar60 || 0).toFixed(2)"></div>
                        </div>

                        <div class="flex flex-col items-center justify-center p-2 rounded border bg-slate-50 border-slate-100">
                            <span class="text-[9px] font-bold text-slate-400 uppercase mb-1">Hace 45 D√≠as</span>
                            <div class="text-lg font-bold text-slate-600" x-text="(selectedRow?.vtar45 || 0).toFixed(2)"></div>
                        </div>

                        <div class="flex flex-col items-center justify-center p-2 rounded border border-blue-100 bg-blue-50">
                            <span class="text-[9px] font-bold text-blue-500 uppercase mb-1">Hace 30 D√≠as</span>
                            <div class="text-xl font-bold text-blue-700" x-text="(selectedRow?.vtar30 || 0).toFixed(2)"></div>
                        </div>

                        <div class="flex flex-col items-center justify-center p-2 rounded border-2 relative transition-all duration-300"
                             :class="(selectedRow?.vtar15 >= selectedRow?.vtar30) ? 'border-green-200 bg-green-50' : 'border-red-100 bg-red-50'">
                            
                            <span class="absolute -top-2.5 bg-white px-2 py-0.5 text-[9px] font-bold border rounded shadow-sm flex items-center gap-1"
                                  :class="(selectedRow?.vtar15 >= selectedRow?.vtar30) ? 'text-green-600 border-green-200' : 'text-red-600 border-red-200'">
                                <span x-text="(selectedRow?.vtar15 >= selectedRow?.vtar30) ? 'üöÄ ACELERANDO' : 'üê¢ FRENANDO'"></span>
                            </span>

                            <span class="text-[9px] font-bold uppercase mb-1 mt-1"
                                  :class="(selectedRow?.vtar15 >= selectedRow?.vtar30) ? 'text-green-600' : 'text-red-600'">
                                √öltimos 15 D√≠as
                            </span>
                            
                            <div class="text-2xl font-black"
                                 :class="(selectedRow?.vtar15 >= selectedRow?.vtar30) ? 'text-green-700' : 'text-red-700'" 
                                 x-text="(selectedRow?.vtar15 || 0).toFixed(2)"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-lg border shadow-sm">
                    <h3 class="text-xs font-bold text-slate-400 uppercase border-b pb-2 mb-3">Inventario</h3>
                    <div class="space-y-3 text-xs">
                        <div x-show="selectedRow?.dep" class="bg-blue-50 p-2 rounded mb-2 font-bold text-center">Datos del Dep√≥sito: <span x-text="selectedRow?.dep"></span></div>
                        <div class="flex justify-between p-2 bg-slate-50 rounded"><span>Dep√≥sito 1:</span><strong x-text="selectedRow?.pbi?.dep1"></strong></div>
                        <div class="flex justify-between p-2 bg-purple-50 rounded border-purple-100"><span>Dep√≥sito 80:</span><strong x-text="selectedRow?.pbi?.dep80"></strong></div>
                        <div class="flex justify-between p-2 bg-blue-50 rounded border-blue-100 text-blue-700"><span>En Camino:</span><strong x-text="selectedRow?.comprasEnCamino"></strong></div>

                        <div class="flex justify-between p-2 rounded border mt-2 items-center"
                             :class="(selectedRow?.diasStock || 0) <= 15 ? 'bg-red-100 text-red-800 border-red-200' : 
                                    ((selectedRow?.diasStock || 0) > 45 ? 'bg-purple-100 text-purple-800 border-purple-200' : 
                                    'bg-green-100 text-green-800 border-green-200')">
                            <span class="font-bold uppercase text-[10px]">D√≠as de Stock Actual:</span>
                            <strong class="text-base" x-text="(selectedRow?.diasStock > 900 ? '‚àû' : (selectedRow?.diasStock || 0).toFixed(1)) + ' d'"></strong>
                        </div>

                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <div class="p-2 bg-slate-50 rounded border flex flex-col items-center justify-center">
                                <span class="text-[9px] text-slate-500 uppercase font-bold tracking-wide">VTAR (Real)</span>
                                <div class="text-base font-bold text-slate-800" x-text="(selectedRow?.vtarTotal || 0).toFixed(2) + ' u.'"></div>
                            </div>
                            <div class="p-2 bg-blue-50/50 rounded border border-blue-100 flex flex-col items-center justify-center">
                                <span class="text-[9px] text-blue-600 uppercase font-bold tracking-wide">VPD (Proy.)</span>
                                <div class="text-base font-bold text-blue-700" x-text="(selectedRow?.vpdCpra || 0).toFixed(2) + ' u.'"></div>
                            </div>
                        </div>

                        <div class="flex justify-between p-2 bg-emerald-50 rounded border-emerald-100 mt-2"><span>Stock M√≠nimo:</span><strong x-text="selectedRow?.stockMin"></strong></div>
                        <div class="flex justify-between p-2 bg-emerald-50 rounded border-emerald-100"><span>Stock M√°ximo:</span><strong x-text="selectedRow?.stockMax"></strong></div>

                        <div x-show="selectedRow?.trendHistory?.length > 1" class="pt-2 mt-2 border-t">
                             <span class="text-[10px] font-bold text-slate-400">TENDENCIA √öLTIMOS D√çAS:</span>
                             <div class="w-full h-12 border rounded bg-slate-50 mt-1 flex items-center justify-center">
                                <div class="sparkline-container w-full h-full px-2" x-html="renderSparkline(selectedRow?.trendHistory || [], 200, 40)"></div>
                             </div> 
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-4">
                    <div class="bg-white p-5 rounded-lg border shadow-sm">
                        <h3 class="text-xs font-bold text-blue-600 uppercase border-b pb-2 mb-3">Env√≠o Full (80)</h3>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between"><span>Disponible:</span><span x-text="selectedRow?.stockRestante"></span></div>
                            <div class="flex justify-between"><span>Demanda (30d):</span><strong x-text="selectedRow?.vta30d_80"></strong></div>
                            <div class="flex justify-between items-center border-t pt-2 mt-2">
                                <span class="font-bold text-blue-800">A ENVIAR:</span>
                                <span class="text-2xl font-bold text-blue-700" x-text="selectedRow?.qEnviar"></span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-lg border shadow-sm flex-1">
                        <h3 class="text-xs font-bold text-orange-600 uppercase border-b pb-2 mb-3">üìÖ Trazabilidad de Lotes</h3>
                        <div class="overflow-y-auto max-h-40 scrollbar-thin">
                            <template x-if="selectedRowLotes && selectedRowLotes.length > 0">
                                <table class="w-full text-[10px]">
                                    <thead class="bg-orange-50 text-orange-800">
                                        <tr>
                                            <th class="p-1 text-left">Ingreso</th>
                                            <th class="p-1 text-left">Vencimiento</th>
                                            <th class="p-1 text-center">Estado</th>
                                            <th class="p-1 text-right">Cant.</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y">
                                        <template x-for="lote in selectedRowLotes" :key="lote.id">
                                            <tr>
                                                <td class="p-1 font-bold" x-text="lote.fechaIngreso || '-'"></td>
                                                
                                                <td class="p-1 font-bold" x-text="lote.fechaVto"></td>
                                                <td class="p-1 text-center">
                                                    <span class="px-1 rounded" :class="lote.dias <= 30 ? 'bg-red-100 text-red-600' : (lote.dias <= 60 ? 'bg-yellow-100 text-yellow-600' : 'bg-green-100 text-green-600')"
                                                          x-text="lote.dias <= 30 ? 'üî¥' : (lote.dias <= 60 ? 'üü°' : 'üü¢')"></span>
                                                </td>
                                                <td class="p-1 text-right font-mono" x-text="lote.stockComprometido"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </template>
                            <template x-if="!selectedRowLotes || selectedRowLotes.length === 0">
                                <div class="text-[10px] text-slate-400 text-center py-4">No hay informaci√≥n de lotes.</div>
                            </template>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-lg border shadow-sm relative overflow-hidden">
                    <h3 class="text-xs font-bold uppercase border-b pb-2 mb-3" :class="selectedRow?.impulsar ? 'text-orange-600' : 'text-emerald-600'">Compra</h3>
                    <div x-show="!selectedRow?.impulsar">
                        <div class="grid grid-cols-2 gap-4 text-center mb-3">
                            <div><div class="text-[10px]">Unidades</div><div class="text-xl font-bold text-emerald-700" x-text="selectedRow?.comprarU"></div></div>
                            <div><div class="text-[10px]">Inversi√≥n</div><div class="text-xl font-bold" x-text="formatMoney(selectedRow?.inversion)"></div></div>
                        </div>
                        <div class="text-[10px] text-center text-slate-400 mt-2" x-show="selectedRow?.comprasEnCamino > 0">(Descontado en camino: <span x-text="selectedRow?.comprasEnCamino"></span> u.)</div>

                        <div class="mt-3 pt-3 border-t text-center">
                             <div class="text-[9px] font-bold text-slate-400 uppercase">Precisi√≥n Venta vs Proyecci√≥n</div>
                             <div class="text-lg font-bold" :class="((selectedRow?.vtarTotal - selectedRow?.vpdCpra)/selectedRow?.vpdCpra * 100) > 0 ? 'text-green-600' : 'text-red-600'">
                                 <span x-text="selectedRow?.vpdCpra > 0 ? (((selectedRow?.vtarTotal - selectedRow?.vpdCpra)/selectedRow?.vpdCpra * 100).toFixed(1) + '%') : 'S/D'"></span>
                             </div>
                        </div>
                        <div class="mt-3 pt-3 border-t text-center" x-show="selectedRow?.vtarIa">
                             <div class="text-[9px] font-bold text-purple-500 uppercase">Predicci√≥n IA (Regresi√≥n)</div>
                             <div class="text-lg font-bold text-purple-600">
                                 <span x-text="selectedRow?.vtarIa?.toFixed(2)"></span>
                                 <span class="text-xs text-slate-400">(vs VTAR: <span x-text="selectedRow?.vtarTotal.toFixed(2)"></span>)</span>
                             </div>
                        </div>

                    </div>
                    <div x-show="selectedRow?.impulsar" class="text-center py-4 font-bold text-orange-700 text-sm">COMPRA PAUSADA (Impulsar)</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚ö° OPTIMIZACI√ìN: Cache para memoizaci√≥n de c√°lculos costosos
        const MemoCache = {
            _cache: new Map(),
            get(key) { return this._cache.get(key); },
            set(key, value) { this._cache.set(key, value); return value; },
            has(key) { return this._cache.has(key); },
            clear() { this._cache.clear(); },
            size() { return this._cache.size; }
        };

        const DB={
            name:'InvProV93', store:'Files', histStore: 'History', debtStore: 'DebtHistory',
            async getDB(){
                return new Promise((r,j)=>{
                    const q=indexedDB.open(this.name, 24);
                    q.onupgradeneeded=e=>{
                        const db=e.target.result;
                        if(!db.objectStoreNames.contains(this.store)) db.createObjectStore(this.store);
                        if(!db.objectStoreNames.contains(this.histStore)) db.createObjectStore(this.histStore, {keyPath: 'id', autoIncrement: true});
                        if(!db.objectStoreNames.contains(this.debtStore)) db.createObjectStore(this.debtStore, {keyPath: 'date'});
                    };
                    q.onsuccess=e=>r(e.target.result);
                    q.onerror=j
                })
            },
            async save(k,d){try{const db=await this.getDB();return new Promise(r=>{const tx=db.transaction(this.store,'readwrite');tx.objectStore(this.store).put(d,k);tx.oncomplete=r})}catch(e){}},
            async load(k){try{const db=await this.getDB();return new Promise(r=>{const tx=db.transaction(this.store,'readonly');const q=tx.objectStore(this.store).get(k);q.onsuccess=()=>r(q.result);q.onerror=()=>r(null)})}catch(e){return null}},
            async saveSnapshot(data) {
                try {
                    const db = await this.getDB();
                    const tx = db.transaction(this.histStore, 'readwrite');
                    const store = tx.objectStore(this.histStore);
                    const today = new Date().toISOString().slice(0,10);
                    store.add({ date: today, data: data });
                } catch(e) { }
            },
            async saveDebtHistory(totalDebt) {
                try {
                    const db = await this.getDB();
                    const tx = db.transaction(this.debtStore, 'readwrite');
                    const store = tx.objectStore(this.debtStore);
                    const today = new Date().toISOString().slice(0,10);
                    store.put({ date: today, val: totalDebt });
                } catch(e) { }
            },
            async getHistory() {
                try {
                    const db = await this.getDB();
                    return new Promise(r => {
                        const tx = db.transaction(this.histStore, 'readonly');
                        const req = tx.objectStore(this.histStore).getAll();
                        req.onsuccess = () => r(req.result);
                        req.onerror = () => r([]);
                    });
                } catch(e) { return []; }
            },
            async getDebtHistory() {
                try {
                    const db = await this.getDB();
                    return new Promise(r => {
                        const tx = db.transaction(this.debtStore, 'readonly');
                        const req = tx.objectStore(this.debtStore).getAll();
                        req.onsuccess = () => r(req.result);
                        req.onerror = () => r([]);
                    });
                } catch(e) { return []; }
            },
            async clear(){return new Promise(r=>{const q=indexedDB.deleteDatabase(this.name);q.onsuccess=r})}
        };

        function calculateLinearRegression(y) {
            const n = y.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            for (let i = 0; i < n; i++) {
                sumX += i;
                sumY += y[i];
                sumXY += i * y[i];
                sumXX += i * i;
            }
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            return { slope, intercept, nextVal: slope * n + intercept };
        }

        function calculateStandardDeviation(arr, mean) {
            if (!arr || arr.length === 0) return 0;
            const n = arr.length;
            const m = mean !== undefined ? mean : arr.reduce((a, b) => a + b, 0) / n;
            return Math.sqrt(arr.map(x => Math.pow(x - m, 2)).reduce((a, b) => a + b, 0) / n);
        }

        function detectAnomaly(data) {
            if (data.length < 5) return false;
            const mean = data.reduce((a,b)=>a+b,0) / data.length;
            const variance = data.reduce((a,b)=>a + Math.pow(b-mean,2),0) / data.length;
            const stdDev = Math.sqrt(variance);
            if (stdDev === 0) return false;
            const lastVal = data[data.length-1];
            const zScore = Math.abs((lastVal - mean) / stdDev);
            return zScore > 2.5;
        }

        /**
         * Convierte fecha serial de Excel a formato DD/MM/YYYY
         * @param {number} serial - N√∫mero serial de Excel
         * @returns {string} Fecha formateada o valor original si es inv√°lido
         */
        function excelDateToJSDate(serial) {
           if (!serial || isNaN(serial)) return serial;
           try {
               const utc_days  = Math.floor(serial - 25569);
               const utc_value = utc_days * 86400000;
               const date_info = new Date(utc_value);
               const day = String(date_info.getUTCDate()).padStart(2, '0');
               const month = String(date_info.getUTCMonth() + 1).padStart(2, '0');
               const year = date_info.getUTCFullYear();
               return `${day}/${month}/${year}`;
           } catch(e) {
               console.warn('[WARN] Error convirtiendo fecha:', serial);
               return serial;
           }
        }
//--  ---
        window.inventoryApp = function() {
            return {
                // üîê Sistema de Login
                isAuthenticated: false,
                loginUser: '',
                loginPass: '',
                loginError: '',
                
                isLoading: false, loadingMsg: '', dataReady: false, fileName: null, lastUpdate: null,
                darkMode: true, // Por defecto tema oscuro
                
                filterMLUrgencies: false,
                focusMode: false,
                
                filterOpportunityCost: false,
                filterAging: null,
                filterArbitrage: false,
                kpiFilter: null, // 'criticos' | 'viejo' | null

                modalOpen: false, selectedRow: null, selectedRowLotes: [],
                rawData: {}, masterData: [], flatData: [], enviosData: [], lotesData: [], proveedoresData: [], otherDepositsData: [],
                uniqueEnvioFechas: [],

                params: { diasSuc: 30, diasFull: 30, diasCompra: 30, diasOtros: 30, simulationDays: 30 },
                
                // üîÑ M√©todo de c√°lculo: 'vtar' (hist√≥rico) o 'vpd' (proyectado)
                calcMethod: 'vtar',
                
                showSimulator: false,
                simParams: { days: 30 },

                selectedIds: [],
                
                kpiDashboard: { criticos: 0, dineroViejo: 0, stockTotal: 0, skusActivos: 0, fillRate: 0, rotacionInv: 0, forecastRatio: 0, vtarTotalSum: 0, vpdTotalSum: 0, ventaPerdidaTotal: 0, deudaTotal: 0 },
                searchTimeout: null, // Debounce para b√∫squeda
                stockViejoFilters: [], // Selector m√∫ltiple: ['>30', '>45', '>60', '>90', '>120']
                stockSinVentaFilters: [], // Selector m√∫ltiple: ['‚â§20', '‚â§30', '‚â§40', '‚â§50', '‚â§60', '>60']
                sugerencias: [],
                
                // üõí SHARE de Mercado
                shareSearchType: 'sku',
                shareSearchText: '',
                shareSearchResult: null,
                shareSelectedMonth: 'NOVIEMBRE', // Mes seleccionado para SHARE
                shareMonths: ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'],
                shareMetrics: { shareProm: 0, skusLideres: 0, skusDebiles: 0, valorLideres: 0, distribution: {}, topSkus: [], worstSkus: [], byMarca: [] },
                
                // An√°lisis comparativo Dashboard
                dashboardAnalysisType: 'sku',
                dashboardSelectedItems: [],
                dashboardChartInstance: null,
                dashboardChartData: {},
                dashboardSearchText: '',
                dashboardSearchResults: [],
                
                showSeasonalityModal: false,
                seasonalFactorInput: 1.2,

                showLiquidationModal: false,
                liqParams: { discount: 20, elasticity: 1.5 },

                currentTab: 'consolidado', currentPage: 1, pageSize: 50, search: '', sortCol: 'qEnviar', sortAsc: false,

                filterLotesRanges: [], selectedEnvioFechas: [], activeFilters: {}, filterMenuOpen: null,
                editingCell: null, columnMaxValues: {}, copyFeedback: false, historyData: [], debtHistory: [],

                availableOtherDeps: ['80', '82', '86', '87', '89'],
                selectedOtherDeps: ['80', '82', '86', '87', '89'],

                chatOpen: false, chatInput: '', isTyping: false,
                chatMessages: [{type: 'bot', text: '¬°Hola! Soy tu asistente de inventario. Preg√∫ntame por un SKU, Marca o usa los botones r√°pidos.'}],

                lookups: { mapML: {}, mapCargos: {}, mapEnvios: {}, mapCanasta: {}, mapMLA: {}, mapSTA19: {} },

                // üìä SIMPLEX - Ventas por mes (2025 y 2026)
                simplexData2025: [],
                simplexData2026: [],
                simplexData: [], // Datos activos seg√∫n selecci√≥n de a√±o
                simplexFilteredData: [],
                simplexSearchType: 'sku', // 'sku' | 'marca' | 'proveedor'
                simplexSearchText: '',
                simplexViewMode: 'horizontal', // 'horizontal' | 'vertical'
                simplexYears: { y2025: true, y2026: false }, // A√±os seleccionados
                simplexMetric: 'ambos', // 'unidades' | 'importe' | 'ambos'
                simplexMeses2025: ['ene-25','feb-25','mar-25','abr-25','may-25','jun-25','jul-25','ago-25','sept-25','oct-25','nov-25','dic-25'],
                simplexMeses2026: ['ene-26','feb-26','mar-26','abr-26','may-26','jun-26','jul-26','ago-26','sept-26','oct-26','nov-26','dic-26'],
                simplexMeses: ['ene-25','feb-25','mar-25','abr-25','may-25','jun-25','jul-25','ago-25','sept-25','oct-25','nov-25','dic-25'], // Activos
                simplexChartInstance: null,

                kpis: { compra:0, envios:0, valorEnvios:0, lotesVencidos:0, skusCompra:0, cantImpulsar:0, enCamino: 0, inmovilizado: 0 },
                
                matrixCounts: {},
                
                metrics: {
                    analistas: [], analistasTable: [],
                    proveedores: [], proveedoresInmo: [], vto: {},
                    health: { q:0, pq:0, s:0, a:0, o:0 }, deviationStats: {}, totalDeudaAnalistas: 0,
                    matrix: { A: {q:0, pq:0, s:0, a:0, o:0}, B: {q:0, pq:0, s:0, a:0, o:0}, C: {q:0, pq:0, s:0, a:0, o:0} },
                    topRisks: [], brands: [], huesos: []
                },

                tabs: [
                    { id: 'detalle', label: 'üìã Grafana' },
                    { id: 'consolidado', label: 'üåç Consolidado' },
                    { id: 'matriz_det', label: 'üö¶ Detalle Matriz' },
                    { id: 'dep80', label: 'üì¶ Env√≠os Full' },
                    { id: 'otros_depositos', label: 'üè≠ Otros Dep√≥sitos' },
                    { id: 'enviados', label: 'üöö Hist. Env√≠os' },
                    { id: 'resumen', label: 'üõí Compras' },
                    { id: 'proveedores', label: 'üè≠ Proveedores' },
                    { id: 'inmovilizado', label: 'üì¶ SOBRESTOCK' },
                    { id: 'cargos', label: '‚ö†Ô∏è Cargos ML' },
                    { id: 'vencimientos', label: 'üìÖ Vencimientos' },
                    { id: 'combos', label: 'üéÅ COMBOS' },
                    { id: 'dashboard', label: '‚ö° Dashboard KPI' },
                    { id: 'metricas', label: 'üìä M√©tricas' },
                    { id: 'simplex', label: 'üìä SIMPLEX' }
                ],
                chartInstances: {},

                // üìä GENERAR REPORTE COMPLETO DE CARGOS ML
                generateCargosReport() {
                    if (!this.rawData.cargos || this.rawData.cargos.length <= 1) {
                        alert('‚ùå No hay datos de cargos cargados. Por favor, importa un archivo Excel con la hoja "Cargos".');
                        return;
                    }

                    if (!this.rawData.grafana || this.rawData.grafana.length <= 1) {
                        alert('‚ùå No hay datos de Grafana cargados. Necesario para obtener Analista, Marca y Proveedor.');
                        return;
                    }

                    try {
                        // ===== CREAR LOOKUP DESDE GRAFANA (SKU -> {analista, marca, prov, desc}) =====
                        const headersGrafana = this.rawData.grafana[0];
                        const iSkuGrafana = this.findColumnIndex(headersGrafana, ['SKU']);
                        const iAnalistaGrafana = this.findColumnIndex(headersGrafana, ['Analista', 'ANALISTA']);
                        const iMarcaGrafana = this.findColumnIndex(headersGrafana, ['Marca', 'MARCA']);
                        const iProvGrafana = this.findColumnIndex(headersGrafana, ['Prov', 'PROV', 'Proveedor', 'PROVEEDOR']);
                        const iDescGrafana = this.findColumnIndex(headersGrafana, ['Descripcion', 'DESCRIPCION', 'Desc', 'DESC']);

                        const mapSkuGrafana = {};
                        this.rawData.grafana.slice(1).forEach(row => {
                            const sku = this.cleanString(row[iSkuGrafana]);
                            if (sku && sku !== 'TOTAL') {
                                mapSkuGrafana[sku] = {
                                    analista: row[iAnalistaGrafana] || 'Sin Analista',
                                    marca: row[iMarcaGrafana] || 'S/D',
                                    prov: row[iProvGrafana] || 'S/D',
                                    desc: row[iDescGrafana] || ''
                                };
                            }
                        });

                        // ===== PROCESAR DATOS DE CARGOS =====
                        const headersCargos = this.rawData.cargos[0];
                        const iSku = this.findColumnIndex(headersCargos, ['SKU']);
                        const iDesc = this.findColumnIndex(headersCargos, ['Descripcion', 'DESCRIPCION']);
                        const iUnidades = this.findColumnIndex(headersCargos, ['UNIDADES CON CARGO', 'Unidades']);
                        const iCargoPorUni = this.findColumnIndex(headersCargos, ['Cargo por unidad', 'CARGO POR UNIDAD']);
                        const iFecha = this.findColumnIndex(headersCargos, ['Fecha de Cargos', 'FECHA DE CARGOS', 'FECHA']);

                        // Estructuras de datos
                        const cargosPorAnalista = {}; // { analista: {skus: Set, unidades: 0, importe: 0} }
                        const cargosPorAnalistaFecha = {}; // { analista: { fecha: importe } } - para evoluci√≥n
                        const cargosDetallados = [];
                        const fechasSet = new Set();
                        let ultimaFecha = null;
                        let ultimaFechaSerial = 0;

                        this.rawData.cargos.slice(1).forEach(row => {
                            const sku = this.cleanString(row[iSku]);
                            if (!sku || sku === 'TOTAL') return;

                            const fechaSerial = row[iFecha];
                            const fechaStr = typeof fechaSerial === 'number' ? this.excelDateToJSDate(fechaSerial) : (fechaSerial || 'Sin Fecha');
                            const unidades = this.parseNumber(row[iUnidades]);
                            const cargoPorUni = this.parseNumber(row[iCargoPorUni]);
                            const importe = unidades * cargoPorUni;

                            // Rastrear √∫ltima fecha
                            if (typeof fechaSerial === 'number' && fechaSerial > ultimaFechaSerial) {
                                ultimaFechaSerial = fechaSerial;
                                ultimaFecha = fechaStr;
                            }

                            fechasSet.add(fechaStr);

                            // Obtener datos de Grafana
                            const datosGrafana = mapSkuGrafana[sku] || { analista: 'Sin Analista', marca: 'S/D', prov: 'S/D', desc: '' };
                            const analista = datosGrafana.analista;
                            const marca = datosGrafana.marca;
                            const prov = datosGrafana.prov;
                            const desc = row[iDesc] || datosGrafana.desc || '';

                            // Agrupar por analista para resumen
                            if (!cargosPorAnalista[analista]) {
                                cargosPorAnalista[analista] = { skus: new Set(), unidades: 0, importe: 0 };
                            }
                            cargosPorAnalista[analista].skus.add(sku);
                            cargosPorAnalista[analista].unidades += unidades;
                            cargosPorAnalista[analista].importe += importe;

                            // Agrupar por analista Y fecha para evoluci√≥n
                            if (!cargosPorAnalistaFecha[analista]) {
                                cargosPorAnalistaFecha[analista] = {};
                            }
                            if (!cargosPorAnalistaFecha[analista][fechaStr]) {
                                cargosPorAnalistaFecha[analista][fechaStr] = 0;
                            }
                            cargosPorAnalistaFecha[analista][fechaStr] += importe;

                            // Detalle para segunda hoja
                            cargosDetallados.push({
                                fecha: fechaStr,
                                analista,
                                sku,
                                descripcion: desc,
                                marca,
                                prov,
                                unidades,
                                importe
                            });
                        });

                        // Ordenar fechas cronol√≥gicamente
                        const fechasOrdenadas = Array.from(fechasSet).sort((a, b) => {
                            const parseDate = (str) => {
                                const parts = str.split('/');
                                if (parts.length === 3) {
                                    return new Date(parts[2], parts[1] - 1, parts[0]);
                                }
                                return new Date(str);
                            };
                            return parseDate(a) - parseDate(b);
                        });

                        const primeraFecha = fechasOrdenadas[0];
                        const analistas = Object.keys(cargosPorAnalista).sort();
                        
                        // Calcular totales globales
                        let totalSkus = 0, totalUnidadesGlobal = 0, totalImporteGlobal = 0;
                        analistas.forEach(a => {
                            totalSkus += cargosPorAnalista[a].skus.size;
                            totalUnidadesGlobal += cargosPorAnalista[a].unidades;
                            totalImporteGlobal += cargosPorAnalista[a].importe;
                        });

                        // Funci√≥n para crear barra visual ASCII
                        const createBar = (pct, maxLen = 20) => {
                            const filled = Math.round((pct / 100) * maxLen);
                            return '‚ñà'.repeat(filled) + '‚ñë'.repeat(maxLen - filled);
                        };

                        const wb = XLSX.utils.book_new();

                        // ========== HOJA 1: INFORME EJECUTIVO COMPLETO ==========
                        const ws1Data = [];

                        // T√≠tulo
                        ws1Data.push(['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê']);
                        ws1Data.push(['                    INFORME EJECUTIVO DE CARGOS ML']);
                        ws1Data.push(['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê']);
                        ws1Data.push(['Generado:', new Date().toLocaleString('es-AR')]);
                        ws1Data.push(['Per√≠odo analizado:', `${primeraFecha} al ${ultimaFecha}`]);
                        ws1Data.push(['Total Cargos Acumulados:', `$ ${totalImporteGlobal.toLocaleString('es-AR')}`]);
                        ws1Data.push([]);

                        // ‚îÄ‚îÄ‚îÄ TABLA 1: RANKING DE ANALISTAS (Mayor a menor) ‚îÄ‚îÄ‚îÄ
                        ws1Data.push(['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ']);
                        ws1Data.push(['üìä RANKING DE ANALISTAS POR CARGOS TOTALES']);
                        ws1Data.push(['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ']);
                        ws1Data.push(['#', 'Analista', 'SKUs', 'Unidades', 'Cargos Total ($)', '% Participaci√≥n', 'Gr√°fico']);

                        const ranking = analistas.map(a => ({
                            analista: a,
                            skus: cargosPorAnalista[a].skus.size,
                            unidades: cargosPorAnalista[a].unidades,
                            importe: cargosPorAnalista[a].importe,
                            pct: (cargosPorAnalista[a].importe / totalImporteGlobal) * 100
                        })).sort((a, b) => b.importe - a.importe);

                        ranking.forEach((r, idx) => {
                            ws1Data.push([
                                idx + 1,
                                r.analista,
                                r.skus,
                                r.unidades,
                                r.importe,
                                `${r.pct.toFixed(1)}%`,
                                createBar(r.pct)
                            ]);
                        });
                        ws1Data.push(['', 'TOTAL', totalSkus, totalUnidadesGlobal, totalImporteGlobal, '100%', createBar(100)]);
                        ws1Data.push([]);
                        ws1Data.push([]);

                        // ‚îÄ‚îÄ‚îÄ TABLA 2: EVOLUCI√ìN POR FECHA (Importes) ‚îÄ‚îÄ‚îÄ
                        ws1Data.push(['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ']);
                        ws1Data.push(['üìà EVOLUCI√ìN DE CARGOS POR FECHA (Importes $)']);
                        ws1Data.push(['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ']);
                        
                        const headerEvol = ['Analista', ...fechasOrdenadas, 'TOTAL'];
                        ws1Data.push(headerEvol);

                        const totalesPorFecha = {};
                        fechasOrdenadas.forEach(f => totalesPorFecha[f] = 0);

                        ranking.forEach(r => {
                            const row = [r.analista];
                            let totalAnalista = 0;
                            fechasOrdenadas.forEach(fecha => {
                                const val = cargosPorAnalistaFecha[r.analista][fecha] || 0;
                                row.push(val);
                                totalesPorFecha[fecha] += val;
                                totalAnalista += val;
                            });
                            row.push(totalAnalista);
                            ws1Data.push(row);
                        });

                        const rowTotalFechas = ['TOTAL'];
                        let grandTotal = 0;
                        fechasOrdenadas.forEach(f => {
                            rowTotalFechas.push(totalesPorFecha[f]);
                            grandTotal += totalesPorFecha[f];
                        });
                        rowTotalFechas.push(grandTotal);
                        ws1Data.push(rowTotalFechas);
                        ws1Data.push([]);
                        ws1Data.push([]);

                        // ‚îÄ‚îÄ‚îÄ TABLA 3: PARTICIPACI√ìN % POR FECHA ‚îÄ‚îÄ‚îÄ
                        ws1Data.push(['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ']);
                        ws1Data.push(['üìä PARTICIPACI√ìN PORCENTUAL POR FECHA']);
                        ws1Data.push(['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ']);
                        
                        const headerPct = ['Analista', ...fechasOrdenadas.map(f => `% ${f}`)];
                        ws1Data.push(headerPct);

                        ranking.forEach(r => {
                            const row = [r.analista];
                            fechasOrdenadas.forEach(fecha => {
                                const val = cargosPorAnalistaFecha[r.analista][fecha] || 0;
                                const totalFecha = totalesPorFecha[fecha] || 1;
                                const pct = (val / totalFecha) * 100;
                                row.push(`${pct.toFixed(1)}%`);
                            });
                            ws1Data.push(row);
                        });
                        ws1Data.push([]);
                        ws1Data.push([]);

                        // ‚îÄ‚îÄ‚îÄ TABLA 4: VARIACI√ìN ENTRE FECHAS ‚îÄ‚îÄ‚îÄ
                        if (fechasOrdenadas.length >= 2) {
                            ws1Data.push(['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ']);
                            ws1Data.push(['üìâ VARIACI√ìN ENTRE PRIMERA Y √öLTIMA FECHA']);
                            ws1Data.push(['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ']);
                            ws1Data.push(['Analista', `${primeraFecha}`, `${ultimaFecha}`, 'Variaci√≥n ($)', 'Variaci√≥n (%)', 'Tendencia']);

                            ranking.forEach(r => {
                                const valPrimera = cargosPorAnalistaFecha[r.analista][primeraFecha] || 0;
                                const valUltima = cargosPorAnalistaFecha[r.analista][ultimaFecha] || 0;
                                const variacionAbs = valUltima - valPrimera;
                                const variacionPct = valPrimera > 0 ? ((valUltima - valPrimera) / valPrimera) * 100 : (valUltima > 0 ? 100 : 0);
                                const tendencia = variacionAbs > 0 ? 'üìà SUBI√ì' : (variacionAbs < 0 ? 'üìâ BAJ√ì' : '‚û°Ô∏è IGUAL');
                                
                                ws1Data.push([
                                    r.analista,
                                    valPrimera,
                                    valUltima,
                                    variacionAbs,
                                    `${variacionPct.toFixed(1)}%`,
                                    tendencia
                                ]);
                            });
                            ws1Data.push([]);
                            ws1Data.push([]);
                        }

                        // ‚îÄ‚îÄ‚îÄ TABLA 5: RESUMEN ESTAD√çSTICO ‚îÄ‚îÄ‚îÄ
                        ws1Data.push(['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ']);
                        ws1Data.push(['üìã RESUMEN ESTAD√çSTICO']);
                        ws1Data.push(['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ']);
                        
                        const maxAnalista = ranking[0];
                        const minAnalista = ranking[ranking.length - 1];
                        const promedio = totalImporteGlobal / analistas.length;

                        ws1Data.push(['M√©trica', 'Valor']);
                        ws1Data.push(['Total Analistas', analistas.length]);
                        ws1Data.push(['Total SKUs con Cargos', totalSkus]);
                        ws1Data.push(['Total Unidades Afectadas', totalUnidadesGlobal]);
                        ws1Data.push(['Importe Total Cargos', `$ ${totalImporteGlobal.toLocaleString('es-AR')}`]);
                        ws1Data.push(['Promedio por Analista', `$ ${Math.round(promedio).toLocaleString('es-AR')}`]);
                        ws1Data.push(['Mayor Responsable', `${maxAnalista.analista} (${maxAnalista.pct.toFixed(1)}%)`]);
                        ws1Data.push(['Menor Responsable', `${minAnalista.analista} (${minAnalista.pct.toFixed(1)}%)`]);
                        ws1Data.push(['Fechas Analizadas', fechasOrdenadas.length]);

                        const ws1 = XLSX.utils.aoa_to_sheet(ws1Data);
                        
                        // Anchos de columna
                        const maxCols = Math.max(7, fechasOrdenadas.length + 2);
                        const colWidths1 = [{ wch: 20 }];
                        for (let i = 1; i < maxCols; i++) colWidths1.push({ wch: 16 });
                        colWidths1.push({ wch: 22 }); // Gr√°fico
                        ws1['!cols'] = colWidths1;

                        XLSX.utils.book_append_sheet(wb, ws1, 'Informe de Cargos');

                        // ========== HOJA 2: DETALLE POR ANALISTA (√öLTIMA FECHA) ==========
                        const detalleUltimaFecha = cargosDetallados.filter(c => c.fecha === ultimaFecha);
                        detalleUltimaFecha.sort((a, b) => {
                            if (a.analista !== b.analista) return a.analista.localeCompare(b.analista);
                            return b.importe - a.importe;
                        });

                        const ws2Data = [];
                        ws2Data.push(['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê']);
                        ws2Data.push([`DETALLE DE CARGOS - FECHA: ${ultimaFecha || 'N/A'}`]);
                        ws2Data.push(['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê']);
                        ws2Data.push([]);
                        ws2Data.push(['FECHA', 'ANALISTA', 'SKU', 'DESCRIPCION', 'MARCA', 'PROVEEDOR', 'CANTIDAD', 'IMPORTE ($)']);

                        let currentAnalista = '';
                        let subtotalUnidades = 0;
                        let subtotalImporte = 0;

                        detalleUltimaFecha.forEach((item, idx) => {
                            if (currentAnalista && currentAnalista !== item.analista) {
                                ws2Data.push(['', `‚ñ∫ SUBTOTAL ${currentAnalista}`, '', '', '', '', subtotalUnidades, subtotalImporte]);
                                ws2Data.push([]);
                                subtotalUnidades = 0;
                                subtotalImporte = 0;
                            }
                            currentAnalista = item.analista;
                            subtotalUnidades += item.unidades;
                            subtotalImporte += item.importe;

                            ws2Data.push([
                                item.fecha,
                                item.analista,
                                item.sku,
                                item.descripcion,
                                item.marca,
                                item.prov,
                                item.unidades,
                                item.importe
                            ]);
                        });

                        if (currentAnalista) {
                            ws2Data.push(['', `‚ñ∫ SUBTOTAL ${currentAnalista}`, '', '', '', '', subtotalUnidades, subtotalImporte]);
                        }

                        const totalUnidadesDetalle = detalleUltimaFecha.reduce((a, b) => a + b.unidades, 0);
                        const totalImportesDetalle = detalleUltimaFecha.reduce((a, b) => a + b.importe, 0);
                        ws2Data.push([]);
                        ws2Data.push(['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê']);
                        ws2Data.push(['', '‚òÖ TOTAL GENERAL', '', '', '', '', totalUnidadesDetalle, totalImportesDetalle]);

                        const ws2 = XLSX.utils.aoa_to_sheet(ws2Data);
                        ws2['!cols'] = [
                            { wch: 12 }, { wch: 22 }, { wch: 14 }, { wch: 35 },
                            { wch: 18 }, { wch: 18 }, { wch: 12 }, { wch: 15 }
                        ];

                        XLSX.utils.book_append_sheet(wb, ws2, 'Detalle por Analista');

                        // Descargar archivo
                        const fechaHoy = new Date().toISOString().split('T')[0];
                        XLSX.writeFile(wb, `Reporte_Cargos_ML_${fechaHoy}.xlsx`);

                        console.log('[REPORTE CARGOS] ‚úÖ Excel generado exitosamente');
                        alert('‚úÖ Reporte de Cargos ML generado!\n\nüìä Incluye:\n‚Ä¢ Ranking con gr√°fico visual\n‚Ä¢ Evoluci√≥n por Fecha\n‚Ä¢ Participaci√≥n %\n‚Ä¢ Variaci√≥n entre fechas\n‚Ä¢ Estad√≠sticas\n‚Ä¢ Detalle con subtotales');

                    } catch (error) {
                        console.error('[REPORTE CARGOS] ‚ùå Error:', error);
                        alert(`‚ùå Error al generar reporte: ${error.message}`);
                    }
                },

                async initApp() {
                    // üîê Verificar si ya est√° autenticado (sesi√≥n guardada)
                    const savedAuth = sessionStorage.getItem('inventoryAuth');
                    if(savedAuth === 'true') {
                        this.isAuthenticated = true;
                    }
                    
                    // üé® Cargar tema guardado (por defecto: oscuro)
                    const savedTheme = localStorage.getItem('inventoryAppTheme');
                    if (savedTheme === 'light') {
                        this.darkMode = false;
                        document.body.classList.remove('dark-theme');
                    } else {
                        // Por defecto tema oscuro
                        this.darkMode = true;
                        document.body.classList.add('dark-theme');
                        if (!savedTheme) localStorage.setItem('inventoryAppTheme', 'dark');
                    }
                    
                    this.isLoading = true; this.loadingMsg = 'RECUPERANDO SESI√ìN...';
                    try {
                        const main = await DB.load('grafana');
                        if(main && main.length) {
                            const meta = await DB.load('meta');
                            this.fileName = meta?.fileName; this.lastUpdate = meta?.date;
                            for(let k of ['grafana','pbi','sml','pml','cargos','enviados','vto','canasta','mla','sta19','simplex']) this.rawData[k] = await DB.load(k);
                            this.strategyOverrides = await DB.load('strategyOverrides') || {};
                            this.historyData = await DB.getHistory();
                            this.debtHistory = await DB.getDebtHistory();

                            this.loadingMsg = 'PROCESANDO DATOS...';
                            this.processAll();
                        } else { this.isLoading = false; }
                    } catch(e) { console.error(e); this.isLoading = false; }
                },

                // üîê Manejar Login
                handleLogin() {
                    const validUser = 'Lpared';
                    const validPass = '1979';
                    
                    if(this.loginUser === validUser && this.loginPass === validPass) {
                        this.isAuthenticated = true;
                        this.loginError = '';
                        sessionStorage.setItem('inventoryAuth', 'true');
                        console.log('[AUTH] ‚úÖ Login exitoso');
                    } else {
                        this.loginError = 'Usuario o contrase√±a incorrectos';
                        console.log('[AUTH] ‚ùå Login fallido');
                    }
                },

                // üîê Cerrar sesi√≥n
                handleLogout() {
                    this.isAuthenticated = false;
                    sessionStorage.removeItem('inventoryAuth');
                    this.loginUser = '';
                    this.loginPass = '';
                    console.log('[AUTH] Sesi√≥n cerrada');
                },

                toggleTheme() {
                    this.darkMode = !this.darkMode;
                    if (this.darkMode) {
                        document.body.classList.add('dark-theme');
                        localStorage.setItem('inventoryAppTheme', 'dark');
                    } else {
                        document.body.classList.remove('dark-theme');
                        localStorage.setItem('inventoryAppTheme', 'light');
                    }
                },

                // üì• Cargar Excel directamente desde carpeta local
                async loadLocalExcel() {
                    // Prioridad: .xlsb primero (m√°s actualizado), luego .xlsx
                    const fileNames = ['ENVIOS LUCIANO.xlsb', 'ENVIOS LUCIANO.xlsx'];
                    this.isLoading = true;
                    this.loadingMsg = 'BUSCANDO ARCHIVO LOCAL...';
                    
                    let response = null;
                    let fileName = null;
                    
                    // Intentar cargar .xlsb primero, luego .xlsx
                    for (const name of fileNames) {
                        try {
                            console.log(`[DEBUG] Intentando cargar: ${name}`);
                            const resp = await fetch(name);
                            console.log(`[DEBUG] Respuesta para ${name}: status=${resp.status}, ok=${resp.ok}`);
                            if (resp.ok) {
                                response = resp;
                                fileName = name;
                                console.log(`[INFO] ‚úÖ Archivo encontrado: ${name}`);
                                break;
                            }
                        } catch (e) {
                            console.log(`[INFO] Archivo ${name} no encontrado, probando siguiente...`, e.message);
                        }
                    }
                    
                    try {
                        if (!response || !response.ok) {
                            throw new Error(`No se encontr√≥ ning√∫n archivo "ENVIOS LUCIANO" (.xlsb o .xlsx) en la carpeta del proyecto.`);
                        }
                        
                        this.loadingMsg = 'LEYENDO EXCEL...';
                        const arrayBuffer = await response.arrayBuffer();
                        
                        console.log('[INFO] Cargando archivo local:', fileName);
                        const wb = XLSX.read(arrayBuffer, { type: 'array' });
                        console.log('[INFO] Hojas encontradas:', wb.SheetNames.join(', '));
                        
                        const getSheet = (keys) => { 
                            const name = wb.SheetNames.find(n => keys.some(k => n.toLowerCase().includes(k.toLowerCase()))); 
                            console.log('[DEBUG] Buscando hoja con keys:', keys, '‚Üí Encontrada:', name || 'NO ENCONTRADA');
                            if (!name) return [];
                            return XLSX.utils.sheet_to_json(wb.Sheets[name], { header: 1 });
                        };
                        
                        this.rawData.grafana = getSheet(['grafana', 'main']);
                        this.rawData.pbi = getSheet(['pbi', 'powerbi']);
                        this.rawData.sml = getSheet(['stock ml', 'stock_ml']);
                        this.rawData.pml = getSheet(['plan ml', 'plan_ml']);
                        this.rawData.cargos = getSheet(['cargos', 'deuda']);
                        this.rawData.enviados = getSheet(['enviados', 'envios']);
                        this.rawData.vto = getSheet(['vencimiento', 'vto']);
                        this.rawData.canasta = getSheet(['canasta']);
                        this.rawData.mla = getSheet(['mla']);
                        this.rawData.sta19 = getSheet(['sta19', 'sta 19']);
                        this.rawData.simplex = getSheet(['simplex2025', 'simplex']);
                        this.rawData.simplex2026 = getSheet(['simplex2026']);
                        
                        if(this.rawData.grafana.length === 0) {
                            throw new Error("‚ùå No se encontr√≥ la hoja 'Grafana' o est√° vac√≠a.");
                        }
                        
                        this.fileName = fileName;
                        
                        // Procesar directamente (sin guardar en IndexedDB para evitar error de clonaci√≥n)
                        this.loadingMsg = 'PROCESANDO DATOS...';
                        this.processAll();
                        
                        // Guardar despu√©s del procesamiento en segundo plano
                        setTimeout(async () => {
                            try {
                                for(let k of ['grafana','pbi','sml','pml','cargos','enviados','vto','canasta','mla','sta19','simplex','simplex2026']) {
                                    if(this.rawData[k] && this.rawData[k].length > 0) {
                                        // Clonar manualmente para evitar problemas
                                        const cleanData = this.rawData[k].map(row => 
                                            Array.isArray(row) ? row.map(cell => cell === undefined ? null : cell) : row
                                        );
                                        await DB.save(k, cleanData);
                                    }
                                }
                                console.log('[INFO] Datos guardados en IndexedDB');
                            } catch(e) {
                                console.warn('[WARN] No se pudo guardar en IndexedDB:', e.message);
                            }
                        }, 1000);
                        
                    } catch (error) {
                        console.error('[ERROR] Carga local:', error);
                        alert(`‚ùå Error al cargar archivo local:\n\n${error.message}\n\nüìÅ Aseg√∫rate de que el archivo "ENVIOS LUCIANO.xlsx" est√© en la misma carpeta que index.html`);
                        this.isLoading = false;
                    }
                },

                handleFile(e) {
                    const file = e.target.files[0]; 
                    if (!file) return;
                    
                    // Validaci√≥n de archivo (soporta .xlsx, .xls y .xlsb)
                    if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls') && !file.name.endsWith('.xlsb')) {
                        alert('‚ùå Por favor sube un archivo Excel (.xlsx, .xls o .xlsb)');
                        return;
                    }
                    
                    console.log('[INFO] Cargando archivo:', file.name, '(' + (file.size / 1024).toFixed(2) + ' KB)');
                    this.isLoading = true; this.loadingMsg = 'LEYENDO EXCEL...';
                    this.fileName = file.name;
                    const reader = new FileReader();
                    reader.onload = async (evt) => {
                        try {
                            const wb = XLSX.read(evt.target.result, { type: 'array' });
                            console.log('[INFO] Hojas encontradas:', wb.SheetNames.join(', '));
                            const getSheet = (keys) => { const name = wb.SheetNames.find(n => keys.some(k => n.toLowerCase().includes(k.toLowerCase()))); return name ? XLSX.utils.sheet_to_json(wb.Sheets[name], { header: 1 }) : []; };
                            this.rawData.grafana = getSheet(['grafana', 'main']);
                            this.rawData.pbi = getSheet(['pbi', 'powerbi']);
                            this.rawData.sml = getSheet(['stock ml', 'stock_ml']);
                            this.rawData.pml = getSheet(['plan ml', 'plan_ml']);
                            this.rawData.cargos = getSheet(['cargos', 'deuda']);
                            this.rawData.enviados = getSheet(['enviados', 'envios']);
                            this.rawData.vto = getSheet(['vencimiento', 'vto']);
                            this.rawData.canasta = getSheet(['canasta']);
                            this.rawData.mla = getSheet(['mla']);
                            this.rawData.sta19 = getSheet(['sta19', 'sta 19']);
                            this.rawData.simplex = getSheet(['simplex2025', 'simplex']);
                            this.rawData.simplex2026 = getSheet(['simplex2026']);

                            if(this.rawData.grafana.length === 0) {
                                throw new Error("‚ùå No se encontr√≥ la hoja 'Grafana' o est√° vac√≠a.\n\nVerifica que tu Excel tenga una hoja con ese nombre.");
                            }
                            
                            // Validar columnas m√≠nimas requeridas
                            const hG = this.rawData.grafana[0];
                            const requiredCols = ['SKU', 'VTAR', 'Stock'];
                            const missingCols = requiredCols.filter(col => 
                                !hG.some(h => String(h).toUpperCase().includes(col.toUpperCase()))
                            );
                            if (missingCols.length > 0) {
                                throw new Error(`‚ùå Faltan columnas requeridas en Grafana: ${missingCols.join(', ')}`);
                            }

                            const now = new Date().toLocaleString();
                            this.lastUpdate = now;
                            DB.save('meta', {fileName: file.name, date: now});
                            Object.keys(this.rawData).forEach(k => DB.save(k, this.rawData[k]));

                            this.loadingMsg = 'GUARDANDO HISTORIAL...';
                            const snapshot = this.generateSnapshot();
                            await DB.saveSnapshot(snapshot);
                            this.historyData = await DB.getHistory();
                            this.debtHistory = await DB.getDebtHistory();

                            this.loadingMsg = 'CALCULANDO M√âTRICAS...';
                            this.processAll();
                        } catch (err) { console.error(err); alert(err.message); this.isLoading = false; }
                    };
                    reader.readAsArrayBuffer(file);
                },

                generateSnapshot() {
                    try {
                        const hG = this.rawData.grafana[0];
                        const iSku = hG.findIndex(c => String(c).toUpperCase().includes('SKU'));
                        const iVtar = hG.findIndex(c => String(c).toUpperCase().includes('VTAR'));
                        const snap = {};
                        this.rawData.grafana.slice(1).forEach(r => {
                            const s = String(r[iSku]||'').trim().toUpperCase();
                            if(s && s !== 'TOTAL') {
                                const v = parseFloat(r[iVtar]) || 0;
                                if(!snap[s]) snap[s] = {v:0};
                                snap[s].v += v;
                            }
                        });
                        return snap;
                    } catch(e) { return {}; }
                },

                recalculateGlobal() { if(this.dataReady) this.processAll(); },
                switchTab(id) {
                    this.currentTab = id; this.currentPage = 1; this.search = '';
                    this.activeFilters = {};
                    this.selectedIds = [];
                    this.filterOpportunityCost = false;
                    this.filterAging = null;
                    this.filterArbitrage = false;
                    this.kpiFilter = null; // Limpiar filtro KPI
                    
                    // ‚ö° Limpiar cache de memoizaci√≥n al cambiar tab
                    MemoCache.clear();
                    
                    if(id === 'metricas') setTimeout(()=>this.renderCharts(), 100);
                    else this.calculateColumnMaxes();
                },

                // üîó Navegaci√≥n desde KPI Dashboard
                goToCriticos() {
                    this.currentTab = 'consolidado';
                    this.currentPage = 1;
                    this.search = '';
                    this.activeFilters = {};
                    this.selectedIds = [];
                    this.filterOpportunityCost = false;
                    this.filterAging = null;
                    this.filterArbitrage = false;
                    this.kpiFilter = 'criticos'; // Filtro especial para cr√≠ticos
                    MemoCache.clear();
                    this.calculateColumnMaxes();
                },

                goToStockViejo() {
                    this.currentTab = 'inmovilizado';
                    this.currentPage = 1;
                    this.search = '';
                    this.activeFilters = {};
                    this.selectedIds = [];
                    this.filterOpportunityCost = false;
                    this.filterAging = null;
                    this.filterArbitrage = false;
                    this.kpiFilter = null;
                    MemoCache.clear();
                    this.calculateColumnMaxes();
                },

                // üéØ Filtrar por celda de Matriz ABC vs Salud
                filterMatrixCell(abc, salud) {
                    this.currentTab = 'matriz_det';
                    this.currentPage = 1;
                    this.search = '';
                    this.activeFilters = { 'abc': [abc], 'estadoSalud': [salud] };
                    this.selectedIds = [];
                    this.kpiFilter = null;
                    MemoCache.clear();
                    this.calculateColumnMaxes();
                },

                // üéØ Filtrar solo por ABC (click en la letra)
                filterMatrixByAbc(abc) {
                    this.currentTab = 'matriz_det';
                    this.currentPage = 1;
                    this.search = '';
                    this.activeFilters = { 'abc': [abc] };
                    this.selectedIds = [];
                    this.kpiFilter = null;
                    MemoCache.clear();
                    this.calculateColumnMaxes();
                },

                // üéØ Filtrar stock viejo por d√≠as seleccionados
                applyStockViejoFilter() {
                    if(this.stockViejoFilters.length === 0) {
                        this.goToStockViejo();
                        return;
                    }
                    this.currentTab = 'inmovilizado';
                    this.currentPage = 1;
                    this.search = '';
                    this.activeFilters = {};
                    this.selectedIds = [];
                    this.kpiFilter = null;
                    // El filtro se aplica en el getter de filteredData
                    MemoCache.clear();
                    this.calculateColumnMaxes();
                },

                // üéØ Filtrar stock sin venta por rangos de d√≠as
                applyStockSinVentaFilter() {
                    if(this.stockSinVentaFilters.length === 0) return;
                    this.currentTab = 'consolidado';
                    this.currentPage = 1;
                    this.search = '';
                    this.activeFilters = {};
                    this.selectedIds = [];
                    this.kpiFilter = 'stockSinVenta'; // Filtro especial
                    MemoCache.clear();
                    this.calculateColumnMaxes();
                },

                toggleSelectAll(e) {
                    if (e.target.checked) {
                        this.selectedIds = this.filteredData.map(r => r.id);
                    } else {
                        this.selectedIds = [];
                    }
                },

                applyBulkEdit(field, value) {
                    if (this.selectedIds.length === 0) return;
                    
                    if (value === undefined && field === 'diasEstrategia') {
                        value = prompt("Ingrese d√≠as de estrategia para " + this.selectedIds.length + " items:", "45");
                        if (value === null) return;
                        value = parseFloat(value);
                    }

                    this.masterData.forEach(item => {
                        if (this.selectedIds.includes(item.id)) {
                            item[field] = value;
                            if (field === 'diasEstrategia') {
                                if (!this.strategyOverrides) this.strategyOverrides = {};
                                this.strategyOverrides[item.sku] = value;
                            }
                        }
                    });

                    if (field === 'diasEstrategia') DB.save('strategyOverrides', this.strategyOverrides);

                    const updated = this.masterData.map(item => this.calculateRowLogic(item));
                    this.masterData = updated;
                    this.updateKPIs();
                    this.selectedIds = [];
                },

                calculateLiquidation() {
                    const stockItems = this.filteredData; 
                    let totalRecovery = 0;
                    let totalLoss = 0;
                    const discount = this.liqParams.discount / 100;

                    stockItems.forEach(item => {
                        const val = item.stockValorizado;
                        const recovery = val * (1 - discount);
                        totalRecovery += recovery;
                        totalLoss += (val - recovery);
                    });

                    return { recovery: totalRecovery, loss: totalLoss };
                },

                getSimulatedTotal() {
                    if (!this.masterData.length) return 0;
                    return this.masterData.reduce((acc, item) => {
                        const pbi = item.pbi || {dep1:0, dep80:0};
                        const stockSucTotal = [81,82,83,86,87,89].reduce((a,n)=>a+(pbi[`dep${n}`]||0), 0);
                        const stockRed = pbi.dep1 + stockSucTotal + pbi.dep80 + item.comprasEnCamino;
                        const lt = item.lt || 30;
                        const ss = Math.ceil(2.33 * item.vtarTotal * Math.sqrt(lt));
                        const targetStock = Math.ceil((item.vtarTotal * this.params.simulationDays) + ss);
                        let buy = 0; if(stockRed < targetStock) buy = targetStock - stockRed;
                        if(buy < 0) buy = 0; buy = Math.ceil(buy / item.uxb) * item.uxb;
                        return acc + (buy * item.costo);
                    }, 0);
                },

                getSimulationResults() {
                    const days = this.simParams.days || 30;
                    let totalSimulated = 0;
                    this.masterData.forEach(item => {
                        const pbi = item.pbi || {dep1:0, dep80:0};
                        const stockSuc = [81,82,83,87,89].reduce((a,n)=>a+(pbi[`dep${n}`]||0),0);
                        const stockRed = pbi.dep1 + stockSuc + pbi.dep80 + item.comprasEnCamino;
                        const lt = item.lt || 30;
                        const ss = Math.ceil(2.33 * item.vtarTotal * Math.sqrt(lt));
                        const target = Math.ceil((item.vtarTotal * days) + ss);
                        let buy = Math.max(0, target - stockRed);
                        buy = Math.ceil(buy / item.uxb) * item.uxb;
                        totalSimulated += (buy * item.costo);
                    });
                    return { total: totalSimulated, diff: totalSimulated - this.kpis.compra };
                },

                exportProviderOrder(providerName) {
                    const items = this.masterData.filter(i => i.prov === providerName && i.comprarU > 0);
                    if (items.length === 0) { alert("No hay items para pedir a " + providerName); return; }
                    
                    const data = items.map(i => ({
                        SKU: i.sku,
                        Descripcion: i.desc,
                        Marca: i.marca,
                        Cantidad: i.comprarU,
                        CostoUnitario: i.costo,
                        Total: i.inversion
                    }));
                    
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Orden");
                    XLSX.writeFile(wb, `Orden_Compra_${providerName.replace(/[^a-zA-Z0-9]/g,'_')}.xlsx`);
                },

                filterMatrix(code) {
                    this.switchTab('consolidado');
                    this.activeFilters['abc_xyz'] = [code];
                },

                toggleChat() { this.chatOpen = !this.chatOpen; },
                sendQuickMsg(text) { this.chatInput = text; this.sendMessage(); },

                async sendMessage() {
                    if(!this.chatInput.trim()) return;
                    const txt = this.chatInput.trim();
                    this.chatMessages.push({ type: 'user', text: txt });
                    this.chatInput = '';
                    this.isTyping = true;

                    this.$nextTick(() => { const c = document.getElementById('chat-messages'); c.scrollTop = c.scrollHeight; });

                    setTimeout(() => {
                        const response = this.processChatQuery(txt);
                        this.isTyping = false;
                        this.chatMessages.push(response);
                        this.$nextTick(() => { const c = document.getElementById('chat-messages'); c.scrollTop = c.scrollHeight; });
                    }, 600);
                },

                processChatQuery(q) {
                    q = q.toUpperCase();

                    if(q === 'RESUMEN' || q === 'STATUS') {
                        if(this.currentTab === 'dep80') return { type: 'bot', html: `<div class="font-bold text-purple-700">üì¶ Contexto: Env√≠os Full</div><div>Items a enviar: <b>${this.kpis.envios.toLocaleString()}</b></div><div>Inversi√≥n: <b>${this.formatMoney(this.kpis.valorEnvios)}</b></div>` };
                        if(this.currentTab === 'resumen') return { type: 'bot', html: `<div class="font-bold text-emerald-700">üõí Contexto: Compras</div><div>Total Inversi√≥n: <b>${this.formatMoney(this.kpis.compra)}</b></div><div>SKUs: <b>${this.kpis.skusCompra}</b></div>` };
                        if(this.currentTab === 'metricas') return { type: 'bot', html: `<b>üìä Est√°s en M√©tricas.</b> Revisa la Matriz ABC-XYZ para estrategia.` };
                    }

                    if(q.includes('QUIEBRE') || q.includes('URGENTE')) {
                        const risks = this.metrics.topRisks.slice(0, 3);
                        let html = `<div class="font-bold text-red-600 mb-1">üî• Top Riesgos Inminentes</div>`;
                        if(risks.length===0) html += `<span class="text-slate-500">Todo bajo control.</span>`;
                        else risks.forEach(r => html += `<div class="border-b py-1 last:border-0"><div class="font-bold">${r.sku}</div><div class="flex justify-between text-[10px]"><span>Stock: ${r.stock}</span><span class="text-red-600 font-bold">${r.days.toFixed(1)} d√≠as</span></div></div>`);
                        return { type: 'bot', html };
                    }
                    if(q.includes('VENCIMIENTO') || q.includes('VENCER')) {
                        const vtos = this.lotesData.filter(l=>l.dias<=30).sort((a,b)=>a.dias-b.dias).slice(0,3);
                        let html = `<div class="font-bold text-orange-600 mb-1">üìÖ Vencimientos Pr√≥ximos (30d)</div>`;
                        if(vtos.length===0) html += `<span class="text-slate-500">Sin lotes cr√≠ticos.</span>`;
                        else vtos.forEach(v => html += `<div class="border-b py-1 last:border-0"><div class="font-bold">${v.sku}</div><div class="text-[10px]">Vence: ${v.fechaVto} (${v.stockComprometido} u.)</div></div>`);
                        return { type: 'bot', html };
                    }
                    if(q.includes('DINERO') || q.includes('PLATA') || q.includes('INVERSION')) {
                        return { type: 'bot', html: `
                            <div class="font-bold text-emerald-700 mb-2">üí∞ Resumen Financiero</div>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div class="bg-emerald-50 p-1 rounded">
                                    <div class="text-emerald-500 text-[9px]">Sugerido</div>
                                    <div class="font-bold">${this.formatMoney(this.kpis.compra)}</div>
                                </div>
                                <div class="bg-purple-50 p-1 rounded">
                                    <div class="text-purple-500 text-[9px]">Sobrestock</div>
                                    <div class="font-bold">${this.formatMoney(this.kpis.inmovilizado)}</div>
                                </div>
                            </div>
                        `};
                    }

                    const skuMatch = this.masterData.find(i => i.sku === q || i.desc.toUpperCase().includes(q));
                    if(skuMatch) {
                        const lotes = this.lotesData.filter(l => l.sku === skuMatch.sku).sort((a,b)=>a.dias-b.dias);
                        const nextVto = lotes.length > 0 ? lotes[0].fechaVto + ` (${lotes[0].dias}d)` : 'Sin datos';
                        return { type: 'bot', html: `
                            <div class="border-l-4 border-blue-500 pl-2 mb-2">
                                <div class="font-bold text-sm">${skuMatch.sku}</div>
                                <div class="text-[10px] text-slate-500 truncate">${skuMatch.desc}</div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-[10px] mb-2">
                                <div class="bg-slate-100 p-1 rounded">Stock Total: <b>${skuMatch.stockGrafana}</b></div>
                                <div class="bg-slate-100 p-1 rounded">D√≠as: <b class="${skuMatch.diasStock<15?'text-red-600':'text-green-600'}">${skuMatch.diasStock.toFixed(1)}</b></div>
                                <div class="bg-slate-100 p-1 rounded">Dep 1: <b>${skuMatch.pbi?.dep1||0}</b></div>
                                <div class="bg-slate-100 p-1 rounded">Dep 80: <b>${skuMatch.pbi?.dep80||0}</b></div>
                            </div>
                            <div class="text-[10px] bg-orange-50 text-orange-700 p-1 rounded border border-orange-100">
                                ‚è≥ Prox. Vencimiento: <b>${nextVto}</b>
                            </div>
                        `};
                    }

                    const brandItems = this.masterData.filter(i => (i.marca||'').toUpperCase().includes(q) || (i.prov||'').toUpperCase().includes(q));
                    if(brandItems.length > 0) {
                        const totalStock = brandItems.reduce((a,b)=>a+b.stockGrafana,0);
                        const totalVal = brandItems.reduce((a,b)=>a+b.stockValorizado,0);
                        const quiebres = brandItems.filter(i=>i.diasStock<=10).length;
                        return { type: 'bot', html: `
                            <div class="font-bold text-indigo-700 mb-2">Resumen: ${q}</div>
                            <div class="space-y-1 text-xs">
                                <div class="flex justify-between"><span>SKUs:</span> <b>${brandItems.length}</b></div>
                                <div class="flex justify-between"><span>Capital:</span> <b>${this.formatMoney(totalVal)}</b></div>
                                <div class="flex justify-between"><span>Unidades:</span> <b>${totalStock}</b></div>
                                <div class="flex justify-between text-red-600"><span>En Quiebre:</span> <b>${quiebres}</b></div>
                            </div>
                        `};
                    }

                    return { type: 'bot', text: 'ü§î No encontr√© ese SKU, Marca o comando. Intenta con un c√≥digo exacto o pulsa los botones.' };
                },

                processAll() {
                    setTimeout(() => {
                        const startTime = performance.now();
                        console.log('[INFO] Iniciando procesamiento de datos...');
                        
                        try {
                            // Utilidades optimizadas
                            const clean = (s) => String(s||'').trim().toUpperCase();
                            const num = (v) => { if(typeof v==='number') return v; if(!v) return 0; let s = String(v).replace(/[$\s]/g,''); if(s.includes(',') && s.includes('.')) s = s.replace(/\./g,'').replace(',','.'); else if(s.includes(',')) s = s.replace(',','.'); return parseFloat(s) || 0; };
                            const idx = (row, keys) => row.findIndex(c => keys.some(k => String(c).trim().toUpperCase().includes(k.toUpperCase())));
                            
                            // Validaci√≥n de datos de entrada
                            if (!this.rawData.grafana || this.rawData.grafana.length < 2) {
                                throw new Error('‚ùå La hoja Grafana est√° vac√≠a o no tiene datos');
                            }

                            this.lookups.mapML = {};
                            this.lookups.mapCargos = {};
                            this.lookups.mapEnvios = {};
                            this.lookups.mapCanasta = {};

                            if(this.rawData.sml && this.rawData.sml.length) {
                                const h=this.rawData.sml[0];
                                const iS=idx(h,['SKU']), iI=idx(h,['IMPULSAR']);
                                const iEstado=idx(h,['ESTADO DE PUBLICACION']);
                                const iCalidad=idx(h,['Calidad ok']);

                                this.rawData.sml.slice(1).forEach(r=>{ 
                                    const s=clean(r[iS]); 
                                    if(s) {
                                        this.lookups.mapML[s] = {
                                            impulsar: String(r[iI]).includes('SI'),
                                            estado: r[iEstado],
                                            calidad: r[iCalidad]
                                        };
                                    } 
                                });
                            }

                            if(this.rawData.cargos && this.rawData.cargos.length) {
                                const h=this.rawData.cargos[0];
                                const iS=idx(h,['SKU']), iU=idx(h,['Unidades']), iUCost=idx(h,['Cargo por unidad']), iDate=idx(h,['FECHA']);
                                const iAnt=idx(h,['Antig√ºedad']);

                                let latestDate = 0;
                                if(iDate > -1) {
                                    this.rawData.cargos.slice(1).forEach(r => {
                                        const d = r[iDate];
                                        if(typeof d === 'number' && d > latestDate) latestDate = d;
                                    });
                                }
                                this.rawData.cargos.slice(1).forEach(r=>{
                                    const rowDate = r[iDate];
                                    if(iDate === -1 || rowDate === latestDate) {
                                        const s=clean(r[iS]);
                                        if(s) {
                                            if(!this.lookups.mapCargos[s]) this.lookups.mapCargos[s]={monto:0,unidades:0, antiguedad: ''};
                                            const u=num(r[iU]), uc=num(r[iUCost]);
                                            this.lookups.mapCargos[s].unidades+=u;
                                            this.lookups.mapCargos[s].monto+=(u*uc);
                                            if(r[iAnt]) this.lookups.mapCargos[s].antiguedad = r[iAnt]; 
                                        }
                                    }
                                });
                            }

                            this.lookups.mapPlanML = {};
                            if(this.rawData.pml && this.rawData.pml.length) {
                                const h=this.rawData.pml[0];
                                const iS=idx(h,['SKU']);
                                const iRec=idx(h,['Recomendaci√≥n']);
                                const iSug=idx(h,['Unidades sugeridas', 'sugeridas']);

                                this.rawData.pml.slice(1).forEach(r=>{
                                    const s=clean(r[iS]);
                                    if(s) {
                                        const recText = String(r[iRec]||'');
                                        this.lookups.mapPlanML[s] = {
                                            rec: recText,
                                            sug: num(r[iSug]),
                                            esUrgente: recText.toLowerCase().includes('urgencia') || recText.toLowerCase().includes('perdiendo')
                                        };
                                    }
                                });
                            }

                            // üö© CANASTA - FLAG BLOQUEADOS
                            this.lookups.mapCanasta = {};
                            if(this.rawData.canasta && this.rawData.canasta.length) {
                                const h = this.rawData.canasta[0];
                                const iS = idx(h, ['SKU']);
                                const iFlag = idx(h, ['FLAG BLOQUEADOS', 'BLOQUEADOS', 'BLOQUEADO', 'FLAG']);
                                
                                console.log('[DEBUG] Canasta headers:', h);
                                console.log('[DEBUG] Canasta columna SKU idx:', iS, '| FLAG idx:', iFlag);
                                
                                if(iS > -1 && iFlag > -1) {
                                    this.rawData.canasta.slice(1).forEach(r => {
                                        const s = clean(r[iS]);
                                        if(s) {
                                            const flagVal = String(r[iFlag] || '').toUpperCase().trim();
                                            const esBloqueado = flagVal === 'SI' || flagVal === 'S√ç' || flagVal === 'S' || flagVal === 'TRUE' || flagVal === '1';
                                            this.lookups.mapCanasta[s] = {
                                                bloqueado: esBloqueado
                                            };
                                            // Debug: mostrar primeros 5 SKUs bloqueados
                                            if(esBloqueado && Object.values(this.lookups.mapCanasta).filter(x=>x.bloqueado).length <= 5) {
                                                console.log('[DEBUG] SKU bloqueado encontrado:', s, '| Valor columna:', flagVal);
                                            }
                                        }
                                    });
                                } else {
                                    console.warn('[WARN] No se encontr√≥ columna SKU o FLAG BLOQUEADOS en hoja Canasta');
                                }
                                const bloqueadosCount = Object.values(this.lookups.mapCanasta).filter(x=>x.bloqueado).length;
                                console.log('[INFO] Canasta cargada:', Object.keys(this.lookups.mapCanasta).length, 'SKUs |', bloqueadosCount, 'bloqueados');
                            } else {
                                console.log('[INFO] Hoja Canasta no encontrada o vac√≠a');
                            }

                            // üì∞ MLA - C√≥digos publicaci√≥n Mercado Libre (Dep80)
                            this.lookups.mapMLA = {};
                            if(this.rawData.mla && this.rawData.mla.length) {
                                const h = this.rawData.mla[0];
                                const iS = idx(h, ['SKU']);
                                const iMLA = idx(h, ['MLA']);
                                const iEstado = idx(h, ['ESTADO']);
                                
                                console.log('[DEBUG] MLA headers:', h);
                                console.log('[DEBUG] MLA columna SKU idx:', iS, '| MLA idx:', iMLA, '| ESTADO idx:', iEstado);
                                
                                if(iS > -1 && iMLA > -1) {
                                    this.rawData.mla.slice(1).forEach(r => {
                                        const s = clean(r[iS]);
                                        if(s) {
                                            this.lookups.mapMLA[s] = {
                                                mla: clean(r[iMLA]),
                                                estado: clean(r[iEstado] || '')
                                            };
                                        }
                                    });
                                } else {
                                    console.warn('[WARN] No se encontr√≥ columna SKU o MLA en hoja MLA');
                                }
                                console.log('[INFO] MLA cargada:', Object.keys(this.lookups.mapMLA).length, 'SKUs');
                            } else {
                                console.log('[INFO] Hoja MLA no encontrada o vac√≠a');
                            }

                            // üìã STA19 - EAN y datos maestros
                            this.lookups.mapSTA19 = {};
                            if(this.rawData.sta19 && this.rawData.sta19.length) {
                                const h = this.rawData.sta19[0];
                                const iS = idx(h, ['SKU']);
                                const iEAN = idx(h, ['EAN']);
                                
                                console.log('[DEBUG] STA19 headers:', h.slice(0, 10), '...');
                                console.log('[DEBUG] STA19 columna SKU idx:', iS, '| EAN idx:', iEAN);
                                
                                if(iS > -1 && iEAN > -1) {
                                    this.rawData.sta19.slice(1).forEach(r => {
                                        const s = clean(r[iS]);
                                        if(s) {
                                            this.lookups.mapSTA19[s] = {
                                                ean: String(r[iEAN] || '').trim()
                                            };
                                        }
                                    });
                                } else {
                                    console.warn('[WARN] No se encontr√≥ columna SKU o EAN en hoja STA19');
                                }
                                console.log('[INFO] STA19 cargada:', Object.keys(this.lookups.mapSTA19).length, 'SKUs con EAN');
                            } else {
                                console.log('[INFO] Hoja STA19 no encontrada o vac√≠a');
                            }

                            const data = {}; const hG = this.rawData.grafana[0];
                            const iSku = idx(hG, ['SKU']), iDep = idx(hG, ['Deposito']), iVtar = idx(hG, ['VTAR']), iVpd = idx(hG, ['VPD_Cpra']);
                            const iDesc = idx(hG, ['Descripcion']), iMarca = idx(hG, ['Marca']), iProv = idx(hG, ['Proveedor', 'Prov']), iAnalista = idx(hG, ['Analista']);
                            const iCosto = idx(hG, ['Costo', 'Reposici√≥n', 'C_Repo', 'M√°x. de Precio_Lista_900']), iLt = idx(hG, ['Lead']), iDev = idx(hG, ['Desv√≠o']), iStock = idx(hG, ['Stock']), iUxb = idx(hG, ['UXB']);
                            // Preprocesar mapa de costos STA19 si existe
                            let sta19CostMap = {};
                            if (this.rawData.sta19 && this.rawData.sta19.length) {
                                const hSTA = this.rawData.sta19[0];
                                const iSkuSTA = idx(hSTA, ['SKU']);
                                const iCostoSTA = idx(hSTA, ['M√°x. de Precio_Lista_900']);
                                if (iSkuSTA > -1 && iCostoSTA > -1) {
                                    this.rawData.sta19.slice(1).forEach(r => {
                                        const sku = clean(r[iSkuSTA]);
                                        if (sku) sta19CostMap[sku] = num(r[iCostoSTA]);
                                    });
                                }
                            }
                            if (iCosto === -1) {
                                alert('‚ùå FALTA la columna COSTO o REPOSICI√ìN en la hoja principal (Grafana). No se pueden calcular valores.');
                                throw new Error('Columna de costo no encontrada en hoja principal');
                            }
                            const iCamino = idx(hG, ['COMPRAS']), iVta59 = idx(hG, ['TOTAL VENDIDO', '59 D√çAS', 'VENDIDO 59']);
                            
                            const iPerfil = idx(hG, ['Perfil']);
                            const iSubPerfil = idx(hG, ['Sub_Perfil']);
                            
                            // üö© FLAG BLOQUEADOS (columna DN en Grafana)
                            const iFlagBloq = idx(hG, ['FLAG BLOQUEADOS', 'BLOQUEADOS', 'BLOQUEADO', 'FLAG_BLOQ']);
                            console.log('[DEBUG] Columna FLAG BLOQUEADOS encontrada en √≠ndice:', iFlagBloq);
                            
                            // üõí √çndices para columnas Q MES (Market)
                            const meses = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];
                            const iQMes = {};
                            meses.forEach(mes => {
                                const i = hG.findIndex(c => String(c).toUpperCase().trim() === 'Q ' + mes);
                                if(i > -1) iQMes[mes] = i;
                            });

                            const flatRows = [];
                            this.rawData.grafana.slice(1).forEach(r => {
                                const sku = clean(r[iSku]); if(!sku || sku === 'TOTAL') return;
                                const dep = clean(r[iDep]), v = num(r[iVtar]), st = num(r[iStock]), vta59 = num(r[iVta59]);

                                // üö© Detectar FLAG BLOQUEADOS para este SKU
                                const flagBloqVal = iFlagBloq > -1 ? String(r[iFlagBloq] || '').toUpperCase().trim() : '';
                                const esBloqueado = flagBloqVal === 'SI' || flagBloqVal === 'S√ç' || flagBloqVal === 'S' || flagBloqVal === 'TRUE' || flagBloqVal === '1';

                                if(!data[sku]) {
                                    let costoGrafana = num(r[iCosto]);
                                    if (!costoGrafana && sta19CostMap[sku]) costoGrafana = sta19CostMap[sku];
                                    data[sku] = {
                                        sku, desc: r[iDesc], marca: r[iMarca]||'-', prov: r[iProv]||'-',
                                        analista: r[iAnalista]||'-', costo: costoGrafana,
                                        lt: num(r[iLt])||30,
                                        dev: 0,
                                        vpdCpra: num(r[iVpd]),
                                        uxb: num(r[iUxb])||1,
                                        perfil: (iPerfil > -1 ? r[iPerfil] : '') || 'Sin Clasificar',
                                        subPerfil: (iSubPerfil > -1 ? r[iSubPerfil] : '') || 'Sin Clasificar',
                                        vtarTotal: 0, vtar80: 0, vtar1: 0, vtarSuc: 0,
                                        stockGrafana: 0, comprasEnCamino: 0, vta59Total: 0,
                                        vta30d: 0, vta30d_80: 0,
                                        histDaily: [], histDaily80: [], vtarBreakdown: {}, seasonalMult: 1,
                                        // üõí Datos Q MES para Market (acumuladores para promedio)
                                        _qMesSum: {}, _qMesCount: 0,
                                        // üö© FLAG BLOQUEADOS desde Grafana
                                        bloqueado: esBloqueado
                                    };
                                    
                                    // Debug: mostrar primeros SKUs bloqueados
                                    if(esBloqueado) {
                                        console.log('[DEBUG] üö© SKU BLOQUEADO encontrado:', sku, '| Valor columna:', flagBloqVal);
                                    }
                                }

                                const depNum = dep.match(/\d+/)?.[0] || '';
                                if(depNum && ['82','86','87','89'].includes(depNum)) {
                                    if(!data[sku].vtarBreakdown[depNum]) data[sku].vtarBreakdown[depNum] = 0;
                                    data[sku].vtarBreakdown[depNum] += v;
                                }

                                const histIndices = [];
                                for(let i=1; i<=60; i++) { 
                                    const ix = idx(hG, [`-${i}`]); 
                                    if(ix > -1) histIndices.push({ idx: ix, day: i }); 
                                }

                                if (histIndices.length > 0) {
                                    const dailySales = histIndices.map(item => num(r[item.idx]));
                                    if (data[sku].histDaily.length === 0) data[sku].histDaily = dailySales;
                                    else for(let k=0; k<dailySales.length; k++) data[sku].histDaily[k] += dailySales[k];
                                    
                                    // Acumular histDaily80 SOLO si es dep√≥sito 80
                                    if(dep.includes('80') || dep.includes('FULL')) {
                                        if (data[sku].histDaily80.length === 0) data[sku].histDaily80 = dailySales;
                                        else for(let k=0; k<dailySales.length; k++) data[sku].histDaily80[k] += dailySales[k];
                                    }

                                    const calcAvg = (days) => {
                                        const slice = data[sku].histDaily.slice(0, days); 
                                        const sum = slice.reduce((a,b) => a + b, 0);
                                        return (days > 0 && slice.length > 0) ? (sum / days) : 0;
                                    };

                                    data[sku].vtar15 = calcAvg(15);
                                    data[sku].vtar30 = calcAvg(30);
                                    data[sku].vtar45 = calcAvg(45);
                                    data[sku].vtar60 = calcAvg(60);
                                    
                                    // Calcular venta total de 30 d√≠as (suma de -1 a -30)
                                    const slice30 = data[sku].histDaily.slice(0, 30);
                                    data[sku].vta30d = slice30.reduce((a,b) => a + b, 0);
                                    
                                    // Calcular venta de 30 d√≠as SOLO del dep√≥sito 80
                                    const slice30_80 = data[sku].histDaily80.slice(0, 30);
                                    data[sku].vta30d_80 = slice30_80.reduce((a,b) => a + b, 0);
                                }

                                data[sku].vtarTotal += v; data[sku].stockGrafana += st; data[sku].vta59Total += vta59;
                                if(iCamino > -1) data[sku].comprasEnCamino += num(r[iCamino]);
                                if(dep.includes('80') || dep.includes('FULL')) data[sku].vtar80 += v; else if(dep.includes('1') || dep.includes('CENTRAL')) data[sku].vtar1 += v; else data[sku].vtarSuc += v;
                                
                                // üõí Acumular Q MES (para promediar despu√©s)
                                meses.forEach(mes => {
                                    if(iQMes[mes] !== undefined) {
                                        const val = num(r[iQMes[mes]]);
                                        if(!data[sku]._qMesSum[mes]) data[sku]._qMesSum[mes] = 0;
                                        data[sku]._qMesSum[mes] += val;
                                    }
                                });
                                data[sku]._qMesCount++;
                                
                                flatRows.push({ id: Math.random().toString(36).substr(2,9), sku: sku, desc: r[iDesc]||data[sku]?.desc||'-', marca: r[iMarca]||'-', prov: r[iProv]||'-', dep, vtar: v, stock: st, vta59, diasStockDep: v > 0 ? st/v : (st>0 ? 999 : 0), costo: num(r[iCosto]), analista: r[iAnalista]||'-' });
                            }); 

                            if(this.rawData.pbi && this.rawData.pbi.length) {
                                const hP_Uni = this.rawData.pbi[0];
                                const iP_S = idx(hP_Uni, ['SKU']);
                                const iP_Desc = idx(hP_Uni, ['DESCRIPCION']);
                                
                                this.rawData.pbi.slice(1).forEach(r => {
                                    const sku = clean(r[iP_S]);
                                    if(sku && !data[sku]) {
                                        // Buscar costo en hoja principal si existe
                                        let costoPrincipal = 0;
                                        if (this.rawData.grafana && this.rawData.grafana.length) {
                                            const idxSku = this.rawData.grafana.findIndex(row => clean(row[iSku]) === sku);
                                            if (idxSku > 0) {
                                                costoPrincipal = num(this.rawData.grafana[idxSku][iCosto]);
                                            }
                                        }
                                        // Si no est√° en grafana, buscar en STA19
                                        if (!costoPrincipal && sta19CostMap[sku]) costoPrincipal = sta19CostMap[sku];
                                        data[sku] = {
                                            sku, 
                                            desc: r[iP_Desc] || 'Producto solo en PBI (Falta en Grafana)',
                                            marca: 'S/D', prov: 'S/D', analista: 'S/D',
                                            costo: costoPrincipal, lt: 30, dev: 0, vpdCpra: 0, uxb: 1,
                                            vtarTotal: 0, vtar80: 0, vtar1: 0, vtarSuc: 0,
                                            stockGrafana: 0, comprasEnCamino: 0, vta59Total: 0,
                                            histDaily: [], vtarBreakdown: {}, seasonalMult: 1,
                                            origen: 'Solo PBI'
                                        };
                                    }
                                });
                            }

                            if(this.rawData.sml && this.rawData.sml.length) {
                                const hS_Uni = this.rawData.sml[0];
                                const iS_S = idx(hS_Uni, ['SKU']);
                                const iS_Desc = idx(hS_Uni, ['DESCRIPCION']);
                                const iS_Pub = idx(hS_Uni, ['PUBLICACION', 'TITULO']);

                                this.rawData.sml.slice(1).forEach(r => {
                                    const sku = clean(r[iS_S]);
                                    if(sku && !data[sku]) {
                                        // Buscar costo en hoja principal si existe
                                        let costoPrincipal = 0;
                                        if (this.rawData.grafana && this.rawData.grafana.length) {
                                            const idxSku = this.rawData.grafana.findIndex(row => clean(row[iSku]) === sku);
                                            if (idxSku > 0) {
                                                costoPrincipal = num(this.rawData.grafana[idxSku][iCosto]);
                                            }
                                        }
                                        // Si no est√° en grafana, buscar en STA19
                                        if (!costoPrincipal && sta19CostMap[sku]) costoPrincipal = sta19CostMap[sku];
                                        data[sku] = {
                                            sku, 
                                            desc: r[iS_Desc] || r[iS_Pub] || 'Producto solo en ML (Falta en Grafana)',
                                            marca: 'S/D', prov: 'S/D', analista: 'S/D',
                                            costo: costoPrincipal, lt: 30, dev: 0, vpdCpra: 0, uxb: 1,
                                            vtarTotal: 0, vtar80: 0, vtar1: 0, vtarSuc: 0,
                                            stockGrafana: 0, comprasEnCamino: 0, vta59Total: 0,
                                            histDaily: [], vtarBreakdown: {}, seasonalMult: 1,
                                            origen: 'Solo ML'
                                        };
                                    }
                                });
                            }

                            const hP = this.rawData.pbi ? this.rawData.pbi[0] : null;
                            if(hP) {
                                const iP_S = idx(hP, ['SKU']), iP_D1 = idx(hP, ['DEP 1']), iP_D80 = idx(hP, ['DEP 80']);
                                const colsSuc = [81,82,83,86,87,89].map(n => ({k:`dep${n}`, i:idx(hP, [`DEP ${n}`])}));
                                this.rawData.pbi.slice(1).forEach(r => {
                                    const sku = clean(r[iP_S]);
                                    if(data[sku]) { data[sku].pbi = { dep1: num(r[iP_D1]), dep80: num(r[iP_D80]) }; colsSuc.forEach(c => data[sku].pbi[c.k] = num(r[c.i])); }
                                });
                            }

                            const rawEnvios = [], envioFechas = new Set();
                            if(this.rawData.enviados && this.rawData.enviados.length) {
                                const h=this.rawData.enviados[0], iS=idx(h,['SKU']), iDesc=idx(h,['DESCRIPCI√ìN']), iProv=idx(h,['PROV']), iCant=idx(h,['ENVIO REALIZADO']), iNum=idx(h,['N¬∞ ENVIO']), iFecha=idx(h,['FECHA']);
                                this.rawData.enviados.slice(1).forEach(r=>{
                                    const s=clean(r[iS]);
                                    if(s) {
                                        this.lookups.mapEnvios[s] = (this.lookups.mapEnvios[s]||0)+num(r[iCant]);
                                        let fStr = String(r[iFecha]||'-');
                                        if(typeof r[iFecha]==='number') fStr = excelDateToJSDate(r[iFecha]);
                                        envioFechas.add(fStr);
                                        rawEnvios.push({ id: Math.random().toString(36).substr(2,9), sku: s, desc: r[iDesc]||data[s]?.desc||'-', marca: data[s]?.marca||'-', prov: r[iProv]||data[s]?.prov||'-', cant: num(r[iCant]), num_envio: r[iNum], fecha: fStr });
                                    }
                                });
                            }
                            this.enviosData = rawEnvios; this.uniqueEnvioFechas = Array.from(envioFechas).sort();

                            const rawLotes = [], vtoBuckets = { '15-30': 0, '31-60': 0, '61-90': 0 };
                            let totalRiesgoVto = 0;

                            if(this.rawData.vto && this.rawData.vto.length) {
                                const h = this.rawData.vto[0], iS=idx(h,['SKU']), iRec=idx(h,['RECIBIDO','STOCK']), iIn=idx(h,['INGRESO']), iVto=idx(h,['VENCIMIENTO']);
                                
                                const batchesBySku = {};
                                const hoy = new Date(); 
                                hoy.setHours(0,0,0,0); 

                                this.rawData.vto.slice(1).forEach(r => {
                                    const sku = clean(r[iS]); if(!sku) return; if(!batchesBySku[sku]) batchesBySku[sku] = [];
                                    
                                    let fIn = r[iIn], dVal = typeof fIn==='number' ? fIn : 0;
                                    if(typeof fIn === 'number') fIn = excelDateToJSDate(fIn);
                                    
                                    let rawVto = r[iVto];
                                    let fVtoStr = rawVto; 
                                    let diasCalculados = 0;
                                    let vtoObj = null;

                                    if(typeof rawVto === 'number') {
                                        const utc_value = Math.floor(rawVto - 25569) * 86400000;
                                        vtoObj = new Date(utc_value);
                                        fVtoStr = excelDateToJSDate(rawVto); 
                                    } else if (typeof rawVto === 'string') {
                                        if(rawVto.includes('-')) { 
                                            const parts = rawVto.split('-');
                                            if(parts.length===3) {
                                                vtoObj = new Date(parts[0], parts[1]-1, parts[2]);
                                                fVtoStr = `${parts[2]}/${parts[1]}/${parts[0]}`;
                                            }
                                        } else if (rawVto.includes('/')) { 
                                             const parts = rawVto.split('/');
                                             if(parts.length===3) vtoObj = new Date(parts[2], parts[1]-1, parts[0]);
                                        }
                                    }

                                    if(vtoObj && !isNaN(vtoObj.getTime())) {
                                        const diffTime = vtoObj.getTime() - hoy.getTime();
                                        diasCalculados = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                    }

                                    batchesBySku[sku].push({ 
                                        sku, 
                                        desc: data[sku]?.desc||'-', 
                                        marca: data[sku]?.marca||'-', 
                                        prov: data[sku]?.prov||'-', 
                                        recibido: num(r[iRec]), 
                                        fechaIngreso: fIn,
                                        fechaVto: fVtoStr, 
                                        dias: diasCalculados,
                                        dateVal: dVal 
                                    });
                                });

                                Object.keys(batchesBySku).forEach(sku => {
                                    let currentStock = data[sku]?.stockGrafana || 0;
                                    const batches = batchesBySku[sku].sort((a,b) => b.dateVal - a.dateVal);
                                    
                                    const ventaDiaria = data[sku]?.vtarTotal || 0;
                                    const costo = data[sku]?.costo || 0;

                                    batches.forEach(batch => {
                                        if(currentStock > 0) {
                                            const stockDeEsteLote = Math.min(currentStock, batch.recibido);
                                            if(stockDeEsteLote > 0) {
                                                batch.stockComprometido = stockDeEsteLote;
                                                batch.id = Math.random().toString(36).substr(2,9);
                                                
                                                const diasUtiles = Math.max(0, batch.dias);
                                                const ventaPosible = ventaDiaria * diasUtiles;
                                                const unidadesEnRiesgo = Math.max(0, stockDeEsteLote - ventaPosible);
                                                
                                                batch.riesgoMonetario = unidadesEnRiesgo * costo;
                                                if(batch.riesgoMonetario > 0) totalRiesgoVto += batch.riesgoMonetario;

                                                rawLotes.push(batch);
                                                
                                                if(batch.dias <= 30) vtoBuckets['15-30']++; 
                                                else if(batch.dias <= 60) vtoBuckets['31-60']++;
                                                else if(batch.dias <= 90) vtoBuckets['61-90']++;
                                                currentStock -= stockDeEsteLote;
                                            }
                                        }
                                    });
                                });
                            }
                            this.lotesData = rawLotes; 
                            this.metrics.vto = vtoBuckets;
                            this.kpis.riesgoVto = totalRiesgoVto;

                            if(this.strategyOverrides) {
                                Object.keys(this.strategyOverrides).forEach(s => {
                                    if(data[s]) data[s].diasEstrategia = this.strategyOverrides[s];
                                });
                            }

                            // üõí Calcular promedios Q MES para Market
                            // üìÖ C√°lculo din√°mico de d√≠as de Noviembre basado en fecha actual
                            const hoy = new Date();
                            const diaDelMes = hoy.getDate();
                            const mesActual = hoy.getMonth(); // 0=Enero, 11=Diciembre
                            
                            // Calcular qu√© d√≠as del historial corresponden a Noviembre
                            // Si estamos en Diciembre (mes 11), Noviembre termin√≥ hace "diaDelMes" d√≠as
                            // -1 = ayer, entonces el d√≠a 1 de diciembre ser√≠a -diaDelMes desde el d√≠a 30 de nov
                            let novStart = 0, novEnd = 0;
                            if(mesActual === 11) { // Diciembre
                                // √öltimo d√≠a de noviembre fue hace "diaDelMes" d√≠as
                                novEnd = diaDelMes; // Ej: si hoy es 13 dic, -13 = 30 nov
                                novStart = diaDelMes + 29; // -43 = 1 nov (30 d√≠as de noviembre)
                            } else if(mesActual === 10) { // Noviembre
                                // Estamos en noviembre, solo podemos calcular d√≠as pasados del mes
                                novEnd = 1; // Ayer
                                novStart = diaDelMes - 1; // Desde el d√≠a 1 de noviembre hasta ayer
                            }
                            console.log('[INFO] SHARE: Calculando ventas Noviembre, d√≠as -' + novEnd + ' a -' + novStart);
                            
                            Object.values(data).forEach(item => {
                                const count = item._qMesCount || 1;
                                const mesMap = {
                                    'ENERO': 'qEnero', 'FEBRERO': 'qFebrero', 'MARZO': 'qMarzo',
                                    'ABRIL': 'qAbril', 'MAYO': 'qMayo', 'JUNIO': 'qJunio',
                                    'JULIO': 'qJulio', 'AGOSTO': 'qAgosto', 'SEPTIEMBRE': 'qSeptiembre',
                                    'OCTUBRE': 'qOctubre', 'NOVIEMBRE': 'qNoviembre', 'DICIEMBRE': 'qDiciembre'
                                };
                                Object.keys(mesMap).forEach(mes => {
                                    const prop = mesMap[mes];
                                    const sum = item._qMesSum?.[mes] || 0;
                                    item[prop] = count > 0 ? Math.round(sum / count) : 0;
                                });
                                
                                // üõí Calcular ventas propias de Noviembre desde histDaily
                                let vtaNoviembre = 0;
                                if(item.histDaily && item.histDaily.length > 0 && novStart > 0) {
                                    // histDaily[0] = -1 (ayer), histDaily[1] = -2, etc.
                                    for(let d = novEnd - 1; d < novStart && d < item.histDaily.length; d++) {
                                        vtaNoviembre += (item.histDaily[d] || 0);
                                    }
                                }
                                item.vtaNoviembre = vtaNoviembre;
                                
                                // üõí Calcular SHARE % = Ventas propias Nov / Q NOVIEMBRE (Mercado) * 100
                                const qNov = item._qMesSum?.['NOVIEMBRE'] || 0;
                                const qNovProm = count > 0 ? qNov / count : 0;
                                item.qNoviembre = qNovProm; // Guardar Q Noviembre promedio para uso en b√∫squeda
                                item.shareNov = qNovProm > 0 ? (vtaNoviembre / qNovProm) * 100 : 0;
                                
                                // Limpiar propiedades temporales
                                delete item._qMesSum;
                                delete item._qMesCount;
                            });

                            const processed = Object.values(data).map(item => {
                                if (item.histDaily && item.histDaily.length > 5) {
                                    const chrono = [...item.histDaily].reverse();
                                    const reg = calculateLinearRegression(chrono);
                                    item.vtarIa = Math.max(0, reg.nextVal);
                                    item.isAnomaly = detectAnomaly(chrono);
                                } else {
                                    item.vtarIa = 0;
                                    item.isAnomaly = false;
                                }

                                if(item.histDaily.length>0) {
                                    item.stdDev = calculateStandardDeviation(item.histDaily, item.vtarTotal);
                                    item.cv = item.vtarTotal > 0 ? (item.stdDev / item.vtarTotal) : 0;
                                    if(item.vtarTotal === 0) item.stability = 'Inactivo';
                                    else if(item.cv < 0.3) item.stability = 'Estable'; 
                                    else if(item.cv < 0.7) item.stability = 'Variable';
                                    else item.stability = 'Err√°tico';
                                } else { 
                                    item.stability = 'S/D'; item.cv = 0; 
                                }

                                // Asegurar que cada item tenga el campo inversion correctamente calculado
                                if (typeof item.inversion === 'undefined' || isNaN(item.inversion)) {
                                    item.inversion = (item.stockGrafana || 0) * (item.costo || 0);
                                }

                                const p = this.calculateRowLogic(item);
                                p.id = Math.random().toString(36).substr(2,9);
                                return p;
                            });

                            // Unificar l√≥gica: usar solo una declaraci√≥n de provMap y sumar correctamente
                            let provMapStock = {};
                            processed.forEach(item => {
                                const pName = item.prov || 'S/D';
                                if (!provMapStock[pName]) {
                                    provMapStock[pName] = {
                                        id: Math.random().toString(36).substr(2,9),
                                        prov: pName,
                                        totalStockVal: 0,
                                        totalStockQty: 0,
                                        totalVtar: 0,
                                        inmoVal: 0,
                                        inversion: 0
                                    };
                                }
                                // C√°lculo correcto usando costo
                                provMapStock[pName].totalStockVal += (item.stockGrafana || 0) * (item.costo || 0);
                                provMapStock[pName].totalStockQty += item.stockGrafana || 0;
                                provMapStock[pName].totalVtar += item.vtarTotal || 0;
                                // Sobrestock: solo unidades que exceden 45 d√≠as
                                if ((item.diasStock || 0) > 45) provMapStock[pName].inmoVal += ((item.stockGrafana || 0) * (item.costo || 0));
                                provMapStock[pName].inversion += item.inversion || 0;
                            });
                            this.proveedoresData = Object.values(provMapStock).map(p => ({
                                ...p,
                                diasStockProm: p.totalVtar > 0 ? (p.totalStockQty / p.totalVtar) : 0
                            }));

                            const otherDepsList = [];
                            const targetDays = this.params.diasOtros || 30;

                            processed.forEach(item => {
                                const lt = item.lt || 30; // Lead time del SKU
                                
                                this.availableOtherDeps.forEach(d => {
                                    const stk = item.pbi ? (item.pbi[`dep${d}`] || 0) : 0;
                                    let vt = 0;
                                    if (d === '80') {
                                        vt = item.vtar80 || 0; 
                                    } else {
                                        vt = (item.vtarBreakdown && item.vtarBreakdown[d]) || 0;
                                    }

                                    const dias = vt > 0 ? stk/vt : (stk > 0 ? 999 : 0);

                                    // üßÆ C√°lculos SS, Stock M√≠n, Stock M√°x basados en VTAR del dep√≥sito
                                    const ssDep = Math.ceil(2.33 * vt * Math.sqrt(lt));
                                    const stockMinDep = Math.ceil((vt * lt) + ssDep);
                                    let stockMaxDep = Math.ceil(vt * 30); // 30 d√≠as de cobertura
                                    if (stockMaxDep < stockMinDep) stockMaxDep = stockMinDep;

                                    let q = 0;
                                    if(vt > 0) {
                                         const target = vt * targetDays;
                                         if(stk < target) q = target - stk;
                                    }

                                    let status = 'üü¢';
                                    if (stk === 0 && vt > 0) status = 'üî¥';
                                    else if (dias < targetDays) status = 'üü°';
                                    else if (dias > targetDays * 2) status = 'üü£';

                                    if(stk > 0 || vt > 0 || q > 0) {
                                         otherDepsList.push({
                                             id: item.sku + '_' + d,
                                             sku: item.sku,
                                             desc: item.desc,
                                             marca: item.marca,
                                             prov: item.prov,
                                             deposito: d,
                                             stock: stk,
                                             vtar: vt,
                                             diasStock: dias,
                                             // üÜï Stock Seguridad, M√≠nimo, M√°ximo por dep√≥sito
                                             ssDep: ssDep,
                                             stockMinDep: stockMinDep,
                                             stockMaxDep: stockMaxDep,
                                             enviadoHist: item.enviadoHist || 0,
                                             qEnviar: Math.ceil(q),
                                             statusVisual: status,
                                             // üö© FLAG BLOQUEADO propagado
                                             bloqueado: item.bloqueado || false
                                         });
                                    }
                                });
                            });
                            this.otherDepositsData = otherDepsList;

                            setTimeout(() => {
                                try {
                                    const histByDate = {};
                                    this.historyData.forEach(h => histByDate[h.date] = h.data);
                                    const sortedDates = Object.keys(histByDate).sort().slice(-14);
                                    processed.forEach(row => {
                                        const trend = [];
                                        sortedDates.forEach(d => {
                                            const daySnap = histByDate[d];
                                            if(daySnap && daySnap[row.sku]) trend.push(daySnap[row.sku].v);
                                            else trend.push(0);
                                        });
                                        
                                        if (trend.filter(x=>x>0).length < 2 && row.histDaily && row.histDaily.length > 1) {
                                            row.trendHistory = [...row.histDaily].reverse();
                                        } else {
                                            trend.push(row.vtarTotal);
                                            row.trendHistory = trend;
                                        }

                                        if(row.trendHistory.length >= 2) {
                                            row.trendSlope = row.vtarTotal - row.trendHistory[row.trendHistory.length-2];
                                        } else { row.trendSlope = 0; }
                                    });
                                    this.masterData = [...this.masterData];
                                } catch(errHist) { console.warn("Trend calc skipped", errHist); }
                            }, 100);

                            // ‚ö° OPTIMIZACI√ìN: Clasificaci√≥n ABC-XYZ-Salud consolidada en 1 solo bucle
                            console.log('[INFO] Calculando clasificaci√≥n ABC-XYZ...');
                            const totVenta = processed.reduce((s,i)=>s+(i.vtarTotal*i.costo),0);
                            processed.sort((a,b)=>(b.vtarTotal*b.costo)-(a.vtarTotal*a.costo));
                            
                            let acc=0;
                            const matrix = { A: {q:0, pq:0, s:0, a:0, o:0}, B: {q:0, pq:0, s:0, a:0, o:0}, C: {q:0, pq:0, s:0, a:0, o:0} };
                            const mCounts = {};

                            // BUCLE CONSOLIDADO: ABC + XYZ + Matriz de Salud en una sola pasada
                            processed.forEach(p=>{
                                // Clasificaci√≥n ABC (Pareto)
                                acc+=(p.vtarTotal*p.costo);
                                const pct=totVenta?acc/totVenta:0;
                                p.abc=pct<=0.8?'A':(pct<=0.95?'B':'C');
                                
                                // Clasificaci√≥n XYZ (Estabilidad)
                                let xyz = 'Z';
                                if (p.stability === 'Estable') xyz = 'X';
                                else if (p.stability === 'Variable') xyz = 'Y';
                                p.abc_xyz = p.abc + xyz;
                                mCounts[p.abc_xyz] = (mCounts[p.abc_xyz] || 0) + 1;

                                // Matriz de Salud (d√≠as de stock)
                                let status = '';
                                if(p.diasStock <= 10) status='q';
                                else if(p.diasStock <= 17) status='pq';
                                else if(p.diasStock <= 30) status='s';
                                else if(p.diasStock <= 45) status='a';
                                else status='o';
                                matrix[p.abc][status] += (p.stockGrafana * p.costo);
                            });
                            this.metrics.matrix = matrix;
                            this.matrixCounts = mCounts;
                            console.log('[INFO] Clasificaci√≥n completada:', Object.keys(mCounts).length, 'categor√≠as');

                            this.masterData = processed;
                            this.flatData = flatRows;

                            // üéØ M√âTRICA: Sub_Perfil + Cobertura en Dep80 (30 d√≠as)
                            const subPerfilStats = {};
                            const subPerfilNames = ['Killer', 'Normal', 'Baja Rotaci√≥n', 'Verano'];
                            subPerfilNames.forEach(sp => {
                                subPerfilStats[sp] = { count: 0, stock: 0, vtar: 0, coverage: 0 };
                            });

                            this.masterData.forEach(item => {
                                const sp = String(item.subPerfil || 'Sin Clasificar').trim();
                                const matchedSp = subPerfilNames.find(name => sp.toLowerCase().includes(name.toLowerCase()));
                                if(matchedSp) {
                                    subPerfilStats[matchedSp].count++;
                                    subPerfilStats[matchedSp].stock += (item.pbi?.dep80 || 0); // Stock F√çSICO en dep80
                                    subPerfilStats[matchedSp].vtar += (item.vtar80 || 0); // VTAR del dep80 (venta diaria)
                                }
                            });

                            const totalSkusDep80 = Object.values(subPerfilStats).reduce((acc, s) => acc + s.count, 0);
                            const subPerfilCoverageData = Object.entries(subPerfilStats).map(([name, stats]) => {
                                const coberturaDias = stats.vtar > 0 ? Math.round(stats.stock / stats.vtar) : 0;
                                const stockSaludable = Math.round(stats.vtar * 45); // Stock m√°ximo saludable (45 d√≠as)
                                const unidadesSobrestock = coberturaDias > 45 ? Math.round(stats.stock - stockSaludable) : 0;
                                
                                return {
                                    subPerfil: name,
                                    porcentajeProductos: totalSkusDep80 > 0 ? ((stats.count / totalSkusDep80) * 100).toFixed(1) : 0,
                                    cantProductos: stats.count,
                                    stockDep80: Math.round(stats.stock),
                                    vtarTotal: stats.vtar.toFixed(2),
                                    coberturaDias: coberturaDias,
                                    stockSaludable: stockSaludable,
                                    unidadesSobrestock: unidadesSobrestock
                                };
                            });

                            this.metrics.subPerfilCoverage = subPerfilCoverageData;
                            console.log('[INFO] Sub_Perfil Cobertura:', subPerfilCoverageData);

                            // üéØ OPCI√ìN 1: MATRIZ DE RIESGO (Cobertura vs Rotaci√≥n)
                            const riskMatrix = { RED: [], ORANGE: [], YELLOW: [], GREEN: [] };
                            const vtarMediana = this.masterData.length > 0 
                                ? this.masterData.map(m => m.vtarTotal || 0).sort((a,b) => a-b)[Math.floor(this.masterData.length/2)]
                                : 0;
                            
                            this.masterData.forEach(item => {
                                if(item.stockGrafana > 0) {
                                    const cobertura = item.vtarTotal > 0 ? (item.vtar80 / item.vtarTotal) * 30 : 0;
                                    const isHighRotation = item.vtarTotal >= vtarMediana;
                                    const isGoodCoverage = cobertura >= 30;
                                    
                                    let quadrant = '';
                                    if (!isHighRotation && !isGoodCoverage) quadrant = 'ORANGE'; // Baja rot + poco stock
                                    else if (!isHighRotation && isGoodCoverage) quadrant = 'RED';    // Dinero congelado
                                    else if (isHighRotation && !isGoodCoverage) quadrant = 'YELLOW'; // Riesgo desabast
                                    else quadrant = 'GREEN';                                         // Ideal
                                    
                                    riskMatrix[quadrant].push({
                                        sku: item.sku,
                                        desc: item.desc,
                                        vtar: item.vtarTotal,
                                        stock: item.vtar80,
                                        cobertura: cobertura.toFixed(1),
                                        valor: (item.vtar80 * item.costo).toFixed(0)
                                    });
                                }
                            });
                            
                            this.metrics.riskMatrix = {
                                RED: { label: 'Dinero Congelado', icon: 'üî¥', items: riskMatrix.RED, count: riskMatrix.RED.length },
                                ORANGE: { label: 'Bajo Perfil', icon: 'üü†', items: riskMatrix.ORANGE, count: riskMatrix.ORANGE.length },
                                YELLOW: { label: 'Riesgo Desabastecimiento', icon: 'üü°', items: riskMatrix.YELLOW, count: riskMatrix.YELLOW.length },
                                GREEN: { label: 'Ideal', icon: 'üü¢', items: riskMatrix.GREEN, count: riskMatrix.GREEN.length }
                            };
                            console.log('[INFO] Matriz Riesgo:', this.metrics.riskMatrix);

                            // üéØ OPCI√ìN 2: FORECAST DE COMPRA (30 y 45 d√≠as)
                            const forecast30 = {}; const forecast45 = {};
                            this.masterData.forEach(item => {
                                if(item.comprarU > 0) {
                                    const prov = item.prov || 'S/D';
                                    const inv = item.inversion || 0;
                                    
                                    // A 30 d√≠as: SKUs con cobertura < 30
                                    if(item.diasStock < 30) {
                                        if(!forecast30[prov]) forecast30[prov] = { count: 0, monto: 0, items: [] };
                                        forecast30[prov].count++;
                                        forecast30[prov].monto += inv;
                                        forecast30[prov].items.push({sku: item.sku, inv});
                                    }
                                    
                                    // A 45 d√≠as: SKUs con cobertura < 45
                                    if(item.diasStock < 45) {
                                        if(!forecast45[prov]) forecast45[prov] = { count: 0, monto: 0, items: [] };
                                        forecast45[prov].count++;
                                        forecast45[prov].monto += inv;
                                        forecast45[prov].items.push({sku: item.sku, inv});
                                    }
                                }
                            });
                            
                            this.metrics.forecast30 = Object.entries(forecast30)
                                .map(([prov, data]) => ({prov, ...data, monto: data.monto.toFixed(0)}))
                                .sort((a,b) => b.monto - a.monto);
                            
                            this.metrics.forecast45 = Object.entries(forecast45)
                                .map(([prov, data]) => ({prov, ...data, monto: data.monto.toFixed(0)}))
                                .sort((a,b) => b.monto - a.monto);
                            
                            const totalFc30 = this.metrics.forecast30.reduce((a,b) => a + parseFloat(b.monto), 0);
                            const totalFc45 = this.metrics.forecast45.reduce((a,b) => a + parseFloat(b.monto), 0);
                            this.metrics.forecastSummary = { f30: totalFc30.toFixed(0), f45: totalFc45.toFixed(0) };
                            console.log('[INFO] Forecast:', this.metrics.forecastSummary);

                            // üéØ OPCI√ìN 3: AN√ÅLISIS LEAD TIME vs COBERTURA
                            const ltAnalysis = { CRITICAL: [], AT_RISK: [], OK: [] };
                            this.masterData.forEach(item => {
                                if(item.stockGrafana > 0) {
                                    const cobertura = item.vtarTotal > 0 ? (item.stockGrafana / item.vtarTotal) : 0;
                                    const lt = item.lt || 0;
                                    const gap = lt - cobertura;
                                    
                                    const risk = {
                                        sku: item.sku,
                                        desc: item.desc,
                                        lt: lt,
                                        cobertura: cobertura.toFixed(1),
                                        gap: gap.toFixed(1),
                                        status: gap > 5 ? 'üî¥ CR√çTICO' : (gap > 0 ? 'üü† RIESGO' : 'üü¢ OK')
                                    };
                                    
                                    if(gap > 5) ltAnalysis.CRITICAL.push(risk);
                                    else if(gap > 0) ltAnalysis.AT_RISK.push(risk);
                                    else ltAnalysis.OK.push(risk);
                                }
                            });
                            
                            this.metrics.ltAnalysis = {
                                CRITICAL: ltAnalysis.CRITICAL.slice(0, 20),
                                AT_RISK: ltAnalysis.AT_RISK.slice(0, 20),
                                OK: ltAnalysis.OK.slice(0, 20),
                                criticalCount: ltAnalysis.CRITICAL.length,
                                atRiskCount: ltAnalysis.AT_RISK.length
                            };
                            console.log('[INFO] Lead Time Analysis:', this.metrics.ltAnalysis);

                            // üéØ HEALTH SCORE - CORREGIDO
                            // 1. COBERTURA (40%): % de SKUs con stock entre 15-45 d√≠as (rango saludable)
                            const skusConStock = this.masterData.filter(m => m.stockGrafana > 0);
                            const skusSaludables = skusConStock.filter(m => {
                                const diasStock = m.vtarTotal > 0 ? m.stockGrafana / m.vtarTotal : 0;
                                return diasStock >= 15 && diasStock <= 45;
                            }).length;
                            const coberturaScore = skusConStock.length > 0 
                                ? (skusSaludables / skusConStock.length) * 100 
                                : 0;
                            
                            // 2. ROTACI√ìN (25%): % de SKUs activos (con venta > 0)
                            const skusActivos = this.masterData.filter(m => m.vtarTotal > 0).length;
                            const rotacionScore = this.masterData.length > 0 
                                ? (skusActivos / this.masterData.length) * 100 
                                : 0;
                            
                            // 3. EFICIENCIA CAPITAL (20%): % del capital en productos que rotan (no inmovilizados)
                            const capitalTotal = this.masterData.reduce((a,m) => a + (m.stockValorizado || 0), 0);
                            const capitalSaludable = this.masterData.filter(m => {
                                const diasStock = m.vtarTotal > 0 ? m.stockGrafana / m.vtarTotal : 999;
                                return diasStock <= 45; // No inmovilizado
                            }).reduce((a,m) => a + (m.stockValorizado || 0), 0);
                            const capitalScore = capitalTotal > 0 ? (capitalSaludable / capitalTotal) * 100 : 50;
                            
                            // 4. GESTI√ìN CARGOS (15%): Inverso de cargos vs historial
                            const cargosTotal = this.metrics.totalDeudaAnalistas || 0;
                            const cargosHistAvg = this.debtHistory.length > 0 
                                ? this.debtHistory.reduce((a,d) => a + (d.val || 0), 0) / this.debtHistory.length
                                : 0;
                            const cargosScore = cargosHistAvg > 0 
                                ? Math.min(100, Math.max(0, 100 - (cargosTotal / cargosHistAvg) * 50))
                                : (cargosTotal === 0 ? 100 : 50);
                            
                            // SCORE FINAL PONDERADO
                            const healthScore = Math.round(
                                (coberturaScore * 0.4) + 
                                (rotacionScore * 0.25) + 
                                (capitalScore * 0.2) + 
                                (cargosScore * 0.15)
                            );
                            
                            // TENDENCIA: Comparar con historial previo si existe
                            let healthTrend = '‚Üí';
                            if (this.historyData && this.historyData.length > 1) {
                                const prevHealthScore = this.metrics.healthScore?.overall || healthScore;
                                if (healthScore > prevHealthScore + 2) healthTrend = '‚Üë';
                                else if (healthScore < prevHealthScore - 2) healthTrend = '‚Üì';
                            }
                            
                            this.metrics.healthScore = {
                                overall: healthScore,
                                trend: healthTrend,
                                components: {
                                    cobertura: Math.round(coberturaScore),
                                    rotacion: Math.round(rotacionScore),
                                    capital: Math.round(capitalScore),
                                    deuda: Math.round(cargosScore)
                                },
                                details: {
                                    skusSaludables: skusSaludables,
                                    skusConStock: skusConStock.length,
                                    skusActivos: skusActivos,
                                    capitalSaludable: capitalSaludable,
                                    capitalTotal: capitalTotal
                                }
                            };
                            console.log('[INFO] Health Score:', this.metrics.healthScore);

                            // üö® OPCI√ìN 1: ALERTAS Y BANDERAS VISUALES
                            // Calcular mediana de VTAR para comparaci√≥n
                            const vtars = this.masterData.map(m => m.vtarTotal || 0).sort((a,b) => a-b);
                            const medianVtar = vtars[Math.floor(vtars.length/2)] || 5;
                            
                            this.masterData.forEach(item => {
                                let alerta = null;
                                const cobertura = (item.stockGrafana || 0) / (item.vtarTotal || 1);
                                const gap = (item.lt || 0) - cobertura;
                                
                                try {
                                    if(item.diasStock < 5 && item.vtarTotal > medianVtar) {
                                        alerta = { nivel: 'CR√çTICO', icono: 'üî¥', texto: 'Stock cr√≠tico + Alta demanda' };
                                    } else if(item.diasStock < 10 && gap > 0) {
                                        alerta = { nivel: 'CR√çTICO', icono: 'üî¥', texto: 'Lead Time > Cobertura' };
                                    } else if(item.diasStock > 30 && item.vtarTotal < medianVtar) {
                                        alerta = { nivel: 'ATENCI√ìN', icono: 'üü°', texto: 'Dinero congelado' };
                                    } else if(item.diasStock < 15 && item.vtarTotal > medianVtar) {
                                        alerta = { nivel: 'ATENCI√ìN', icono: 'üü°', texto: 'Stock bajo + Demanda alta' };
                                    } else {
                                        alerta = { nivel: 'OK', icono: 'üü¢', texto: 'Normal' };
                                    }
                                } catch(e) {
                                    alerta = { nivel: 'OK', icono: 'üü¢', texto: 'Normal' };
                                }
                                item.alerta = alerta;
                            });

                            // üéØ OPCI√ìN 4: SUGERENCIAS DE ACCI√ìN AUTOM√ÅTICAS
                            const sugerencias = [];
                            this.masterData.forEach(item => {
                                try {
                                    if(item.diasStock < 5 && item.vtarTotal > medianVtar) {
                                        sugerencias.push({
                                            prioridad: 1,
                                            icono: 'üö®',
                                            titulo: 'COMPRA URGENTE',
                                            sku: item.sku,
                                            desc: item.desc,
                                            detalle: `Stock ${item.diasStock.toFixed(1)}d, VTAR ${item.vtarTotal.toFixed(1)}, necesita ${Math.ceil(item.vtarTotal * 30)} unid.`
                                        });
                                    } else if((item.lt || 0) - (item.stockGrafana / (item.vtarTotal || 1)) > 5) {
                                        sugerencias.push({
                                            prioridad: 1,
                                            icono: '‚è±Ô∏è',
                                            titulo: 'RIESGO LEAD TIME',
                                            sku: item.sku,
                                            desc: item.desc,
                                            detalle: `LT ${item.lt}d > Cobertura ${(item.stockGrafana / (item.vtarTotal || 1)).toFixed(1)}d`
                                        });
                                    } else if(item.diasStock > 45 && item.vtarTotal < medianVtar) {
                                        sugerencias.push({
                                            prioridad: 2,
                                            icono: 'üí∞',
                                            titulo: 'LIQUIDAR STOCK',
                                            sku: item.sku,
                                            desc: item.desc,
                                            detalle: `${item.stockGrafana} unidades en ${item.diasStock.toFixed(1)} d√≠as`
                                        });
                                    } else if(item.diasStock < 20 && item.diasStock > 0) {
                                        const proximo30 = item.vtarTotal * 30;
                                        if(proximo30 > 100) {
                                            sugerencias.push({
                                                prioridad: 2,
                                                icono: 'üìà',
                                                titulo: 'PREPARAR COMPRA',
                                                sku: item.sku,
                                                desc: item.desc,
                                                detalle: `Proyectado ${Math.ceil(proximo30)} unid. en 30 d√≠as`
                                            });
                                        }
                                    }
                                } catch(e) {
                                    // Skip item si hay error
                                }
                            });
                            sugerencias.sort((a,b) => a.prioridad - b.prioridad);
                            this.sugerencias = sugerencias.slice(0, 20); // Top 20

                            // üìä OPCI√ìN 2: DASHBOARD KPI EJECUTIVO
                            // Calcular m√©tricas adicionales
                            const skusConStockKpi = this.masterData.filter(m => m.stockGrafana > 0).length;
                            const skusTotales = this.masterData.length;
                            const fillRate = skusTotales > 0 ? (skusConStockKpi / skusTotales) * 100 : 0;
                            
                            const stockTotal = this.masterData.reduce((a,m) => a + (m.stockGrafana || 0), 0);
                            const venta30dTotal = this.masterData.reduce((a,m) => a + (m.vta30d || 0), 0);
                            const rotacionInv = stockTotal > 0 ? venta30dTotal / stockTotal : 0;
                            
                            // Forecast: Relaci√≥n VTAR vs VPD (cumplimiento del objetivo)
                            // VPD = Venta Proyectada (objetivo/meta), VTAR = Venta hist√≥rica real
                            const vtarTotalSum = this.masterData.reduce((a,m) => a + (m.vtarTotal || 0), 0);
                            const vpdTotalSum = this.masterData.reduce((a,m) => a + (m.vpdCpra || 0), 0);
                            
                            // Forecast = (VTAR / VPD) * 100
                            // >100% = Se super√≥ el objetivo, <100% = No se alcanz√≥ el objetivo
                            let forecastRatio = 0;
                            if(vpdTotalSum > 0) {
                                forecastRatio = (vtarTotalSum / vpdTotalSum) * 100;
                            }
                            
                            const ventaPerdidaTotal = this.masterData.reduce((a,m) => a + (m.ventaPerdida || 0), 0);
                            const deudaTotalKpi = this.masterData.reduce((a,m) => a + (m.deuda || 0), 0);
                            
                            this.kpiDashboard = {
                                criticos: this.masterData.filter(m => m.diasStock < 5 && m.vtarTotal > medianVtar).length,
                                dineroViejo: this.masterData
                                    .filter(m => m.diasStock > 45)
                                    .reduce((a,m) => a + ((m.stockGrafana || 0) * (m.costo || 0)), 0),
                                stockTotal: Math.ceil(this.masterData.reduce((a,m) => a + (m.stockValorizado || 0), 0)),
                                skusActivos: this.masterData.filter(m => m.stockGrafana > 0 || m.vta30d > 0).length,
                                fillRate,
                                rotacionInv,
                                forecastRatio,
                                vtarTotalSum,
                                vpdTotalSum,
                                ventaPerdidaTotal,
                                deudaTotal: deudaTotalKpi
                            };
                            console.log('[INFO] KPI Dashboard:', this.kpiDashboard);
                            console.log('[INFO] Sugerencias:', this.sugerencias.length);

                            const anaDebt = {}; let totalDebt = 0;
                            const anaStats = {};
                            this.masterData.forEach(i => {
                                if(i.deuda>0) {
                                    const a=i.analista||'S/D';
                                    anaDebt[a]=(anaDebt[a]||0)+i.deuda;
                                    totalDebt += i.deuda;

                                    if(!anaStats[a]) anaStats[a] = { name: a, debt: 0, count: 0, units: 0 };
                                    anaStats[a].debt += i.deuda;
                                    anaStats[a].count += 1;
                                    anaStats[a].units += (i.unidadesCargo || 0);
                                }
                            });
                            this.metrics.analistas = Object.entries(anaDebt).map(([name,val])=>({name,val})).sort((a,b)=>b.val-a.val);
                            this.metrics.analistasTable = Object.values(anaStats).sort((a,b)=>b.debt-a.debt);
                            this.metrics.totalDeudaAnalistas = totalDebt;
                            DB.saveDebtHistory(totalDebt);

                            const provMap = {};
                            this.simplexData.filter(d => (d.prov || '').toUpperCase().includes(query)).forEach(d => {
                                const key = d.prov + '_' + d.year;
                                if(!provMap[key]) {
                                    provMap[key] = {
                                        prov: d.prov, analista: d.analista,
                                        puntoVenta: '-', qTotal: 0, ventaTotal: 0, year: d.year,
                                        totalStockVal: 0, // Importe stock actual
                                        inmoVal: 0,       // Importe sobrestock >45d
                                        inversion: 0,    // Total inversi√≥n a realizar
                                        ...initMeses()
                                    };
                                }
                                provMap[key].qTotal += d.qTotal || 0;
                                provMap[key].ventaTotal += d.ventaTotal || 0;
                                provMap[key].totalStockVal += d.totalStockVal || 0;
                                provMap[key].inmoVal += d.inmoVal || 0;
                                provMap[key].inversion += d.inversion || 0;
                                const meses = d.year === 2025 ? this.simplexMeses2025 : this.simplexMeses2026;
                                meses.forEach(mes => {
                                    if(provMap[key][mes] && d[mes]) {
                                        provMap[key][mes].q += d[mes].q || 0;
                                        provMap[key][mes].venta += d[mes].venta || 0;
                                    }
                                });
                            });
                            results = Object.values(provMap);
                            let provBuy = {};
                            let brandMap = {};
                            this.masterData.forEach(i => {
                                if(i.inversion>0) { const p=i.prov||'S/D'; provBuy[p]=(provBuy[p]||0)+i.inversion; }
                                const b = i.marca || 'S/D';
                                const val = i.stockGrafana * i.costo;
                                brandMap[b] = (brandMap[b] || 0) + val;
                            });
                            this.metrics.proveedores = Object.entries(provBuy).map(([name,val])=>({name,val})).sort((a,b)=>b.val-a.val).slice(0,20);

                            const sortedBrands = Object.entries(brandMap).map(([name,val])=>({name,val})).sort((a,b)=>b.val-a.val);
                            if (sortedBrands.length > 15) {
                                const top = sortedBrands.slice(0, 14);
                                const others = sortedBrands.slice(14).reduce((acc, curr) => acc + curr.val, 0);
                                top.push({ name: 'OTROS', val: others });
                                this.metrics.brands = top;
                            } else {
                                this.metrics.brands = sortedBrands;
                            }

                            let h={q:0, pq:0, s:0, a:0, o:0};
                            this.masterData.forEach(i => {
                                if(i.stockGrafana > 0) {
                                    const d = i.diasStock;
                                    if(d <= 10) h.q++;
                                    else if(d <= 17) h.pq++;
                                    else if(d <= 30) h.s++;
                                    else if(d <= 45) h.a++;
                                    else h.o++;
                                }
                            });
                            this.metrics.health = h;

                            this.metrics.huesos = this.masterData
                                .filter(i => i.vtarTotal <= 0.1 && i.stockGrafana > 0 && i.stockValorizado > 0)
                                .sort((a,b) => b.stockValorizado - a.stockValorizado)
                                .slice(0, 5);

                            this.metrics.topRisks = this.masterData
                                .filter(i => i.stockGrafana > 0 && i.diasStock < i.lt)
                                .sort((a,b) => a.diasStock - b.diasStock)
                                .slice(0, 5)
                                .map(i => ({
                                    sku: i.sku,
                                    desc: i.desc,
                                    stock: i.stockGrafana,
                                    vtar: i.vtarTotal.toFixed(1),
                                    days: i.diasStock
                                }));

                            const devBuckets = { '>150%': 0, '126-150%': 0, '101-125%': 0, '76-100%': 0, '51-75%': 0, '1-50%': 0, '-1 to -50%': 0, '-51 to -75%': 0, '-76 to -100%': 0 };
                            let totalValid = 0;
                            this.masterData.forEach(i => {
                                const vpd = i.vpdCpra || 0;
                                if (vpd > 0) {
                                    totalValid++;
                                    const diff = ((i.vtarTotal - vpd) / vpd) * 100;
                                    if(diff > 150) devBuckets['>150%']++;
                                    else if(diff > 125) devBuckets['126-150%']++;
                                    else if(diff > 100) devBuckets['101-125%']++;
                                    else if(diff > 75) devBuckets['76-100%']++;
                                    else if(diff > 50) devBuckets['51-75%']++;
                                    else if(diff >= 1) devBuckets['1-50%']++;
                                    else if(diff <= -76) devBuckets['-76 to -100%']++;
                                    else if(diff <= -51) devBuckets['-51 to -75%']++;
                                    else if(diff <= -1) devBuckets['-1 to -50%']++;
                                }
                            });
                            const devStats = {};
                            Object.keys(devBuckets).forEach(key => { devStats[key] = totalValid > 0 ? ((devBuckets[key] / totalValid) * 100).toFixed(1) : 0; });
                            this.metrics.deviationStats = devStats;

                            const profStats = {};
                            let totalValStock = 0;
                            
                            this.masterData.forEach(item => {
                                const p = item.perfil || 'Sin Clasificar';
                                const val = item.stockValorizado || 0;
                                
                                if(!profStats[p]) profStats[p] = { name: p, count: 0, money: 0 };
                                profStats[p].count++;
                                profStats[p].money += val;
                                totalValStock += val;
                            });

                            this.metrics.profiles = Object.values(profStats)
                                .map(p => ({
                                    ...p,
                                    pct: totalValStock > 0 ? (p.money / totalValStock * 100).toFixed(1) : 0
                                }))
                                .sort((a,b) => b.money - a.money); 

                            // üõí M√âTRICAS DE SHARE DE MERCADO - Calcular din√°micamente seg√∫n mes seleccionado
                            this.updateShareMetrics();

                            // üìä SIMPLEX2025 - Procesar datos de ventas por mes
                            this.processSimplexData();

                            this.updateKPIs();
                            this.calculateColumnMaxes();
                            this.isLoading = false; this.dataReady = true;
                            
                            // Logging de rendimiento
                            const endTime = performance.now();
                            const processingTime = ((endTime - startTime) / 1000).toFixed(2);
                            console.log(`[INFO] ‚úÖ Procesamiento completado en ${processingTime}s`);
                            console.log('[INFO] SKUs procesados:', this.masterData.length);
                            console.log('[INFO] Dashboard - Datos disponibles para b√∫squeda:', {
                                masterDataLength: this.masterData.length,
                                flatDataLength: this.flatData.length,
                                primeraLinea: this.masterData[0]?.sku
                            });
                            
                            if(this.currentTab === 'metricas') this.renderCharts();

                        } catch (e) { 
                            console.error("[ERROR] CR√çTICO:", e.message); 
                            console.error("[ERROR] Stack:", e.stack);
                            alert("‚ùå Error cr√≠tico procesando datos: " + e.message + "\n\nRevisa la consola (F12) para m√°s detalles."); 
                            this.isLoading = false; 
                        }
                    }, 50);
                },






               calculateRowLogic(item) {
                    const pbi = item.pbi || {dep1:0, dep80:0};
                    const stockSucTotal = [81,82,83,87,89].reduce((a,n)=>a+(pbi[`dep${n}`]||0), 0);
                    let reservaSuc = Math.ceil((item.vtarSuc * this.params.diasSuc) - stockSucTotal); if(reservaSuc < 0) reservaSuc = 0;
                    const reservaDep1 = Math.ceil(item.vtar1 * this.params.diasSuc);
                    const disponibleParaEnviar = Math.max(0, pbi.dep1 - reservaSuc - reservaDep1);
                    const demanda80 = Math.ceil(item.vtar80 * this.params.diasFull);
                    const necesidad80 = Math.max(0, demanda80 - pbi.dep80);
                    const stockRed = pbi.dep1 + stockSucTotal + pbi.dep80 + item.comprasEnCamino;

                    const dev = item.dev || 0;
                    const lt = item.lt || 30;
                    const ss = Math.ceil(2.33 * item.vtarTotal * Math.sqrt(lt));
                    const stockMin = Math.ceil((item.vtarTotal * lt) + ss);
                    let stockMax = Math.ceil(item.vtarTotal * 30);
                    if (stockMax < stockMin) stockMax = stockMin;

                    // --- DATOS EXTERNOS ---
                    const mlData = this.lookups.mapML && this.lookups.mapML[item.sku];
                    const isImpulse = mlData ? mlData.impulsar : item.impulsar;
                    const statusML = mlData ? mlData.estado : 'S/D';
                    const qualityML = mlData ? mlData.calidad : 'S/D';

                    const cargoData = this.lookups.mapCargos && this.lookups.mapCargos[item.sku];
                    const deudaVal = cargoData ? cargoData.monto : (item.deuda||0);
                    const unitVal = cargoData ? cargoData.unidades : (item.unidadesCargo||0);
                    const antiguedadStock = cargoData ? cargoData.antiguedad : '';

                    const planML = this.lookups.mapPlanML && this.lookups.mapPlanML[item.sku];
                    const mlRecomendacion = planML ? planML.rec : '';
                    const mlSugerido = planML ? planML.sug : 0;
                    const mlEsUrgente = planML ? planML.esUrgente : false;
                    
                    const envHist = (this.lookups.mapEnvios && this.lookups.mapEnvios[item.sku]) ? this.lookups.mapEnvios[item.sku] : (item.enviadoHist||0);
                    
                    // --- FLAG BLOQUEADO (viene directo de Grafana) ---
                    const bloqueado = item.bloqueado || false;
                    
                    // --- MLA (C√≥digo publicaci√≥n Mercado Libre - Dep80) ---
                    const mlaData = this.lookups.mapMLA && this.lookups.mapMLA[item.sku];
                    const mla = mlaData ? mlaData.mla : '';
                    const estadoMLA = mlaData ? mlaData.estado : '';
                    
                    // --- EAN (desde STA19) ---
                    const sta19Data = this.lookups.mapSTA19 && this.lookups.mapSTA19[item.sku];
                    const ean = sta19Data ? sta19Data.ean : '';
                    
                    // --- C√ÅLCULO DE COMPRA (OPTIMIZADO POR BULTOS) ---
                    let necesidadExacta = 0;
                    const strategyDays = item.diasEstrategia;
                    const hasStrategy = (strategyDays !== undefined && strategyDays !== null && strategyDays !== "");
                    const coverageDays = hasStrategy ? parseFloat(strategyDays) : (this.params.diasCompra || 30);

                    // üîÑ SELECCI√ìN DE BASE DE C√ÅLCULO: VTAR (hist√≥rico) o VPD (proyectado)
                    const baseVenta = this.calcMethod === 'vpd' && item.vpdCpra > 0 
                        ? item.vpdCpra 
                        : item.vtarTotal;
                    
                    let vtarCalc = baseVenta;
                    if (item.seasonalMult && item.seasonalMult !== 1) vtarCalc = baseVenta * item.seasonalMult;

                    if(!isImpulse && vtarCalc > 0) {
                        const targetStock = Math.ceil((vtarCalc * coverageDays) + ss);
                        if(hasStrategy || stockRed < stockMin) necesidadExacta = Math.max(0, targetStock - stockRed);
                        else if(stockRed < stockMin) necesidadExacta = Math.max(0, stockMax - stockRed);
                    }
                    
                    // L√ìGICA DE BULTOS (UXB)
                    const uxb = item.uxb || 1; // Unidades por bulto (defecto 1)
                    let cantBultos = 0;
                    let comprarU = 0;
                    
                    if (necesidadExacta > 0) {
                        // Redondeamos SIEMPRE hacia arriba para cerrar la caja
                        cantBultos = Math.ceil(necesidadExacta / uxb);
                        comprarU = cantBultos * uxb;
                    }
                    // -------------------------------------------------

                    let diasStock = item.vtarTotal > 0 ? item.stockGrafana / item.vtarTotal : (item.stockGrafana===0?0:999);
                    let diasStock80 = item.vtar80 > 0 ? pbi.dep80 / item.vtar80 : (pbi.dep80===0?0:999);

                    let runOutDate = '‚àû';
                    let runOutCritical = false;
                    if (item.vtarTotal > 0 && diasStock < 999) {
                        const d = new Date(); d.setDate(d.getDate() + Math.floor(diasStock));
                        runOutDate = d.toLocaleDateString('es-AR');
                        if (diasStock <= 3) runOutCritical = true;
                    } else if (item.stockGrafana <= 0) {
                         runOutDate = new Date().toLocaleDateString('es-AR'); runOutCritical = true;
                    }

                    let healthStatus = 'Sobrestock';
                    if(diasStock <= 10) healthStatus = 'Quiebre';
                    else if(diasStock <= 17) healthStatus = 'Por Quebrar';
                    else if(diasStock <= 30) healthStatus = 'Saludable';
                    else if(diasStock <= 45) healthStatus = 'Alerta';

                    // --- VENTA PERDIDA ---
                    let ventaPerdida = 0;
                    const perfilNormalizado = String(item.perfil || '').toUpperCase();
                    if (stockRed <= 0 && item.vtarTotal > 0 && perfilNormalizado.includes('ACTIVO')) {
                        ventaPerdida = item.vtarTotal * item.costo;
                    }

                    // --- ARBITRAJE ---
                    let isArbitrage = false;
                    let arbitrageVal = 0;
                    if (diasStock80 <= 7 && Math.min(disponibleParaEnviar, necesidad80) > 0) {
                        isArbitrage = true;
                        arbitrageVal = Math.min(disponibleParaEnviar, necesidad80) * item.costo;
                    }

                    return {
                        ...item, impulsar: isImpulse, diasStock, diasStock80,
                        stockRestante: disponibleParaEnviar, debugDemanda80: demanda80, debugReservaSuc: reservaSuc, debugReserva1: reservaDep1,
                        qEnviar: Math.min(disponibleParaEnviar, necesidad80), valorizado: Math.min(disponibleParaEnviar, necesidad80) * item.costo,
                        
                        comprarU, // Cantidad final redondeada
                        cantBultos, // NUEVO: Cantidad de cajas
                        uxb,        // NUEVO: Unidades por caja
                        inversion: comprarU * item.costo, 
                        
                        deuda: deudaVal, unidadesCargo: unitVal, enviadoHist: envHist,
                        ss, stockMin, stockMax, stockValorizado: item.stockGrafana * item.costo,
                        criticalGap: (diasStock < lt) && (item.vtarTotal > 0),
                        estadoSalud: healthStatus, vtarIa: item.vtarIa, isAnomaly: item.isAnomaly,
                        runOutDate, runOutCritical, statusML, qualityML, antiguedadStock,
                        mlRecomendacion, mlSugerido, mlEsUrgente,
                        ventaPerdida,
                        isArbitrage, arbitrageVal,
                        bloqueado,
                        mla, estadoMLA, ean,
                        // SOBRESTOCK: Unidades que exceden los 45 d√≠as
                        unidadesExcedentes: diasStock > 45 && item.vtarTotal > 0 
                            ? Math.round((diasStock - 45) * item.vtarTotal) 
                            : 0,
                        costoExcedente: diasStock > 45 && item.vtarTotal > 0 
                            ? Math.round((diasStock - 45) * item.vtarTotal) * item.costo 
                            : 0,
                        pctExcedente: diasStock > 45 && item.vtarTotal > 0 && item.stockGrafana > 0
                            ? Math.round(((diasStock - 45) * item.vtarTotal) / item.stockGrafana * 100 * 10) / 10
                            : 0
                    };
                },






                renderSparkline(data, w=60, h=25) {
                    if (!data || data.length < 2) return '';

                    // 1. Normalizar datos
                    const max = Math.max(...data);
                    const min = Math.min(...data);
                    const range = max - min || 1;
                    
                    const points = data.map((val, i) => {
                        const x = (i / (data.length - 1)) * w;
                        const y = h - ((val - min) / range * h); 
                        return [x, y];
                    });

                    // 2. Suavizado de curvas (B√©zier)
                    const line = (pointA, pointB) => {
                        const lengthX = pointB[0] - pointA[0];
                        const lengthY = pointB[1] - pointA[1];
                        return {
                            length: Math.sqrt(Math.pow(lengthX, 2) + Math.pow(lengthY, 2)),
                            angle: Math.atan2(lengthY, lengthX)
                        };
                    };

                    const controlPoint = (current, previous, next, reverse) => {
                        const p = previous || current;
                        const n = next || current;
                        const o = line(p, n);
                        const angle = o.angle + (reverse ? Math.PI : 0);
                        const length = o.length * 0.2; 
                        const x = current[0] + Math.cos(angle) * length;
                        const y = current[1] + Math.sin(angle) * length;
                        return [x, y];
                    };

                    const bezierCommand = (point, i, a) => {
                        const [cpsX, cpsY] = controlPoint(a[i - 1], a[i - 2], point);
                        const [cpeX, cpeY] = controlPoint(point, a[i - 1], a[i + 1], true);
                        return `C ${cpsX.toFixed(1)},${cpsY.toFixed(1)} ${cpeX.toFixed(1)},${cpeY.toFixed(1)} ${point[0].toFixed(1)},${point[1].toFixed(1)}`;
                    };

                    // 3. Construir el PATH
                    let d = `M ${points[0][0].toFixed(1)},${points[0][1].toFixed(1)}`;
                    for (let i = 1; i < points.length; i++) {
                        d += ' ' + bezierCommand(points[i], i, points);
                    }

                    // 4. Colores Din√°micos (Verde sube / Rojo baja)
                    const isUp = data[data.length - 1] >= data[0]; 
                    const strokeColor = isUp ? '#10b981' : '#f43f5e'; 
                    const fillColor = isUp ? '#ecfdf5' : '#fff1f2';   

                    const fillPath = `${d} L ${w},${h} L 0,${h} Z`;

                    return `
                        <svg width="${w}" height="${h}" overflow="visible">
                            <path d="${fillPath}" fill="${fillColor}" stroke="none" />
                            <path d="${d}" fill="none" stroke="${strokeColor}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    `;
                },

                get filteredData() {
                    let d = this.masterData;
                    if(this.currentTab === 'detalle') d = this.flatData;
                    else if(this.currentTab === 'enviados') d = this.enviosData;
                    else if(this.currentTab === 'vencimientos') d = this.lotesData;
                    else if(this.currentTab === 'proveedores') d = this.proveedoresData;
                    else if(this.currentTab === 'otros_depositos') {
                        d = this.otherDepositsData.filter(i => this.selectedOtherDeps.includes(i.deposito));
                        
                        // Los env√≠os de HIST. ENVIOS son solo para dep√≥sito 80
                        // Recalcular enviadoHist: solo dep√≥sito 80 tiene env√≠os, otros muestran 0
                        if (this.selectedEnvioFechas.length > 0) {
                            const enviosPorSku = {};
                            this.enviosData.forEach(e => {
                                if(this.selectedEnvioFechas.includes(e.fecha)) {
                                    enviosPorSku[e.sku] = (enviosPorSku[e.sku] || 0) + (e.cant || 0);
                                }
                            });
                            d = d.map(item => ({
                                ...item,
                                // Solo dep√≥sito 80 tiene env√≠os, otros dep√≥sitos muestran 0
                                enviadoHist: item.deposito === '80' ? (enviosPorSku[item.sku] || 0) : 0
                            }));
                        } else {
                            // Sin filtro de fechas: solo dep 80 muestra enviadoHist, otros 0
                            d = d.map(item => ({
                                ...item,
                                enviadoHist: item.deposito === '80' ? (item.enviadoHist || 0) : 0
                            }));
                        }
                    }
                    if (this.filterOpportunityCost) {
                        d = d.filter(i => i.ventaPerdida > 0);
                    }
                    if (this.filterAging) {
                        const f = this.filterAging;
                        d = d.filter(i => {
                            const ds = i.diasStock;
                            if(f === '0-30d') return ds <= 30;
                            if(f === '31-60d') return ds > 30 && ds <= 60;
                            if(f === '61-90d') return ds > 60 && ds <= 90;
                            if(f === '91-180d') return ds > 90 && ds <= 180;
                            if(f === '>180d') return ds > 180;
                            return true;
                        });
                    if (this.filterArbitrage) {
                        d = d.filter(i => i.isArbitrage);
                    }
                    }

                    if(this.currentTab === 'dep80') {
                        d = d.filter(i => i.qEnviar > 0);
                        
                        if (this.filterMLUrgencies) {
                            d = d.filter(i => i.mlEsUrgente);
                        }

                        // Recalcular enviadoHist seg√∫n fechas seleccionadas
                        if (this.selectedEnvioFechas.length > 0) {
                            // Calcular env√≠os solo de las fechas seleccionadas
                            const enviosPorSku = {};
                            this.enviosData.forEach(e => {
                                if(this.selectedEnvioFechas.includes(e.fecha)) {
                                    enviosPorSku[e.sku] = (enviosPorSku[e.sku] || 0) + (e.cant || 0);
                                }
                            });
                            
                            // Filtrar solo SKUs con env√≠os en esas fechas y actualizar enviadoHist
                            d = d.filter(i => enviosPorSku[i.sku] !== undefined)
                                 .map(item => ({
                                     ...item,
                                     enviadoHist: enviosPorSku[item.sku] || 0
                                 }));
                        }
                    }
                    else if(this.currentTab === 'resumen') d = d.filter(i => i.comprarU > 0 || i.comprasEnCamino > 0);
                    else if(this.currentTab === 'cargos') d = d.filter(i => i.deuda > 0 || i.unidadesCargo > 0);
                    else if(this.currentTab === 'combos') d = d.filter(i => (i.perfil || '').toUpperCase() === 'COMBO');
                    else if(this.currentTab === 'inmovilizado') {
                        // üßä Aplicar filtros de stock viejo seleccionados
                        const filters = this.stockViejoFilters.length > 0 ? this.stockViejoFilters : ['>45'];
                        const minDays = Math.min(...filters.map(f => parseInt(f.replace('>', ''))));
                        d = d.filter(i => i.diasStock > minDays);
                    }

                    // üîó Filtro KPI desde Dashboard
                    if (this.kpiFilter === 'criticos') {
                        const vtars = this.masterData.map(m => m.vtarTotal || 0).sort((a,b) => a-b);
                        const medianVtar = vtars[Math.floor(vtars.length/2)] || 5;
                        d = d.filter(i => i.diasStock < 5 && i.vtarTotal > medianVtar);
                    }
                    
                    // üì¶ Filtro KPI Stock Sin Venta (por d√≠as desde √∫ltima venta)
                    if (this.kpiFilter === 'stockSinVenta' && this.stockSinVentaFilters.length > 0) {
                        d = d.filter(i => {
                            if (!(i.stockGrafana > 0 && i.vtarTotal === 0 && this.getDiasSinVenta(i) > 0)) return false;
                            const dias = this.getDiasSinVenta(i);
                            return this.stockSinVentaFilters.some(f => {
                                if(f === '20-30') return dias >= 20 && dias <= 30;
                                if(f === '31-40') return dias >= 31 && dias <= 40;
                                if(f === '41-50') return dias >= 41 && dias <= 50;
                                if(f === '>51') return dias > 51;
                                return false;
                            });
                        });
                    }

                    if(this.activeFilters['abc_xyz']) {
                        const code = this.activeFilters['abc_xyz'][0];
                        d = d.filter(i => i.abc_xyz === code);
                    }

                    if(this.currentTab === 'vencimientos' && this.filterLotesRanges.length > 0) {
                        d = d.filter(l => {
                            const dias = l.dias;
                            return this.filterLotesRanges.some(range => {
                                if(range === '0-30') return dias <= 30;
                                if(range === '31-60') return dias > 30 && dias <= 60;
                                if(range === '61-90') return dias > 60 && dias <= 90;
                                if(range === '91-120') return dias > 90 && dias <= 120;
                                if(range === '121-150') return dias > 120 && dias <= 150;
                                if(range === '150+') return dias > 150;
                                return false;
                            });
                        });
                    }
                    if(this.currentTab === 'enviados' && this.selectedEnvioFechas.length > 0) d = d.filter(e => this.selectedEnvioFechas.includes(e.fecha));

                    if(this.search) {
                        const q = this.search.toUpperCase();
                        d = d.filter(i => String(i.sku||'').toUpperCase().includes(q) || String(i.desc||'').toUpperCase().includes(q) || String(i.marca||'').toUpperCase().includes(q) || String(i.prov||'').toUpperCase().includes(q));
                    }

                    Object.keys(this.activeFilters).forEach(key => {
                        const allowed = this.activeFilters[key];
                        if(allowed && allowed.length > 0 && key !== 'abc_xyz') {
                            d = d.filter(row => allowed.includes(String(row[key]||'')));
                        }
                    });

                    if (this.focusMode) {
                        d = d.filter(row => {
                            const stockProblem = row.diasStock <= 17; 
                            const mlProblem = row.mlEsUrgente || (row.statusML && row.statusML !== 'Activa' && row.statusML !== 'S/D');
                            const oldStock = row.antiguedadStock && (row.antiguedadStock.includes('6') || row.antiguedadStock.includes('12'));
                            return stockProblem || mlProblem || oldStock;
                        });
                    }

                    return d.sort((a,b) => {
                        let va = a[this.sortCol]||"", vb = b[this.sortCol]||"";
                        if (typeof va === 'string') va = va.toLowerCase(); if (typeof vb === 'string') vb = vb.toLowerCase();
                        if (va < vb) return this.sortAsc ? -1 : 1; if (va > vb) return this.sortAsc ? 1 : -1; return 0;
                    });
                },

                get paginatedData() {
                    const s=(this.currentPage-1)*this.pageSize;
                    const pData = this.filteredData.slice(s, s+this.pageSize);
                    setTimeout(() => this.calculatePageMaxes(pData), 0);
                    return pData;
                },
                get totalPages() { return Math.ceil(this.filteredData.length/this.pageSize)||1; },
                nextPage() { if(this.currentPage < this.totalPages) this.currentPage++; },
                prevPage() { if(this.currentPage > 1) this.currentPage--; },

                calculateColumnMaxes() { this.columnMaxValues = {}; },
                calculatePageMaxes(pageData) {
                    const colsToCheck = ['stockGrafana', 'pbi.dep80', 'pbi.dep1', 'qEnviar', 'enviadoHist', 'comprarU', 'inversion', 'deuda', 'vtarTotal', 'vtar80', 'vtarIa'];
                    const maxes = {};
                    colsToCheck.forEach(k => {
                        maxes[k] = 0;
                        pageData.forEach(row => {
                            const val = k.split('.').reduce((o,i)=>(o?o[i]:0), row) || 0;
                            if(val > maxes[k]) maxes[k] = val;
                        });
                    });
                    this.columnMaxValues = maxes;
                },
                getBarStyle(col, row) {
                    // ‚ö° MEMOIZACI√ìN: Cachear resultados de barras para evitar rec√°lculos
                    const cacheKey = `bar_${col.key}_${row.id}_${this.columnMaxValues[col.key]}`;
                    if (MemoCache.has(cacheKey)) {
                        return MemoCache.get(cacheKey);
                    }
                    
                    const key = col.key;
                    if(!['pbi.dep80', 'pbi.dep1', 'qEnviar', 'comprarU', 'inversion', 'stockGrafana', 'vtarIa'].includes(key)) return '';
                    const val = key.split('.').reduce((o,i)=>(o?o[i]:0), row);
                    const max = this.columnMaxValues[key] || 1;
                    const pct = Math.min(100, Math.max(0, (val / max) * 100));
                    let color = '#cbd5e1';
                    if(key === 'qEnviar' || key === 'pbi.dep80') color = '#c084fc';
                    if(key === 'comprarU' || key === 'inversion') color = '#86efac';
                    if(key.includes('stock')) color = '#93c5fd';
                    if(key === 'vtarIa') color = '#d8b4fe';
                    
                    const result = `width: ${pct}%; background-color: ${color};`;
                    return MemoCache.set(cacheKey, result);
                },
                isFilterable(key) { return ['marca', 'prov', 'analista', 'dep', 'abc', 'estadoSalud', 'deposito'].includes(key); },
                toggleFilterMenu(key) { this.filterMenuOpen = this.filterMenuOpen === key ? null : key; },
                getUniqueValues(key) {
                    const source = this.currentTab === 'otros_depositos' ? this.otherDepositsData : (this.masterData.length ? this.masterData : this.flatData);
                    const vals = new Set(source.map(r => String(r[key]||'')));
                    return Array.from(vals).sort();
                },
                isFilterChecked(key, val) {
                    return this.activeFilters[key] ? this.activeFilters[key].includes(val) : false;
                },
                toggleFilter(key, val) {
                    if(!this.activeFilters[key]) this.activeFilters[key] = [];
                    const idx = this.activeFilters[key].indexOf(val);
                    if(idx > -1) this.activeFilters[key].splice(idx, 1);
                    else this.activeFilters[key].push(val);
                    if(this.activeFilters[key].length === 0) delete this.activeFilters[key];
                    this.currentPage = 1;
                },
                clearFilter(key) { delete this.activeFilters[key]; this.currentPage = 1; },
                getColLabel(key) { return this.getColumns().find(c=>c.key===key)?.label || key; },

                async copySkus() {
                    const skus = this.filteredData.map(r => r.sku).join('\n');
                    try {
                        await navigator.clipboard.writeText(skus);
                        this.copyFeedback = true;
                        setTimeout(() => this.copyFeedback = false, 2000);
                    } catch(err) { console.error('Failed to copy', err); }
                },
                exportExcel() {
                    if (!this.dataReady) return;

                    const dataToExport = this.filteredData;
                    const columns = this.getColumns();
                    const sheetName = this.tabs.find(t => t.id === this.currentTab)?.label || 'Datos';

                    // Preparar datos con alertas y formateo
                    const exportData = dataToExport.map(row => {
                        const newRow = {};
                        columns.forEach(col => {
                            let val = col.key.split('.').reduce((o, i) => (o ? o[i] : undefined), row);
                            if (val === undefined) val = row[col.key];
                            
                            // Formatear seg√∫n tipo
                            if (col.key === 'stockValorizado') val = Math.round(val || 0);
                            else if (['vtarTotal', 'diasStock', 'lt', 'uxb'].includes(col.key)) val = parseFloat(val || 0).toFixed(2);
                            else if (col.key === 'alerta') val = row.alerta ? `${row.alerta.icono} ${row.alerta.nivel}` : 'OK';
                            
                            newRow[col.label] = val;
                        });
                        
                        // Agregar columna de ALERTA si no existe
                        if (!newRow['ALERTA']) {
                            newRow['ALERTA'] = row.alerta ? `${row.alerta.icono} ${row.alerta.nivel}` : 'üü¢ OK';
                        }
                        
                        return newRow;
                    });

                    const ws = XLSX.utils.json_to_sheet(exportData);
                    
                    // Ajustar ancho de columnas
                    ws['!cols'] = [];
                    if (exportData.length > 0) {
                        Object.keys(exportData[0]).forEach((col, idx) => {
                            ws['!cols'][idx] = { wch: Math.min(20, Math.max(10, col.length + 2)) };
                        });
                    }

                    // Crear workbook y agregar hoja principal
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);

                    // Agregar hoja de SUGERENCIAS si hay
                    if (this.sugerencias && this.sugerencias.length > 0) {
                        const sugData = this.sugerencias.map(s => ({
                            'PRIORIDAD': `P${s.prioridad}`,
                            'ACCI√ìN': s.titulo,
                            'SKU': s.sku,
                            'DESCRIPCI√ìN': s.desc,
                            'DETALLE': s.detalle
                        }));
                        const wsSug = XLSX.utils.json_to_sheet(sugData);
                        wsSug['!cols'] = [
                            { wch: 10 },
                            { wch: 20 },
                            { wch: 12 },
                            { wch: 25 },
                            { wch: 40 }
                        ];
                        XLSX.utils.book_append_sheet(wb, wsSug, 'Sugerencias');
                    }

                    // Agregar hoja de KPIs
                    const kpiData = [{
                        'M√âTRICA': 'SKUs Cr√≠ticos',
                        'VALOR': this.kpiDashboard?.criticos || 0
                    }, {
                        'M√âTRICA': 'Dinero Congelado',
                        'VALOR': `$${Math.round(this.kpiDashboard?.dineroCong || 0).toLocaleString()}`
                    }, {
                        'M√âTRICA': 'Riesgo Lead Time',
                        'VALOR': this.kpiDashboard?.riesgoLT || 0
                    }, {
                        'M√âTRICA': 'Compra Pr√≥xima 30d',
                        'VALOR': (this.kpiDashboard?.compraProxima || 0).toLocaleString()
                    }, {
                        'M√âTRICA': 'Stock Total Valorizado',
                        'VALOR': `$${Math.round(this.kpiDashboard?.stockTotal || 0).toLocaleString()}`
                    }, {
                        'M√âTRICA': 'Health Score',
                        'VALOR': `${Math.round(this.metrics?.healthScore?.overall || 0)}%`
                    }];
                    
                    const wsKpi = XLSX.utils.json_to_sheet(kpiData);
                    wsKpi['!cols'] = [{ wch: 25 }, { wch: 20 }];
                    XLSX.utils.book_append_sheet(wb, wsKpi, 'KPIs Ejecutivos');

                    // Generar nombre de archivo seguro
                    const timestamp = (this.lastUpdate || new Date().toLocaleString('es-AR')).replace(/[\/, :]/g, '_');
                    XLSX.writeFile(wb, `Dashboard_${sheetName}_${timestamp}.xlsx`);
                    console.log('[INFO] Excel exportado:', sheetName);
                },

                // üìä AN√ÅLISIS COMPARATIVO DASHBOARD
                searchDashboardItems() {
                    try {
                        let query = (this.dashboardSearchText || '').toLowerCase().trim();
                        query = query.replace(/\s+/g, ' ').trim();
                        
                        if(query.length < 1) {
                            this.dashboardSearchResults = [];
                            return;
                        }
                        
                        console.log('[DASHBOARD-SEARCH] Buscando:', query);
                        
                        // SIEMPRE buscar en rawData.grafana (la solapa del Excel)
                        if(!this.rawData?.grafana || this.rawData.grafana.length < 2) {
                            console.warn('[DASHBOARD-SEARCH] rawData.grafana vac√≠o');
                            this.dashboardSearchResults = [];
                            return;
                        }
                        
                        const hG = this.rawData.grafana[0]; // Encabezados
                        
                        // Encontrar √≠ndices de columnas
                        const iSku = hG.findIndex(c => String(c).toUpperCase().trim() === 'SKU');
                        const iDesc = hG.findIndex(c => String(c).toUpperCase().includes('DESC'));
                        const iMarca = hG.findIndex(c => String(c).toUpperCase().includes('MARCA'));
                        const iProv = hG.findIndex(c => String(c).toUpperCase().includes('PROV'));
                        
                        // Mapear todas las columnas de ventas (-1 a -59)
                        const trendCols = {};
                        const trendHeaders = [];
                        
                        hG.forEach((header, idx) => {
                            if(header === null || header === undefined) return;
                            const h = String(header).trim();
                            // Intentar parsear como n√∫mero
                            const dayNum = parseInt(h, 10);
                            
                            // Si es un n√∫mero entre -59 y -1, guardarlo
                            if(!isNaN(dayNum) && dayNum >= -59 && dayNum <= -1) {
                                trendCols[dayNum] = idx;
                                trendHeaders.push({ day: dayNum, idx: idx, header: h });
                            }
                        });
                        
                        // Ordenar headers por d√≠a para visualizaci√≥n
                        trendHeaders.sort((a, b) => b.day - a.day);
                        
                        console.log('[DASHBOARD-SEARCH] Total trend cols encontradas:', Object.keys(trendCols).length);
                        console.log('[DASHBOARD-SEARCH] Primeras 5 columnas trend:', trendHeaders.slice(0, 5));
                        console.log('[DASHBOARD-SEARCH] √öltimas 5 columnas trend:', trendHeaders.slice(-5));
                        console.log('[DASHBOARD-SEARCH] Mapa completo trendCols:', trendCols);
                        
                        const results = [];
                        const seen = {};
                        
                        // Buscar en todas las filas del Excel
                        this.rawData.grafana.slice(1).forEach((row, rowIdx) => {
                            if(!row || !row[iSku]) return;
                            
                            const sku = (row[iSku] || '').toString().toLowerCase().trim().replace(/\s+/g, ' ');
                            if(sku === 'total' || seen[sku]) return;
                            
                            const desc = (row[iDesc] || '').toString().toLowerCase().trim();
                            const marca = (row[iMarca] || '').toString().toLowerCase().trim();
                            const prov = (row[iProv] || '').toString().toLowerCase().trim();
                            
                            // Buscar en todos los campos
                            const match = sku.includes(query) || desc.includes(query) || marca.includes(query) || prov.includes(query);
                            
                            if(match) {
                                seen[sku] = true;
                                
                                // Extraer hist√≥rico de -1 a -59 usando el mapeo
                                const trendData = [];
                                for(let day = -1; day >= -59; day--) {
                                    if(trendCols[day] !== undefined) {
                                        const val = parseFloat(row[trendCols[day]]) || 0;
                                        trendData.push(val);
                                    } else {
                                        trendData.push(0);
                                    }
                                }
                                
                                results.push({
                                    sku: row[iSku],
                                    desc: row[iDesc] || 'S/D',
                                    marca: row[iMarca] || 'S/D',
                                    prov: row[iProv] || 'S/D',
                                    stockGrafana: 0,
                                    vtarTotal: 0,
                                    trendHistory: trendData
                                });
                                
                                console.log('[DASHBOARD-SEARCH] ‚úì Encontrado:', row[iSku], 'hist√≥rico:', trendData.length);
                            }
                        });
                        
                        // Ordenar por coincidencia en SKU
                        results.sort((a, b) => {
                            const aSkuMatch = (a.sku || '').toLowerCase().trim().replace(/\s+/g, ' ').includes(query);
                            const bSkuMatch = (b.sku || '').toLowerCase().trim().replace(/\s+/g, ' ').includes(query);
                            if(aSkuMatch && !bSkuMatch) return -1;
                            if(!aSkuMatch && bSkuMatch) return 1;
                            return 0;
                        });
                        
                        console.log('[DASHBOARD-SEARCH] Resultados:', results.length, results.slice(0, 3).map(r => r.sku));
                        this.dashboardSearchResults = results.slice(0, 10);
                        
                    } catch(e) {
                        console.error('[DASHBOARD-SEARCH] Error:', e);
                        this.dashboardSearchResults = [];
                    }
                },

                handleDashboardSearchEnter() {
                    try {
                        // Ejecutar b√∫squeda primero
                        this.searchDashboardItems();
                        
                        // Esperar a que se actualice dashboardSearchResults
                        this.$nextTick(() => {
                            if(this.dashboardSearchResults && this.dashboardSearchResults.length > 0) {
                                console.log('[DASHBOARD-ENTER] Agregando:', this.dashboardSearchResults[0].sku);
                                this.addDashboardItem(this.dashboardSearchResults[0]);
                            } else {
                                console.warn('[DASHBOARD-ENTER] Sin resultados para:', this.dashboardSearchText);
                                alert('‚ö†Ô∏è No se encontraron resultados para: ' + this.dashboardSearchText);
                            }
                        });
                    } catch(e) {
                        console.error('[DASHBOARD-ENTER] Error:', e);
                    }
                },

                addDashboardItem(item) {
                    try {
                        // Validar item
                        if(!item || !item.sku) {
                            console.error('[DASHBOARD] Item inv√°lido:', item);
                            return;
                        }
                        
                        // Validar l√≠mite de 5 items
                        if(this.dashboardSelectedItems.length >= 5) {
                            alert('‚ö†Ô∏è M√°ximo 5 items permitidos');
                            return;
                        }
                        
                        // Evitar duplicados
                        if(this.dashboardSelectedItems.some(s => s.sku === item.sku)) {
                            console.info('[DASHBOARD] Item ya seleccionado:', item.sku);
                            return;
                        }
                        
                        // Obtener datos completos del item desde masterData
                        const fullItem = this.masterData?.find(m => m.sku === item.sku) || item;
                        
                        // Agregar item con todos los campos disponibles
                        this.dashboardSelectedItems.push({
                            sku: item.sku,
                            desc: item.desc || fullItem.desc || 'S/D',
                            marca: item.marca || fullItem.marca || 'S/D',
                            prov: item.prov || fullItem.prov || 'S/D',
                            vtarTotal: fullItem.vtarTotal || item.vtar || item.vtarTotal || 0,
                            stockGrafana: fullItem.stockGrafana || item.stock || item.stockGrafana || 0,
                            costo: fullItem.costo || item.costo || 0,
                            trendHistory: (item.trendHistory && item.trendHistory.length > 0) ? item.trendHistory : (fullItem.trendHistory || [])
                        });
                        
                        console.log('[DASHBOARD] Item agregado:', item.sku, this.dashboardSelectedItems.length);
                        
                        // Limpiar b√∫squeda
                        this.dashboardSearchText = '';
                        this.dashboardSearchResults = [];
                        
                        // Actualizar gr√°fica
                        this.$nextTick(() => {
                            this.updateDashboardAnalysis();
                        });
                    } catch(e) {
                        console.error('[DASHBOARD] Error en addDashboardItem:', e);
                    }
                },

                removeDashboardItem(sku) {
                    try {
                        if(!sku) return;
                        this.dashboardSelectedItems = this.dashboardSelectedItems.filter(s => s.sku !== sku);
                        this.$nextTick(() => {
                            this.updateDashboardAnalysis();
                        });
                    } catch(e) {
                        console.error('Error en removeDashboardItem:', e);
                    }
                },

                // üõí ACTUALIZAR M√âTRICAS DE SHARE SEG√öN MES SELECCIONADO
                updateShareMetrics() {
                    try {
                        const mes = this.shareSelectedMonth || 'NOVIEMBRE';
                        const qKey = 'q' + mes.charAt(0) + mes.slice(1).toLowerCase(); // qNoviembre, qOctubre, etc.
                        
                        console.log('[SHARE] Actualizando m√©tricas para:', mes, '| Key:', qKey);
                        
                        // Calcular d√≠as del mes para extraer ventas de histDaily
                        const hoy = new Date();
                        const mesActual = hoy.getMonth(); // 0=Enero, 11=Diciembre
                        const diaDelMes = hoy.getDate();
                        const a√±oActual = hoy.getFullYear();
                        
                        const mesesNombres = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];
                        const mesIdx = mesesNombres.indexOf(mes); // 0-11
                        
                        // Calcular rango de d√≠as en histDaily para el mes seleccionado
                        let diasDesde = 0, diasHasta = 0;
                        
                        if(mesIdx === mesActual) {
                            // Mes actual: desde d√≠a 1 hasta ayer
                            diasHasta = 1;
                            diasDesde = diaDelMes - 1;
                        } else if(mesIdx === mesActual - 1 || (mesActual === 0 && mesIdx === 11)) {
                            // Mes anterior
                            const diasMesAnterior = new Date(a√±oActual, mesActual, 0).getDate(); // √öltimo d√≠a del mes anterior
                            diasHasta = diaDelMes;
                            diasDesde = diaDelMes + diasMesAnterior - 1;
                        } else if(mesIdx === mesActual - 2 || (mesActual === 0 && mesIdx === 10) || (mesActual === 1 && mesIdx === 11)) {
                            // Hace 2 meses (l√≠mite de histDaily ~60 d√≠as)
                            const diasMes1 = new Date(a√±oActual, mesActual, 0).getDate();
                            const diasMes2 = new Date(a√±oActual, mesActual - 1, 0).getDate();
                            diasHasta = diaDelMes + diasMes1;
                            diasDesde = diaDelMes + diasMes1 + diasMes2 - 1;
                        } else {
                            // Meses m√°s antiguos: no hay datos en histDaily, usar 0
                            diasDesde = 0;
                            diasHasta = 0;
                        }
                        
                        console.log('[SHARE] Rango histDaily para', mes, ': d√≠as -' + diasHasta, 'a -' + diasDesde);
                        
                        // Calcular ventas y SHARE para cada SKU
                        this.masterData.forEach(item => {
                            let vtaMes = 0;
                            if(item.histDaily && diasDesde > 0) {
                                for(let d = diasHasta - 1; d < diasDesde && d < item.histDaily.length; d++) {
                                    vtaMes += (item.histDaily[d] || 0);
                                }
                            }
                            item._vtaMesActual = vtaMes;
                            item._qMesActual = item[qKey] || 0;
                            item._shareMesActual = item._qMesActual > 0 ? (vtaMes / item._qMesActual) * 100 : 0;
                        });
                        
                        // Calcular m√©tricas agregadas
                        const shareData = this.masterData.filter(m => m._shareMesActual > 0 && m._qMesActual > 0);
                        const totalShareSkus = shareData.length || 1;
                        const shareProm = shareData.reduce((a, m) => a + m._shareMesActual, 0) / totalShareSkus;
                        const skusLideres = this.masterData.filter(m => m._shareMesActual >= 50).length;
                        const skusDebiles = this.masterData.filter(m => m._shareMesActual > 0 && m._shareMesActual < 10).length;
                        const valorLideres = this.masterData.filter(m => m._shareMesActual >= 50).reduce((a, m) => a + ((m.stockGrafana || 0) * (m.costo || 0)), 0);
                        
                        // Distribuci√≥n
                        const shareDistribution = { '0-10%': 0, '10-30%': 0, '30-50%': 0, '>50%': 0 };
                        this.masterData.forEach(m => {
                            if(m._shareMesActual > 0) {
                                if(m._shareMesActual < 10) shareDistribution['0-10%']++;
                                else if(m._shareMesActual < 30) shareDistribution['10-30%']++;
                                else if(m._shareMesActual < 50) shareDistribution['30-50%']++;
                                else shareDistribution['>50%']++;
                            }
                        });
                        
                        // Top 10
                        const topSkus = this.masterData
                            .filter(m => m._shareMesActual > 0)
                            .sort((a, b) => b._shareMesActual - a._shareMesActual)
                            .slice(0, 10)
                            .map(m => ({ sku: m.sku, desc: m.desc, marca: m.marca, shareNov: m._shareMesActual, vtaNov: m._vtaMesActual, qNov: m._qMesActual }));
                        
                        // Peores 10
                        const worstSkus = this.masterData
                            .filter(m => m._shareMesActual > 0 && m._shareMesActual < 50)
                            .sort((a, b) => a._shareMesActual - b._shareMesActual)
                            .slice(0, 10)
                            .map(m => ({ sku: m.sku, desc: m.desc, marca: m.marca, shareNov: m._shareMesActual, vtaNov: m._vtaMesActual, qNov: m._qMesActual }));
                        
                        // Por marca
                        const shareByMarca = {};
                        this.masterData.forEach(m => {
                            if(m._shareMesActual > 0) {
                                const marca = m.marca || 'S/D';
                                if(!shareByMarca[marca]) shareByMarca[marca] = { count: 0, totalShare: 0, vtaMes: 0, qMes: 0 };
                                shareByMarca[marca].count++;
                                shareByMarca[marca].totalShare += m._shareMesActual;
                                shareByMarca[marca].vtaMes += m._vtaMesActual;
                                shareByMarca[marca].qMes += m._qMesActual;
                            }
                        });
                        const byMarca = Object.entries(shareByMarca)
                            .map(([marca, data]) => ({
                                marca,
                                skus: data.count,
                                shareProm: data.count > 0 ? (data.totalShare / data.count).toFixed(1) : 0,
                                shareTotal: data.qMes > 0 ? ((data.vtaMes / data.qMes) * 100).toFixed(1) : 0
                            }))
                            .sort((a, b) => parseFloat(b.shareTotal) - parseFloat(a.shareTotal))
                            .slice(0, 15);
                        
                        this.shareMetrics = {
                            shareProm: shareProm.toFixed(1),
                            skusLideres,
                            skusDebiles,
                            valorLideres,
                            distribution: shareDistribution,
                            topSkus,
                            worstSkus,
                            byMarca,
                            mes: mes
                        };
                        
                        // Limpiar resultado de b√∫squeda anterior
                        this.shareSearchResult = null;
                        
                        console.log('[SHARE] M√©tricas actualizadas:', this.shareMetrics);
                    } catch(e) {
                        console.error('[SHARE] Error actualizando m√©tricas:', e);
                    }
                },

                // üõí B√öSQUEDA DE SHARE DE MERCADO
                searchShare() {
                    try {
                        const query = (this.shareSearchText || '').toUpperCase().trim();
                        if(query.length < 2) {
                            this.shareSearchResult = null;
                            return;
                        }
                        
                        const type = this.shareSearchType;
                        const mes = this.shareSelectedMonth || 'NOVIEMBRE';
                        let items = [];
                        
                        if(type === 'sku') {
                            items = this.masterData.filter(m => m.sku && String(m.sku).toUpperCase().includes(query));
                        } else if(type === 'marca') {
                            items = this.masterData.filter(m => m.marca && String(m.marca).toUpperCase().includes(query));
                        } else if(type === 'proveedor') {
                            items = this.masterData.filter(m => m.prov && String(m.prov).toUpperCase().includes(query));
                        }
                        
                        if(items.length === 0) {
                            this.shareSearchResult = { error: true, message: 'No se encontraron resultados para: ' + query };
                            return;
                        }
                        
                        // Usar datos del mes seleccionado (calculados en updateShareMetrics)
                        const vtaMesTotal = items.reduce((a, m) => a + (m._vtaMesActual || 0), 0);
                        const qMesTotal = items.reduce((a, m) => a + (m._qMesActual || 0), 0);
                        const shareTotal = qMesTotal > 0 ? (vtaMesTotal / qMesTotal) * 100 : 0;
                        
                        this.shareSearchResult = {
                            type: type,
                            query: query,
                            mes: mes,
                            skusCount: items.length,
                            vtaNoviembre: vtaMesTotal,
                            qNoviembre: qMesTotal,
                            share: shareTotal.toFixed(2),
                            items: items.slice(0, 10).map(m => ({
                                sku: m.sku,
                                desc: m.desc,
                                vtaNov: m._vtaMesActual || 0,
                                qNov: m._qMesActual || 0,
                                share: m._shareMesActual?.toFixed(1) || '0'
                            }))
                        };
                        
                        console.log('[SHARE] Resultado b√∫squeda:', this.shareSearchResult);
                    } catch(e) {
                        console.error('[SHARE] Error en searchShare:', e);
                        this.shareSearchResult = { error: true, message: 'Error: ' + e.message };
                    }
                },

                // üìä SIMPLEX - PROCESAR DATOS DE VENTAS POR MES (detecta a√±o por MES)
                processSimplexData() {
                    console.log('[SIMPLEX] Iniciando procesamiento...');
                    
                    const sheetKey = 'simplex';
                    if(!this.rawData[sheetKey] || this.rawData[sheetKey].length < 2) {
                        console.log('[SIMPLEX] ‚ùå Hoja no encontrada');
                        this.simplexData2025 = [];
                        this.simplexData2026 = [];
                        return;
                    }

                    const clean = (s) => String(s||'').trim().toUpperCase();
                    const num = (v) => { 
                        if(typeof v === 'number') return v; 
                        if(!v) return 0; 
                        let s = String(v).replace(/[$\s]/g,'');
                        if(s.includes('.') && s.includes(',')) {
                            s = s.replace(/\./g, '').replace(',', '.');
                        } else if(s.includes(',')) {
                            s = s.replace(',', '.');
                        }
                        return parseFloat(s) || 0; 
                    };
                    const idx = (row, keys) => row.findIndex(c => keys.some(k => String(c).trim().toUpperCase().includes(k.toUpperCase())));

                    const h = this.rawData[sheetKey][0];
                    const iSku = idx(h, ['COD_ARTICU', 'SKU']);
                    const iDesc = idx(h, ['DESCRIPCIO', 'DESCRIPCION']);
                    const iQ = idx(h, ['Q']);
                    const iVenta = idx(h, ['VENTA']);
                    const iProv = idx(h, ['CA_967_PROVEEDOR', 'PROVEEDOR']);
                    const iMarca = idx(h, ['CA_967_MARCA', 'MARCA']);
                    const iAnalista = idx(h, ['CA_967_ANALISTA', 'ANALISTA']);
                    const iMes = idx(h, ['MES']);
                    const iPuntoVenta = idx(h, ['NOMBRE_VEN', 'PUNTO DE VENTA', 'PUNTO_VENTA']);

                    if(iSku === -1 || iMes === -1) {
                        console.warn('[SIMPLEX] ‚ùå Columnas no encontradas');
                        return;
                    }

                    // Mapeo de nombres de mes a clave
                    const mesNombreToKey = (mesStr, year) => {
                        const m = String(mesStr).toLowerCase().trim();
                        const suffix = year === 2025 ? '-25' : '-26';
                        const meses = ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'];
                        for(let i = 0; i < meses.length; i++) {
                            if(m.includes(meses[i])) {
                                // Septiembre especial
                                return (i === 8 ? 'sept' : meses[i]) + suffix;
                            }
                        }
                        return null;
                    };

                    const dataMap2025 = {};
                    const dataMap2026 = {};

                    this.rawData[sheetKey].slice(1).forEach(r => {
                        const sku = clean(r[iSku]);
                        if(!sku || sku === 'TOTAL') return;

                        const mesRaw = String(r[iMes] || '').trim();
                        const year = mesRaw.includes('26') ? 2026 : 2025;
                        const mesKey = mesNombreToKey(mesRaw, year);
                        
                        const dataMap = year === 2025 ? dataMap2025 : dataMap2026;
                        const meses = year === 2025 ? this.simplexMeses2025 : this.simplexMeses2026;
                        
                        const q = num(r[iQ]);
                        const venta = num(r[iVenta]);

                        if(!dataMap[sku]) {
                            dataMap[sku] = {
                                sku, desc: r[iDesc] || '-', marca: r[iMarca] || '-',
                                prov: r[iProv] || '-', analista: r[iAnalista] || '-',
                                puntoVenta: r[iPuntoVenta] || '-', qTotal: 0, ventaTotal: 0, year
                            };
                            meses.forEach(m => dataMap[sku][m] = { q: 0, venta: 0 });
                        }

                        dataMap[sku].qTotal += q;
                        dataMap[sku].ventaTotal += venta;
                        
                        if(mesKey && dataMap[sku][mesKey]) {
                            dataMap[sku][mesKey].q += q;
                            dataMap[sku][mesKey].venta += venta;
                        }
                    });

                    this.simplexData2025 = Object.values(dataMap2025);
                    this.simplexData2026 = Object.values(dataMap2026);
                    console.log('[SIMPLEX] 2025:', this.simplexData2025.length, '| 2026:', this.simplexData2026.length);
                    this.updateSimplexActiveData();
                },

                // Procesar una hoja espec√≠fica de SIMPLEX
                _processSimplexYear(sheetKey, year) {
                    try {
                        const suffix = year === 2025 ? '-25' : '-26';
                        const meses = year === 2025 ? this.simplexMeses2025 : this.simplexMeses2026;
                        
                        if(!this.rawData[sheetKey] || this.rawData[sheetKey].length < 2) {
                            console.log(`[SIMPLEX ${year}] ‚ùå Hoja no encontrada o vac√≠a`);
                            if(year === 2025) this.simplexData2025 = [];
                            else this.simplexData2026 = [];
                            return;
                        }
                        
                        console.log(`[SIMPLEX ${year}] ‚úÖ Procesando ${this.rawData[sheetKey].length} filas`);

                        const clean = (s) => String(s||'').trim().toUpperCase();
                        const num = (v) => { 
                            if(typeof v === 'number') return v; 
                            if(!v) return 0; 
                            // Limpiar y convertir: quitar $, espacios, y manejar coma decimal
                            let s = String(v).replace(/[$\s]/g,'');
                            // Si tiene punto Y coma, el punto es miles (formato AR)
                            if(s.includes('.') && s.includes(',')) {
                                s = s.replace(/\./g, '').replace(',', '.');
                            } else if(s.includes(',')) {
                                // Solo coma = decimal
                                s = s.replace(',', '.');
                            }
                            return parseFloat(s) || 0; 
                        };
                        
                        // Normaliza el mes del Excel al formato del array (ene-25, sept-26, etc)
                        const normalizeMes = (mesStr) => {
                            if(!mesStr) return null;
                            const m = String(mesStr).toLowerCase().trim();
                            // Mapeo de abreviaciones de mes a formato est√°ndar
                            const mesMap = {
                                'ene': 'ene', 'enero': 'ene',
                                'feb': 'feb', 'febrero': 'feb',
                                'mar': 'mar', 'marzo': 'mar',
                                'abr': 'abr', 'abril': 'abr',
                                'may': 'may', 'mayo': 'may',
                                'jun': 'jun', 'junio': 'jun',
                                'jul': 'jul', 'julio': 'jul',
                                'ago': 'ago', 'agosto': 'ago',
                                'sep': 'sept', 'sept': 'sept', 'septiembre': 'sept',
                                'oct': 'oct', 'octubre': 'oct',
                                'nov': 'nov', 'noviembre': 'nov',
                                'dic': 'dic', 'diciembre': 'dic'
                            };
                            // Extraer nombre de mes y a√±o
                            const match = m.match(/^([a-z]+)[-\s]?(\d{2,4})$/);
                            if(match) {
                                const mesNombre = mesMap[match[1]] || match[1];
                                let anio = match[2];
                                if(anio.length === 4) anio = anio.slice(-2);
                                return `${mesNombre}-${anio}`;
                            }
                            return null;
                        };
                        
                        const idx = (row, keys) => row.findIndex(c => keys.some(k => String(c).trim().toUpperCase().includes(k.toUpperCase())));

                        const h = this.rawData[sheetKey][0];

                        // √çndices de columnas
                        const iSku = idx(h, ['COD_ARTICU', 'SKU']);
                        const iDesc = idx(h, ['DESCRIPCIO', 'DESCRIPCION']);
                        const iQ = idx(h, ['Q']);
                        const iVenta = idx(h, ['VENTA']);
                        const iProv = idx(h, ['CA_967_PROVEEDOR', 'PROVEEDOR']);
                        const iMarca = idx(h, ['CA_967_MARCA', 'MARCA']);
                        const iAnalista = idx(h, ['CA_967_ANALISTA', 'ANALISTA']);
                        const iMes = idx(h, ['MES']);
                        const iPuntoVenta = idx(h, ['NOMBRE_VEN', 'PUNTO DE VENTA', 'PUNTO_VENTA']);

                        console.log(`[SIMPLEX ${year}] √çndices - SKU:${iSku}, Q:${iQ}, VENTA:${iVenta}, MES:${iMes}`);

                        if(iSku === -1 || iMes === -1) {
                            console.warn(`[SIMPLEX ${year}] ‚ùå Columnas cr√≠ticas no encontradas`);
                            if(year === 2025) this.simplexData2025 = [];
                            else this.simplexData2026 = [];
                            return;
                        }

                        // Mostrar primeros valores para debug
                        const fila1 = this.rawData[sheetKey][1];
                        console.log(`[SIMPLEX ${year}] Fila 1 - MES: "${fila1[iMes]}" | Q: ${fila1[iQ]} | VENTA: ${fila1[iVenta]}`);
                        console.log(`[SIMPLEX ${year}] Meses esperados:`, meses);

                        // Procesar filas
                        const dataMap = {};
                        let mesesOk = 0, mesesFail = 0;
                        const mesesNoEncontrados = new Set();
                        
                        this.rawData[sheetKey].slice(1).forEach((r, idx) => {
                            const sku = clean(r[iSku]);
                            if(!sku || sku === 'TOTAL') return;

                            // Obtener mes: normalizar al formato del array (ej: "sep-26" ‚Üí "sept-26")
                            const mesRaw = String(r[iMes] || '').trim();
                            const mesKey = normalizeMes(mesRaw);
                            
                            const q = num(r[iQ]);
                            const venta = num(r[iVenta]);

                            if(!dataMap[sku]) {
                                dataMap[sku] = {
                                    sku, 
                                    desc: r[iDesc] || '-', 
                                    marca: r[iMarca] || '-',
                                    prov: r[iProv] || '-', 
                                    analista: r[iAnalista] || '-',
                                    puntoVenta: r[iPuntoVenta] || '-', 
                                    qTotal: 0, 
                                    ventaTotal: 0, 
                                    year
                                };
                                // Inicializar todos los meses en 0
                                meses.forEach(m => dataMap[sku][m] = { q: 0, venta: 0 });
                            }

                            dataMap[sku].qTotal += q;
                            dataMap[sku].ventaTotal += venta;
                            
                            // Verificar si el mes normalizado existe en el objeto
                            if(mesKey && dataMap[sku].hasOwnProperty(mesKey)) {
                                dataMap[sku][mesKey].q += q;
                                dataMap[sku][mesKey].venta += venta;
                                mesesOk++;
                            } else {
                                mesesFail++;
                                mesesNoEncontrados.add(`"${mesRaw}" ‚Üí "${mesKey}"`);
                            }
                        });
                        
                        console.log(`[SIMPLEX ${year}] üìä Meses OK=${mesesOk}, FAIL=${mesesFail}`);
                        if(mesesFail > 0) {
                            console.warn(`[SIMPLEX ${year}] ‚ùå Meses no encontrados:`, [...mesesNoEncontrados]);
                        }

                        const result = Object.values(dataMap);
                        if(year === 2025) this.simplexData2025 = result;
                        else this.simplexData2026 = result;
                        
                        // Debug: mostrar primer SKU con valores de meses
                        if(result.length > 0) {
                            const p = result[0];
                            const mesConDatos = meses.find(m => p[m]?.q > 0);
                            console.log(`[SIMPLEX ${year}] Primer SKU: ${p.sku} | qTotal: ${p.qTotal} | Mes con datos: ${mesConDatos || 'NINGUNO'} = ${p[mesConDatos]?.q || 0}u`);
                        }
                        
                        console.log(`[SIMPLEX ${year}] ‚úÖ Total SKUs: ${result.length}`);
                    } catch(e) {
                        console.error(`[SIMPLEX ${year}] Error:`, e);
                        if(year === 2025) this.simplexData2025 = [];
                        else this.simplexData2026 = [];
                    }
                },

                // Actualizar datos activos seg√∫n selecci√≥n de a√±os
                updateSimplexActiveData() {
                    let data = [];
                    let meses = [];
                    
                    console.log('[SIMPLEX] updateSimplexActiveData - simplexData2025:', this.simplexData2025.length, '| simplexData2026:', this.simplexData2026.length);
                    
                    if(this.simplexYears.y2025 && this.simplexYears.y2026) {
                        // Ambos a√±os: combinar datos
                        data = [...this.simplexData2025, ...this.simplexData2026];
                        meses = [...this.simplexMeses2025, ...this.simplexMeses2026];
                        console.log('[SIMPLEX] Combinando ambos a√±os. Total:', data.length);
                    } else if(this.simplexYears.y2025) {
                        data = this.simplexData2025;
                        meses = this.simplexMeses2025;
                    } else if(this.simplexYears.y2026) {
                        data = this.simplexData2026;
                        meses = this.simplexMeses2026;
                    }
                    
                    // Verificar a√±os en los datos
                    const a√±os = [...new Set(data.map(d => d.year))];
                    console.log('[SIMPLEX] A√±os en data combinada:', a√±os);
                    
                    this.simplexData = data;
                    this.simplexMeses = meses;
                    this.filterSimplexData();
                    this.updateSimplexChart();
                },

                // Actualizar gr√°fico de evoluci√≥n SIMPLEX
                updateSimplexChart() {
                    // Usar nextTick para asegurar que el DOM est√° actualizado
                    this.$nextTick(() => {
                        const canvas = document.getElementById('simplexEvolutionChart');
                        if(!canvas) {
                            console.log('[SIMPLEX Chart] Canvas no encontrado');
                            return;
                        }
                        
                        if(this.simplexChartInstance) {
                            this.simplexChartInstance.destroy();
                            this.simplexChartInstance = null;
                        }
                        
                        if(this.simplexFilteredData.length === 0) {
                            console.log('[SIMPLEX Chart] Sin datos filtrados');
                            return;
                        }
                        
                        console.log('[SIMPLEX Chart] Generando gr√°fico con', this.simplexFilteredData.length, 'registros');
                        console.log('[SIMPLEX Chart] A√±os en datos:', this.simplexFilteredData.map(d => d.year));
                        
                        // DEBUG: Ver estructura de datos 2026
                        const datos2026 = this.simplexFilteredData.filter(d => d.year === 2026);
                        if(datos2026.length > 0) {
                            console.log('[SIMPLEX Chart] üîç Primer registro 2026:', datos2026[0]);
                            console.log('[SIMPLEX Chart] üîç Meses 2026 en registro:', this.simplexMeses2026.map(m => `${m}: ${datos2026[0][m]?.q || 0}u`));
                        }
                        
                        const mesesLabels = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
                        const datasets = [];
                        
                        // Consolidar datos de los resultados filtrados
                        const totals2025 = this.simplexMeses2025.map(m => 
                            this.simplexFilteredData.filter(d => d.year === 2025).reduce((sum, d) => sum + (d[m]?.q || 0), 0)
                        );
                        const totals2026 = this.simplexMeses2026.map(m => 
                            this.simplexFilteredData.filter(d => d.year === 2026).reduce((sum, d) => sum + (d[m]?.q || 0), 0)
                        );
                        const ventas2025 = this.simplexMeses2025.map(m => 
                            this.simplexFilteredData.filter(d => d.year === 2025).reduce((sum, d) => sum + (d[m]?.venta || 0), 0)
                        );
                        const ventas2026 = this.simplexMeses2026.map(m => 
                            this.simplexFilteredData.filter(d => d.year === 2026).reduce((sum, d) => sum + (d[m]?.venta || 0), 0)
                        );
                        
                        console.log('[SIMPLEX Chart] totals2025:', totals2025.reduce((a,b) => a+b, 0), '| totals2026:', totals2026.reduce((a,b) => a+b, 0));
                        
                        const showUnits = this.simplexMetric === 'unidades' || this.simplexMetric === 'ambos';
                        const showSales = this.simplexMetric === 'importe' || this.simplexMetric === 'ambos';
                        
                        if(this.simplexYears.y2025) {
                            if(showUnits) {
                                datasets.push({
                                    label: 'Unidades 2025',
                                    data: totals2025,
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    fill: true,
                                    tension: 0.3,
                                    yAxisID: 'y'
                                });
                            }
                            if(showSales) {
                                datasets.push({
                                    label: 'Venta $ 2025',
                                    data: ventas2025,
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    fill: true,
                                    tension: 0.3,
                                    yAxisID: 'y1',
                                    borderDash: showUnits ? [5, 5] : []
                                });
                            }
                        }
                        
                        if(this.simplexYears.y2026) {
                            if(showUnits) {
                                datasets.push({
                                    label: 'Unidades 2026',
                                    data: totals2026,
                                    borderColor: '#8b5cf6',
                                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                    fill: true,
                                    tension: 0.3,
                                    yAxisID: 'y'
                                });
                            }
                            if(showSales) {
                                datasets.push({
                                    label: 'Venta $ 2026',
                                    data: ventas2026,
                                    borderColor: '#f59e0b',
                                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                    fill: true,
                                    tension: 0.3,
                                    yAxisID: 'y1',
                                    borderDash: showUnits ? [5, 5] : []
                                });
                            }
                        }
                    
                        console.log('[SIMPLEX Chart] Datasets creados:', datasets.length, datasets.map(d => d.label));
                    
                        if(datasets.length === 0) {
                            console.warn('[SIMPLEX Chart] ‚ö†Ô∏è No hay datasets para mostrar');
                            return;
                        }
                        
                        const ctx = canvas.getContext('2d');
                        this.simplexChartInstance = new Chart(ctx, {
                            type: 'line',
                            data: { labels: mesesLabels, datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: {
                                legend: { position: 'top', labels: { font: { size: 10 } } },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => {
                                            const val = ctx.parsed.y;
                                            if(ctx.dataset.label.includes('Venta')) {
                                                return ctx.dataset.label + ': ' + this.formatMoney(val);
                                            }
                                            return ctx.dataset.label + ': ' + val.toLocaleString() + ' u';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: showUnits,
                                    position: 'left',
                                    title: { display: true, text: 'Unidades', font: { size: 10 } },
                                    ticks: { font: { size: 9 } }
                                },
                                y1: {
                                    type: 'linear',
                                    display: showSales,
                                    position: 'right',
                                    title: { display: true, text: 'Venta $', font: { size: 10 } },
                                    grid: { drawOnChartArea: false },
                                    ticks: { 
                                        font: { size: 9 },
                                        callback: v => this.formatMoney(v)
                                    }
                                },
                                x: { ticks: { font: { size: 9 } } }
                            }
                        }
                        });
                    }); // Cierre de $nextTick
                },

                // üìä SIMPLEX - FILTRAR Y BUSCAR DATOS
                filterSimplexData() {
                    const query = (this.simplexSearchText || '').toUpperCase().trim();
                    if(query.length < 2) {
                        this.simplexFilteredData = [];
                        return;
                    }

                    const type = this.simplexSearchType;
                    let results = [];
                    
                    // Funci√≥n para crear estructura inicial de meses
                    const initMeses = () => {
                        const obj = {};
                        this.simplexMeses2025.forEach(m => obj[m] = { q: 0, venta: 0 });
                        this.simplexMeses2026.forEach(m => obj[m] = { q: 0, venta: 0 });
                        return obj;
                    };

                    if(type === 'sku') {
                        // B√∫squeda por SKU: mostrar detalle individual (preservar year)
                        results = this.simplexData.filter(d => d.sku.includes(query));
                    } else if(type === 'marca') {
                        // B√∫squeda por MARCA: consolidar por marca + a√±o
                        const marcaMap = {};
                        this.simplexData.filter(d => (d.marca || '').toUpperCase().includes(query)).forEach(d => {
                            const key = d.marca + '_' + d.year;
                            if(!marcaMap[key]) {
                                marcaMap[key] = {
                                    marca: d.marca, prov: d.prov, analista: d.analista,
                                    puntoVenta: '-', qTotal: 0, ventaTotal: 0, year: d.year,
                                    ...initMeses()
                                };
                            }
                            marcaMap[key].qTotal += d.qTotal;
                            marcaMap[key].ventaTotal += d.ventaTotal;
                            const meses = d.year === 2025 ? this.simplexMeses2025 : this.simplexMeses2026;
                            meses.forEach(mes => {
                                if(marcaMap[key][mes] && d[mes]) {
                                    marcaMap[key][mes].q += d[mes].q || 0;
                                    marcaMap[key][mes].venta += d[mes].venta || 0;
                                }
                            });
                        });
                        results = Object.values(marcaMap);
                    } else if(type === 'proveedor') {
                        // B√∫squeda por PROVEEDOR: consolidar por proveedor + a√±o
                        const provMap = {};
                        this.simplexData.filter(d => (d.prov || '').toUpperCase().includes(query)).forEach(d => {
                            const key = d.prov + '_' + d.year;
                            if(!provMap[key]) {
                                provMap[key] = {
                                    prov: d.prov, analista: d.analista,
                                    puntoVenta: '-', qTotal: 0, ventaTotal: 0, year: d.year,
                                    ...initMeses()
                                };
                            }
                            provMap[key].qTotal += d.qTotal;
                            provMap[key].ventaTotal += d.ventaTotal;
                            const meses = d.year === 2025 ? this.simplexMeses2025 : this.simplexMeses2026;
                            meses.forEach(mes => {
                                if(provMap[key][mes] && d[mes]) {
                                    provMap[key][mes].q += d[mes].q || 0;
                                    provMap[key][mes].venta += d[mes].venta || 0;
                                }
                            });
                        });
                        results = Object.values(provMap);
                    }

                    this.simplexFilteredData = results;
                    console.log('[SIMPLEX] Filtrado:', results.length, 'resultados. A√±os:', [...new Set(results.map(r => r.year))]);
                    
                    // Debug: mostrar resumen de resultados
                    results.forEach(r => {
                        const mes1_2025 = r['ene-25']?.q || 0;
                        const mes1_2026 = r['ene-26']?.q || 0;
                        console.log(`[SIMPLEX] ${r.marca || r.prov || r.sku} | a√±o: ${r.year} | ene-25: ${mes1_2025} | ene-26: ${mes1_2026}`);
                    });
                },

                // üìä SIMPLEX - Obtener columnas din√°micas seg√∫n tipo de b√∫squeda
                getSimplexColumns() {
                    // Columnas de meses gen√©ricas (ENE, FEB, MAR... DIC) sin a√±o
                    const mesesGenericos = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'];
                    const mesesCols = mesesGenericos.map(m => ({ key: m, label: m }));
                    
                    const showBothYears = this.simplexYears.y2025 && this.simplexYears.y2026;
                    
                    const baseCols = [
                        { key: 'year', label: 'A√ëO' },
                        { key: 'qTotal', label: 'Q TOTAL' },
                        { key: 'ventaTotal', label: 'VENTA TOTAL' },
                        ...mesesCols
                    ];
                    
                    if(this.simplexSearchType === 'sku') {
                        return [
                            { key: 'sku', label: 'SKU' },
                            { key: 'desc', label: 'DESCRIPCI√ìN' },
                            { key: 'marca', label: 'MARCA' },
                            { key: 'prov', label: 'PROVEEDOR' },
                            ...baseCols
                        ];
                    } else if(this.simplexSearchType === 'marca') {
                        return [
                            { key: 'marca', label: 'MARCA' },
                            { key: 'prov', label: 'PROVEEDOR' },
                            ...baseCols
                        ];
                    } else { // proveedor
                        return [
                            { key: 'prov', label: 'PROVEEDOR' },
                            ...baseCols
                        ];
                    }
                },

                // üìä SIMPLEX - Obtener valor de celda (maneja meses con Q y Venta seg√∫n m√©trica)
                getSimplexCellValue(row, col) {
                    // Mapeo de columna gen√©rica a mes espec√≠fico del a√±o de la fila
                    const mesesMap = {
                        'ENE': 'ene', 'FEB': 'feb', 'MAR': 'mar', 'ABR': 'abr',
                        'MAY': 'may', 'JUN': 'jun', 'JUL': 'jul', 'AGO': 'ago',
                        'SEP': 'sept', 'OCT': 'oct', 'NOV': 'nov', 'DIC': 'dic'
                    };
                    
                    // Verificar si es una columna de mes gen√©rica
                    if(mesesMap[col.key]) {
                        const suffix = row.year === 2025 ? '-25' : '-26';
                        const mesKey = mesesMap[col.key] + suffix;
                        const mesData = row[mesKey];
                        if(mesData) {
                            if(this.simplexMetric === 'unidades') {
                                return (mesData.q || 0).toLocaleString() + ' u';
                            } else if(this.simplexMetric === 'importe') {
                                return this.formatMoney(mesData.venta || 0);
                            } else {
                                return `${(mesData.q || 0).toLocaleString()} u / ${this.formatMoney(mesData.venta || 0)}`;
                            }
                        }
                        return this.simplexMetric === 'importe' ? '$0' : '0 u';
                    }
                    if(col.key === 'qTotal') {
                        return (row[col.key] || 0).toLocaleString();
                    }
                    if(col.key === 'ventaTotal') {
                        return this.formatMoney(row[col.key] || 0);
                    }
                    return row[col.key] || '-';
                },

                getDashboardItemOptions() {
                    if(this.dashboardAnalysisType === 'sku') {
                        return [...new Set(this.masterData.map(m => m.sku))].sort();
                    } else if(this.dashboardAnalysisType === 'marca') {
                        return [...new Set(this.masterData.map(m => m.marca || 'S/D'))].sort();
                    } else if(this.dashboardAnalysisType === 'proveedor') {
                        return [...new Set(this.masterData.map(m => m.prov || 'S/D'))].sort();
                    }
                    return [];
                },

                updateDashboardAnalysis() {
                    try {
                        if(!this.dashboardSelectedItems || this.dashboardSelectedItems.length === 0) {
                            if(this.dashboardChartInstance) {
                                this.dashboardChartInstance.destroy();
                                this.dashboardChartInstance = null;
                            }
                            return;
                        }
                        
                        // Preparar datos hist√≥ricos -1 a -59 (60 d√≠as)
                        const labels = [];
                        for(let i = 1; i <= 60; i++) {
                            labels.push(`-${i}d`);
                        }
                        
                        const datasets = [];
                        const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#a855f7'];
                        
                        this.dashboardSelectedItems.slice(0, 5).forEach((item, idx) => {
                            try {
                                if(!item || !item.sku) return;
                                
                                let data = [];
                                
                                // PRIMERO: Intentar usar trendHistory del item (viene del Excel)
                                if(item.trendHistory && Array.isArray(item.trendHistory) && item.trendHistory.length > 0) {
                                    data = [...item.trendHistory].reverse().slice(0, 60);
                                    console.log('[CHART] Usando trendHistory del item:', item.sku, 'puntos:', data.length);
                                } else {
                                    // FALLBACK: Buscar en masterData
                                    const sku = this.masterData?.find(m => m?.sku === item.sku);
                                    if(sku?.trendHistory && Array.isArray(sku.trendHistory)) {
                                        data = [...sku.trendHistory].reverse().slice(0, 60);
                                        console.log('[CHART] Usando trendHistory de masterData:', item.sku, 'puntos:', data.length);
                                    }
                                }
                                
                                // Rellenar con ceros si faltan datos
                                while(data.length < 60) {
                                    data.unshift(0);
                                }
                                
                                // Validar que todos sean n√∫meros
                                data = data.map(d => typeof d === 'number' ? d : 0).slice(0, 60);
                                
                                datasets.push({
                                    label: item.sku + ' (' + (item.desc?.substring(0, 15) || 'S/D') + ')',
                                    data: data,
                                    borderColor: colors[idx % colors.length],
                                    backgroundColor: colors[idx % colors.length] + '20',
                                    tension: 0.3,
                                    fill: false,
                                    borderWidth: 2,
                                    pointRadius: 0,
                                    pointHoverRadius: 4
                                });
                            } catch(e) {
                                console.warn('Error procesando item:', item, e);
                            }
                        });
                        
                        const ctx = document.getElementById('dashboardChart');
                        if(!ctx || datasets.length === 0) return;
                        
                        if(this.dashboardChartInstance) {
                            try {
                                this.dashboardChartInstance.destroy();
                            } catch(e) {
                                console.warn('Error destruyendo chart anterior:', e);
                            }
                        }
                        
                        this.dashboardChartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                        labels: { color: '#d1d5db', font: { size: 11 } }
                                    }
                                },
                                scales: {
                                    x: { grid: { color: '#374151' }, ticks: { color: '#9ca3af', maxRotation: 45, minRotation: 0 } },
                                    y: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' } }
                                }
                            }
                        });
                    } catch(e) {
                        console.error('Error en updateDashboardAnalysis:', e);
                    }
                },

                isEditable(key) { return ['lt', 'uxb', 'dev', 'costo', 'diasEstrategia'].includes(key); },
                startEdit(row, key) {
                    if(this.isEditable(key) && (this.currentTab === 'resumen' || this.currentTab === 'consolidado')) {
                        this.editingCell = { sku: row.sku, key: key };
                    }
                },
                isEditing(row, key) {
                    return this.editingCell && this.editingCell.sku === row.sku && this.editingCell.key === key;
                },
                saveEdit(row, key, val) {
                    let numVal = parseFloat(val);
                    if(val === '' && key === 'diasEstrategia') numVal = undefined;
                    if(numVal === undefined || !isNaN(numVal)) {
                        const target = this.masterData.find(r => r.sku === row.sku);
                        if(target) {
                            target[key] = numVal;
                            if(key === 'diasEstrategia') {
                                if(!this.strategyOverrides) this.strategyOverrides = {};
                                if(numVal === undefined) delete this.strategyOverrides[row.sku];
                                else this.strategyOverrides[row.sku] = numVal;
                                DB.save('strategyOverrides', this.strategyOverrides);
                            }
                            const recalculated = this.calculateRowLogic(target);
                            Object.assign(target, recalculated);
                            this.masterData = [...this.masterData];
                            this.updateKPIs();
                            this.calculateColumnMaxes();
                        }
                    }
                    this.editingCell = null;
                },

                getHeaderTitle() { return this.tabs.find(t=>t.id===this.currentTab)?.label || 'Dashboard'; },
                getHeaderStats() {
                    const isFiltered = this.search.length > 0 || Object.keys(this.activeFilters).length > 0;

                    if(this.currentTab === 'dep80') {
                        const total = isFiltered
                            ? this.filteredData.reduce((a,b)=>a+b.qEnviar,0)
                            : this.kpis.envios;
                        const val = isFiltered
                            ? this.filteredData.reduce((a,b)=>a+b.valorizado,0)
                            : this.kpis.valorEnvios;

                        return `
                            <span class="${isFiltered?'text-purple-600 font-bold':''}">Total a enviar:</span>
                            <b class="ml-1">${total.toLocaleString()} u.</b>
                            <span class="mx-2">|</span>
                            <span class="${isFiltered?'text-purple-600 font-bold':''}">Inversi√≥n Env√≠o:</span>
                            <b class="ml-1">${this.formatMoney(val)}</b>
                            ${isFiltered ? '<span class="ml-2 text-[9px] bg-purple-100 text-purple-700 px-1 rounded">FILTRADO</span>' : ''}
                        `;
                    }

                    if(this.currentTab === 'resumen') {
                        const skus = isFiltered
                            ? this.filteredData.length
                            : this.kpis.skusCompra;
                        const inv = isFiltered
                            ? this.filteredData.reduce((a,b)=>a+(b.inversion||0),0)
                            : this.kpis.compra;

                        return `
                            <span class="${isFiltered?'text-emerald-600 font-bold':''}">SKUs a comprar:</span>
                            <b class="ml-1">${skus}</b>
                            <span class="mx-2">|</span>
                            <span class="${isFiltered?'text-emerald-600 font-bold':''}">Inversi√≥n Total:</span>
                            <b class="ml-1">${this.formatMoney(inv)}</b>
                            ${isFiltered ? '<span class="ml-2 text-[9px] bg-emerald-100 text-emerald-700 px-1 rounded">FILTRADO</span>' : ''}
                        `;
                    }

                    if(this.currentTab === 'inmovilizado') {
                        const inv = isFiltered
                            ? this.filteredData.reduce((a,b)=>a+(b.costoExcedente||0),0)
                            : this.kpis.inmovilizado;
                        const unidadesExc = isFiltered
                            ? this.filteredData.reduce((a,b)=>a+(b.unidadesExcedentes||0),0)
                            : this.masterData.reduce((a,b)=>a+(b.unidadesExcedentes||0),0);
                        const filters = this.stockViejoFilters.length > 0 ? this.stockViejoFilters : ['>45'];
                        const filterLabel = filters.join(', ') + ' d√≠as';
                         return `
                            <span class="${isFiltered?'text-purple-600 font-bold':''}">Costo Sobrestock (${filterLabel}):</span>
                            <b class="ml-1 text-purple-600">${this.formatMoney(inv)}</b>
                            <span class="mx-2">|</span>
                            <span>Unidades Excedentes:</span>
                            <b class="ml-1">${unidadesExc.toLocaleString('es-AR')}</b>
                            <span class="ml-2 text-[9px]">${this.filteredData.length} SKUs</span>
                            ${isFiltered ? '<span class="ml-2 text-[9px] bg-purple-100 text-purple-700 px-1 rounded">FILTRADO</span>' : ''}
                        `;
                    }

                    if(this.currentTab === 'otros_depositos') {
                        const totalEnv = this.filteredData.reduce((a,b)=>a+(b.qEnviar||0), 0);
                        return `Total a enviar (${this.selectedOtherDeps.length} deps): <b class="ml-1 text-purple-700">${totalEnv.toLocaleString()} u.</b>`;
                    }

                    if(this.currentTab === 'cargos') {
                        const totalDeuda = isFiltered
                            ? this.filteredData.reduce((a,b)=>a+b.deuda,0)
                            : this.masterData.reduce((a,b)=>a+b.deuda,0);
                        return `Deuda Total Acumulada: <b class="ml-1 text-red-600 bg-red-50 px-1 rounded">${this.formatMoney(totalDeuda)}</b>`;
                    }

                    if(this.currentTab === 'vencimientos') {
                        const c = this.filteredData.filter(l=>l.dias<=30).length;
                        const riesgoTotal = this.filteredData.reduce((acc, row) => acc + (row.riesgoMonetario || 0), 0);
                        
                        return `
                            Lotes Cr√≠ticos (0-30d): <b class="ml-1 text-red-600">${c}</b> 
                            <span class="mx-2 text-slate-300">|</span> 
                            Riesgo Econ√≥mico Total: <b class="ml-1 text-red-700 bg-red-100 px-2 rounded border border-red-200">${this.formatMoney(riesgoTotal)}</b>
                        `;
                    }

                    if(this.currentTab === 'enviados') return `Total Env√≠os Hist√≥ricos: <b>${this.filteredData.length}</b> filas`;

                    if(this.currentTab === 'detalle' || this.currentTab === 'consolidado' || this.currentTab === 'proveedores' || this.currentTab === 'matriz_det') {
                         return `Total SKUs: <b>${this.filteredData.length}</b>`;
                    }

                    return '';
                },

                getColumns() {
                    if(this.currentTab==='matriz_det') return [
                        {key:'sku',label:'SKU'}, {key:'desc',label:'DESCRIPCION'}, {key:'marca',label:'MARCA'}, {key:'prov',label:'PROVEEDOR'},
                        {key:'abc',label:'CLASIF. ABC'},
                        {key:'estadoSalud',label:'ESTADO SALUD'},
                        {key:'stockGrafana',label:'STOCK TOTAL'},
                        {key:'vtarTotal',label:'VTAR TOTAL'},
                        {key:'diasStock',label:'DIAS STOCK'},
                        {key:'stockValorizado',label:'CAPITAL INVERTIDO ($)'}
                    ];
                     
                    if(this.currentTab==='consolidado') return [
                        {key:'sku',label:'SKU'}, 
                        {key:'mla',label:'MLA'}, 
                        {key:'ean',label:'EAN'}, 
                        {key:'estadoMLA',label:'ESTADO'}, 
                        {key:'desc',label:'DESCRIPCION'}, 
                        {key:'statusVisualML',label:'ESTADO ML'}, 
                        {key:'antiguedadStock',label:'ANTIG√úEDAD STOCK'}, 
                        {key:'comprasEnCamino',label:'EN CAMINO'},
                        {key:'vta30d',label:'VENTA 30D (Total)'},
                        {key:'stockGrafana',label:'STOCK TOTAL'},
                        {key:'vtarTotal',label:'VTAR TOTAL (Tendencia)'},
                        {key:'vtarIa',label:'VTAR IA (Pred)'}, 
                        {key:'diasStock',label:'DIAS STOCK'},
                        {key:'runOutDate',label:'AGOTAMIENTO ESTIMADO'}, 
                        {key:'diasEstrategia',label:'DIAS EST.', editable:true},
                        {key:'perfil', label:'PERFIL'},
                        
                        {key:'ss',label:'STOCK SEGURIDAD'}, 
                        {key:'stockMin',label:'STOCK MINIMO'},
                        {key:'stockMax',label:'STOCK MAXIMO'},

                        {key:'comprarU',label:'CANTIDAD A PEDIR'}
                    ];
                    
                    
                    if(this.currentTab==='proveedores') return [
                        {key:'actions',label:'ACCIONES'},
                        {key:'prov',label:'PROVEEDOR'},
                        {key:'diasStockProm',label:'DIAS STOCK PROM'},
                        {key:'totalStockVal',label:'IMPORTE STOCK ACTUAL'},
                        {key:'inmoVal',label:'IMPORTE SOBRESTOCK >45d'},
                        {key:'inversion',label:'TOTAL INVERSION A REALIZAR'}
                    ];
                    if(this.currentTab==='inmovilizado') return [
                        {key:'sku',label:'SKU'}, {key:'desc',label:'DESCRIPCION'}, {key:'marca',label:'MARCA'}, {key:'prov',label:'PROVEEDOR'},
                        {key:'stockGrafana',label:'STOCK TOTAL'}, {key:'vtarTotal',label:'VTAR TOTAL'}, {key:'diasStock',label:'DIAS STOCK'},
                        {key:'unidadesExcedentes',label:'UNIDADES EXCEDENTES'}, {key:'costoExcedente',label:'COSTO EXCEDENTE'},
                        {key:'pctExcedente',label:'% EXCEDENTE'}, {key:'stockValorizado',label:'COSTO TOTAL STOCK'}
                    ];

                    if(this.currentTab==='otros_depositos') return [
                        {key:'statusVisual',label:'ESTADO'},
                        {key:'sku',label:'SKU'}, {key:'desc',label:'DESCRIPCION'}, {key:'marca',label:'MARCA'}, {key:'prov',label:'PROVEEDOR'},
                        {key:'deposito',label:'DEPOSITO'}, {key:'stock',label:'STOCK'}, {key:'vtar',label:'VTAR'},
                        {key:'diasStock',label:'DIAS STOCK'},
                        {key:'ssDep',label:'STOCK SEGURIDAD'}, {key:'stockMinDep',label:'STOCK MINIMO'}, {key:'stockMaxDep',label:'STOCK MAXIMO'},
                        {key:'enviadoHist',label:'ENVIOS REALIZADO'}, {key:'qEnviar',label:'CANTIDADES A ENVIAR'}
                    ];

                    if(this.currentTab==='dep80') return [
                        {key:'sku',label:'SKU'}, 
                        {key:'desc',label:'DESCRIPCION'},
                        {key:'prov',label:'PROVEEDOR'},
                        {key:'subPerfil',label:'SUB_PERFIL'},
                        {key:'vta30d_80',label:'VENTA 30D (80)'}, 
                        {key:'vtar80',label:'VTAR 80'}, 
                        {key:'pbi.dep80',label:'STOCK 80'}, 
                        {key:'diasStock80',label:'DIAS 80'},
                        {key:'runOutDate',label:'AGOTAMIENTO ESTIMADO'},
                        {key:'pbi.dep1',label:'STOCK CENTRAL'}, 
                        {key:'stockRestante',label:'DISPONIBLE'}, 
                        {key:'enviadoHist',label:'ENVIOS REALIZADO'},
                        {key:'qEnviar',label:'A ENVIAR'}, 
                        {key:'valorizado',label:'MONTO $'}
                    ];
                
                    if(this.currentTab==='resumen') return [
                        {key:'sku',label:'SKU'}, 
                        {key:'desc',label:'PRODUCTO'}, 
                        {key:'marca',label:'MARCA'}, 
                        {key:'prov',label:'PROVEEDOR'},
                        {key:'vtarTotal',label:'VTAR GENERAL'}, 
                        {key:'stockGrafana',label:'STOCK TOTAL'}, 
                        {key:'diasStock',label:'DIAS STOCK'},
                        {key:'diasEstrategia',label:'DIAS EST.', editable:true}, 
                        {key:'comprasEnCamino',label:'EN CAMINO'}, 
                        {key:'comprarU',label:'A PEDIR'}, 
                        {key:'inversion',label:'INVERSI√ìN $'},
                        {key:'lt',label:'LEAD TIME'} 
                    ];
                    if(this.currentTab==='cargos') return [
                        {key:'sku',label:'SKU'}, {key:'desc',label:'DESCRIPCION'}, {key:'marca',label:'MARCA'}, {key:'prov',label:'PROVEEDOR'},
                        {key:'analista',label:'ANALISTA'}, {key:'unidadesCargo',label:'UNIDADES CON CARGO'}, {key:'deuda',label:'COSTO TOTAL POR CARGOS'},
                        {key:'fechaCarga',label:'FECHA CARGA'}
                    ];
                    if(this.currentTab==='detalle') return [
                        {key:'sku',label:'SKU'}, {key:'desc',label:'DESCRIPCION'}, {key:'marca',label:'MARCA'}, {key:'prov',label:'PROVEEDOR'},
                        {key:'dep',label:'DEPOSITO'}, {key:'vtar',label:'VTAR'}, {key:'stock',label:'STOCK'}, {key:'diasStockDep',label:'DIAS STOCK'},
                        {key:'vta59',label:'VENTA 60 D√çAS'}, {key:'analista',label:'ANALISTA'}
                    ];
                    if(this.currentTab==='enviados') return [
                        {key:'sku',label:'SKU'}, {key:'desc',label:'DESCRIPCION'}, {key:'marca',label:'MARCA'}, {key:'prov',label:'PROVEEDOR'},
                        {key:'cant',label:'ENVIO REALIZADO'}, {key:'num_envio',label:'N¬∞ ENVIO'}, {key:'fecha',label:'FECHA'}
                    ];
                    if(this.currentTab==='vencimientos') return [
                        {key:'sku',label:'SKU'}, 
                        {key:'desc',label:'DESCRIPCION'}, 
                        {key:'marca',label:'MARCA'}, 
                        {key:'fechaIngreso',label:'FECHA DE INGRESO'}, 
                        {key:'fechaVto',label:'FECHA DE VENCIMIENTO'}, 
                        {key:'dias',label:'DIAS AL VENCIMIENTO'}, 
                        {key:'stockComprometido',label:'STOCK LOTE'},
                        {key:'riesgoMonetario',label:'RIESGO ($) PROYECTADO'}
                    ];
                    if(this.currentTab==='combos') return [
                        {key:'sku',label:'SKU'}, 
                        {key:'desc',label:'DESCRIPCION'}, 
                        {key:'prov',label:'PROVEEDOR'},
                        {key:'pbi.dep1',label:'DEPOSITO 1'}, 
                        {key:'pbi.dep80',label:'DEPOSITO 80'}, 
                        {key:'stockGrafana',label:'STOCK TOTAL'},
                        {key:'vtarTotal',label:'VTAR TOTAL (Tendencia)'}, 
                        {key:'diasStock',label:'DIAS STOCK'},
                        {key:'vta59Total',label:'VENTA 60 D√çAS'}
                    ];
                },            
                    getCellClass(c,r) {
                    if(c.key === 'abc') {
                        if(r.abc === 'A') return 'bg-green-100 text-green-800 font-bold text-center';
                        if(r.abc === 'B') return 'bg-yellow-50 text-yellow-800 font-bold text-center';
                        return 'bg-slate-100 text-slate-500 text-center';
                    }
                    if(c.key === 'estadoSalud') {
                        if(r.estadoSalud === 'Quiebre') return 'bg-red-900 text-white font-bold text-center';
                        if(r.estadoSalud === 'Por Quebrar') return 'bg-red-600 text-white font-bold text-center';
                        if(r.estadoSalud === 'Saludable') return 'bg-green-100 text-green-800 font-bold text-center';
                        if(r.estadoSalud === 'Alerta') return 'bg-yellow-100 text-yellow-800 font-bold text-center';
                        return 'bg-purple-100 text-purple-800 font-bold text-center';
                    }

                    if(c.key === 'statusVisualML') {
                        const st = (r.statusML||'').toUpperCase();
                        if(st === 'PAUSADA') return 'bg-red-100 text-red-700 font-bold text-[10px] text-center';
                        if(st === 'INACTIVA') return 'bg-gray-200 text-gray-500 font-bold text-[10px] text-center';
                        return 'text-green-600 font-bold text-[10px] text-center';
                    }

                    if(c.key === 'estadoMLA') {
                        const st = (r.estadoMLA||'').toUpperCase();
                        if(st === 'ACTIVE') return 'bg-green-100 text-green-700 font-bold text-[10px] text-center';
                        if(st === 'PAUSED') return 'bg-red-100 text-red-700 font-bold text-[10px] text-center';
                        if(st === 'UNDER_REVIEW') return 'bg-yellow-100 text-yellow-700 font-bold text-[10px] text-center';
                        return 'text-slate-400 text-[10px] text-center';
                    }
                    
                    if(c.key === 'antiguedadStock') {
                         if(!r.antiguedadStock) return 'text-center text-slate-300';
                         if(r.antiguedadStock.includes('2 and 4')) return 'bg-yellow-50 text-yellow-700 font-bold text-center';
                         if(r.antiguedadStock.includes('4 and 6')) return 'bg-orange-100 text-orange-700 font-bold text-center';
                         if(r.antiguedadStock.includes('6') || r.antiguedadStock.includes('12')) return 'bg-red-100 text-red-700 font-bold text-center';
                    }

                    if(c.key === 'mlEsUrgente' && r.mlEsUrgente) return 'bg-red-500 text-white font-bold text-center animate-pulse';
                    if(c.key === 'mlSugerido' && r.mlSugerido > 0) return 'text-center font-bold text-blue-600 bg-blue-50';

                    if(c.key === 'riesgoMonetario' && r.riesgoMonetario > 0) return 'font-mono font-bold text-red-600 bg-red-50 text-right';

                    if(['diasStock', 'diasStock80', 'diasStockDep'].includes(c.key)) {
                        const val = r[c.key];
                        if(val <= 10) return 'bg-red-900 text-white font-bold';
                        if(val <= 17) return 'bg-red-600 text-white font-bold';
                        if(val <= 30) return 'bg-green-100 text-green-800 font-bold';
                        if(val <= 45) return 'bg-yellow-100 text-yellow-800 font-bold';
                        return 'bg-purple-100 text-purple-800 font-bold';
                    }
                    if(c.key==='qEnviar') return 'font-bold text-purple-600';
                    if(c.key==='enviadoHist' && r.enviadoHist > 0) return 'font-bold text-blue-600';
                    if(c.key==='comprarU') return 'font-bold text-emerald-600';
                    if(c.key==='comprasEnCamino' && r.comprasEnCamino > 0) return 'text-blue-600 font-bold';
                    if(c.key==='inversion' || c.key==='deuda') return 'font-mono text-right';
                    if(c.key==='unidadesCargo') return 'text-center font-bold text-slate-700';
                    if(c.key==='stockComprometido') return 'font-bold text-slate-700 bg-yellow-50';
                    if(this.isEditable(c.key)) return 'bg-yellow-50 hover:bg-yellow-100 cursor-text border-b-2 border-dashed border-slate-300 font-bold text-blue-700';
                    if(c.key==='ss' || c.key==='stockMin' || c.key==='stockMax') return 'text-center text-slate-600 bg-slate-50 font-medium';
                    // üÜï Estilos para columnas SS, Min, Max por dep√≥sito
                    if(c.key==='ssDep' || c.key==='stockMinDep' || c.key==='stockMaxDep') return 'text-center text-slate-600 bg-slate-50 font-medium';
                    if(c.key==='stockValorizado' || c.key==='inmoVal') return 'font-mono font-bold text-red-700 bg-red-50';
                    if(c.key==='vtarIa') return 'bg-indigo-50 font-bold text-indigo-700';
                    if(c.key==='deposito') return 'text-center font-bold bg-purple-50 text-purple-800';
                    if(c.key === 'runOutDate' && r.runOutCritical) return 'bg-red-500 text-white font-bold text-center';
                    return '';
                },
                
                getTooltip(col, row) {
                    if(col.key === 'bloqueado' && row.bloqueado) return '‚ö†Ô∏è SKU BLOQUEADO (Canasta)';
                    if(col.key === 'comprarU' && row.uxb > 1) return `${row.comprarU} unidades = ${row.cantBultos} bultos de ${row.uxb} u/bulto`;
                    if(col.key === 'diasStock') return `D√≠as de stock: ${Math.round(row.diasStock || 0)}`;
                    if(col.key === 'vtarIa') return 'Predicci√≥n IA basada en regresi√≥n lineal';
                    if(col.key === 'runOutDate' && row.runOutCritical) return '‚ö†Ô∏è QUIEBRE INMINENTE';
                    return '';
                },
                
                formatCell(c,r) {
                    // --- NUEVO: Visualizaci√≥n de Bultos en la Tabla ---
                    if (c.key === 'comprarU') {
                        if (r.comprarU > 0 && r.uxb > 1) {
                            return r.comprarU + ' u. (' + r.cantBultos + ' üì¶)';
                        }
                        return r.comprarU;
                    }
                    // --------------------------------------------------

                    // ... (aqu√≠ sigue el resto de tu c√≥digo existente: statusVisualML, etc.)

                    if(c.key === 'statusVisualML') {
                        const st = (r.statusML||'').toUpperCase();
                        if(st === 'PAUSADA') return '‚è∏Ô∏è PAUSADA';
                        if(st === 'INACTIVA') return '‚ùå INACTIVA';
                        if(st === 'ACTIVA') return '‚úÖ ACTIVA';
                        if(c.key === 'mlEsUrgente') return r.mlEsUrgente ? 'üî• URGENTE' : '-';
                        return st;
                    }
                    if(c.key === 'estadoMLA') {
                        const st = (r.estadoMLA||'').toUpperCase();
                        if(st === 'ACTIVE') return '‚úÖ ACTIVE';
                        if(st === 'PAUSED') return '‚è∏Ô∏è PAUSED';
                        if(st === 'UNDER_REVIEW') return '‚ö†Ô∏è REVIEW';
                        return r.estadoMLA || '-';
                    }
                    if(c.key === 'antiguedadStock') {
                         if(!r.antiguedadStock) return '-';
                         if(r.antiguedadStock.includes('2 and 4')) return '‚ö†Ô∏è 2-4 Meses';
                         if(r.antiguedadStock.includes('4 and 6')) return 'üü† 4-6 Meses';
                        if(r.antiguedadStock.includes('6 and 12')) return 'üî• 6-12 Meses';
                        if(r.antiguedadStock.includes('Over 12')) return 'üíÄ +12 Meses';
                        return r.antiguedadStock;
                   }


                   if(c.key === 'statusVisual') return r.statusVisual;
                   if(c.key === 'fechaCarga') return new Date().toLocaleDateString('es-AR');
                   if(c.key === 'subPerfil') return r.subPerfil || '-';
                   if(c.key === 'vta30d_80') {
                       return (r.vta30d_80 || 0).toFixed(0);
                   }
                   if(c.key === 'vta30d') {
                       return (r.vta30d || 0).toFixed(0);
                   }
                   
                   // üõí Formato para columnas Q MES (Market)
                   if(c.key.startsWith('q') && ['qEnero','qFebrero','qMarzo','qAbril','qMayo','qJunio','qJulio','qAgosto','qSeptiembre','qOctubre','qNoviembre','qDiciembre'].includes(c.key)) {
                       const val = r[c.key];
                       if(val === undefined || val === null || val === 0) return '-';
                       return val.toLocaleString('es-AR');
                   }
                   
                   // üõí Formato para SHARE % NOV
                   if(c.key === 'shareNov') {
                       const share = r.shareNov || 0;
                       if(share === 0) return '-';
                       return share.toFixed(1) + '%';
                   }
                   
                   // üì¶ Formato para % EXCEDENTE
                   if(c.key === 'pctExcedente') {
                       const pct = r.pctExcedente || 0;
                       if(pct === 0) return '-';
                       return pct.toFixed(1) + '%';
                   }
                   
                   let val = c.key.split('.').reduce((o,i)=>(o?o[i]:0), r);
                   if(c.key.includes('inversion') || c.key.includes('totalStockVal') || c.key.includes('inmoVal') || c.key.includes('valorizado') || c.key.includes('deuda') || c.key==='stockValorizado' || c.key==='costoExcedente') return this.formatMoney(val);
                   if((c.key.includes('fecha') || c.key.includes('Ingreso') || c.key.includes('Vto')) && typeof val==='number') return new Date((val-25569)*86400000).toLocaleDateString('es-AR');
                   if(typeof val==='number') return c.key.includes('dias') ? val.toFixed(1) : (Number.isInteger(val) ? val : val.toFixed(2));
                   return val;
               },
               formatMoney(v) { return '$ '+(v||0).toLocaleString('es-AR',{maximumFractionDigits:0}); },
               
               // üîß M√©todos auxiliares para procesamiento de datos
               cleanString(str) {
                   if (!str) return '';
                   return String(str).trim().toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
               },
               
               parseNumber(val) {
                   if (val === null || val === undefined || val === '') return 0;
                   if (typeof val === 'number') return val;
                   const str = String(val).replace(/\s/g, '');
                   if (str.includes(',') && str.includes('.')) {
                       if (str.lastIndexOf(',') > str.lastIndexOf('.')) {
                           return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
                       }
                       return parseFloat(str.replace(/,/g, '')) || 0;
                   }
                   if (str.includes(',')) return parseFloat(str.replace(',', '.')) || 0;
                   return parseFloat(str) || 0;
               },
               
               findColumnIndex(headers, aliases) {
                   for (let alias of aliases) {
                       const idx = headers.findIndex(h => String(h).toUpperCase().includes(alias.toUpperCase()));
                       if (idx > -1) return idx;
                   }
                   return -1;
               },
               
               excelDateToJSDate(serial) {
                   if (!serial || isNaN(serial)) return serial;
                   try {
                       const utc_days = Math.floor(serial - 25569);
                       const utc_value = utc_days * 86400000;
                       const date_info = new Date(utc_value);
                       const day = String(date_info.getUTCDate()).padStart(2, '0');
                       const month = String(date_info.getUTCMonth() + 1).padStart(2, '0');
                       const year = date_info.getUTCFullYear();
                       return `${day}/${month}/${year}`;
                   } catch(e) {
                       return serial;
                   }
               },
               
               // üßä Calcular valor de stock viejo seg√∫n filtros seleccionados
               getStockViejoValue() {
                   if(!this.masterData || this.masterData.length === 0) return this.kpiDashboard?.dineroViejo || 0;
                   
                   // Si no hay filtros, usar >45 d√≠as por defecto
                   const filters = this.stockViejoFilters.length > 0 ? this.stockViejoFilters : ['>45'];
                   
                   // Obtener el m√≠nimo de d√≠as de los filtros seleccionados
                   const minDays = Math.min(...filters.map(f => parseInt(f.replace('>', ''))));
                   
                   return this.masterData
                       .filter(item => item.diasStock > minDays)
                       .reduce((sum, item) => sum + (item.stockGrafana * item.costo), 0);
               },
               
               // üßä Obtener datos filtrados de stock viejo para la solapa inmovilizado
               getStockViejoFiltered() {
                   if(!this.masterData || this.masterData.length === 0) return [];
                   
                   const filters = this.stockViejoFilters.length > 0 ? this.stockViejoFilters : ['>45'];
                   const minDays = Math.min(...filters.map(f => parseInt(f.replace('>', ''))));
                   
                   return this.masterData.filter(item => item.diasStock > minDays);
               },

               // üì¶ Obtener cantidad de SKUs con stock sin venta (seg√∫n filtros seleccionados)
               getStockSinVentaCount() {
                   if(!this.masterData || this.masterData.length === 0) return 0;
                   if(this.stockSinVentaFilters.length === 0) {
                       // Por defecto mostrar todos los SKUs con stock > 0 y vtarTotal === 0
                       return this.masterData.filter(i => i.stockGrafana > 0 && i.vtarTotal === 0 && this.getDiasSinVenta(i) > 0).length;
                   }
                   return this.masterData.filter(i => {
                       if (!(i.stockGrafana > 0 && i.vtarTotal === 0 && this.getDiasSinVenta(i) > 0)) return false;
                       const dias = this.getDiasSinVenta(i);
                       return this.stockSinVentaFilters.some(f => {
                           if(f === '20-30') return dias >= 20 && dias <= 30;
                           if(f === '31-40') return dias >= 31 && dias <= 40;
                           if(f === '41-50') return dias >= 41 && dias <= 50;
                           if(f === '>51') return dias > 51;
                           return false;
                       });
                   }).length;
               },

               // Calcula d√≠as desde la √∫ltima venta para un SKU
               getDiasSinVenta(item) {
                   if (!item.histDaily || !Array.isArray(item.histDaily) || item.histDaily.length === 0) return 0;
                   for (let i = 0; i < item.histDaily.length; i++) {
                       if (item.histDaily[item.histDaily.length - 1 - i] > 0) {
                           return i;
                       }
                   }
                   return item.histDaily.length; // Nunca vendi√≥ en el per√≠odo
               },

               openModal(r) {
                   const m = this.masterData.find(x => x.sku === r.sku);
                   this.selectedRow = m ? {...m, dep: r.dep} : r;

                   if (this.selectedRow && this.selectedRow.sku) {
                       this.selectedRowLotes = this.lotesData
                           .filter(l => l.sku === this.selectedRow.sku)
                           .sort((a,b) => a.dias - b.dias);
                   } else {
                       this.selectedRowLotes = [];
                   }

                   this.modalOpen = true;
               },
               sortBy(k) { if(this.sortCol===k) this.sortAsc=!this.sortAsc; else {this.sortCol=k; this.sortAsc=true;} },
               resetApp() { if(confirm('¬øBorrar base de datos local?')) DB.clear().then(()=>location.reload()); },
               nextPage() { if(this.currentPage < this.totalPages) this.currentPage++; },
               prevPage() { if(this.currentPage > 1) this.currentPage--; },
               get totalPages() { return Math.ceil(this.filteredData.length/this.pageSize)||1; },








               updateKPIs() {
                    // 1. Totales Generales (Compras, Env√≠os, etc.)
                    this.kpis.compra = this.masterData.reduce((a,b)=>a+b.inversion,0);
                    this.kpis.skusCompra = this.masterData.filter(b=>b.comprarU>0).length;
                    this.kpis.envios = this.masterData.reduce((a,b)=>a+b.qEnviar,0);
                    this.kpis.valorEnvios = this.masterData.reduce((a,b)=>a+b.valorizado,0);
                    this.kpis.cantImpulsar = this.masterData.filter(b=>b.impulsar).length;
                    this.kpis.enCamino = this.masterData.reduce((a,b)=>a+(b.comprasEnCamino||0),0);
                    // SOBRESTOCK: Solo el costo de las unidades que EXCEDEN los 45 d√≠as
                    this.kpis.inmovilizado = this.masterData.reduce((a,b) => a + (b.costoExcedente || 0), 0);
                    
                    // Venta Perdida (Feature anterior)
                    this.kpis.ventaPerdidaTotal = this.masterData.reduce((a,b) => a + (b.ventaPerdida || 0), 0);

                    // --- NUEVO KPI: Total Arbitraje (Dinero a recuperar moviendo stock) ---
                    this.kpis.arbitrageTotal = this.masterData.reduce((a,b) => a + (b.arbitrageVal || 0), 0);
                    // ---------------------------------------------------------------------

                    // 2. L√≥gica de Cash Flow (Mantenemos lo que ya ten√≠as)
                    const cf = { w1: 0, w2: 0, w3: 0, w4: 0 };
                    this.masterData.forEach(item => {
                        if (item.comprarU > 0) {
                            const d = item.diasStock;
                            const plata = item.inversion;
                            if (d < 7) cf.w1 += plata;
                            else if (d < 14) cf.w2 += plata;
                            else if (d < 21) cf.w3 += plata;
                            else cf.w4 += plata;
                        }
                    });
                    this.metrics.cashFlow = cf;

                    // 3. L√≥gica de Aging (Mantenemos lo que ya ten√≠as)
                    const ag = { f0_30: 0, f31_60: 0, f61_90: 0, f91_180: 0, f180: 0 };
                    this.masterData.forEach(item => {
                        if (item.stockGrafana > 0) {
                            const val = item.stockValorizado;
                            const d = item.diasStock;
                            if (d <= 30) ag.f0_30 += val;
                            else if (d <= 60) ag.f31_60 += val;
                            else if (d <= 90) ag.f61_90 += val;
                            else if (d <= 180) ag.f91_180 += val;
                            else ag.f180 += val;
                        }
                    });
                    this.metrics.aging = ag;
                },

                renderCharts() {
                   // 1. Obtener contextos
                   const ctx1 = document.getElementById('chartAnalista');
                   const ctx2 = document.getElementById('chartHealth');
                   const ctx3 = document.getElementById('chartDeudaHistory');
                   const ctx4 = document.getElementById('chartBrands');
                   const ctx5 = document.getElementById('chartProfiles');
                   const ctx6 = document.getElementById('chartCashFlow');
                   const ctx7 = document.getElementById('chartAging');

                   // 2. Limpiar anteriores
                   if(this.chartInstances['ana']) this.chartInstances['ana'].destroy();
                   if(this.chartInstances['health']) this.chartInstances['health'].destroy();
                   if(this.chartInstances['debt']) this.chartInstances['debt'].destroy();
                   if(this.chartInstances['brand']) this.chartInstances['brand'].destroy();
                   if(this.chartInstances['prof']) this.chartInstances['prof'].destroy();
                   if(this.chartInstances['cf']) this.chartInstances['cf'].destroy();
                   if(this.chartInstances['ag']) this.chartInstances['ag'].destroy();

                   // 3. Gr√°ficos existentes...
                   const topAna = this.metrics.analistas;
                   if(ctx1) {
                       this.chartInstances['ana'] = new Chart(ctx1, {
                           type: 'bar',
                           data: { labels: topAna.map(x=>x.name), datasets: [{ label: 'Deuda Total ($)', data: topAna.map(x=>x.val), backgroundColor: '#dc2626' }] },
                           options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
                       });
                   }

                   if(ctx2) {
                       this.chartInstances['health'] = new Chart(ctx2, {
                           type: 'doughnut',
                           data: { labels: ['Quiebres', 'Por Quebrar', 'Saludable', 'Alerta', 'Sobrestock'], datasets: [{ data: [this.metrics.health.q, this.metrics.health.pq, this.metrics.health.s, this.metrics.health.a, this.metrics.health.o], backgroundColor: ['#7f1d1d', '#dc2626', '#16a34a', '#ca8a04', '#9333ea'] }] },
                           options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, onClick: (evt, elements) => { if(elements.length > 0) { const index = elements[0].index; const mapStatus = ['Quiebre', 'Por Quebrar', 'Saludable', 'Alerta', 'Sobrestock']; this.switchTab('matriz_det'); this.activeFilters['estadoSalud'] = [mapStatus[index]]; } } }
                       });
                   }

                   if(ctx3 && this.debtHistory.length > 0) {
                       const sortedDebt = this.debtHistory.sort((a,b) => new Date(a.date) - new Date(b.date));
                       this.chartInstances['debt'] = new Chart(ctx3, {
                           type: 'line',
                           data: { labels: sortedDebt.map(d => d.date), datasets: [{ label: 'Evoluci√≥n Deuda ($)', data: sortedDebt.map(d => d.val), borderColor: '#dc2626', backgroundColor: 'rgba(220, 38, 38, 0.1)', fill: true, tension: 0.3 }] },
                           options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
                       });
                   }

                   if(ctx4 && this.metrics.brands.length > 0) {
                       this.chartInstances['brand'] = new Chart(ctx4, {
                           type: 'bar',
                           data: { labels: this.metrics.brands.map(b => b.name), datasets: [{ label: 'Capital Invertido ($)', data: this.metrics.brands.map(b => b.val), backgroundColor: '#4f46e5' }] },
                           options: { responsive: true, maintainAspectRatio: false, onClick: (evt, elements) => { if(elements.length > 0) { const index = elements[0].index; const brand = this.metrics.brands[index].name; if(brand !== 'OTROS') { this.switchTab('consolidado'); this.activeFilters['marca'] = [brand]; } } } }
                       });
                   }

                   if(ctx5 && this.metrics.profiles && this.metrics.profiles.length > 0) {
                       this.chartInstances['prof'] = new Chart(ctx5, {
                           type: 'doughnut',
                           data: { labels: this.metrics.profiles.map(p => p.name), datasets: [{ data: this.metrics.profiles.map(p => p.money), backgroundColor: ['#ea580c', '#3b82f6', '#22c55e', '#94a3b8', '#eab308', '#a855f7'], borderWidth: 0 }] },
                           options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } }, tooltip: { callbacks: { label: function(context) { return (context.label||'') + ': $ ' + (context.raw ? context.raw.toLocaleString('es-AR') : '0'); } } } }, onClick: (evt, elements) => { if(elements.length > 0) { const index = elements[0].index; const perfilName = this.metrics.profiles[index].name; this.switchTab('consolidado'); this.activeFilters['perfil'] = [perfilName]; } } }
                       });
                   }

                   if(ctx6 && this.metrics.cashFlow) {
                        const cfData = this.metrics.cashFlow;
                        this.chartInstances['cf'] = new Chart(ctx6, {
                            type: 'bar',
                            data: { labels: ['Semana 1 (Urgente)', 'Semana 2', 'Semana 3', 'Semana 4+'], datasets: [{ label: 'Necesidad de Pago Estimada ($)', data: [cfData.w1, cfData.w2, cfData.w3, cfData.w4], backgroundColor: ['#dc2626', '#f97316', '#eab308', '#3b82f6'], borderRadius: 4 }] },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + (v/1000000).toFixed(1) + 'M' } } } }
                        });
                   }

                   // 9. GRAFICO AGING CON CLICK (ESTE ES EL CAMBIO IMPORTANTE)
                   if(ctx7 && this.metrics.aging) {
                        const ag = this.metrics.aging;
                        this.chartInstances['ag'] = new Chart(ctx7, {
                            type: 'bar',
                            data: {
                                labels: ['0-30d', '31-60d', '61-90d', '91-180d', '>180d'],
                                datasets: [{
                                    label: 'Stock Valorizado ($)',
                                    data: [ag.f0_30, ag.f31_60, ag.f61_90, ag.f91_180, ag.f180],
                                    backgroundColor: ['#22c55e', '#eab308', '#f97316', '#ef4444', '#475569'],
                                    borderRadius: 4
                                }]
                            },
                            options: {
                                indexAxis: 'y',
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: { x: { beginAtZero: true, ticks: { callback: v => '$' + (v/1000000).toFixed(1) + 'M' } } },
                                
                    
                                // CORRECCI√ìN DEFINITIVA DEL CLICK (Con retraso de seguridad)
                                onClick: (evt, elements) => {
                                    if (elements.length > 0) {
                                        const index = elements[0].index;
                                        const labels = ['0-30d', '31-60d', '61-90d', '91-180d', '>180d'];
                                        const selectedLabel = labels[index];
                                        
                                        // 1. Cambiamos de pesta√±a (esto limpia la pantalla)
                                        this.switchTab('consolidado');
                                        
                                        // 2. Esperamos 50ms para aplicar el filtro (asegura que no se borre)
                                        setTimeout(() => {
                                            this.filterAging = selectedLabel;
                                        }, 50); 
                                    }
                                }
                            }
                        });
                   }
               }
               
           }
       }
   </script>
</body>
</html>

