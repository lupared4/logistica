<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Inventario Pro (V93 - Master AI Ultimate)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        [x-cloak] { display: none !important; }

        th { background-color: #1e293b; color: white; font-size: 10px; text-transform: uppercase; position: sticky; top: 0; z-index: 10; white-space: nowrap; padding: 8px; }
        td { font-size: 11px; border-bottom: 1px solid #e2e8f0; padding: 4px 8px; white-space: nowrap; color: #334155; position: relative; height: 35px; }
        tr:hover td { background-color: #f0f9ff; cursor: pointer; }

        .data-bar-bg { position: absolute; left: 0; top: 2px; bottom: 2px; z-index: 0; opacity: 0.25; pointer-events: none; transition: width 0.3s ease; }
        .cell-content { position: relative; z-index: 1; display: flex; align-items: center; height: 100%; width: 100%; }
        
        .sparkline-container { width: 60px; height: 25px; display: flex; align-items: center; justify-content: center; margin-right: 8px; flex-shrink: 0; }
        .sparkline-container svg { display: block; width: 100%; height: 100%; }

        .sticky-left { position: sticky; left: 0; z-index: 20; background-color: inherit; border-right: 2px solid #cbd5e1; }
        .tab-active { background: #fff; border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: bold; }
        .tab-inactive { color: #64748b; background: transparent; }
        .table-container { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .filter-dropdown { position: absolute; top: 100%; left: 0; background: white; border: 1px solid #cbd5e1; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 4px; padding: 8px; z-index: 50; min-width: 180px; max-height: 250px; overflow-y: auto; color: #334155; font-weight: normal; text-transform: none; }

        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); cursor: pointer; transition: all 0.2s ease-in-out; }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #2563eb; cursor: pointer; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #cbd5e1; border-radius: 2px; }

        .chat-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        .slide-over { transform: translateX(100%); transition: transform 0.3s ease-in-out; }
        .slide-over.open { transform: translateX(0); }

        .fab-enter { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden" x-data="inventoryApp()" x-init="initApp()" x-cloak>

    <header class="bg-white border-b px-4 py-2 flex justify-between items-center shadow-sm shrink-0 z-30">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-700 text-white font-bold px-2 py-1 rounded text-xs shadow">INV PRO V93</div>
            <div>
                <h1 class="text-sm font-bold text-slate-800">Dashboard</h1>
                <div class="text-[10px] text-slate-500 flex items-center gap-1" x-show="lastUpdate">
                    <span>üïí Datos al:</span>
                    <span class="font-bold text-indigo-600" x-text="lastUpdate"></span>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-4 bg-slate-50 px-3 py-1 rounded border border-slate-200" x-show="dataReady">
            <div class="flex flex-col" x-show="currentTab !== 'otros_depositos'">
                <label class="text-[9px] font-bold text-slate-500 uppercase">Cobertura Compra</label>
                <div class="flex items-center gap-1">
                    <input type="number" x-model.number="params.diasCompra" @change="recalculateGlobal" class="w-12 text-xs border rounded text-center font-bold text-emerald-600" min="1">
                    <span class="text-[10px]">d√≠as</span>
                </div>
            </div>
            <div class="w-px h-6 bg-slate-300" x-show="currentTab !== 'otros_depositos'"></div>
            <div class="flex flex-col" x-show="currentTab !== 'otros_depositos'">
                <label class="text-[9px] font-bold text-slate-500 uppercase">Dep√≥sitos</label>
                <div class="flex items-center gap-1">
                    <input type="number" x-model.number="params.diasSuc" @change="recalculateGlobal" class="w-12 text-xs border rounded text-center font-bold text-blue-600" min="1">
                    <span class="text-[10px]">d√≠as</span>
                </div>
            </div>
            
            <button @click="showSeasonalityModal = true" class="bg-orange-100 text-orange-700 hover:bg-orange-200 px-3 py-1 rounded text-xs font-bold transition flex items-center gap-1 border border-orange-200 ml-2">
                <span>‚öôÔ∏è</span> Estacionalidad
            </button>

            <button @click="showSimulator = true" class="bg-purple-100 text-purple-700 hover:bg-purple-200 px-3 py-1 rounded text-xs font-bold transition flex items-center gap-1 border border-purple-200 ml-2">
                <span>üéõÔ∏è</span> Simulador
            </button>

            <button @click="recalculateGlobal" class="bg-blue-100 text-blue-600 hover:bg-blue-200 px-2 py-1 rounded text-xs font-bold transition">‚Üª Recalcular</button>
        
            <button @click="focusMode = !focusMode" 
                class="transition-all duration-300 border px-3 py-1.5 rounded text-xs font-bold flex gap-2 items-center shadow mr-2"
                :class="focusMode ? 'bg-slate-800 text-white border-slate-900 ring-2 ring-slate-400' : 'bg-white text-slate-600 border-slate-300 hover:bg-slate-100'">
                <span>   </span> <span x-text="focusMode ? 'MODO FOCUS: ACTIVO' : 'Modo Focus'"></span>
            </button>
        </div>

        <div class="flex items-center gap-2">
            <button @click="copySkus" :disabled="!dataReady" class="bg-slate-700 hover:bg-slate-800 text-white font-bold py-1.5 px-3 rounded text-xs flex gap-2 items-center shadow transition">
                <span x-text="copyFeedback ? '‚úÖ COPIADO' : 'üìã Copiar SKUs'"></span>
            </button>
            <button @click="exportExcel" :disabled="!dataReady" class="bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 text-white font-bold py-1.5 px-3 rounded text-xs flex gap-2 items-center shadow transition">
                <span>üìä</span> Excel
            </button>
            <label class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-4 rounded shadow text-xs flex gap-2 items-center transition">
                <span x-text="dataReady ? 'üîÑ ACTUALIZAR' : 'üìÇ CARGAR EXCEL'"></span>
                <input type="file" class="hidden" accept=".xlsx, .xls" @change="handleFile">
            </label>
            <button @click="resetApp" class="text-slate-400 hover:text-red-500 p-1.5 transition" title="Borrar datos y reiniciar">üóëÔ∏è</button>
        </div>
    </header>

    <main class="flex-1 flex flex-col p-4 overflow-hidden bg-slate-100 relative">

        <div x-show="isLoading" class="absolute inset-0 bg-white/90 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-3"></div>
            <span class="text-sm font-bold text-blue-800 animate-pulse" x-text="loadingMsg">PROCESANDO DATOS...</span>
        </div>

        <div x-show="!dataReady && !isLoading" class="flex-1 flex flex-col items-center justify-center text-slate-300">
            <div class="text-6xl mb-4">üíæ</div>
            <p class="text-lg font-medium">No hay datos guardados</p>
            <p class="text-sm">Sube tu archivo Excel para comenzar.</p>
        </div>

        <div class="flex-1 flex flex-col bg-white rounded-lg border shadow-sm overflow-hidden relative" x-show="dataReady">

            <div class="flex border-b px-4 pt-3 gap-6 shrink-0 bg-slate-50 overflow-x-auto">
                <template x-for="tab in tabs" :key="tab.id">
                    <button @click="switchTab(tab.id)"
                        class="pb-2 text-xs uppercase tracking-wider font-bold transition-colors relative whitespace-nowrap"
                        :class="currentTab === tab.id ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-400 hover:text-slate-600'">
                        <span x-text="tab.label"></span>
                    </button>
                </template>
            </div>

            <div class="bg-indigo-50 border-b px-4 py-2 flex justify-between items-center text-xs sticky top-0 z-20" x-show="currentTab !== 'metricas'">
                <div class="font-bold text-indigo-800 uppercase tracking-wide flex items-center gap-2">
                    <span class="text-lg">üìç</span> <span x-text="getHeaderTitle()"></span>
                </div>
                <div class="flex gap-6 text-indigo-700 font-medium">
                    <span x-html="getHeaderStats()"></span>
                </div>
            </div>

            <div class="p-2 border-b bg-white flex gap-3 items-center shrink-0" x-show="currentTab !== 'metricas'">
                <div class="relative">
                    <span class="absolute left-2 top-1.5 text-slate-400">üîç</span>
                    <input type="text" x-model="search" placeholder="Buscar SKU, Nombre, Marca, Proveedor..." class="border rounded pl-7 pr-3 py-1.5 text-xs w-64 focus:outline-none focus:border-blue-400 shadow-sm">
                </div>

                <button x-show="currentTab === 'inmovilizado'" @click="showLiquidationModal = true" class="bg-red-100 text-red-700 hover:bg-red-200 px-3 py-1.5 rounded border border-red-200 text-xs font-bold transition flex items-center gap-1">
                    <span>üí∏</span> Calc. Liquidaci√≥n
                </button>
                <button x-show="currentTab === 'dep80'" @click="filterMLUrgencies = !filterMLUrgencies" 
                    class="px-3 py-1.5 rounded border text-xs font-bold transition flex items-center gap-1 shadow-sm"
                    :class="filterMLUrgencies ? 'bg-red-600 text-white border-red-700 ring-2 ring-red-300' : 'bg-white text-slate-600 border-slate-300 hover:bg-slate-50'">
                    <span>üö®</span> <span x-text="filterMLUrgencies ? 'Viendo Urgencias ML' : 'Filtrar Urgencias ML'"></span>
                </button>

                <div class="relative" x-data="{ openDates: false }" x-show="currentTab !== 'vencimientos' && currentTab !== 'otros_depositos'">
                    <button @click="openDates = !openDates" @click.outside="openDates = false"
                        class="flex items-center justify-between gap-2 bg-blue-50 px-3 py-1.5 rounded border border-blue-100 text-xs text-blue-800 font-bold hover:bg-blue-100 transition w-48"
                        :class="selectedEnvioFechas.length > 0 ? 'ring-2 ring-blue-300' : ''">
                        <span x-text="selectedEnvioFechas.length === 0 ? 'üìÖ Filtrar por Fecha' : selectedEnvioFechas.length + ' fechas activas'"></span>
                        <span class="text-[10px]">‚ñº</span>
                    </button>
                    <div x-show="openDates" class="absolute top-full left-0 mt-1 w-64 bg-white border rounded shadow-xl z-50 max-h-80 overflow-y-auto scrollbar-thin flex flex-col">
                        <div class="p-2 border-b bg-slate-50 flex justify-between items-center sticky top-0 z-10">
                            <span class="text-[10px] font-bold text-slate-500">Selecciona Fechas</span>
                            <button @click="selectedEnvioFechas = []" class="text-[9px] text-red-500 hover:underline">Borrar Todo</button>
                        </div>
                        <div class="p-1">
                            <template x-for="fecha in uniqueEnvioFechas" :key="fecha">
                                <label class="flex items-center gap-2 px-2 py-1.5 hover:bg-blue-50 rounded cursor-pointer text-xs transition-colors" @click.stop>
                                    <input type="checkbox" :value="fecha" x-model="selectedEnvioFechas" class="rounded border-slate-300 text-blue-600 focus:ring-0 w-4 h-4">
                                    <span x-text="fecha" class="text-slate-700 font-medium"></span>
                                </label>
                            </template>
                        </div>
                        <div class="p-2 border-t bg-slate-50 sticky bottom-0 z-10 text-center">
                            <button @click="openDates = false" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 w-full">Cerrar</button>
                        </div>
                    </div>
                </div>

                <div x-show="currentTab === 'vencimientos'" class="flex items-center gap-2 bg-orange-50 px-2 py-1 rounded border border-orange-100">
                    <label class="text-[10px] font-bold text-orange-700 uppercase">Vencimiento:</label>
                    <select x-model="filterLotesRange" class="text-xs border rounded p-1 text-orange-800 focus:outline-none">
                        <option value="all">Todos</option>
                        <option value="0-30">üî¥ Cr√≠tico (0-30 d√≠as)</option>
                        <option value="31-60">üü† Riesgo (31-60 d√≠as)</option>
                        <option value="61-90">üü° Alerta (61-90 d√≠as)</option>
                        <option value="90+">üü¢ Seguro (+90 d√≠as)</option>
                    </select>
                </div>

                <div x-show="currentTab === 'otros_depositos'" class="flex items-center gap-2 bg-purple-50 px-2 py-1 rounded border border-purple-100">
                    <label class="text-[10px] font-bold text-purple-700 uppercase">Dep√≥sitos:</label>
                    <div class="flex gap-2">
                        <template x-for="d in availableOtherDeps" :key="d">
                            <label class="flex items-center gap-1 cursor-pointer hover:bg-purple-100 px-1 rounded transition-colors">
                                <input type="checkbox" :value="d" x-model="selectedOtherDeps" class="rounded border-purple-300 text-purple-600 focus:ring-0 w-3 h-3">
                                <span x-text="d" class="text-xs text-purple-800 font-bold"></span>
                            </label>
                        </template>
                    </div>
                </div>

                <div class="flex items-center gap-2 flex-wrap" x-show="Object.keys(activeFilters).length > 0">
                    <span class="text-[10px] text-slate-400 font-bold uppercase">Filtros Activos:</span>
                    <template x-for="(vals, key) in activeFilters" :key="key">
                        <span class="bg-slate-100 border text-slate-600 text-[10px] px-2 py-0.5 rounded flex items-center gap-1">
                            <span x-text="getColLabel(key) + ': ' + vals.length"></span>
                            <button @click="clearFilter(key)" class="hover:text-red-500 font-bold">√ó</button>
                        </span>
                    </template>
                    <button @click="activeFilters = {}" class="text-[9px] text-red-500 hover:underline">Borrar todos</button>
                </div>

                <div class="flex-1 flex justify-end items-center gap-2">
                    <span class="text-[10px] text-slate-500 uppercase font-bold mr-2" x-text="filteredData.length + ' Filas'"></span>
                    <button @click="prevPage" :disabled="currentPage===1" class="p-1 px-2 bg-slate-100 border rounded hover:bg-slate-200 disabled:opacity-50 text-xs">‚óÄ</button>
                    <span class="text-xs font-mono w-12 text-center" x-text="currentPage + '/' + totalPages"></span>
                    <button @click="nextPage" :disabled="currentPage>=totalPages" class="p-1 px-2 bg-slate-100 border rounded hover:bg-slate-200 disabled:opacity-50 text-xs">‚ñ∂</button>
                </div>
            </div>

            <div class="flex-1 overflow-auto table-container relative bg-white" x-show="currentTab !== 'metricas'">
                <div x-show="filterOpportunityCost" class="bg-red-50 text-red-800 px-4 py-2 text-xs font-bold border-b border-red-100 flex justify-between items-center animate-in slide-in-from-top duration-300">
                    <div class="flex items-center gap-2">
                        <span class="text-lg animate-pulse">üî•</span>
                        <span>MODO ALERTA: Mostrando productos con Venta Perdida (Stock 0 + Activos).</span>
                    </div>
                    <button @click="filterOpportunityCost = false" class="text-[10px] underline hover:text-red-950 bg-white px-2 py-1 rounded border border-red-100 hover:bg-red-50 transition">
                        Mostrar Todo
                    </button>
                </div>
                <div x-show="currentTab === 'dep80' && selectedEnvioFechas.length > 0" class="bg-yellow-50 text-yellow-800 px-4 py-2 text-xs font-bold border-b border-yellow-100 flex justify-between items-center">
                    <span>‚ö†Ô∏è FILTRANDO POR FECHAS SELECCIONADAS: Mostrando solo SKUs enviados en las fechas marcadas.</span>
                    <button @click="selectedEnvioFechas = []" class="underline hover:text-yellow-900">Limpiar Fechas</button>
                </div>

                <div x-show="filterAging" class="bg-indigo-50 text-indigo-800 px-4 py-2 text-xs font-bold border-b border-indigo-100 flex justify-between items-center animate-in slide-in-from-top duration-300">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">üê¢</span>
                        <span>FILTRO ANTIG√úEDAD: Mostrando stock con antig√ºedad <span x-text="filterAging" class="bg-white px-1 rounded border border-indigo-200 ml-1"></span></span>
                    </div>
                    <button @click="filterAging = null" class="text-[10px] underline hover:text-indigo-950 bg-white px-2 py-1 rounded border border-indigo-100 hover:bg-indigo-50 transition">
                        Borrar Filtro
                    </button>
                </div>

                <div x-show="filterArbitrage" class="bg-purple-50 text-purple-800 px-4 py-2 text-xs font-bold border-b border-purple-100 flex justify-between items-center animate-in slide-in-from-top duration-300">
                    <div class="flex items-center gap-2">
                        <span class="text-lg animate-pulse">üîÑ</span>
                        <span>OPORTUNIDAD ARBITRAJE: Mostrando SKUs para enviar urgente (Hay en Central -> Falta en Full).</span>
                    </div>
                    <button @click="filterArbitrage = false" class="text-[10px] underline hover:text-purple-950 bg-white px-2 py-1 rounded border border-purple-100 hover:bg-purple-50 transition">
                        Mostrar Todo
                    </button>
                </div>

                <table class="w-full border-collapse">
                    <thead class="bg-slate-800 text-white">
                        <tr>
                            <th class="sticky-left z-20 w-8 bg-slate-800 px-2">
                                <input type="checkbox" @change="toggleSelectAll($event)" class="rounded border-slate-500 bg-slate-700 text-blue-500 focus:ring-0">
                            </th>

                            <template x-for="col in getColumns()" :key="col.key">
                                <th class="text-left group transition relative" :class="col.key === 'sku' || col.key === 'prov' ? 'sticky-left bg-slate-800' : ''">
                                    <div class="flex items-center justify-between gap-1">
                                        <div class="flex items-center gap-1 cursor-pointer hover:text-blue-300" @click="sortBy(col.key)">
                                            <span x-text="col.label"></span>
                                            <span x-show="sortCol === col.key" x-text="sortAsc ? '‚ñ≤' : '‚ñº'" class="text-yellow-400 text-[9px]"></span>
                                        </div>
                                        
                                        <div x-show="isFilterable(col.key)" class="relative">
                                            <button @click.stop="toggleFilterMenu(col.key)" class="p-1 hover:bg-slate-600 rounded text-slate-400 hover:text-white transition" :class="activeFilters[col.key] ? 'text-blue-400 font-bold' : ''">‚ñº</button>
                                            <div x-show="filterMenuOpen === col.key" @click.outside="filterMenuOpen = null" class="filter-dropdown text-left">
                                                <div class="mb-2 pb-2 border-b flex justify-between items-center sticky top-0 bg-white">
                                                    <span class="text-[10px] font-bold text-slate-500">Filtrar por <span x-text="col.label"></span></span>
                                                    <button @click="clearFilter(col.key); filterMenuOpen=null" class="text-[9px] text-red-500 hover:underline">Limpiar</button>
                                                </div>
                                                <div class="flex flex-col gap-1 max-h-40 overflow-y-auto scrollbar-thin">
                                                    <template x-for="val in getUniqueValues(col.key)" :key="val">
                                                        <label class="flex items-center gap-2 px-1 hover:bg-slate-50 cursor-pointer text-xs">
                                                            <input type="checkbox" :checked="isFilterChecked(col.key, val)" @change="toggleFilter(col.key, val)" class="rounded border-slate-300 text-blue-600 focus:ring-0 w-3 h-3">
                                                            <span x-text="val === '' ? '(Vac√≠o)' : val" class="truncate"></span>
                                                        </label>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </th>
                            </template>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="row in paginatedData" :key="row.id + '_' + (row.comprarU||0) + '_' + (row.diasEstrategia || 'def') + '_' + row.stockGrafana">
                            <tr class="group transition-colors hover:bg-blue-50" :class="selectedIds.includes(row.id) ? 'bg-blue-100' : ''">
                                
                                <td class="sticky-left bg-inherit border-r border-slate-200 text-center px-2">
                                    <input type="checkbox" :value="row.id" x-model="selectedIds" class="rounded border-slate-300 text-blue-600 focus:ring-0">
                                </td>

                                <template x-for="col in getColumns()">
                                    <td class="border-r border-slate-100 group-hover:border-blue-200 relative overflow-hidden"
                                        :class="[getCellClass(col, row), (col.key === 'sku' || col.key === 'prov' && currentTab === 'proveedores') ? 'sticky-left group-hover:bg-blue-50 bg-white' : '']"
                                        @click="if(!isEditable(col.key) && col.key !== 'actions') openModal(row)"
                                        @dblclick="startEdit(row, col.key)"
                                        :title="getTooltip(col, row)">

                                        <div class="data-bar-bg" :style="getBarStyle(col, row)"></div>

                                        <div class="cell-content w-full flex items-center" :class="col.key === 'vtarTotal' ? 'justify-end' : ''">
                                            
                                            <template x-if="col.key === 'vtarTotal' && row.trendHistory && row.trendHistory.length > 1">
                                                <div class="sparkline-container" x-html="renderSparkline(row.trendHistory?.slice(-30), 60, 25)"></div>
                                            </template>

                                            <template x-if="col.key === 'sku'">
                                                <div class="flex items-center gap-2 w-full">
                                                    <span x-text="row.sku" class="font-bold text-slate-700"></span>
                                                    <span x-show="row.impulsar" class="text-[10px] bg-orange-100 text-orange-700 px-1 rounded border border-orange-200" title="Impulsar">üöÄ</span>
                                                    <span x-show="row.seasonalMult && row.seasonalMult !== 1" class="text-[10px] bg-indigo-100 text-indigo-700 px-1 rounded border border-indigo-200" title="Estacionalidad Aplicada">‚ùÑÔ∏è‚òÄÔ∏è</span>
                                                    <span x-show="row.criticalGap" class="text-sm ml-2" title="‚ö†Ô∏è QUIEBRE INEVITABLE">üíÄ</span>
                                                    <span x-show="row.isAnomaly" class="text-sm ml-2 cursor-help" title="üëÅÔ∏è IA: Anomal√≠a">üëÅÔ∏è</span>
                                                </div>
                                            </template>

                                            <template x-if="col.key === 'actions' && currentTab === 'proveedores'">
                                                <button @click.stop="exportProviderOrder(row.prov)" class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-1 rounded hover:bg-emerald-200 border border-emerald-300 font-bold flex items-center gap-1 shadow-sm">
                                                    üì• Orden
                                                </button>
                                            </template>

                                            <template x-if="isEditing(row, col.key)">
                                                <input type="number" class="w-full h-full text-right border-2 border-blue-500 rounded px-1 text-xs bg-white absolute inset-0 z-50" :value="row[col.key]" @blur="saveEdit(row, col.key, $event.target.value)" @keydown.enter="saveEdit(row, col.key, $event.target.value)" x-init="$el.focus()">
                                            </template>

                                            <template x-if="col.key === 'statusVisual'">
                                                <div class="flex justify-center w-full">
                                                    <span x-html="formatCell(col, row)"></span>
                                                </div>
                                            </template>

                                            <span x-show="!isEditing(row, col.key) && col.key !== 'sku' && col.key !== 'statusVisual' && col.key !== 'actions'" x-text="formatCell(col, row)"></span>
                                        </div>
                                    </td>
                                </template>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <div x-show="selectedIds.length > 0" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl z-50 flex items-center gap-4 fab-enter">
                <span class="font-bold text-sm"><span x-text="selectedIds.length"></span> seleccionados</span>
                <div class="h-4 w-px bg-slate-600"></div>
                <button @click="applyBulkEdit('diasEstrategia')" class="hover:text-blue-300 text-xs font-bold">üìÖ Cambiar D√≠as Est.</button>
                <button @click="applyBulkEdit('seasonalMult')" class="hover:text-orange-300 text-xs font-bold">‚ùÑÔ∏è Multiplicador</button>
                <div class="h-4 w-px bg-slate-600"></div>
                <button @click="selectedIds = []" class="text-slate-400 hover:text-white text-xs">Cancelar</button>
            </div>

            <div class="flex-1 overflow-y-auto bg-slate-50 p-6" x-show="currentTab === 'metricas'">

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div @click="switchTab('consolidado'); filterOpportunityCost = true;" 
                     class="bg-red-50 p-4 rounded-lg border-l-4 border-l-red-600 shadow-sm card-hover border border-red-100 relative overflow-hidden group cursor-pointer transition-transform hover:scale-[1.02]" 
                     title="Clic para ver detalle de p√©rdidas">
                        <div class="absolute right-2 top-2 text-2xl opacity-20 group-hover:scale-125 transition-transform">üî•</div>
                        <div class="text-[10px] font-bold text-red-800 uppercase tracking-wider">Flujo Perdido (Costo)</div>
                        <div class="text-2xl font-black text-red-600 mt-1" x-text="formatMoney(kpis.ventaPerdidaTotal)"></div>
                        <div class="text-[9px] text-red-500 font-bold mt-1 bg-red-100 inline-block px-1 rounded">Diario ¬∑ Solo Activos</div>
                    </div>


                    <div @click="switchTab('consolidado'); filterArbitrage = true;" 
                         class="bg-purple-50 p-4 rounded-lg border-l-4 border-l-purple-600 shadow-sm card-hover border border-purple-100 relative overflow-hidden group cursor-pointer transition-transform hover:scale-[1.02]" 
                         title="Clic para ver oportunidades de movimiento de stock">
                        <div class="absolute right-2 top-2 text-2xl opacity-20 group-hover:scale-125 transition-transform">üîÑ</div>
                        <div class="text-[10px] font-bold text-purple-800 uppercase tracking-wider">Arbitraje (Rescate)</div>
                        <div class="text-2xl font-black text-purple-600 mt-1" x-text="formatMoney(kpis.arbitrageTotal)"></div>
                        <div class="text-[9px] text-purple-500 font-bold mt-1 bg-purple-100 inline-block px-1 rounded">Mover Central -> Full</div>
                    </div>
                    


                    <div class="bg-white p-4 rounded-lg border-l-4 border-l-emerald-500 shadow-sm card-hover" @click="switchTab('resumen')">
                        <div class="text-xs font-bold text-slate-400 uppercase">Inversi√≥n Sugerida</div>
                        <div class="text-2xl font-bold text-emerald-700" x-text="formatMoney(kpis.compra)"></div>
                        <div class="text-xs text-emerald-600" x-text="kpis.skusCompra + ' SKUs a pedir'"></div>
                    </div>

                    <div class="bg-white p-4 rounded-lg border-l-4 border-l-purple-500 shadow-sm card-hover" @click="switchTab('dep80')">
                        <div class="text-xs font-bold text-slate-400 uppercase">A Enviar Dep 80</div>
                        <div class="text-2xl font-bold text-purple-700" x-text="kpis.envios.toLocaleString() + ' u.'"></div>
                        <div class="text-xs text-purple-600" x-text="formatMoney(kpis.valorEnvios)"></div>
                    </div>

                    <div class="bg-white p-4 rounded-lg border-l-4 border-l-blue-500 shadow-sm card-hover" @click="switchTab('resumen')">
                        <div class="text-xs font-bold text-slate-400 uppercase">En Camino</div>
                        <div class="text-2xl font-bold text-blue-700" x-text="kpis.enCamino.toLocaleString() + ' u.'"></div>
                        <div class="text-xs text-slate-400">Mercader√≠a Comprada</div>
                    </div>

                    <div class="bg-white p-4 rounded-lg border-l-4 border-l-red-500 shadow-sm card-hover" @click="switchTab('inmovilizado')">
                        <div class="text-xs font-bold text-slate-400 uppercase">Capital Inmovilizado</div>
                        <div class="text-2xl font-bold text-red-700" x-text="formatMoney(kpis.inmovilizado)"></div>
                        <div class="text-xs text-red-600">Stock > 45 d√≠as</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-7xl mx-auto">
                    <div class="flex flex-col gap-6">
                        <div class="bg-white p-4 rounded-lg shadow border flex flex-col gap-4">
                            <div class="flex justify-between items-center border-b pb-2">
                                <h3 class="text-sm font-bold text-red-700 uppercase">Cargos por Analista</h3>
                                <div class="text-right"><div class="text-[9px] text-slate-400 uppercase">Total Deuda Acumulada</div><div class="text-lg font-bold text-red-600" x-text="formatMoney(metrics.totalDeudaAnalistas)"></div></div>
                            </div>
                            <div class="h-48 w-full"><canvas id="chartAnalista"></canvas></div>

                            <div class="overflow-x-auto max-h-48 border rounded mt-2">
                                <table class="w-full text-xs">
                                    <thead class="bg-slate-100 font-bold text-slate-600 sticky top-0"><tr><td class="p-2">Analista</td><td class="p-2 text-center">SKUs</td><td class="p-2 text-center">Unidades</td><td class="p-2 text-right">Deuda Total</td></tr></thead>
                                    <tbody class="divide-y">
                                        <template x-for="a in metrics.analistasTable" :key="a.name">
                                            <tr class="hover:bg-red-50 cursor-pointer" @click="switchTab('cargos'); activeFilters['analista'] = [a.name];">
                                                <td class="p-2 font-medium text-slate-700" x-text="a.name"></td>
                                                <td class="p-2 text-center" x-text="a.count"></td>
                                                <td class="p-2 text-center" x-text="a.units"></td>
                                                <td class="p-2 text-right font-bold text-red-600" x-text="formatMoney(a.debt)"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>

                           

                            <div class="border-t pt-4 mt-2">
                                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Evoluci√≥n Deuda Total (Hist√≥rico)</h4>
                                <div class="h-32 w-full"><canvas id="chartDeudaHistory"></canvas></div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow border border-indigo-200">
                            <h3 class="text-sm font-bold text-indigo-800 uppercase border-b pb-2 mb-3 flex justify-between items-center">
                                <span>üß† Matriz Estrat√©gica ABC-XYZ</span>
                                <span class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded">Valor vs. Variabilidad</span>
                            </h3>
                            <div class="grid grid-cols-4 gap-1 text-center text-xs">
                                <div class="col-start-2 font-bold text-slate-500">X (Estable)</div>
                                <div class="font-bold text-slate-500">Y (Variable)</div>
                                <div class="font-bold text-slate-500">Z (Err√°tico)</div>

                                <div class="font-bold text-slate-500 flex items-center justify-center h-20">A (Alto)</div>
                                <div class="bg-green-100 p-2 rounded border border-green-200 flex flex-col justify-center h-20 cursor-pointer hover:bg-green-200 transition" @click="filterMatrix('AX')">
                                    <div class="font-bold text-green-800 text-lg">AX</div>
                                    <div class="text-[10px]" x-text="matrixCounts['AX'] || 0"></div>
                                </div>
                                <div class="bg-green-50 p-2 rounded border border-green-100 flex flex-col justify-center h-20 cursor-pointer hover:bg-green-100 transition" @click="filterMatrix('AY')">
                                    <div class="font-bold text-green-700 text-lg">AY</div>
                                    <div class="text-[10px]" x-text="matrixCounts['AY'] || 0"></div>
                                </div>
                                <div class="bg-yellow-50 p-2 rounded border border-yellow-100 flex flex-col justify-center h-20 cursor-pointer hover:bg-yellow-100 transition" @click="filterMatrix('AZ')">
                                    <div class="font-bold text-yellow-700 text-lg">AZ</div>
                                    <div class="text-[10px]" x-text="matrixCounts['AZ'] || 0"></div>
                                </div>

                                <div class="font-bold text-slate-500 flex items-center justify-center h-20">B (Medio)</div>
                                <div class="bg-blue-50 p-2 rounded border border-blue-100 flex flex-col justify-center h-20 cursor-pointer hover:bg-blue-100 transition" @click="filterMatrix('BX')">
                                    <div class="font-bold text-blue-700 text-lg">BX</div>
                                    <div class="text-[10px]" x-text="matrixCounts['BX'] || 0"></div>
                                </div>
                                <div class="bg-slate-50 p-2 rounded border border-slate-200 flex flex-col justify-center h-20 cursor-pointer hover:bg-slate-100 transition" @click="filterMatrix('BY')">
                                    <div class="font-bold text-slate-600 text-lg">BY</div>
                                    <div class="text-[10px]" x-text="matrixCounts['BY'] || 0"></div>
                                </div>
                                <div class="bg-orange-50 p-2 rounded border border-orange-100 flex flex-col justify-center h-20 cursor-pointer hover:bg-orange-100 transition" @click="filterMatrix('BZ')">
                                    <div class="font-bold text-orange-700 text-lg">BZ</div>
                                    <div class="text-[10px]" x-text="matrixCounts['BZ'] || 0"></div>
                                </div>

                                <div class="font-bold text-slate-500 flex items-center justify-center h-20">C (Bajo)</div>
                                <div class="bg-slate-50 p-2 rounded border border-slate-200 flex flex-col justify-center h-20 cursor-pointer hover:bg-slate-100 transition" @click="filterMatrix('CX')">
                                    <div class="font-bold text-slate-400 text-lg">CX</div>
                                    <div class="text-[10px]" x-text="matrixCounts['CX'] || 0"></div>
                                </div>
                                <div class="bg-slate-50 p-2 rounded border border-slate-200 flex flex-col justify-center h-20 cursor-pointer hover:bg-slate-100 transition" @click="filterMatrix('CY')">
                                    <div class="font-bold text-slate-400 text-lg">CY</div>
                                    <div class="text-[10px]" x-text="matrixCounts['CY'] || 0"></div>
                                </div>
                                <div class="bg-red-50 p-2 rounded border border-red-100 flex flex-col justify-center h-20 cursor-pointer hover:bg-red-100 transition" @click="filterMatrix('CZ')">
                                    <div class="font-bold text-red-400 text-lg">CZ</div>
                                    <div class="text-[10px]" x-text="matrixCounts['CZ'] || 0"></div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow border border-indigo-100">
                            <h3 class="text-sm font-bold text-indigo-700 uppercase border-b pb-2 mb-2">Distribuci√≥n Capital por Marca (Pareto)</h3>
                            <div class="h-48 w-full"><canvas id="chartBrands"></canvas></div>
                        </div>

                    </div>

                    <div class="flex flex-col gap-6">

                        <div class="bg-white p-4 rounded-lg shadow border border-indigo-100">
                            <h3 class="text-sm font-bold text-indigo-700 uppercase border-b pb-2 mb-3">Matriz de Calidad: ABC vs Salud (Capital Invertido)</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-[10px] border-collapse">
                                    <thead>
                                        <tr class="bg-slate-100 font-bold text-center">
                                            <th class="p-2 text-left text-slate-600">Clase</th>
                                            <th class="p-2 text-red-700 border-l">Quiebre (1-10)</th>
                                            <th class="p-2 text-orange-600 border-l">Pre-Quiebre</th>
                                            <th class="p-2 text-green-700 border-l">Saludable</th>
                                            <th class="p-2 text-yellow-600 border-l">Alerta</th>
                                            <th class="p-2 text-purple-700 border-l">Sobrestock</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="row in ['A', 'B', 'C']" :key="row">
                                            <tr class="border-b hover:bg-slate-50">
                                                <td class="p-2 font-bold text-center bg-slate-50" x-text="row"></td>
                                                <td class="p-2 text-right font-mono border-l" :class="metrics.matrix[row].q > 0 ? 'bg-red-100 font-bold text-red-800' : ''" x-text="formatMoney(metrics.matrix[row].q)"></td>
                                                <td class="p-2 text-right font-mono border-l" :class="metrics.matrix[row].pq > 0 ? 'bg-orange-50' : ''" x-text="formatMoney(metrics.matrix[row].pq)"></td>
                                                <td class="p-2 text-right font-mono border-l" :class="metrics.matrix[row].s > 0 ? 'bg-green-50' : ''" x-text="formatMoney(metrics.matrix[row].s)"></td>
                                                <td class="p-2 text-right font-mono border-l" :class="metrics.matrix[row].a > 0 ? 'bg-yellow-50' : ''" x-text="formatMoney(metrics.matrix[row].a)"></td>
                                                <td class="p-2 text-right font-mono border-l" :class="metrics.matrix[row].o > 0 ? 'bg-purple-100 font-bold text-purple-800' : ''" x-text="formatMoney(metrics.matrix[row].o)"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow border">
                            <h3 class="text-sm font-bold text-blue-700 uppercase border-b pb-2">Estado de Salud Inventario</h3>
                            <div class="flex items-center gap-4 mt-2">
                                <div class="h-40 w-40 shrink-0"><canvas id="chartHealth"></canvas></div>
                                <div class="text-xs space-y-2 flex-1">
                                    <div class="flex justify-between"><span class="text-red-900 font-bold">‚óè Quiebres (1-10)</span> <b x-text="metrics.health.q"></b></div>
                                    <div class="flex justify-between"><span class="text-red-600 font-bold">‚óè Por Quebrar (11-17)</span> <b x-text="metrics.health.pq"></b></div>
                                    <div class="flex justify-between"><span class="text-green-600 font-bold">‚óè Saludable (18-30)</span> <b x-text="metrics.health.s"></b></div>
                                    <div class="flex justify-between"><span class="text-yellow-600 font-bold">‚óè Alerta (31-45)</span> <b x-text="metrics.health.a"></b></div>
                                    <div class="flex justify-between"><span class="text-purple-600 font-bold">‚óè Sobrestock (>45)</span> <b x-text="metrics.health.o"></b></div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow border border-red-200 bg-red-50/50">
                            <h3 class="text-sm font-bold text-red-700 uppercase border-b border-red-200 pb-2 mb-3">üî• Top 5 Riesgo Inminente (Stock < Lead Time)</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-[10px]">
                                    <thead><tr class="text-red-800"><th class="text-left pb-1">SKU</th><th class="text-left pb-1">Desc</th><th class="text-right pb-1">Stock</th><th class="text-right pb-1">Vtar</th><th class="text-right pb-1">D√≠as Stock</th></tr></thead>
                                    <tbody class="divide-y divide-red-200">
                                        <template x-for="r in metrics.topRisks" :key="r.sku">
                                            <tr class="hover:bg-red-100 cursor-pointer" @click="openModal(r)">
                                                <td class="py-2 font-bold" x-text="r.sku"></td>
                                                <td class="py-2 truncate max-w-[150px]" x-text="r.desc"></td>
                                                <td class="py-2 text-right" x-text="r.stock"></td>
                                                <td class="py-2 text-right" x-text="r.vtar"></td>
                                                <td class="py-2 text-right font-bold text-red-600" x-text="r.days.toFixed(1) + 'd'"></td>
                                            </tr>
                                        </template>
                                        <tr x-show="metrics.topRisks.length === 0"><td colspan="5" class="py-4 text-center text-slate-500">‚úÖ No hay riesgos inminentes detectados.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow border border-slate-300 bg-slate-50">
                            <h3 class="text-sm font-bold text-slate-700 uppercase border-b border-slate-300 pb-2 mb-3">‚ö∞Ô∏è Top 5 "Huesos" (Alto Valor, 0 Venta)</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-[10px]">
                                    <thead><tr class="text-slate-600"><th class="text-left pb-1">SKU</th><th class="text-left pb-1">Desc</th><th class="text-right pb-1">Stock Valorizado</th><th class="text-right pb-1">Venta Diario</th></tr></thead>
                                    <tbody class="divide-y divide-slate-200">
                                        <template x-for="h in metrics.huesos" :key="h.sku">
                                            <tr class="hover:bg-slate-200 cursor-pointer" @click="openModal(h)">
                                                <td class="py-2 font-bold" x-text="h.sku"></td>
                                                <td class="py-2 truncate max-w-[150px]" x-text="h.desc"></td>
                                                <td class="py-2 text-right font-bold text-slate-800" x-text="formatMoney(h.stockValorizado)"></td>
                                                <td class="py-2 text-right text-red-500 font-bold" x-text="h.vtarTotal.toFixed(2)"></td>
                                            </tr>
                                        </template>
                                        <tr x-show="metrics.huesos.length === 0"><td colspan="4" class="py-4 text-center text-slate-500">üëç No se detectaron huesos cr√≠ticos.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow border border-indigo-100">
                            <h3 class="text-sm font-bold text-indigo-700 uppercase border-b pb-2 mb-3">Precisi√≥n de Venta (Real vs Proyectada)</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-xs font-bold text-center mb-2 text-green-700">Venta > Proyecci√≥n (Supera)</div>
                                    <table class="w-full text-[10px]">
                                        <tr class="border-b"><td class="py-1">1% - 50%</td><td class="text-right font-bold" x-text="metrics.deviationStats['1-50%'] + '%'"></td></tr>
                                        <tr class="border-b"><td class="py-1">51% - 75%</td><td class="text-right font-bold" x-text="metrics.deviationStats['51-75%'] + '%'"></td></tr>
                                        <tr class="border-b"><td class="py-1">76% - 100%</td><td class="text-right font-bold" x-text="metrics.deviationStats['76-100%'] + '%'"></td></tr>
                                        <tr class="border-b"><td class="py-1">101% - 125%</td><td class="text-right font-bold" x-text="metrics.deviationStats['101-125%'] + '%'"></td></tr>
                                        <tr class="border-b"><td class="py-1">126% - 150%</td><td class="text-right font-bold" x-text="metrics.deviationStats['126-150%'] + '%'"></td></tr>
                                        <tr><td class="py-1">> 151%</td><td class="text-right font-bold" x-text="metrics.deviationStats['>150%'] + '%'"></td></tr>
                                    </table>
                                </div>
                                <div>
                                    <div class="text-xs font-bold text-center mb-2 text-red-700">Venta < Proyecci√≥n (No Supera)</div>
                                    <table class="w-full text-[10px]">
                                        <tr class="border-b"><td class="py-1">-1% a -50%</td><td class="text-right font-bold" x-text="metrics.deviationStats['-1 to -50%'] + '%'"></td></tr>
                                        <tr class="border-b"><td class="py-1">-51% a -75%</td><td class="text-right font-bold" x-text="metrics.deviationStats['-51 to -75%'] + '%'"></td></tr>
                                        <tr><td class="py-1">-76% a -100%</td><td class="text-right font-bold" x-text="metrics.deviationStats['-76 to -100%'] + '%'"></td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                <div class="bg-white p-4 rounded-lg shadow border border-slate-200 mb-6">
                    <h3 class="text-sm font-bold text-slate-700 uppercase border-b pb-2 mb-3 flex justify-between items-center">
                        <span>ü¶Å Distribuci√≥n por Perfil Estrat√©gico</span>
                        <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded">Origen: Grafana</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs">
                                <thead class="bg-slate-50 text-slate-500 font-bold uppercase">
                                    <tr>
                                        <td class="p-2">Perfil</td>
                                        <td class="p-2 text-center">SKUs</td>
                                        <td class="p-2 text-right">Capital ($)</td>
                                        <td class="p-2 text-right">%</td>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    <template x-for="p in metrics.profiles" :key="p.name">
                                        <tr class="hover:bg-blue-50 cursor-pointer" @click="switchTab('consolidado'); activeFilters['perfil'] = [p.name];">
                                            <td class="p-2 font-bold">
                                                <span x-text="p.name === 'Killer' ? 'ü¶Å ' + p.name : (p.name === 'Sin Clasificar' ? '‚ùì ' + p.name : 'üì¶ ' + p.name)"></span>
                                            </td>
                                            <td class="p-2 text-center" x-text="p.count"></td>
                                            <td class="p-2 text-right font-mono text-slate-700" x-text="formatMoney(p.money)"></td>
                                            <td class="p-2 text-right">
                                                <div class="flex items-center justify-end gap-2">
                                                    <span x-text="p.pct + '%'" class="text-[10px] font-bold text-slate-500"></span>
                                                    <div class="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                                        <div class="h-full bg-blue-500" :style="'width: ' + p.pct + '%'"></div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                        <div class="h-48 w-full relative">
                            <canvas id="chartProfiles"></canvas>
                        </div>
                    </div>
                </div>

                     <div class="bg-white p-4 rounded-lg shadow border border-slate-200 mb-6">
                    <h3 class="text-sm font-bold text-slate-700 uppercase border-b pb-2 mb-3 flex justify-between items-center">
                        <span>üóìÔ∏è Proyecci√≥n de Flujo de Caja (Cash Flow)</span>
                        <span class="text-[10px] bg-green-50 text-green-700 px-2 py-1 rounded border border-green-100">Necesidad de Pago Estimada</span>
                    </h3>
                    <div class="h-64 w-full relative">
                        <canvas id="chartCashFlow"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-4 gap-2 text-center text-[10px]">
                        <div class="bg-red-50 p-2 rounded border border-red-100">
                            <div class="font-bold text-red-700">Semana 1 (Urgente)</div>
                            <div class="text-xs font-black" x-text="formatMoney(metrics.cashFlow?.w1 || 0)"></div>
                            <div class="text-slate-400">Stock < 7 d√≠as</div>
                        </div>
                        <div class="bg-orange-50 p-2 rounded border border-orange-100">
                            <div class="font-bold text-orange-700">Semana 2</div>
                            <div class="text-xs font-black" x-text="formatMoney(metrics.cashFlow?.w2 || 0)"></div>
                            <div class="text-slate-400">Stock 7-14 d√≠as</div>
                        </div>
                        <div class="bg-yellow-50 p-2 rounded border border-yellow-100">
                            <div class="font-bold text-yellow-700">Semana 3</div>
                            <div class="text-xs font-black" x-text="formatMoney(metrics.cashFlow?.w3 || 0)"></div>
                            <div class="text-slate-400">Stock 14-21 d√≠as</div>
                        </div>
                        <div class="bg-blue-50 p-2 rounded border border-blue-100">
                            <div class="font-bold text-blue-700">Semana 4+</div>
                            <div class="text-xs font-black" x-text="formatMoney(metrics.cashFlow?.w4 || 0)"></div>
                            <div class="text-slate-400">Reposici√≥n</div>
                        </div>
                    </div>
                </div>
                

                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border lg:col-span-2">
                        <div class="bg-white p-4 rounded-lg shadow border border-slate-200 mb-6">
                    <h3 class="text-sm font-bold text-slate-700 uppercase border-b pb-2 mb-3 flex justify-between items-center">
                        <span>üê¢ Envejecimiento de Stock (Aging)</span>
                        <span class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded border border-gray-200">Capital Inmovilizado por Antig√ºedad</span>
                    </h3>
                    <div class="h-64 w-full relative">
                        <canvas id="chartAging"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-5 gap-1 text-center text-[9px]">
                        <div class="bg-green-50 p-2 rounded border border-green-100">
                            <div class="font-bold text-green-700">0-30d</div>
                            <div class="text-xs font-black" x-text="formatMoney(metrics.aging?.f0_30 || 0)"></div>
                            <div class="text-slate-400">Fresco</div>
                        </div>
                        <div class="bg-yellow-50 p-2 rounded border border-yellow-100">
                            <div class="font-bold text-yellow-700">31-60d</div>
                            <div class="text-xs font-black" x-text="formatMoney(metrics.aging?.f31_60 || 0)"></div>
                            <div class="text-slate-400">Alerta</div>
                        </div>
                        <div class="bg-orange-50 p-2 rounded border border-orange-100">
                            <div class="font-bold text-orange-700">61-90d</div>
                            <div class="text-xs font-black" x-text="formatMoney(metrics.aging?.f61_90 || 0)"></div>
                            <div class="text-slate-400">Riesgo</div>
                        </div>
                        <div class="bg-red-50 p-2 rounded border border-red-100">
                            <div class="font-bold text-red-700">91-180d</div>
                            <div class="text-xs font-black" x-text="formatMoney(metrics.aging?.f91_180 || 0)"></div>
                            <div class="text-slate-400">Cr√≠tico</div>
                        </div>
                        <div class="bg-slate-100 p-2 rounded border border-slate-300">
                            <div class="font-bold text-slate-700">>180d</div>
                            <div class="text-xs font-black" x-text="formatMoney(metrics.aging?.f180 || 0)"></div>
                            <div class="text-slate-500">Muerto</div>
                        </div>
                    </div>
                </div>
                
                        <h3 class="text-sm font-bold text-emerald-700 uppercase border-b pb-2 mb-3">Top 10 Sugerencias de Compra ($)</h3>
                        <div class="overflow-x-auto max-h-64 border rounded">
                            <table class="w-full text-xs">
                                <thead class="bg-slate-100 font-bold text-slate-600 sticky top-0"><tr><td class="p-2">SKU</td><td class="p-2">Descripci√≥n</td><td class="p-2">Proveedor</td><td class="p-2 text-right">U. a Pedir</td><td class="p-2 text-right">Inversi√≥n</td></tr></thead>
                                <tbody class="divide-y">
                                    <template x-for="item in masterData.filter(i=>i.inversion>0).sort((a,b)=>b.inversion-a.inversion).slice(0,10)" :key="item.sku">
                                        <tr class="hover:bg-slate-50 cursor-pointer" @click="openModal(item)">
                                            <td class="p-2 font-bold text-slate-700" x-text="item.sku"></td><td class="p-2 truncate max-w-[200px]" x-text="item.desc"></td><td class="p-2" x-text="item.prov"></td><td class="p-2 text-right font-bold" x-text="item.comprarU"></td><td class="p-2 text-right font-mono text-emerald-600 font-bold" x-text="formatMoney(item.inversion)"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border lg:col-span-2">
                        <h3 class="text-sm font-bold text-emerald-700 uppercase border-b pb-2 mb-3">Inversi√≥n Sugerida por Proveedor (Top 20)</h3>
                        <div class="overflow-x-auto max-h-64 border rounded">
                            <table class="w-full text-xs">
                                <thead class="bg-slate-100 font-bold text-slate-600 sticky top-0"><tr><td class="p-2 border-b">Proveedor</td><td class="p-2 border-b text-right">Importe a Comprar ($)</td><td class="p-2 border-b text-center">% del Total</td></tr></thead>
                                <tbody class="divide-y">
                                    <template x-for="p in metrics.proveedores" :key="p.name">
                                        <tr class="hover:bg-slate-50"><td class="p-2 font-medium" x-text="p.name"></td><td class="p-2 text-right font-mono text-emerald-700 font-bold" x-text="formatMoney(p.val)"></td><td class="p-2 text-center text-slate-400" x-text="((p.val / kpis.compra)*100).toFixed(1) + '%'"></td></tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div x-show="showSeasonalityModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm" x-cloak>
        <div class="bg-white rounded-lg shadow-2xl p-6 w-96">
            <h2 class="text-lg font-bold text-orange-600 mb-4">Configuraci√≥n Estacional</h2>
            <div class="mb-4">
                <label class="block text-xs font-bold text-slate-500 mb-1">Nombre Etiqueta</label>
                <input type="text" placeholder="Ej: Verano" class="w-full border rounded p-2 text-xs mb-2">
                <label class="block text-xs font-bold text-slate-500 mb-1">Multiplicador (1.0 = Normal)</label>
                <input type="number" step="0.1" x-model.number="seasonalFactorInput" class="w-full border rounded p-2 text-xs">
            </div>
            <div class="flex justify-end gap-2">
                <button @click="showSeasonalityModal=false" class="text-slate-500 text-xs font-bold px-3 py-1">Cancelar</button>
                <button @click="applyBulkEdit('seasonalMult', seasonalFactorInput); showSeasonalityModal=false" class="bg-orange-600 text-white text-xs font-bold px-4 py-2 rounded">Aplicar a Seleccionados</button>
            </div>
        </div>
    </div>

    <div x-show="showLiquidationModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm" x-cloak>
        <div class="bg-white rounded-lg shadow-2xl p-6 w-96">
            <h2 class="text-lg font-bold text-red-600 mb-4">Calculadora de Liquidaci√≥n</h2>
            <div class="space-y-3 mb-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500">Descuento Propuesto (%)</label>
                    <input type="number" x-model.number="liqParams.discount" class="w-full border rounded p-2 text-xs">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500">Elasticidad (Aumento Venta est.)</label>
                    <input type="number" step="0.1" x-model.number="liqParams.elasticity" class="w-full border rounded p-2 text-xs" title="1.5 significa que si bajas 10% el precio, la venta sube 15%">
                </div>
                <div class="bg-slate-100 p-3 rounded">
                    <div class="text-[10px] uppercase text-slate-500 font-bold">Capital a Recuperar</div>
                    <div class="text-xl font-bold text-slate-800" x-text="formatMoney(calculateLiquidation().recovery)"></div>
                    <div class="text-[10px] text-red-500 mt-1">P√©rdida asumida: <span x-text="formatMoney(calculateLiquidation().loss)"></span></div>
                </div>
            </div>
            <div class="flex justify-end">
                <button @click="showLiquidationModal=false" class="bg-slate-800 text-white text-xs font-bold px-4 py-2 rounded">Cerrar</button>
            </div>
        </div>
    </div>

    <div x-show="showSimulator" class="fixed inset-0 z-40 bg-black/20 backdrop-blur-sm" @click="showSimulator=false" x-transition.opacity></div>
    <div x-show="showSimulator" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-50 flex flex-col border-l border-slate-200 transform transition-transform" 
         :class="showSimulator ? 'translate-x-0' : 'translate-x-full'" style="transition: transform 0.3s ease-in-out;">
        <div class="p-4 bg-purple-700 text-white flex justify-between items-center shadow-md">
            <h2 class="font-bold text-sm uppercase">üéõÔ∏è Simulador Financiero</h2>
            <button @click="showSimulator=false" class="text-white hover:text-purple-200">‚úï</button>
        </div>
        <div class="flex-1 p-6 overflow-y-auto space-y-6 bg-slate-50">
            <div class="bg-white p-4 rounded border shadow-sm">
                <label class="text-xs font-bold text-slate-500 block mb-2">D√≠as de Cobertura Simulados</label>
                <input type="range" min="15" max="120" step="5" x-model.number="simParams.days" class="w-full mb-2">
                <div class="text-center font-bold text-purple-600 text-xl" x-text="simParams.days + ' d√≠as'"></div>
            </div>

            <div class="bg-white p-4 rounded border shadow-sm">
                <div class="text-[10px] uppercase font-bold text-slate-400 mb-2">Impacto en Inversi√≥n</div>
                <div class="flex justify-between items-end mb-2">
                    <span class="text-xs text-slate-600">Actual:</span>
                    <span class="font-bold text-slate-800" x-text="formatMoney(kpis.compra)"></span>
                </div>
                <div class="flex justify-between items-end mb-4 border-b pb-2">
                    <span class="text-xs text-purple-600 font-bold">Simulado:</span>
                    <span class="font-bold text-purple-700 text-lg" x-text="formatMoney(getSimulationResults().total)"></span>
                </div>
                <div class="text-center text-xs">
                    Diferencia: 
                    <span class="font-bold px-2 py-1 rounded" :class="getSimulationResults().diff > 0 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'" x-text="(getSimulationResults().diff > 0 ? '+' : '') + formatMoney(getSimulationResults().diff)"></span>
                </div>
            </div>
            
            <div class="text-[10px] text-slate-400 text-center italic">
                *Este simulador calcula la compra necesaria para alcanzar X d√≠as de stock, sin modificar la base de datos real.
            </div>
        </div>
        <div class="p-4 border-t bg-white">
            <button @click="params.diasCompra = simParams.days; recalculateGlobal(); showSimulator=false" class="w-full bg-purple-600 text-white py-2 rounded font-bold shadow hover:bg-purple-700 transition text-xs">
                Aplicar a Realidad
            </button>
        </div>
    </div>

    <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end" x-cloak>
        <div x-show="chatOpen" class="bg-white w-80 sm:w-96 h-[500px] rounded-xl shadow-2xl border border-slate-200 flex flex-col mb-4 overflow-hidden chat-enter">
            <div class="bg-indigo-600 text-white p-3 flex justify-between items-center shadow-sm">
                <div class="flex items-center gap-2">
                    <span class="text-xl">ü§ñ</span>
                    <div>
                        <div class="font-bold text-sm">Asistente de Inventario</div>
                        <div class="text-[10px] opacity-80">Online | Responde al instante</div>
                    </div>
                </div>
                <button @click="toggleChat" class="text-white hover:bg-indigo-700 rounded p-1">‚úï</button>
            </div>

            <div class="flex-1 bg-slate-50 p-4 overflow-y-auto space-y-3" id="chat-messages">
                <template x-for="(msg, index) in chatMessages" :key="index">
                    <div :class="msg.type === 'bot' ? 'flex justify-start' : 'flex justify-end'">
                        <div :class="msg.type === 'bot' ? 'bg-white text-slate-700 rounded-bl-none' : 'bg-indigo-600 text-white rounded-br-none'"
                             class="max-w-[85%] rounded-2xl px-4 py-2 text-xs shadow-sm border border-slate-100">
                            <div x-html="msg.html || msg.text"></div>
                        </div>
                    </div>
                </template>
                <div x-show="isTyping" class="flex justify-start">
                    <div class="bg-white p-3 rounded-2xl rounded-bl-none shadow-sm flex gap-1">
                        <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                    </div>
                </div>
            </div>

            <div class="p-3 bg-white border-t">
                <div class="flex gap-2 overflow-x-auto pb-2 mb-1 scrollbar-thin">
                    <button @click="sendQuickMsg('Quiebres')" class="whitespace-nowrap px-3 py-1 bg-red-50 text-red-600 rounded-full text-[10px] border border-red-100 hover:bg-red-100">üö® Quiebres</button>
                    <button @click="sendQuickMsg('Vencimientos')" class="whitespace-nowrap px-3 py-1 bg-orange-50 text-orange-600 rounded-full text-[10px] border border-orange-100 hover:bg-orange-100">üìÖ Vencimientos</button>
                    <button @click="sendQuickMsg('Dinero')" class="whitespace-nowrap px-3 py-1 bg-emerald-50 text-emerald-600 rounded-full text-[10px] border border-emerald-100 hover:bg-emerald-100">üí∞ Dinero</button>
                </div>
                <div class="flex gap-2">
                    <input type="text" x-model="chatInput" @keydown.enter="sendMessage" placeholder="Escribe SKU, Marca o duda..." class="flex-1 text-xs border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-slate-50">
                    <button @click="sendMessage" class="bg-indigo-600 text-white rounded-full p-2 hover:bg-indigo-700 transition shadow-sm">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
            </div>
        </div>

        <button @click="toggleChat" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-full p-4 shadow-lg transition-transform hover:scale-105 flex items-center justify-center group relative">
            <span class="text-2xl group-hover:hidden">üí¨</span>
            <span class="text-xl hidden group-hover:block">üëã</span>
            <span class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center animate-bounce">1</span>
        </button>
    </div>

    <div x-show="modalOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4" x-transition.opacity x-cloak @keydown.escape.window="modalOpen = false">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl overflow-hidden flex flex-col max-h-[90vh]" @click.away="modalOpen = false">
            <div class="bg-slate-900 text-white px-6 py-4 flex justify-between items-center shrink-0">
                <div>
                    <div class="flex items-center gap-2">
                        <h2 class="text-2xl font-bold" x-text="selectedRow?.sku"></h2>
                        <span x-show="selectedRow?.impulsar" class="bg-orange-500 text-white text-xs px-2 py-1 rounded font-bold animate-pulse">üöÄ IMPULSAR</span>
                    </div>
                    <div class="text-slate-400 text-sm" x-text="selectedRow?.desc"></div>
                </div>
                <button @click="modalOpen = false" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            
            <div class="p-6 overflow-y-auto bg-slate-50 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div x-show="selectedRow?.ventaPerdida > 0" class="md:col-span-3 bg-red-100 border-l-4 border-red-600 text-red-800 p-3 rounded shadow-sm flex justify-between items-center animate-pulse">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">üõë</span>
                        <div>
                            <p class="font-bold text-sm uppercase">Quiebre de Stock (Activo)</p>
                            <p class="text-[10px]">Este producto deber√≠a estar fluyendo pero est√° en 0.</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-[9px] uppercase font-bold opacity-70">Costo Frenado (Diario)</p>
                        <p class="text-xl font-black" x-text="formatMoney(selectedRow?.ventaPerdida)"></p>
                    </div>
                </div>

                <div class="md:col-span-3 bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                    <h3 class="text-xs font-bold text-slate-500 uppercase border-b pb-2 mb-3 flex items-center gap-2">
                        <span>‚è±Ô∏è Tendencia de Venta (Velocidad de Salida)</span>
                        <span class="text-[9px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded border border-blue-100">Unidades x D√≠a Promedio</span>
                    </h3>
                    
                    <div class="grid grid-cols-4 gap-4 text-center">
                        <div class="flex flex-col items-center justify-center p-2 rounded border bg-slate-50 border-slate-100 opacity-70">
                            <span class="text-[9px] font-bold text-slate-400 uppercase mb-1">Hace 60 D√≠as</span>
                            <div class="text-lg font-bold text-slate-600" x-text="(selectedRow?.vtar60 || 0).toFixed(2)"></div>
                        </div>

                        <div class="flex flex-col items-center justify-center p-2 rounded border bg-slate-50 border-slate-100">
                            <span class="text-[9px] font-bold text-slate-400 uppercase mb-1">Hace 45 D√≠as</span>
                            <div class="text-lg font-bold text-slate-600" x-text="(selectedRow?.vtar45 || 0).toFixed(2)"></div>
                        </div>

                        <div class="flex flex-col items-center justify-center p-2 rounded border border-blue-100 bg-blue-50">
                            <span class="text-[9px] font-bold text-blue-500 uppercase mb-1">Hace 30 D√≠as</span>
                            <div class="text-xl font-bold text-blue-700" x-text="(selectedRow?.vtar30 || 0).toFixed(2)"></div>
                        </div>

                        <div class="flex flex-col items-center justify-center p-2 rounded border-2 relative transition-all duration-300"
                             :class="(selectedRow?.vtar15 >= selectedRow?.vtar30) ? 'border-green-200 bg-green-50' : 'border-red-100 bg-red-50'">
                            
                            <span class="absolute -top-2.5 bg-white px-2 py-0.5 text-[9px] font-bold border rounded shadow-sm flex items-center gap-1"
                                  :class="(selectedRow?.vtar15 >= selectedRow?.vtar30) ? 'text-green-600 border-green-200' : 'text-red-600 border-red-200'">
                                <span x-text="(selectedRow?.vtar15 >= selectedRow?.vtar30) ? 'üöÄ ACELERANDO' : 'üê¢ FRENANDO'"></span>
                            </span>

                            <span class="text-[9px] font-bold uppercase mb-1 mt-1"
                                  :class="(selectedRow?.vtar15 >= selectedRow?.vtar30) ? 'text-green-600' : 'text-red-600'">
                                √öltimos 15 D√≠as
                            </span>
                            
                            <div class="text-2xl font-black"
                                 :class="(selectedRow?.vtar15 >= selectedRow?.vtar30) ? 'text-green-700' : 'text-red-700'" 
                                 x-text="(selectedRow?.vtar15 || 0).toFixed(2)"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-lg border shadow-sm">
                    <h3 class="text-xs font-bold text-slate-400 uppercase border-b pb-2 mb-3">Inventario</h3>
                    <div class="space-y-3 text-xs">
                        <div x-show="selectedRow?.dep" class="bg-blue-50 p-2 rounded mb-2 font-bold text-center">Datos del Dep√≥sito: <span x-text="selectedRow?.dep"></span></div>
                        <div class="flex justify-between p-2 bg-slate-50 rounded"><span>Dep√≥sito 1:</span><strong x-text="selectedRow?.pbi?.dep1"></strong></div>
                        <div class="flex justify-between p-2 bg-purple-50 rounded border-purple-100"><span>Dep√≥sito 80:</span><strong x-text="selectedRow?.pbi?.dep80"></strong></div>
                        <div class="flex justify-between p-2 bg-blue-50 rounded border-blue-100 text-blue-700"><span>En Camino:</span><strong x-text="selectedRow?.comprasEnCamino"></strong></div>

                        <div class="flex justify-between p-2 rounded border mt-2 items-center"
                             :class="(selectedRow?.diasStock || 0) <= 15 ? 'bg-red-100 text-red-800 border-red-200' : 
                                    ((selectedRow?.diasStock || 0) > 45 ? 'bg-purple-100 text-purple-800 border-purple-200' : 
                                    'bg-green-100 text-green-800 border-green-200')">
                            <span class="font-bold uppercase text-[10px]">D√≠as de Stock Actual:</span>
                            <strong class="text-base" x-text="(selectedRow?.diasStock > 900 ? '‚àû' : (selectedRow?.diasStock || 0).toFixed(1)) + ' d'"></strong>
                        </div>

                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <div class="p-2 bg-slate-50 rounded border flex flex-col items-center justify-center">
                                <span class="text-[9px] text-slate-500 uppercase font-bold tracking-wide">VTAR (Real)</span>
                                <div class="text-base font-bold text-slate-800" x-text="(selectedRow?.vtarTotal || 0).toFixed(2) + ' u.'"></div>
                            </div>
                            <div class="p-2 bg-blue-50/50 rounded border border-blue-100 flex flex-col items-center justify-center">
                                <span class="text-[9px] text-blue-600 uppercase font-bold tracking-wide">VPD (Proy.)</span>
                                <div class="text-base font-bold text-blue-700" x-text="(selectedRow?.vpdCpra || 0).toFixed(2) + ' u.'"></div>
                            </div>
                        </div>

                        <div class="flex justify-between p-2 bg-emerald-50 rounded border-emerald-100 mt-2"><span>Stock M√≠nimo:</span><strong x-text="selectedRow?.stockMin"></strong></div>
                        <div class="flex justify-between p-2 bg-emerald-50 rounded border-emerald-100"><span>Stock M√°ximo:</span><strong x-text="selectedRow?.stockMax"></strong></div>

                        <div x-show="selectedRow?.trendHistory?.length > 1" class="pt-2 mt-2 border-t">
                             <span class="text-[10px] font-bold text-slate-400">TENDENCIA √öLTIMOS D√çAS:</span>
                             <div class="w-full h-12 border rounded bg-slate-50 mt-1 flex items-center justify-center">
                                <div class="sparkline-container w-full h-full px-2" x-html="renderSparkline(selectedRow?.trendHistory || [], 200, 40)"></div>
                             </div> 
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-4">
                    <div class="bg-white p-5 rounded-lg border shadow-sm">
                        <h3 class="text-xs font-bold text-blue-600 uppercase border-b pb-2 mb-3">Env√≠o Full (80)</h3>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between"><span>Disponible:</span><span x-text="selectedRow?.stockRestante"></span></div>
                            <div class="flex justify-between"><span>Demanda (30d):</span><strong x-text="selectedRow?.debugDemanda80"></strong></div>
                            <div class="flex justify-between items-center border-t pt-2 mt-2">
                                <span class="font-bold text-blue-800">A ENVIAR:</span>
                                <span class="text-2xl font-bold text-blue-700" x-text="selectedRow?.qEnviar"></span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-lg border shadow-sm flex-1">
                        <h3 class="text-xs font-bold text-orange-600 uppercase border-b pb-2 mb-3">üìÖ Trazabilidad de Lotes</h3>
                        <div class="overflow-y-auto max-h-40 scrollbar-thin">
                            <template x-if="selectedRowLotes && selectedRowLotes.length > 0">
                                <table class="w-full text-[10px]">
                                    <thead class="bg-orange-50 text-orange-800">
                                        <tr>
                                            <th class="p-1 text-left">Ingreso</th>
                                            <th class="p-1 text-left">Vencimiento</th>
                                            <th class="p-1 text-center">Estado</th>
                                            <th class="p-1 text-right">Cant.</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y">
                                        <template x-for="lote in selectedRowLotes" :key="lote.id">
                                            <tr>
                                                <td class="p-1 font-bold" x-text="lote.fechaIngreso || '-'"></td>
                                                
                                                <td class="p-1 font-bold" x-text="lote.fechaVto"></td>
                                                <td class="p-1 text-center">
                                                    <span class="px-1 rounded" :class="lote.dias <= 30 ? 'bg-red-100 text-red-600' : (lote.dias <= 60 ? 'bg-yellow-100 text-yellow-600' : 'bg-green-100 text-green-600')"
                                                          x-text="lote.dias <= 30 ? 'üî¥' : (lote.dias <= 60 ? 'üü°' : 'üü¢')"></span>
                                                </td>
                                                <td class="p-1 text-right font-mono" x-text="lote.stockComprometido"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </template>
                            <template x-if="!selectedRowLotes || selectedRowLotes.length === 0">
                                <div class="text-[10px] text-slate-400 text-center py-4">No hay informaci√≥n de lotes.</div>
                            </template>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-lg border shadow-sm relative overflow-hidden">
                    <h3 class="text-xs font-bold uppercase border-b pb-2 mb-3" :class="selectedRow?.impulsar ? 'text-orange-600' : 'text-emerald-600'">Compra</h3>
                    <div x-show="!selectedRow?.impulsar">
                        <div class="grid grid-cols-2 gap-4 text-center mb-3">
                            <div><div class="text-[10px]">Unidades</div><div class="text-xl font-bold text-emerald-700" x-text="selectedRow?.comprarU"></div></div>
                            <div><div class="text-[10px]">Inversi√≥n</div><div class="text-xl font-bold" x-text="formatMoney(selectedRow?.inversion)"></div></div>
                        </div>
                        <div class="text-[10px] text-center text-slate-400 mt-2" x-show="selectedRow?.comprasEnCamino > 0">(Descontado en camino: <span x-text="selectedRow?.comprasEnCamino"></span> u.)</div>

                        <div class="mt-3 pt-3 border-t text-center">
                             <div class="text-[9px] font-bold text-slate-400 uppercase">Precisi√≥n Venta vs Proyecci√≥n</div>
                             <div class="text-lg font-bold" :class="((selectedRow?.vtarTotal - selectedRow?.vpdCpra)/selectedRow?.vpdCpra * 100) > 0 ? 'text-green-600' : 'text-red-600'">
                                 <span x-text="selectedRow?.vpdCpra > 0 ? (((selectedRow?.vtarTotal - selectedRow?.vpdCpra)/selectedRow?.vpdCpra * 100).toFixed(1) + '%') : 'S/D'"></span>
                             </div>
                        </div>
                        <div class="mt-3 pt-3 border-t text-center" x-show="selectedRow?.vtarIa">
                             <div class="text-[9px] font-bold text-purple-500 uppercase">Predicci√≥n IA (Regresi√≥n)</div>
                             <div class="text-lg font-bold text-purple-600">
                                 <span x-text="selectedRow?.vtarIa?.toFixed(2)"></span>
                                 <span class="text-xs text-slate-400">(vs VTAR: <span x-text="selectedRow?.vtarTotal.toFixed(2)"></span>)</span>
                             </div>
                        </div>

                    </div>
                    <div x-show="selectedRow?.impulsar" class="text-center py-4 font-bold text-orange-700 text-sm">COMPRA PAUSADA (Impulsar)</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DB={
            name:'InvProV93', store:'Files', histStore: 'History', debtStore: 'DebtHistory',
            async getDB(){
                return new Promise((r,j)=>{
                    const q=indexedDB.open(this.name, 24);
                    q.onupgradeneeded=e=>{
                        const db=e.target.result;
                        if(!db.objectStoreNames.contains(this.store)) db.createObjectStore(this.store);
                        if(!db.objectStoreNames.contains(this.histStore)) db.createObjectStore(this.histStore, {keyPath: 'id', autoIncrement: true});
                        if(!db.objectStoreNames.contains(this.debtStore)) db.createObjectStore(this.debtStore, {keyPath: 'date'});
                    };
                    q.onsuccess=e=>r(e.target.result);
                    q.onerror=j
                })
            },
            async save(k,d){try{const db=await this.getDB();return new Promise(r=>{const tx=db.transaction(this.store,'readwrite');tx.objectStore(this.store).put(d,k);tx.oncomplete=r})}catch(e){}},
            async load(k){try{const db=await this.getDB();return new Promise(r=>{const tx=db.transaction(this.store,'readonly');const q=tx.objectStore(this.store).get(k);q.onsuccess=()=>r(q.result);q.onerror=()=>r(null)})}catch(e){return null}},
            async saveSnapshot(data) {
                try {
                    const db = await this.getDB();
                    const tx = db.transaction(this.histStore, 'readwrite');
                    const store = tx.objectStore(this.histStore);
                    const today = new Date().toISOString().slice(0,10);
                    store.add({ date: today, data: data });
                } catch(e) { }
            },
            async saveDebtHistory(totalDebt) {
                try {
                    const db = await this.getDB();
                    const tx = db.transaction(this.debtStore, 'readwrite');
                    const store = tx.objectStore(this.debtStore);
                    const today = new Date().toISOString().slice(0,10);
                    store.put({ date: today, val: totalDebt });
                } catch(e) { }
            },
            async getHistory() {
                try {
                    const db = await this.getDB();
                    return new Promise(r => {
                        const tx = db.transaction(this.histStore, 'readonly');
                        const req = tx.objectStore(this.histStore).getAll();
                        req.onsuccess = () => r(req.result);
                        req.onerror = () => r([]);
                    });
                } catch(e) { return []; }
            },
            async getDebtHistory() {
                try {
                    const db = await this.getDB();
                    return new Promise(r => {
                        const tx = db.transaction(this.debtStore, 'readonly');
                        const req = tx.objectStore(this.debtStore).getAll();
                        req.onsuccess = () => r(req.result);
                        req.onerror = () => r([]);
                    });
                } catch(e) { return []; }
            },
            async clear(){return new Promise(r=>{const q=indexedDB.deleteDatabase(this.name);q.onsuccess=r})}
        };

        function calculateLinearRegression(y) {
            const n = y.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            for (let i = 0; i < n; i++) {
                sumX += i;
                sumY += y[i];
                sumXY += i * y[i];
                sumXX += i * i;
            }
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            return { slope, intercept, nextVal: slope * n + intercept };
        }

        function calculateStandardDeviation(arr, mean) {
            if (!arr || arr.length === 0) return 0;
            const n = arr.length;
            const m = mean !== undefined ? mean : arr.reduce((a, b) => a + b, 0) / n;
            return Math.sqrt(arr.map(x => Math.pow(x - m, 2)).reduce((a, b) => a + b, 0) / n);
        }

        function detectAnomaly(data) {
            if (data.length < 5) return false;
            const mean = data.reduce((a,b)=>a+b,0) / data.length;
            const variance = data.reduce((a,b)=>a + Math.pow(b-mean,2),0) / data.length;
            const stdDev = Math.sqrt(variance);
            if (stdDev === 0) return false;
            const lastVal = data[data.length-1];
            const zScore = Math.abs((lastVal - mean) / stdDev);
            return zScore > 2.5;
        }

        function excelDateToJSDate(serial) {
           if (!serial || isNaN(serial)) return serial;
           const utc_days  = Math.floor(serial - 25569);
           const utc_value = utc_days * 86400000;
           const date_info = new Date(utc_value);
           const day = String(date_info.getUTCDate()).padStart(2, '0');
           const month = String(date_info.getUTCMonth() + 1).padStart(2, '0');
           const year = date_info.getUTCFullYear();
           return `${day}/${month}/${year}`;
        }
//--  ---
        window.inventoryApp = function() {
            return {
                isLoading: false, loadingMsg: '', dataReady: false, fileName: null, lastUpdate: null,
                
                filterMLUrgencies: false,
                focusMode: false,
                
                filterOpportunityCost: false,
                filterAging: null,
                filterArbitrage: false,

                modalOpen: false, selectedRow: null, selectedRowLotes: [],
                rawData: {}, masterData: [], flatData: [], enviosData: [], lotesData: [], proveedoresData: [], otherDepositsData: [],
                uniqueEnvioFechas: [],

                params: { diasSuc: 30, diasFull: 30, diasCompra: 30, diasOtros: 30, simulationDays: 30 },
                
                showSimulator: false,
                simParams: { days: 30 },

                selectedIds: [],
                
                showSeasonalityModal: false,
                seasonalFactorInput: 1.2,

                showLiquidationModal: false,
                liqParams: { discount: 20, elasticity: 1.5 },

                currentTab: 'consolidado', currentPage: 1, pageSize: 50, search: '', sortCol: 'qEnviar', sortAsc: false,

                filterLotesRange: 'all', selectedEnvioFechas: [], activeFilters: {}, filterMenuOpen: null,
                editingCell: null, columnMaxValues: {}, copyFeedback: false, historyData: [], debtHistory: [],

                availableOtherDeps: ['80', '82', '86', '87', '89'],
                selectedOtherDeps: ['80', '82', '86', '87', '89'],

                chatOpen: false, chatInput: '', isTyping: false,
                chatMessages: [{type: 'bot', text: '¬°Hola! Soy tu asistente de inventario. Preg√∫ntame por un SKU, Marca o usa los botones r√°pidos.'}],

                lookups: { mapML: {}, mapCargos: {}, mapEnvios: {} },

                kpis: { compra:0, envios:0, valorEnvios:0, lotesVencidos:0, skusCompra:0, cantImpulsar:0, enCamino: 0, inmovilizado: 0 },
                
                matrixCounts: {},
                
                metrics: {
                    analistas: [], analistasTable: [],
                    proveedores: [], proveedoresInmo: [], vto: {},
                    health: { q:0, pq:0, s:0, a:0, o:0 }, deviationStats: {}, totalDeudaAnalistas: 0,
                    matrix: { A: {q:0, pq:0, s:0, a:0, o:0}, B: {q:0, pq:0, s:0, a:0, o:0}, C: {q:0, pq:0, s:0, a:0, o:0} },
                    topRisks: [], brands: [], huesos: []
                },

                tabs: [
                    { id: 'metricas', label: 'üìä M√©tricas' },
                    { id: 'matriz_det', label: 'üö¶ Detalle Matriz' },
                    { id: 'consolidado', label: 'üåç Consolidado' },
                    { id: 'proveedores', label: 'üè≠ Proveedores' },
                    { id: 'otros_depositos', label: 'üè≠ Otros Dep√≥sitos' },
                    { id: 'inmovilizado', label: '‚ö†Ô∏è Stock > 45d' },
                    { id: 'dep80', label: 'üì¶ Env√≠os Full' },
                    { id: 'resumen', label: 'üõí Compras' },
                    { id: 'detalle', label: 'üìã Maestro' },
                    { id: 'cargos', label: '‚ö†Ô∏è Cargos ML' },
                    { id: 'enviados', label: 'üöö Hist. Env√≠os' },
                    { id: 'vencimientos', label: 'üìÖ Lotes' }
                ],
                chartInstances: {},

                async initApp() {
                    this.isLoading = true; this.loadingMsg = 'RECUPERANDO SESI√ìN...';
                    try {
                        const main = await DB.load('grafana');
                        if(main && main.length) {
                            const meta = await DB.load('meta');
                            this.fileName = meta?.fileName; this.lastUpdate = meta?.date;
                            for(let k of ['grafana','pbi','sml','pml','cargos','enviados','vto']) this.rawData[k] = await DB.load(k);
                            this.strategyOverrides = await DB.load('strategyOverrides') || {};
                            this.historyData = await DB.getHistory();
                            this.debtHistory = await DB.getDebtHistory();

                            this.loadingMsg = 'PROCESANDO DATOS...';
                            this.processAll();
                        } else { this.isLoading = false; }
                    } catch(e) { console.error(e); this.isLoading = false; }
                },

                handleFile(e) {
                    const file = e.target.files[0]; if (!file) return;
                    this.isLoading = true; this.loadingMsg = 'LEYENDO EXCEL...';
                    this.fileName = file.name;
                    const reader = new FileReader();
                    reader.onload = async (evt) => {
                        try {
                            const wb = XLSX.read(evt.target.result, { type: 'array' });
                            const getSheet = (keys) => { const name = wb.SheetNames.find(n => keys.some(k => n.toLowerCase().includes(k.toLowerCase()))); return name ? XLSX.utils.sheet_to_json(wb.Sheets[name], { header: 1 }) : []; };
                            this.rawData.grafana = getSheet(['grafana', 'main']);
                            this.rawData.pbi = getSheet(['pbi', 'powerbi']);
                            this.rawData.sml = getSheet(['stock ml', 'stock_ml']);
                            this.rawData.pml = getSheet(['plan ml', 'plan_ml']);
                            this.rawData.cargos = getSheet(['cargos', 'deuda']);
                            this.rawData.enviados = getSheet(['enviados', 'envios']);
                            this.rawData.vto = getSheet(['vencimiento', 'vto']);

                            if(this.rawData.grafana.length === 0) throw new Error("Falta hoja Grafana");

                            const now = new Date().toLocaleString();
                            this.lastUpdate = now;
                            DB.save('meta', {fileName: file.name, date: now});
                            Object.keys(this.rawData).forEach(k => DB.save(k, this.rawData[k]));

                            this.loadingMsg = 'GUARDANDO HISTORIAL...';
                            const snapshot = this.generateSnapshot();
                            await DB.saveSnapshot(snapshot);
                            this.historyData = await DB.getHistory();
                            this.debtHistory = await DB.getDebtHistory();

                            this.loadingMsg = 'CALCULANDO M√âTRICAS...';
                            this.processAll();
                        } catch (err) { console.error(err); alert(err.message); this.isLoading = false; }
                    };
                    reader.readAsArrayBuffer(file);
                },

                generateSnapshot() {
                    try {
                        const hG = this.rawData.grafana[0];
                        const iSku = hG.findIndex(c => String(c).toUpperCase().includes('SKU'));
                        const iVtar = hG.findIndex(c => String(c).toUpperCase().includes('VTAR'));
                        const snap = {};
                        this.rawData.grafana.slice(1).forEach(r => {
                            const s = String(r[iSku]||'').trim().toUpperCase();
                            if(s && s !== 'TOTAL') {
                                const v = parseFloat(r[iVtar]) || 0;
                                if(!snap[s]) snap[s] = {v:0};
                                snap[s].v += v;
                            }
                        });
                        return snap;
                    } catch(e) { return {}; }
                },

                recalculateGlobal() { if(this.dataReady) this.processAll(); },
                switchTab(id) {
                    this.currentTab = id; this.currentPage = 1; this.search = '';
                    this.activeFilters = {};
                    this.selectedIds = [];
                    this.filterOpportunityCost = false;
                    this.filterAging = null;
                    this.filterArbitrage = false;
                    if(id === 'metricas') setTimeout(()=>this.renderCharts(), 100);
                    else this.calculateColumnMaxes();
                },

                toggleSelectAll(e) {
                    if (e.target.checked) {
                        this.selectedIds = this.filteredData.map(r => r.id);
                    } else {
                        this.selectedIds = [];
                    }
                },

                applyBulkEdit(field, value) {
                    if (this.selectedIds.length === 0) return;
                    
                    if (value === undefined && field === 'diasEstrategia') {
                        value = prompt("Ingrese d√≠as de estrategia para " + this.selectedIds.length + " items:", "45");
                        if (value === null) return;
                        value = parseFloat(value);
                    }

                    this.masterData.forEach(item => {
                        if (this.selectedIds.includes(item.id)) {
                            item[field] = value;
                            if (field === 'diasEstrategia') {
                                if (!this.strategyOverrides) this.strategyOverrides = {};
                                this.strategyOverrides[item.sku] = value;
                            }
                        }
                    });

                    if (field === 'diasEstrategia') DB.save('strategyOverrides', this.strategyOverrides);

                    const updated = this.masterData.map(item => this.calculateRowLogic(item));
                    this.masterData = updated;
                    this.updateKPIs();
                    this.selectedIds = [];
                },

                calculateLiquidation() {
                    const stockItems = this.filteredData; 
                    let totalRecovery = 0;
                    let totalLoss = 0;
                    const discount = this.liqParams.discount / 100;

                    stockItems.forEach(item => {
                        const val = item.stockValorizado;
                        const recovery = val * (1 - discount);
                        totalRecovery += recovery;
                        totalLoss += (val - recovery);
                    });

                    return { recovery: totalRecovery, loss: totalLoss };
                },

                getSimulatedTotal() {
                    if (!this.masterData.length) return 0;
                    return this.masterData.reduce((acc, item) => {
                        const pbi = item.pbi || {dep1:0, dep80:0};
                        const stockSucTotal = [81,82,83,86,87,89].reduce((a,n)=>a+(pbi[`dep${n}`]||0), 0);
                        const stockRed = pbi.dep1 + stockSucTotal + pbi.dep80 + item.comprasEnCamino;
                        const lt = item.lt || 30;
                        const ss = Math.ceil(2.33 * item.vtarTotal * Math.sqrt(lt));
                        const targetStock = Math.ceil((item.vtarTotal * this.params.simulationDays) + ss);
                        let buy = 0; if(stockRed < targetStock) buy = targetStock - stockRed;
                        if(buy < 0) buy = 0; buy = Math.ceil(buy / item.uxb) * item.uxb;
                        return acc + (buy * item.costo);
                    }, 0);
                },

                getSimulationResults() {
                    const days = this.simParams.days || 30;
                    let totalSimulated = 0;
                    this.masterData.forEach(item => {
                        const pbi = item.pbi || {dep1:0, dep80:0};
                        const stockSuc = [81,82,83,87,89].reduce((a,n)=>a+(pbi[`dep${n}`]||0),0);
                        const stockRed = pbi.dep1 + stockSuc + pbi.dep80 + item.comprasEnCamino;
                        const lt = item.lt || 30;
                        const ss = Math.ceil(2.33 * item.vtarTotal * Math.sqrt(lt));
                        const target = Math.ceil((item.vtarTotal * days) + ss);
                        let buy = Math.max(0, target - stockRed);
                        buy = Math.ceil(buy / item.uxb) * item.uxb;
                        totalSimulated += (buy * item.costo);
                    });
                    return { total: totalSimulated, diff: totalSimulated - this.kpis.compra };
                },

                exportProviderOrder(providerName) {
                    const items = this.masterData.filter(i => i.prov === providerName && i.comprarU > 0);
                    if (items.length === 0) { alert("No hay items para pedir a " + providerName); return; }
                    
                    const data = items.map(i => ({
                        SKU: i.sku,
                        Descripcion: i.desc,
                        Marca: i.marca,
                        Cantidad: i.comprarU,
                        CostoUnitario: i.costo,
                        Total: i.inversion
                    }));
                    
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Orden");
                    XLSX.writeFile(wb, `Orden_Compra_${providerName.replace(/[^a-zA-Z0-9]/g,'_')}.xlsx`);
                },

                filterMatrix(code) {
                    this.switchTab('consolidado');
                    this.activeFilters['abc_xyz'] = [code];
                },

                toggleChat() { this.chatOpen = !this.chatOpen; },
                sendQuickMsg(text) { this.chatInput = text; this.sendMessage(); },

                async sendMessage() {
                    if(!this.chatInput.trim()) return;
                    const txt = this.chatInput.trim();
                    this.chatMessages.push({ type: 'user', text: txt });
                    this.chatInput = '';
                    this.isTyping = true;

                    this.$nextTick(() => { const c = document.getElementById('chat-messages'); c.scrollTop = c.scrollHeight; });

                    setTimeout(() => {
                        const response = this.processChatQuery(txt);
                        this.isTyping = false;
                        this.chatMessages.push(response);
                        this.$nextTick(() => { const c = document.getElementById('chat-messages'); c.scrollTop = c.scrollHeight; });
                    }, 600);
                },

                processChatQuery(q) {
                    q = q.toUpperCase();

                    if(q === 'RESUMEN' || q === 'STATUS') {
                        if(this.currentTab === 'dep80') return { type: 'bot', html: `<div class="font-bold text-purple-700">üì¶ Contexto: Env√≠os Full</div><div>Items a enviar: <b>${this.kpis.envios.toLocaleString()}</b></div><div>Inversi√≥n: <b>${this.formatMoney(this.kpis.valorEnvios)}</b></div>` };
                        if(this.currentTab === 'resumen') return { type: 'bot', html: `<div class="font-bold text-emerald-700">üõí Contexto: Compras</div><div>Total Inversi√≥n: <b>${this.formatMoney(this.kpis.compra)}</b></div><div>SKUs: <b>${this.kpis.skusCompra}</b></div>` };
                        if(this.currentTab === 'metricas') return { type: 'bot', html: `<b>üìä Est√°s en M√©tricas.</b> Revisa la Matriz ABC-XYZ para estrategia.` };
                    }

                    if(q.includes('QUIEBRE') || q.includes('URGENTE')) {
                        const risks = this.metrics.topRisks.slice(0, 3);
                        let html = `<div class="font-bold text-red-600 mb-1">üî• Top Riesgos Inminentes</div>`;
                        if(risks.length===0) html += `<span class="text-slate-500">Todo bajo control.</span>`;
                        else risks.forEach(r => html += `<div class="border-b py-1 last:border-0"><div class="font-bold">${r.sku}</div><div class="flex justify-between text-[10px]"><span>Stock: ${r.stock}</span><span class="text-red-600 font-bold">${r.days.toFixed(1)} d√≠as</span></div></div>`);
                        return { type: 'bot', html };
                    }
                    if(q.includes('VENCIMIENTO') || q.includes('VENCER')) {
                        const vtos = this.lotesData.filter(l=>l.dias<=30).sort((a,b)=>a.dias-b.dias).slice(0,3);
                        let html = `<div class="font-bold text-orange-600 mb-1">üìÖ Vencimientos Pr√≥ximos (30d)</div>`;
                        if(vtos.length===0) html += `<span class="text-slate-500">Sin lotes cr√≠ticos.</span>`;
                        else vtos.forEach(v => html += `<div class="border-b py-1 last:border-0"><div class="font-bold">${v.sku}</div><div class="text-[10px]">Vence: ${v.fechaVto} (${v.stockComprometido} u.)</div></div>`);
                        return { type: 'bot', html };
                    }
                    if(q.includes('DINERO') || q.includes('PLATA') || q.includes('INVERSION')) {
                        return { type: 'bot', html: `
                            <div class="font-bold text-emerald-700 mb-2">üí∞ Resumen Financiero</div>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div class="bg-emerald-50 p-1 rounded">
                                    <div class="text-emerald-500 text-[9px]">Sugerido</div>
                                    <div class="font-bold">${this.formatMoney(this.kpis.compra)}</div>
                                </div>
                                <div class="bg-red-50 p-1 rounded">
                                    <div class="text-red-500 text-[9px]">Inmovilizado</div>
                                    <div class="font-bold">${this.formatMoney(this.kpis.inmovilizado)}</div>
                                </div>
                            </div>
                        `};
                    }

                    const skuMatch = this.masterData.find(i => i.sku === q || i.desc.toUpperCase().includes(q));
                    if(skuMatch) {
                        const lotes = this.lotesData.filter(l => l.sku === skuMatch.sku).sort((a,b)=>a.dias-b.dias);
                        const nextVto = lotes.length > 0 ? lotes[0].fechaVto + ` (${lotes[0].dias}d)` : 'Sin datos';
                        return { type: 'bot', html: `
                            <div class="border-l-4 border-blue-500 pl-2 mb-2">
                                <div class="font-bold text-sm">${skuMatch.sku}</div>
                                <div class="text-[10px] text-slate-500 truncate">${skuMatch.desc}</div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-[10px] mb-2">
                                <div class="bg-slate-100 p-1 rounded">Stock Total: <b>${skuMatch.stockGrafana}</b></div>
                                <div class="bg-slate-100 p-1 rounded">D√≠as: <b class="${skuMatch.diasStock<15?'text-red-600':'text-green-600'}">${skuMatch.diasStock.toFixed(1)}</b></div>
                                <div class="bg-slate-100 p-1 rounded">Dep 1: <b>${skuMatch.pbi?.dep1||0}</b></div>
                                <div class="bg-slate-100 p-1 rounded">Dep 80: <b>${skuMatch.pbi?.dep80||0}</b></div>
                            </div>
                            <div class="text-[10px] bg-orange-50 text-orange-700 p-1 rounded border border-orange-100">
                                ‚è≥ Prox. Vencimiento: <b>${nextVto}</b>
                            </div>
                        `};
                    }

                    const brandItems = this.masterData.filter(i => (i.marca||'').toUpperCase().includes(q) || (i.prov||'').toUpperCase().includes(q));
                    if(brandItems.length > 0) {
                        const totalStock = brandItems.reduce((a,b)=>a+b.stockGrafana,0);
                        const totalVal = brandItems.reduce((a,b)=>a+b.stockValorizado,0);
                        const quiebres = brandItems.filter(i=>i.diasStock<=10).length;
                        return { type: 'bot', html: `
                            <div class="font-bold text-indigo-700 mb-2">Resumen: ${q}</div>
                            <div class="space-y-1 text-xs">
                                <div class="flex justify-between"><span>SKUs:</span> <b>${brandItems.length}</b></div>
                                <div class="flex justify-between"><span>Capital:</span> <b>${this.formatMoney(totalVal)}</b></div>
                                <div class="flex justify-between"><span>Unidades:</span> <b>${totalStock}</b></div>
                                <div class="flex justify-between text-red-600"><span>En Quiebre:</span> <b>${quiebres}</b></div>
                            </div>
                        `};
                    }

                    return { type: 'bot', text: 'ü§î No encontr√© ese SKU, Marca o comando. Intenta con un c√≥digo exacto o pulsa los botones.' };
                },

                processAll() {
                    setTimeout(() => {
                        try {
                            const clean = (s) => String(s||'').trim().toUpperCase();
                            const num = (v) => { if(typeof v==='number') return v; if(!v) return 0; let s = String(v).replace(/[$\s]/g,''); if(s.includes(',') && s.includes('.')) s = s.replace(/\./g,'').replace(',','.'); else if(s.includes(',')) s = s.replace(',','.'); return parseFloat(s) || 0; };
                            const idx = (row, keys) => row.findIndex(c => keys.some(k => String(c).trim().toUpperCase().includes(k.toUpperCase())));

                            this.lookups.mapML = {};
                            this.lookups.mapCargos = {};
                            this.lookups.mapEnvios = {};

                            if(this.rawData.sml && this.rawData.sml.length) {
                                const h=this.rawData.sml[0];
                                const iS=idx(h,['SKU']), iI=idx(h,['IMPULSAR']);
                                const iEstado=idx(h,['ESTADO DE PUBLICACION']);
                                const iCalidad=idx(h,['Calidad ok']);

                                this.rawData.sml.slice(1).forEach(r=>{ 
                                    const s=clean(r[iS]); 
                                    if(s) {
                                        this.lookups.mapML[s] = {
                                            impulsar: String(r[iI]).includes('SI'),
                                            estado: r[iEstado],
                                            calidad: r[iCalidad]
                                        };
                                    } 
                                });
                            }

                            if(this.rawData.cargos && this.rawData.cargos.length) {
                                const h=this.rawData.cargos[0];
                                const iS=idx(h,['SKU']), iU=idx(h,['Unidades']), iUCost=idx(h,['Cargo por unidad']), iDate=idx(h,['FECHA']);
                                const iAnt=idx(h,['Antig√ºedad']);

                                let latestDate = 0;
                                if(iDate > -1) {
                                    this.rawData.cargos.slice(1).forEach(r => {
                                        const d = r[iDate];
                                        if(typeof d === 'number' && d > latestDate) latestDate = d;
                                    });
                                }
                                this.rawData.cargos.slice(1).forEach(r=>{
                                    const rowDate = r[iDate];
                                    if(iDate === -1 || rowDate === latestDate) {
                                        const s=clean(r[iS]);
                                        if(s) {
                                            if(!this.lookups.mapCargos[s]) this.lookups.mapCargos[s]={monto:0,unidades:0, antiguedad: ''};
                                            const u=num(r[iU]), uc=num(r[iUCost]);
                                            this.lookups.mapCargos[s].unidades+=u;
                                            this.lookups.mapCargos[s].monto+=(u*uc);
                                            if(r[iAnt]) this.lookups.mapCargos[s].antiguedad = r[iAnt]; 
                                        }
                                    }
                                });
                            }

                            this.lookups.mapPlanML = {};
                            if(this.rawData.pml && this.rawData.pml.length) {
                                const h=this.rawData.pml[0];
                                const iS=idx(h,['SKU']);
                                const iRec=idx(h,['Recomendaci√≥n']);
                                const iSug=idx(h,['Unidades sugeridas', 'sugeridas']);

                                this.rawData.pml.slice(1).forEach(r=>{
                                    const s=clean(r[iS]);
                                    if(s) {
                                        const recText = String(r[iRec]||'');
                                        this.lookups.mapPlanML[s] = {
                                            rec: recText,
                                            sug: num(r[iSug]),
                                            esUrgente: recText.toLowerCase().includes('urgencia') || recText.toLowerCase().includes('perdiendo')
                                        };
                                    }
                                });
                            }

                            const data = {}; const hG = this.rawData.grafana[0];
                            const iSku = idx(hG, ['SKU']), iDep = idx(hG, ['Deposito']), iVtar = idx(hG, ['VTAR']), iVpd = idx(hG, ['VPD_Cpra']);
                            const iDesc = idx(hG, ['Descripcion']), iMarca = idx(hG, ['Marca']), iProv = idx(hG, ['Proveedor', 'Prov']), iAnalista = idx(hG, ['Analista']);
                            const iCosto = idx(hG, ['Costo', 'Reposici√≥n']), iLt = idx(hG, ['Lead']), iDev = idx(hG, ['Desv√≠o']), iStock = idx(hG, ['Stock']), iUxb = idx(hG, ['UXB']);
                            const iCamino = idx(hG, ['COMPRAS']), iVta59 = idx(hG, ['TOTAL VENDIDO', '59 D√çAS', 'VENDIDO 59']);
                            
                            const iPerfil = idx(hG, ['Perfil']);

                            const flatRows = [];
                            this.rawData.grafana.slice(1).forEach(r => {
                                const sku = clean(r[iSku]); if(!sku || sku === 'TOTAL') return;
                                const dep = clean(r[iDep]), v = num(r[iVtar]), st = num(r[iStock]), vta59 = num(r[iVta59]);

                                if(!data[sku]) {
                                    data[sku] = {
                                        sku, desc: r[iDesc], marca: r[iMarca]||'-', prov: r[iProv]||'-',
                                        analista: r[iAnalista]||'-', costo: num(r[iCosto]),
                                        lt: num(r[iLt])||30,
                                        dev: 0,
                                        vpdCpra: num(r[iVpd]),
                                        uxb: num(r[iUxb])||1,
                                        perfil: (iPerfil > -1 ? r[iPerfil] : '') || 'Sin Clasificar',
                                        vtarTotal: 0, vtar80: 0, vtar1: 0, vtarSuc: 0,
                                        stockGrafana: 0, comprasEnCamino: 0, vta59Total: 0,
                                        histDaily: [], vtarBreakdown: {}, seasonalMult: 1
                                    };
                                }

                                const depNum = dep.match(/\d+/)?.[0] || '';
                                if(depNum && ['82','86','87','89'].includes(depNum)) {
                                    if(!data[sku].vtarBreakdown[depNum]) data[sku].vtarBreakdown[depNum] = 0;
                                    data[sku].vtarBreakdown[depNum] += v;
                                }

                                const histIndices = [];
                                for(let i=1; i<=60; i++) { 
                                    const ix = idx(hG, [`-${i}`]); 
                                    if(ix > -1) histIndices.push({ idx: ix, day: i }); 
                                }

                                if (histIndices.length > 0) {
                                    const dailySales = histIndices.map(item => num(r[item.idx]));
                                    if (data[sku].histDaily.length === 0) data[sku].histDaily = dailySales;
                                    else for(let k=0; k<dailySales.length; k++) data[sku].histDaily[k] += dailySales[k];

                                    const calcAvg = (days) => {
                                        const slice = data[sku].histDaily.slice(0, days); 
                                        const sum = slice.reduce((a,b) => a + b, 0);
                                        return (days > 0 && slice.length > 0) ? (sum / days) : 0;
                                    };

                                    data[sku].vtar15 = calcAvg(15);
                                    data[sku].vtar30 = calcAvg(30);
                                    data[sku].vtar45 = calcAvg(45);
                                    data[sku].vtar60 = calcAvg(60);
                                }

                                data[sku].vtarTotal += v; data[sku].stockGrafana += st; data[sku].vta59Total += vta59;
                                if(iCamino > -1) data[sku].comprasEnCamino += num(r[iCamino]);
                                if(dep.includes('80') || dep.includes('FULL')) data[sku].vtar80 += v; else if(dep.includes('1') || dep.includes('CENTRAL')) data[sku].vtar1 += v; else data[sku].vtarSuc += v;
                                flatRows.push({ id: Math.random().toString(36).substr(2,9), sku: sku, desc: r[iDesc]||data[sku]?.desc||'-', marca: r[iMarca]||'-', prov: r[iProv]||'-', dep, vtar: v, stock: st, vta59, diasStockDep: v > 0 ? st/v : (st>0 ? 999 : 0), costo: num(r[iCosto]), analista: r[iAnalista]||'-' });
                            }); 

                            if(this.rawData.pbi && this.rawData.pbi.length) {
                                const hP_Uni = this.rawData.pbi[0];
                                const iP_S = idx(hP_Uni, ['SKU']);
                                const iP_Desc = idx(hP_Uni, ['DESCRIPCION']);
                                
                                this.rawData.pbi.slice(1).forEach(r => {
                                    const sku = clean(r[iP_S]);
                                    if(sku && !data[sku]) {
                                        data[sku] = {
                                            sku, 
                                            desc: r[iP_Desc] || 'Producto solo en PBI (Falta en Grafana)',
                                            marca: 'S/D', prov: 'S/D', analista: 'S/D',
                                            costo: 0, lt: 30, dev: 0, vpdCpra: 0, uxb: 1,
                                            vtarTotal: 0, vtar80: 0, vtar1: 0, vtarSuc: 0,
                                            stockGrafana: 0, comprasEnCamino: 0, vta59Total: 0,
                                            histDaily: [], vtarBreakdown: {}, seasonalMult: 1,
                                            origen: 'Solo PBI'
                                        };
                                    }
                                });
                            }

                            if(this.rawData.sml && this.rawData.sml.length) {
                                const hS_Uni = this.rawData.sml[0];
                                const iS_S = idx(hS_Uni, ['SKU']);
                                const iS_Desc = idx(hS_Uni, ['DESCRIPCION']);
                                const iS_Pub = idx(hS_Uni, ['PUBLICACION', 'TITULO']);

                                this.rawData.sml.slice(1).forEach(r => {
                                    const sku = clean(r[iS_S]);
                                    if(sku && !data[sku]) {
                                        data[sku] = {
                                            sku, 
                                            desc: r[iS_Desc] || r[iS_Pub] || 'Producto solo en ML (Falta en Grafana)',
                                            marca: 'S/D', prov: 'S/D', analista: 'S/D',
                                            costo: 0, lt: 30, dev: 0, vpdCpra: 0, uxb: 1,
                                            vtarTotal: 0, vtar80: 0, vtar1: 0, vtarSuc: 0,
                                            stockGrafana: 0, comprasEnCamino: 0, vta59Total: 0,
                                            histDaily: [], vtarBreakdown: {}, seasonalMult: 1,
                                            origen: 'Solo ML'
                                        };
                                    }
                                });
                            }

                            const hP = this.rawData.pbi ? this.rawData.pbi[0] : null;
                            if(hP) {
                                const iP_S = idx(hP, ['SKU']), iP_D1 = idx(hP, ['DEP 1']), iP_D80 = idx(hP, ['DEP 80']);
                                const colsSuc = [81,82,83,86,87,89].map(n => ({k:`dep${n}`, i:idx(hP, [`DEP ${n}`])}));
                                this.rawData.pbi.slice(1).forEach(r => {
                                    const sku = clean(r[iP_S]);
                                    if(data[sku]) { data[sku].pbi = { dep1: num(r[iP_D1]), dep80: num(r[iP_D80]) }; colsSuc.forEach(c => data[sku].pbi[c.k] = num(r[c.i])); }
                                });
                            }

                            const rawEnvios = [], envioFechas = new Set();
                            if(this.rawData.enviados && this.rawData.enviados.length) {
                                const h=this.rawData.enviados[0], iS=idx(h,['SKU']), iDesc=idx(h,['DESCRIPCI√ìN']), iProv=idx(h,['PROV']), iCant=idx(h,['ENVIO REALIZADO']), iNum=idx(h,['N¬∞ ENVIO']), iFecha=idx(h,['FECHA']);
                                this.rawData.enviados.slice(1).forEach(r=>{
                                    const s=clean(r[iS]);
                                    if(s) {
                                        this.lookups.mapEnvios[s] = (this.lookups.mapEnvios[s]||0)+num(r[iCant]);
                                        let fStr = String(r[iFecha]||'-');
                                        if(typeof r[iFecha]==='number') fStr = excelDateToJSDate(r[iFecha]);
                                        envioFechas.add(fStr);
                                        rawEnvios.push({ id: Math.random().toString(36).substr(2,9), sku: s, desc: r[iDesc]||data[s]?.desc||'-', marca: data[s]?.marca||'-', prov: r[iProv]||data[s]?.prov||'-', cant: num(r[iCant]), num_envio: r[iNum], fecha: fStr });
                                    }
                                });
                            }
                            this.enviosData = rawEnvios; this.uniqueEnvioFechas = Array.from(envioFechas).sort();

                            const rawLotes = [], vtoBuckets = { '15-30': 0, '31-60': 0, '61-90': 0 };
                            let totalRiesgoVto = 0;

                            if(this.rawData.vto && this.rawData.vto.length) {
                                const h = this.rawData.vto[0], iS=idx(h,['SKU']), iRec=idx(h,['RECIBIDO','STOCK']), iIn=idx(h,['INGRESO']), iVto=idx(h,['VENCIMIENTO']);
                                
                                const batchesBySku = {};
                                const hoy = new Date(); 
                                hoy.setHours(0,0,0,0); 

                                this.rawData.vto.slice(1).forEach(r => {
                                    const sku = clean(r[iS]); if(!sku) return; if(!batchesBySku[sku]) batchesBySku[sku] = [];
                                    
                                    let fIn = r[iIn], dVal = typeof fIn==='number' ? fIn : 0;
                                    if(typeof fIn === 'number') fIn = excelDateToJSDate(fIn);
                                    
                                    let rawVto = r[iVto];
                                    let fVtoStr = rawVto; 
                                    let diasCalculados = 0;
                                    let vtoObj = null;

                                    if(typeof rawVto === 'number') {
                                        const utc_value = Math.floor(rawVto - 25569) * 86400000;
                                        vtoObj = new Date(utc_value);
                                        fVtoStr = excelDateToJSDate(rawVto); 
                                    } else if (typeof rawVto === 'string') {
                                        if(rawVto.includes('-')) { 
                                            const parts = rawVto.split('-');
                                            if(parts.length===3) {
                                                vtoObj = new Date(parts[0], parts[1]-1, parts[2]);
                                                fVtoStr = `${parts[2]}/${parts[1]}/${parts[0]}`;
                                            }
                                        } else if (rawVto.includes('/')) { 
                                             const parts = rawVto.split('/');
                                             if(parts.length===3) vtoObj = new Date(parts[2], parts[1]-1, parts[0]);
                                        }
                                    }

                                    if(vtoObj && !isNaN(vtoObj.getTime())) {
                                        const diffTime = vtoObj.getTime() - hoy.getTime();
                                        diasCalculados = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                    }

                                    batchesBySku[sku].push({ 
                                        sku, 
                                        desc: data[sku]?.desc||'-', 
                                        marca: data[sku]?.marca||'-', 
                                        prov: data[sku]?.prov||'-', 
                                        recibido: num(r[iRec]), 
                                        fechaIngreso: fIn,
                                        fechaVto: fVtoStr, 
                                        dias: diasCalculados,
                                        dateVal: dVal 
                                    });
                                });

                                Object.keys(batchesBySku).forEach(sku => {
                                    let currentStock = data[sku]?.stockGrafana || 0;
                                    const batches = batchesBySku[sku].sort((a,b) => b.dateVal - a.dateVal);
                                    
                                    const ventaDiaria = data[sku]?.vtarTotal || 0;
                                    const costo = data[sku]?.costo || 0;

                                    batches.forEach(batch => {
                                        if(currentStock > 0) {
                                            const stockDeEsteLote = Math.min(currentStock, batch.recibido);
                                            if(stockDeEsteLote > 0) {
                                                batch.stockComprometido = stockDeEsteLote;
                                                batch.id = Math.random().toString(36).substr(2,9);
                                                
                                                const diasUtiles = Math.max(0, batch.dias);
                                                const ventaPosible = ventaDiaria * diasUtiles;
                                                const unidadesEnRiesgo = Math.max(0, stockDeEsteLote - ventaPosible);
                                                
                                                batch.riesgoMonetario = unidadesEnRiesgo * costo;
                                                if(batch.riesgoMonetario > 0) totalRiesgoVto += batch.riesgoMonetario;

                                                rawLotes.push(batch);
                                                
                                                if(batch.dias <= 30) vtoBuckets['15-30']++; 
                                                else if(batch.dias <= 60) vtoBuckets['31-60']++;
                                                else if(batch.dias <= 90) vtoBuckets['61-90']++;
                                                currentStock -= stockDeEsteLote;
                                            }
                                        }
                                    });
                                });
                            }
                            this.lotesData = rawLotes; 
                            this.metrics.vto = vtoBuckets;
                            this.kpis.riesgoVto = totalRiesgoVto;

                            if(this.strategyOverrides) {
                                Object.keys(this.strategyOverrides).forEach(s => {
                                    if(data[s]) data[s].diasEstrategia = this.strategyOverrides[s];
                                });
                            }

                            const processed = Object.values(data).map(item => {
                                if (item.histDaily && item.histDaily.length > 5) {
                                    const chrono = [...item.histDaily].reverse();
                                    const reg = calculateLinearRegression(chrono);
                                    item.vtarIa = Math.max(0, reg.nextVal);
                                    item.isAnomaly = detectAnomaly(chrono);
                                } else {
                                    item.vtarIa = 0;
                                    item.isAnomaly = false;
                                }

                                if(item.histDaily.length>0) {
                                    item.stdDev = calculateStandardDeviation(item.histDaily, item.vtarTotal);
                                    item.cv = item.vtarTotal > 0 ? (item.stdDev / item.vtarTotal) : 0;
                                    if(item.vtarTotal === 0) item.stability = 'Inactivo';
                                    else if(item.cv < 0.3) item.stability = 'Estable'; 
                                    else if(item.cv < 0.7) item.stability = 'Variable';
                                    else item.stability = 'Err√°tico';
                                } else { 
                                    item.stability = 'S/D'; item.cv = 0; 
                                }

                                const p = this.calculateRowLogic(item);
                                p.id = Math.random().toString(36).substr(2,9);
                                return p;
                            });

                            const provMap = {};
                            processed.forEach(item => {
                                const pName = item.prov || 'S/D';
                                if (!provMap[pName]) {
                                    provMap[pName] = {
                                        id: Math.random().toString(36).substr(2,9),
                                        prov: pName,
                                        totalStockVal: 0,
                                        totalVtar: 0,
                                        totalStockQty: 0,
                                        inmoVal: 0,
                                        inversion: 0
                                    };
                                }
                                provMap[pName].totalStockVal += (item.stockGrafana * item.costo);
                                provMap[pName].totalStockQty += item.stockGrafana;
                                provMap[pName].totalVtar += item.vtarTotal;
                                if (item.diasStock > 45) provMap[pName].inmoVal += (item.stockGrafana * item.costo);
                                provMap[pName].inversion += item.inversion;
                            });

                            this.proveedoresData = Object.values(provMap).map(p => ({
                                ...p,
                                diasStockProm: p.totalVtar > 0 ? (p.totalStockQty / p.totalVtar) : 0
                            }));

                            const otherDepsList = [];
                            const targetDays = this.params.diasOtros || 30;

                            processed.forEach(item => {
                                this.availableOtherDeps.forEach(d => {
                                    const stk = item.pbi ? (item.pbi[`dep${d}`] || 0) : 0;
                                    let vt = 0;
                                    if (d === '80') {
                                        vt = item.vtar80 || 0; 
                                    } else {
                                        vt = (item.vtarBreakdown && item.vtarBreakdown[d]) || 0;
                                    }

                                    const dias = vt > 0 ? stk/vt : (stk > 0 ? 999 : 0);

                                    let q = 0;
                                    if(vt > 0) {
                                         const target = vt * targetDays;
                                         if(stk < target) q = target - stk;
                                    }

                                    let status = 'üü¢';
                                    if (stk === 0 && vt > 0) status = 'üî¥';
                                    else if (dias < targetDays) status = 'üü°';
                                    else if (dias > targetDays * 2) status = 'üü£';

                                    if(stk > 0 || vt > 0 || q > 0) {
                                         otherDepsList.push({
                                             id: item.sku + '_' + d,
                                             sku: item.sku,
                                             desc: item.desc,
                                             marca: item.marca,
                                             prov: item.prov,
                                             deposito: d,
                                             stock: stk,
                                             vtar: vt,
                                             diasStock: dias,
                                             qEnviar: Math.ceil(q),
                                             statusVisual: status
                                         });
                                    }
                                });
                            });
                            this.otherDepositsData = otherDepsList;

                            setTimeout(() => {
                                try {
                                    const histByDate = {};
                                    this.historyData.forEach(h => histByDate[h.date] = h.data);
                                    const sortedDates = Object.keys(histByDate).sort().slice(-14);
                                    processed.forEach(row => {
                                        const trend = [];
                                        sortedDates.forEach(d => {
                                            const daySnap = histByDate[d];
                                            if(daySnap && daySnap[row.sku]) trend.push(daySnap[row.sku].v);
                                            else trend.push(0);
                                        });
                                        
                                        if (trend.filter(x=>x>0).length < 2 && row.histDaily && row.histDaily.length > 1) {
                                            row.trendHistory = [...row.histDaily].reverse();
                                        } else {
                                            trend.push(row.vtarTotal);
                                            row.trendHistory = trend;
                                        }

                                        if(row.trendHistory.length >= 2) {
                                            row.trendSlope = row.vtarTotal - row.trendHistory[row.trendHistory.length-2];
                                        } else { row.trendSlope = 0; }
                                    });
                                    this.masterData = [...this.masterData];
                                } catch(errHist) { console.warn("Trend calc skipped", errHist); }
                            }, 100);

                            const totVenta = processed.reduce((s,i)=>s+(i.vtarTotal*i.costo),0);
                            processed.sort((a,b)=>(b.vtarTotal*b.costo)-(a.vtarTotal*a.costo));
                            let acc=0;
                            const matrix = { A: {q:0, pq:0, s:0, a:0, o:0}, B: {q:0, pq:0, s:0, a:0, o:0}, C: {q:0, pq:0, s:0, a:0, o:0} };
                            const mCounts = {};

                            processed.forEach(p=>{
                                acc+=(p.vtarTotal*p.costo);
                                const pct=totVenta?acc/totVenta:0;
                                p.abc=pct<=0.8?'A':(pct<=0.95?'B':'C');
                                
                                let xyz = 'Z';
                                if (p.stability === 'Estable') xyz = 'X';
                                else if (p.stability === 'Variable') xyz = 'Y';
                                p.abc_xyz = p.abc + xyz;
                                mCounts[p.abc_xyz] = (mCounts[p.abc_xyz] || 0) + 1;

                                let status = '';
                                if(p.diasStock <= 10) status='q';
                                else if(p.diasStock <= 17) status='pq';
                                else if(p.diasStock <= 30) status='s';
                                else if(p.diasStock <= 45) status='a';
                                else status='o';
                                matrix[p.abc][status] += (p.stockGrafana * p.costo);
                            });
                            this.metrics.matrix = matrix;
                            this.matrixCounts = mCounts;

                            this.masterData = processed;
                            this.flatData = flatRows; 

                            const anaDebt = {}; let totalDebt = 0;
                            const anaStats = {};
                            this.masterData.forEach(i => {
                                if(i.deuda>0) {
                                    const a=i.analista||'S/D';
                                    anaDebt[a]=(anaDebt[a]||0)+i.deuda;
                                    totalDebt += i.deuda;

                                    if(!anaStats[a]) anaStats[a] = { name: a, debt: 0, count: 0, units: 0 };
                                    anaStats[a].debt += i.deuda;
                                    anaStats[a].count += 1;
                                    anaStats[a].units += (i.unidadesCargo || 0);
                                }
                            });
                            this.metrics.analistas = Object.entries(anaDebt).map(([name,val])=>({name,val})).sort((a,b)=>b.val-a.val);
                            this.metrics.analistasTable = Object.values(anaStats).sort((a,b)=>b.debt-a.debt);
                            this.metrics.totalDeudaAnalistas = totalDebt;
                            DB.saveDebtHistory(totalDebt);

                            const provInmo = {};
                            this.masterData.forEach(i => {
                                if(i.diasStock > 45) {
                                    const p = i.prov || 'S/D';
                                    const val = i.stockGrafana * i.costo;
                                    provInmo[p] = (provInmo[p] || 0) + val;
                                }
                            });
                            this.metrics.proveedoresInmo = Object.entries(provInmo).map(([name,val])=>({name,val})).sort((a,b)=>b.val-a.val).slice(0,20);

                            const provBuy = {};
                            const brandMap = {};
                            this.masterData.forEach(i => {
                                if(i.inversion>0) { const p=i.prov||'S/D'; provBuy[p]=(provBuy[p]||0)+i.inversion; }

                                const b = i.marca || 'S/D';
                                const val = i.stockGrafana * i.costo;
                                brandMap[b] = (brandMap[b] || 0) + val;
                            });
                            this.metrics.proveedores = Object.entries(provBuy).map(([name,val])=>({name,val})).sort((a,b)=>b.val-a.val).slice(0,20);

                            const sortedBrands = Object.entries(brandMap).map(([name,val])=>({name,val})).sort((a,b)=>b.val-a.val);
                            if (sortedBrands.length > 15) {
                                const top = sortedBrands.slice(0, 14);
                                const others = sortedBrands.slice(14).reduce((acc, curr) => acc + curr.val, 0);
                                top.push({ name: 'OTROS', val: others });
                                this.metrics.brands = top;
                            } else {
                                this.metrics.brands = sortedBrands;
                            }

                            let h={q:0, pq:0, s:0, a:0, o:0};
                            this.masterData.forEach(i => {
                                if(i.stockGrafana > 0) {
                                    const d = i.diasStock;
                                    if(d <= 10) h.q++;
                                    else if(d <= 17) h.pq++;
                                    else if(d <= 30) h.s++;
                                    else if(d <= 45) h.a++;
                                    else h.o++;
                                }
                            });
                            this.metrics.health = h;

                            this.metrics.huesos = this.masterData
                                .filter(i => i.vtarTotal <= 0.1 && i.stockGrafana > 0 && i.stockValorizado > 0)
                                .sort((a,b) => b.stockValorizado - a.stockValorizado)
                                .slice(0, 5);

                            this.metrics.topRisks = this.masterData
                                .filter(i => i.stockGrafana > 0 && i.diasStock < i.lt)
                                .sort((a,b) => a.diasStock - b.diasStock)
                                .slice(0, 5)
                                .map(i => ({
                                    sku: i.sku,
                                    desc: i.desc,
                                    stock: i.stockGrafana,
                                    vtar: i.vtarTotal.toFixed(1),
                                    days: i.diasStock
                                }));

                            const devBuckets = { '>150%': 0, '126-150%': 0, '101-125%': 0, '76-100%': 0, '51-75%': 0, '1-50%': 0, '-1 to -50%': 0, '-51 to -75%': 0, '-76 to -100%': 0 };
                            let totalValid = 0;
                            this.masterData.forEach(i => {
                                const vpd = i.vpdCpra || 0;
                                if (vpd > 0) {
                                    totalValid++;
                                    const diff = ((i.vtarTotal - vpd) / vpd) * 100;
                                    if(diff > 150) devBuckets['>150%']++;
                                    else if(diff > 125) devBuckets['126-150%']++;
                                    else if(diff > 100) devBuckets['101-125%']++;
                                    else if(diff > 75) devBuckets['76-100%']++;
                                    else if(diff > 50) devBuckets['51-75%']++;
                                    else if(diff >= 1) devBuckets['1-50%']++;
                                    else if(diff <= -76) devBuckets['-76 to -100%']++;
                                    else if(diff <= -51) devBuckets['-51 to -75%']++;
                                    else if(diff <= -1) devBuckets['-1 to -50%']++;
                                }
                            });
                            const devStats = {};
                            Object.keys(devBuckets).forEach(key => { devStats[key] = totalValid > 0 ? ((devBuckets[key] / totalValid) * 100).toFixed(1) : 0; });
                            this.metrics.deviationStats = devStats;

                            const profStats = {};
                            let totalValStock = 0;
                            
                            this.masterData.forEach(item => {
                                const p = item.perfil || 'Sin Clasificar';
                                const val = item.stockValorizado || 0;
                                
                                if(!profStats[p]) profStats[p] = { name: p, count: 0, money: 0 };
                                profStats[p].count++;
                                profStats[p].money += val;
                                totalValStock += val;
                            });

                            this.metrics.profiles = Object.values(profStats)
                                .map(p => ({
                                    ...p,
                                    pct: totalValStock > 0 ? (p.money / totalValStock * 100).toFixed(1) : 0
                                }))
                                .sort((a,b) => b.money - a.money); 

                            this.updateKPIs();
                            this.calculateColumnMaxes();
                            this.isLoading = false; this.dataReady = true;
                            if(this.currentTab === 'metricas') this.renderCharts();

                        } catch (e) { console.error("CRITICAL ERROR:", e); alert("Error cr√≠tico procesando datos: " + e.message); this.isLoading = false; }
                    }, 50);
                },






               calculateRowLogic(item) {
                    const pbi = item.pbi || {dep1:0, dep80:0};
                    const stockSucTotal = [81,82,83,87,89].reduce((a,n)=>a+(pbi[`dep${n}`]||0), 0);
                    let reservaSuc = Math.ceil((item.vtarSuc * this.params.diasSuc) - stockSucTotal); if(reservaSuc < 0) reservaSuc = 0;
                    const reservaDep1 = Math.ceil(item.vtar1 * this.params.diasSuc);
                    const disponibleParaEnviar = Math.max(0, pbi.dep1 - reservaSuc - reservaDep1);
                    const demanda80 = Math.ceil(item.vtar80 * this.params.diasFull);
                    const necesidad80 = Math.max(0, demanda80 - pbi.dep80);
                    const stockRed = pbi.dep1 + stockSucTotal + pbi.dep80 + item.comprasEnCamino;

                    const dev = item.dev || 0;
                    const lt = item.lt || 30;
                    const ss = Math.ceil(2.33 * item.vtarTotal * Math.sqrt(lt));
                    const stockMin = Math.ceil((item.vtarTotal * lt) + ss);
                    let stockMax = Math.ceil(item.vtarTotal * 30);
                    if (stockMax < stockMin) stockMax = stockMin;

                    // --- DATOS EXTERNOS ---
                    const mlData = this.lookups.mapML && this.lookups.mapML[item.sku];
                    const isImpulse = mlData ? mlData.impulsar : item.impulsar;
                    const statusML = mlData ? mlData.estado : 'S/D';
                    const qualityML = mlData ? mlData.calidad : 'S/D';

                    const cargoData = this.lookups.mapCargos && this.lookups.mapCargos[item.sku];
                    const deudaVal = cargoData ? cargoData.monto : (item.deuda||0);
                    const unitVal = cargoData ? cargoData.unidades : (item.unidadesCargo||0);
                    const antiguedadStock = cargoData ? cargoData.antiguedad : '';

                    const planML = this.lookups.mapPlanML && this.lookups.mapPlanML[item.sku];
                    const mlRecomendacion = planML ? planML.rec : '';
                    const mlSugerido = planML ? planML.sug : 0;
                    const mlEsUrgente = planML ? planML.esUrgente : false;
                    
                    const envHist = (this.lookups.mapEnvios && this.lookups.mapEnvios[item.sku]) ? this.lookups.mapEnvios[item.sku] : (item.enviadoHist||0);
                    
                    // --- C√ÅLCULO DE COMPRA (OPTIMIZADO POR BULTOS) ---
                    let necesidadExacta = 0;
                    const strategyDays = item.diasEstrategia;
                    const hasStrategy = (strategyDays !== undefined && strategyDays !== null && strategyDays !== "");
                    const coverageDays = hasStrategy ? parseFloat(strategyDays) : (this.params.diasCompra || 30);

                    let vtarCalc = item.vtarTotal;
                    if (item.seasonalMult && item.seasonalMult !== 1) vtarCalc = item.vtarTotal * item.seasonalMult;

                    if(!isImpulse && vtarCalc > 0) {
                        const targetStock = Math.ceil((vtarCalc * coverageDays) + ss);
                        if(hasStrategy || stockRed < stockMin) necesidadExacta = Math.max(0, targetStock - stockRed);
                        else if(stockRed < stockMin) necesidadExacta = Math.max(0, stockMax - stockRed);
                    }
                    
                    // L√ìGICA DE BULTOS (UXB)
                    const uxb = item.uxb || 1; // Unidades por bulto (defecto 1)
                    let cantBultos = 0;
                    let comprarU = 0;
                    
                    if (necesidadExacta > 0) {
                        // Redondeamos SIEMPRE hacia arriba para cerrar la caja
                        cantBultos = Math.ceil(necesidadExacta / uxb);
                        comprarU = cantBultos * uxb;
                    }
                    // -------------------------------------------------

                    let diasStock = item.vtarTotal > 0 ? item.stockGrafana / item.vtarTotal : (item.stockGrafana===0?0:999);
                    let diasStock80 = item.vtar80 > 0 ? pbi.dep80 / item.vtar80 : (pbi.dep80===0?0:999);

                    let runOutDate = '‚àû';
                    let runOutCritical = false;
                    if (item.vtarTotal > 0 && diasStock < 999) {
                        const d = new Date(); d.setDate(d.getDate() + Math.floor(diasStock));
                        runOutDate = d.toLocaleDateString('es-AR');
                        if (diasStock <= 3) runOutCritical = true;
                    } else if (item.stockGrafana <= 0) {
                         runOutDate = new Date().toLocaleDateString('es-AR'); runOutCritical = true;
                    }

                    let healthStatus = 'Sobrestock';
                    if(diasStock <= 10) healthStatus = 'Quiebre';
                    else if(diasStock <= 17) healthStatus = 'Por Quebrar';
                    else if(diasStock <= 30) healthStatus = 'Saludable';
                    else if(diasStock <= 45) healthStatus = 'Alerta';

                    // --- VENTA PERDIDA ---
                    let ventaPerdida = 0;
                    const perfilNormalizado = String(item.perfil || '').toUpperCase();
                    if (stockRed <= 0 && item.vtarTotal > 0 && perfilNormalizado.includes('ACTIVO')) {
                        ventaPerdida = item.vtarTotal * item.costo;
                    }

                    // --- ARBITRAJE ---
                    let isArbitrage = false;
                    let arbitrageVal = 0;
                    if (diasStock80 <= 7 && Math.min(disponibleParaEnviar, necesidad80) > 0) {
                        isArbitrage = true;
                        arbitrageVal = Math.min(disponibleParaEnviar, necesidad80) * item.costo;
                    }

                    return {
                        ...item, impulsar: isImpulse, diasStock, diasStock80,
                        stockRestante: disponibleParaEnviar, debugDemanda80: demanda80, debugReservaSuc: reservaSuc, debugReserva1: reservaDep1,
                        qEnviar: Math.min(disponibleParaEnviar, necesidad80), valorizado: Math.min(disponibleParaEnviar, necesidad80) * item.costo,
                        
                        comprarU, // Cantidad final redondeada
                        cantBultos, // NUEVO: Cantidad de cajas
                        uxb,        // NUEVO: Unidades por caja
                        inversion: comprarU * item.costo, 
                        
                        deuda: deudaVal, unidadesCargo: unitVal, enviadoHist: envHist,
                        ss, stockMin, stockMax, stockValorizado: item.stockGrafana * item.costo,
                        criticalGap: (diasStock < lt) && (item.vtarTotal > 0),
                        estadoSalud: healthStatus, vtarIa: item.vtarIa, isAnomaly: item.isAnomaly,
                        runOutDate, runOutCritical, statusML, qualityML, antiguedadStock,
                        mlRecomendacion, mlSugerido, mlEsUrgente,
                        ventaPerdida,
                        isArbitrage, arbitrageVal
                    };
                },






                renderSparkline(data, w=60, h=25) {
                    if (!data || data.length < 2) return '';

                    // 1. Normalizar datos
                    const max = Math.max(...data);
                    const min = Math.min(...data);
                    const range = max - min || 1;
                    
                    const points = data.map((val, i) => {
                        const x = (i / (data.length - 1)) * w;
                        const y = h - ((val - min) / range * h); 
                        return [x, y];
                    });

                    // 2. Suavizado de curvas (B√©zier)
                    const line = (pointA, pointB) => {
                        const lengthX = pointB[0] - pointA[0];
                        const lengthY = pointB[1] - pointA[1];
                        return {
                            length: Math.sqrt(Math.pow(lengthX, 2) + Math.pow(lengthY, 2)),
                            angle: Math.atan2(lengthY, lengthX)
                        };
                    };

                    const controlPoint = (current, previous, next, reverse) => {
                        const p = previous || current;
                        const n = next || current;
                        const o = line(p, n);
                        const angle = o.angle + (reverse ? Math.PI : 0);
                        const length = o.length * 0.2; 
                        const x = current[0] + Math.cos(angle) * length;
                        const y = current[1] + Math.sin(angle) * length;
                        return [x, y];
                    };

                    const bezierCommand = (point, i, a) => {
                        const [cpsX, cpsY] = controlPoint(a[i - 1], a[i - 2], point);
                        const [cpeX, cpeY] = controlPoint(point, a[i - 1], a[i + 1], true);
                        return `C ${cpsX.toFixed(1)},${cpsY.toFixed(1)} ${cpeX.toFixed(1)},${cpeY.toFixed(1)} ${point[0].toFixed(1)},${point[1].toFixed(1)}`;
                    };

                    // 3. Construir el PATH
                    let d = `M ${points[0][0].toFixed(1)},${points[0][1].toFixed(1)}`;
                    for (let i = 1; i < points.length; i++) {
                        d += ' ' + bezierCommand(points[i], i, points);
                    }

                    // 4. Colores Din√°micos (Verde sube / Rojo baja)
                    const isUp = data[data.length - 1] >= data[0]; 
                    const strokeColor = isUp ? '#10b981' : '#f43f5e'; 
                    const fillColor = isUp ? '#ecfdf5' : '#fff1f2';   

                    const fillPath = `${d} L ${w},${h} L 0,${h} Z`;

                    return `
                        <svg width="${w}" height="${h}" overflow="visible">
                            <path d="${fillPath}" fill="${fillColor}" stroke="none" />
                            <path d="${d}" fill="none" stroke="${strokeColor}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    `;
                },

                get filteredData() {
                    let d = this.masterData;
                    if(this.currentTab === 'detalle') d = this.flatData;
                    else if(this.currentTab === 'enviados') d = this.enviosData;
                    else if(this.currentTab === 'vencimientos') d = this.lotesData;
                    else if(this.currentTab === 'proveedores') d = this.proveedoresData;
                    else if(this.currentTab === 'otros_depositos') {
                        d = this.otherDepositsData.filter(i => this.selectedOtherDeps.includes(i.deposito));
                    }
                    if (this.filterOpportunityCost) {
                        d = d.filter(i => i.ventaPerdida > 0);
                    }
                    if (this.filterAging) {
                        const f = this.filterAging;
                        d = d.filter(i => {
                            const ds = i.diasStock;
                            if(f === '0-30d') return ds <= 30;
                            if(f === '31-60d') return ds > 30 && ds <= 60;
                            if(f === '61-90d') return ds > 60 && ds <= 90;
                            if(f === '91-180d') return ds > 90 && ds <= 180;
                            if(f === '>180d') return ds > 180;
                            return true;
                        });
                    if (this.filterArbitrage) {
                        d = d.filter(i => i.isArbitrage);
                    }
                    }

                    if(this.currentTab === 'dep80') {
                        d = d.filter(i => i.qEnviar > 0);
                        
                        if (this.filterMLUrgencies) {
                            d = d.filter(i => i.mlEsUrgente);
                        }

                        if (this.selectedEnvioFechas.length > 0) {
                            const skusEnFechas = new Set();
                            this.enviosData.forEach(e => {
                                if(this.selectedEnvioFechas.includes(e.fecha)) skusEnFechas.add(e.sku);
                            });
                            d = d.filter(i => skusEnFechas.has(i.sku));
                        }
                    }
                    else if(this.currentTab === 'resumen') d = d.filter(i => i.comprarU > 0 || i.comprasEnCamino > 0);
                    else if(this.currentTab === 'cargos') d = d.filter(i => i.deuda > 0 || i.unidadesCargo > 0);
                    else if(this.currentTab === 'inmovilizado') d = d.filter(i => i.diasStock > 45);

                    if(this.activeFilters['abc_xyz']) {
                        const code = this.activeFilters['abc_xyz'][0];
                        d = d.filter(i => i.abc_xyz === code);
                    }

                    if(this.currentTab === 'vencimientos' && this.filterLotesRange !== 'all') {
                        if(this.filterLotesRange === '0-30') d = d.filter(l => l.dias <= 30);
                        else if(this.filterLotesRange === '31-60') d = d.filter(l => l.dias > 30 && l.dias <= 60);
                        else if(this.filterLotesRange === '61-90') d = d.filter(l => l.dias > 60 && l.dias <= 90);
                        else if(this.filterLotesRange === '90+') d = d.filter(l => l.dias > 90);
                    }
                    if(this.currentTab === 'enviados' && this.selectedEnvioFechas.length > 0) d = d.filter(e => this.selectedEnvioFechas.includes(e.fecha));

                    if(this.search) {
                        const q = this.search.toUpperCase();
                        d = d.filter(i => String(i.sku||'').toUpperCase().includes(q) || String(i.desc||'').toUpperCase().includes(q) || String(i.marca||'').toUpperCase().includes(q) || String(i.prov||'').toUpperCase().includes(q));
                    }

                    Object.keys(this.activeFilters).forEach(key => {
                        const allowed = this.activeFilters[key];
                        if(allowed && allowed.length > 0 && key !== 'abc_xyz') {
                            d = d.filter(row => allowed.includes(String(row[key]||'')));
                        }
                    });

                    if (this.focusMode) {
                        d = d.filter(row => {
                            const stockProblem = row.diasStock <= 17; 
                            const mlProblem = row.mlEsUrgente || (row.statusML && row.statusML !== 'Activa' && row.statusML !== 'S/D');
                            const oldStock = row.antiguedadStock && (row.antiguedadStock.includes('6') || row.antiguedadStock.includes('12'));
                            return stockProblem || mlProblem || oldStock;
                        });
                    }

                    return d.sort((a,b) => {
                        let va = a[this.sortCol]||"", vb = b[this.sortCol]||"";
                        if (typeof va === 'string') va = va.toLowerCase(); if (typeof vb === 'string') vb = vb.toLowerCase();
                        if (va < vb) return this.sortAsc ? -1 : 1; if (va > vb) return this.sortAsc ? 1 : -1; return 0;
                    });
                },

                get paginatedData() {
                    const s=(this.currentPage-1)*this.pageSize;
                    const pData = this.filteredData.slice(s, s+this.pageSize);
                    setTimeout(() => this.calculatePageMaxes(pData), 0);
                    return pData;
                },
                get totalPages() { return Math.ceil(this.filteredData.length/this.pageSize)||1; },
                nextPage() { if(this.currentPage < this.totalPages) this.currentPage++; },
                prevPage() { if(this.currentPage > 1) this.currentPage--; },

                calculateColumnMaxes() { this.columnMaxValues = {}; },
                calculatePageMaxes(pageData) {
                    const colsToCheck = ['stockGrafana', 'pbi.dep80', 'pbi.dep1', 'qEnviar', 'enviadoHist', 'comprarU', 'inversion', 'deuda', 'vtarTotal', 'vtar80', 'vtarIa'];
                    const maxes = {};
                    colsToCheck.forEach(k => {
                        maxes[k] = 0;
                        pageData.forEach(row => {
                            const val = k.split('.').reduce((o,i)=>(o?o[i]:0), row) || 0;
                            if(val > maxes[k]) maxes[k] = val;
                        });
                    });
                    this.columnMaxValues = maxes;
                },
                getBarStyle(col, row) {
                    const key = col.key;
                    if(!['pbi.dep80', 'pbi.dep1', 'qEnviar', 'comprarU', 'inversion', 'stockGrafana', 'vtarIa'].includes(key)) return '';
                    const val = key.split('.').reduce((o,i)=>(o?o[i]:0), row);
                    const max = this.columnMaxValues[key] || 1;
                    const pct = Math.min(100, Math.max(0, (val / max) * 100));
                    let color = '#cbd5e1';
                    if(key === 'qEnviar' || key === 'pbi.dep80') color = '#c084fc';
                    if(key === 'comprarU' || key === 'inversion') color = '#86efac';
                    if(key.includes('stock')) color = '#93c5fd';
                    if(key === 'vtarIa') color = '#d8b4fe';
                    return `width: ${pct}%; background-color: ${color};`;
                },
                isFilterable(key) { return ['marca', 'prov', 'analista', 'dep', 'abc', 'estadoSalud', 'deposito'].includes(key); },
                toggleFilterMenu(key) { this.filterMenuOpen = this.filterMenuOpen === key ? null : key; },
                getUniqueValues(key) {
                    const source = this.currentTab === 'otros_depositos' ? this.otherDepositsData : (this.masterData.length ? this.masterData : this.flatData);
                    const vals = new Set(source.map(r => String(r[key]||'')));
                    return Array.from(vals).sort();
                },
                isFilterChecked(key, val) {
                    return this.activeFilters[key] ? this.activeFilters[key].includes(val) : false;
                },
                toggleFilter(key, val) {
                    if(!this.activeFilters[key]) this.activeFilters[key] = [];
                    const idx = this.activeFilters[key].indexOf(val);
                    if(idx > -1) this.activeFilters[key].splice(idx, 1);
                    else this.activeFilters[key].push(val);
                    if(this.activeFilters[key].length === 0) delete this.activeFilters[key];
                    this.currentPage = 1;
                },
                clearFilter(key) { delete this.activeFilters[key]; this.currentPage = 1; },
                getColLabel(key) { return this.getColumns().find(c=>c.key===key)?.label || key; },

                async copySkus() {
                    const skus = this.filteredData.map(r => r.sku).join('\n');
                    try {
                        await navigator.clipboard.writeText(skus);
                        this.copyFeedback = true;
                        setTimeout(() => this.copyFeedback = false, 2000);
                    } catch(err) { console.error('Failed to copy', err); }
                },
                exportExcel() {
    if (!this.dataReady) return;

    const dataToExport = this.filteredData;
    const columns = this.getColumns();
    const sheetName = this.tabs.find(t => t.id === this.currentTab)?.label || 'Datos';

    const exportData = dataToExport.map(row => {
        const newRow = {};
        columns.forEach(col => {
            let val = col.key.split('.').reduce((o, i) => (o ? o[i] : undefined), row);
            if (val === undefined) val = row[col.key];
            newRow[col.label] = val;
        });
        return newRow;
    });

    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, sheetName);

    XLSX.writeFile(wb, `${sheetName}_${this.lastUpdate.replace(/[\/, :]/g, '_')}.xlsx`);
},

                isEditable(key) { return ['lt', 'uxb', 'dev', 'costo', 'diasEstrategia'].includes(key); },
                startEdit(row, key) {
                    if(this.isEditable(key) && (this.currentTab === 'resumen' || this.currentTab === 'consolidado')) {
                        this.editingCell = { sku: row.sku, key: key };
                    }
                },
                isEditing(row, key) {
                    return this.editingCell && this.editingCell.sku === row.sku && this.editingCell.key === key;
                },
                saveEdit(row, key, val) {
                    let numVal = parseFloat(val);
                    if(val === '' && key === 'diasEstrategia') numVal = undefined;
                    if(numVal === undefined || !isNaN(numVal)) {
                        const target = this.masterData.find(r => r.sku === row.sku);
                        if(target) {
                            target[key] = numVal;
                            if(key === 'diasEstrategia') {
                                if(!this.strategyOverrides) this.strategyOverrides = {};
                                if(numVal === undefined) delete this.strategyOverrides[row.sku];
                                else this.strategyOverrides[row.sku] = numVal;
                                DB.save('strategyOverrides', this.strategyOverrides);
                            }
                            const recalculated = this.calculateRowLogic(target);
                            Object.assign(target, recalculated);
                            this.masterData = [...this.masterData];
                            this.updateKPIs();
                            this.calculateColumnMaxes();
                        }
                    }
                    this.editingCell = null;
                },

                getHeaderTitle() { return this.tabs.find(t=>t.id===this.currentTab)?.label || 'Dashboard'; },
                getHeaderStats() {
                    const isFiltered = this.search.length > 0 || Object.keys(this.activeFilters).length > 0;

                    if(this.currentTab === 'dep80') {
                        const total = isFiltered
                            ? this.filteredData.reduce((a,b)=>a+b.qEnviar,0)
                            : this.kpis.envios;
                        const val = isFiltered
                            ? this.filteredData.reduce((a,b)=>a+b.valorizado,0)
                            : this.kpis.valorEnvios;

                        return `
                            <span class="${isFiltered?'text-purple-600 font-bold':''}">Total a enviar:</span>
                            <b class="ml-1">${total.toLocaleString()} u.</b>
                            <span class="mx-2">|</span>
                            <span class="${isFiltered?'text-purple-600 font-bold':''}">Inversi√≥n Env√≠o:</span>
                            <b class="ml-1">${this.formatMoney(val)}</b>
                            ${isFiltered ? '<span class="ml-2 text-[9px] bg-purple-100 text-purple-700 px-1 rounded">FILTRADO</span>' : ''}
                        `;
                    }

                    if(this.currentTab === 'resumen') {
                        const skus = isFiltered
                            ? this.filteredData.length
                            : this.kpis.skusCompra;
                        const inv = isFiltered
                            ? this.filteredData.reduce((a,b)=>a+(b.inversion||0),0)
                            : this.kpis.compra;

                        return `
                            <span class="${isFiltered?'text-emerald-600 font-bold':''}">SKUs a comprar:</span>
                            <b class="ml-1">${skus}</b>
                            <span class="mx-2">|</span>
                            <span class="${isFiltered?'text-emerald-600 font-bold':''}">Inversi√≥n Total:</span>
                            <b class="ml-1">${this.formatMoney(inv)}</b>
                            ${isFiltered ? '<span class="ml-2 text-[9px] bg-emerald-100 text-emerald-700 px-1 rounded">FILTRADO</span>' : ''}
                        `;
                    }

                    if(this.currentTab === 'inmovilizado') {
                        const inv = isFiltered
                            ? this.filteredData.reduce((a,b)=>a+(b.stockValorizado||0),0)
                            : this.kpis.inmovilizado;
                         return `
                            <span class="${isFiltered?'text-red-600 font-bold':''}">Capital Inmovilizado:</span>
                            <b class="ml-1 text-red-600">${this.formatMoney(inv)}</b>
                            ${isFiltered ? '<span class="ml-2 text-[9px] bg-red-100 text-red-700 px-1 rounded">FILTRADO</span>' : ''}
                        `;
                    }

                    if(this.currentTab === 'otros_depositos') {
                        const totalEnv = this.filteredData.reduce((a,b)=>a+(b.qEnviar||0), 0);
                        return `Total a enviar (${this.selectedOtherDeps.length} deps): <b class="ml-1 text-purple-700">${totalEnv.toLocaleString()} u.</b>`;
                    }

                    if(this.currentTab === 'cargos') {
                        const totalDeuda = isFiltered
                            ? this.filteredData.reduce((a,b)=>a+b.deuda,0)
                            : this.masterData.reduce((a,b)=>a+b.deuda,0);
                        return `Deuda Total Acumulada: <b class="ml-1 text-red-600 bg-red-50 px-1 rounded">${this.formatMoney(totalDeuda)}</b>`;
                    }

                    if(this.currentTab === 'vencimientos') {
                        const c = this.filteredData.filter(l=>l.dias<=30).length;
                        const riesgoTotal = this.filteredData.reduce((acc, row) => acc + (row.riesgoMonetario || 0), 0);
                        
                        return `
                            Lotes Cr√≠ticos (0-30d): <b class="ml-1 text-red-600">${c}</b> 
                            <span class="mx-2 text-slate-300">|</span> 
                            Riesgo Econ√≥mico Total: <b class="ml-1 text-red-700 bg-red-100 px-2 rounded border border-red-200">${this.formatMoney(riesgoTotal)}</b>
                        `;
                    }

                    if(this.currentTab === 'enviados') return `Total Env√≠os Hist√≥ricos: <b>${this.filteredData.length}</b> filas`;

                    if(this.currentTab === 'detalle' || this.currentTab === 'consolidado' || this.currentTab === 'proveedores' || this.currentTab === 'matriz_det') {
                         return `Total SKUs: <b>${this.filteredData.length}</b>`;
                    }

                    return '';
                },

                getColumns() {
                    if(this.currentTab==='matriz_det') return [
                        {key:'sku',label:'SKU'}, {key:'desc',label:'DESCRIPCION'}, {key:'marca',label:'MARCA'}, {key:'prov',label:'PROVEEDOR'},
                        {key:'abc',label:'CLASIF. ABC'},
                        {key:'estadoSalud',label:'ESTADO SALUD'},
                        {key:'stockGrafana',label:'STOCK TOTAL'},
                        {key:'vtarTotal',label:'VTAR TOTAL'},
                        {key:'diasStock',label:'DIAS STOCK'},
                        {key:'stockValorizado',label:'CAPITAL INVERTIDO ($)'}
                    ];
                     
                    if(this.currentTab==='consolidado') return [
                        {key:'sku',label:'SKU'}, 
                        {key:'desc',label:'DESCRIPCION'}, 
                        {key:'statusVisualML',label:'ESTADO ML'}, 
                        {key:'antiguedadStock',label:'ANTIG√úEDAD STOCK'}, 
                        {key:'comprasEnCamino',label:'EN CAMINO'},
                        {key:'stockGrafana',label:'STOCK TOTAL'},
                        {key:'vtarTotal',label:'VTAR TOTAL (Tendencia)'},
                        {key:'vtarIa',label:'VTAR IA (Pred)'}, 
                        {key:'diasStock',label:'DIAS STOCK'},
                        {key:'runOutDate',label:'AGOTAMIENTO ESTIMADO'}, 
                        {key:'diasEstrategia',label:'DIAS EST.', editable:true},
                        {key:'perfil', label:'PERFIL'},
                        
                        {key:'ss',label:'STOCK SEGURIDAD'}, 
                        {key:'stockMin',label:'STOCK MINIMO'},
                        {key:'stockMax',label:'STOCK MAXIMO'},

                        {key:'comprarU',label:'CANTIDAD A PEDIR'}
                    ];
                    
                    
                    if(this.currentTab==='proveedores') return [
                        {key:'actions',label:'ACCIONES'},
                        {key:'prov',label:'PROVEEDOR'},
                        {key:'diasStockProm',label:'DIAS STOCK PROM'},
                        {key:'totalStockVal',label:'IMPORTE STOCK ACTUAL'},
                        {key:'inmoVal',label:'IMPORTE SOBRESTOCK >45d'},
                        {key:'inversion',label:'TOTAL INVERSION A REALIZAR'}
                    ];
                    if(this.currentTab==='inmovilizado') return [
                        {key:'sku',label:'SKU'}, {key:'desc',label:'DESCRIPCION'}, {key:'marca',label:'MARCA'}, {key:'prov',label:'PROVEEDOR'},
                        {key:'stockGrafana',label:'STOCK TOTAL'}, {key:'vtarTotal',label:'VTAR TOTAL'}, {key:'diasStock',label:'DIAS STOCK'},
                        {key:'stockValorizado',label:'COSTO TOTAL INMOVILIZADO'}
                    ];

                    if(this.currentTab==='otros_depositos') return [
                        {key:'statusVisual',label:'ESTADO'},
                        {key:'sku',label:'SKU'}, {key:'desc',label:'DESCRIPCION'}, {key:'marca',label:'MARCA'}, {key:'prov',label:'PROVEEDOR'},
                        {key:'deposito',label:'DEPOSITO'}, {key:'stock',label:'STOCK'}, {key:'vtar',label:'VTAR'},
                        {key:'diasStock',label:'DIAS STOCK'}, {key:'qEnviar',label:'CANTIDADES A ENVIAR'}
                    ];

                    if(this.currentTab==='dep80') return [
                        {key:'sku',label:'SKU'}, 
                        {key:'desc',label:'DESCRIPCION'}, 
                        {key:'mlEsUrgente',label:'ALERTA ML'}, 
                        {key:'mlSugerido',label:'SUG. ML'},    
                        {key:'vtar80',label:'VTAR 80'}, 
                        {key:'pbi.dep80',label:'STOCK 80'}, 
                        {key:'diasStock80',label:'DIAS 80'},
                        {key:'runOutDate',label:'AGOTAMIENTO ESTIMADO'},
                        {key:'pbi.dep1',label:'STOCK CENTRAL'}, 
                        {key:'stockRestante',label:'DISPONIBLE'}, 
                        {key:'qEnviar',label:'A ENVIAR'}, 
                        {key:'valorizado',label:'MONTO $'}
                    ];
                
                    if(this.currentTab==='resumen') return [
                        {key:'sku',label:'SKU'}, 
                        {key:'desc',label:'PRODUCTO'}, 
                        {key:'marca',label:'MARCA'}, 
                        {key:'prov',label:'PROVEEDOR'},
                        {key:'vtarTotal',label:'VTAR GENERAL'}, 
                        {key:'stockGrafana',label:'STOCK TOTAL'}, 
                        {key:'diasStock',label:'DIAS STOCK'},
                        {key:'diasEstrategia',label:'DIAS EST.', editable:true}, 
                        {key:'comprasEnCamino',label:'EN CAMINO'}, 
                        {key:'comprarU',label:'A PEDIR'}, 
                        {key:'inversion',label:'INVERSI√ìN $'},
                        {key:'lt',label:'LEAD TIME'} 
                    ];
                    if(this.currentTab==='cargos') return [
                        {key:'sku',label:'SKU'}, {key:'desc',label:'DESCRIPCION'}, {key:'marca',label:'MARCA'}, {key:'prov',label:'PROVEEDOR'},
                        {key:'analista',label:'ANALISTA'}, {key:'unidadesCargo',label:'UNIDADES CON CARGO'}, {key:'deuda',label:'COSTO TOTAL POR CARGOS'},
                        {key:'fechaCarga',label:'FECHA CARGA'}
                    ];
                    if(this.currentTab==='detalle') return [
                        {key:'sku',label:'SKU'}, {key:'desc',label:'DESCRIPCION'}, {key:'marca',label:'MARCA'}, {key:'prov',label:'PROVEEDOR'},
                        {key:'dep',label:'DEPOSITO'}, {key:'vtar',label:'VTAR'}, {key:'stock',label:'STOCK'}, {key:'diasStockDep',label:'DIAS STOCK'},
                        {key:'vta59',label:'VENTA 60 D√çAS'}, {key:'analista',label:'ANALISTA'}
                    ];
                    if(this.currentTab==='enviados') return [
                        {key:'sku',label:'SKU'}, {key:'desc',label:'DESCRIPCION'}, {key:'marca',label:'MARCA'}, {key:'prov',label:'PROVEEDOR'},
                        {key:'cant',label:'ENVIO REALIZADO'}, {key:'num_envio',label:'N¬∞ ENVIO'}, {key:'fecha',label:'FECHA'}
                    ];
                    if(this.currentTab==='vencimientos') return [
                        {key:'sku',label:'SKU'}, 
                        {key:'desc',label:'DESCRIPCION'}, 
                        {key:'marca',label:'MARCA'}, 
                        {key:'fechaIngreso',label:'FECHA DE INGRESO'}, 
                        {key:'fechaVto',label:'FECHA DE VENCIMIENTO'}, 
                        {key:'dias',label:'DIAS AL VENCIMIENTO'}, 
                        {key:'stockComprometido',label:'STOCK LOTE'},
                        {key:'riesgoMonetario',label:'RIESGO ($) PROYECTADO'}
                    ];
                },            
                    getCellClass(c,r) {
                    if(c.key === 'abc') {
                        if(r.abc === 'A') return 'bg-green-100 text-green-800 font-bold text-center';
                        if(r.abc === 'B') return 'bg-yellow-50 text-yellow-800 font-bold text-center';
                        return 'bg-slate-100 text-slate-500 text-center';
                    }
                    if(c.key === 'estadoSalud') {
                        if(r.estadoSalud === 'Quiebre') return 'bg-red-900 text-white font-bold text-center';
                        if(r.estadoSalud === 'Por Quebrar') return 'bg-red-600 text-white font-bold text-center';
                        if(r.estadoSalud === 'Saludable') return 'bg-green-100 text-green-800 font-bold text-center';
                        if(r.estadoSalud === 'Alerta') return 'bg-yellow-100 text-yellow-800 font-bold text-center';
                        return 'bg-purple-100 text-purple-800 font-bold text-center';
                    }

                    if(c.key === 'statusVisualML') {
                        const st = (r.statusML||'').toUpperCase();
                        if(st === 'PAUSADA') return 'bg-red-100 text-red-700 font-bold text-[10px] text-center';
                        if(st === 'INACTIVA') return 'bg-gray-200 text-gray-500 font-bold text-[10px] text-center';
                        return 'text-green-600 font-bold text-[10px] text-center';
                    }
                    
                    if(c.key === 'antiguedadStock') {
                         if(!r.antiguedadStock) return 'text-center text-slate-300';
                         if(r.antiguedadStock.includes('2 and 4')) return 'bg-yellow-50 text-yellow-700 font-bold text-center';
                         if(r.antiguedadStock.includes('4 and 6')) return 'bg-orange-100 text-orange-700 font-bold text-center';
                         if(r.antiguedadStock.includes('6') || r.antiguedadStock.includes('12')) return 'bg-red-100 text-red-700 font-bold text-center';
                    }

                    if(c.key === 'mlEsUrgente' && r.mlEsUrgente) return 'bg-red-500 text-white font-bold text-center animate-pulse';
                    if(c.key === 'mlSugerido' && r.mlSugerido > 0) return 'text-center font-bold text-blue-600 bg-blue-50';

                    if(c.key === 'riesgoMonetario' && r.riesgoMonetario > 0) return 'font-mono font-bold text-red-600 bg-red-50 text-right';

                    if(['diasStock', 'diasStock80', 'diasStockDep'].includes(c.key)) {
                        const val = r[c.key];
                        if(val <= 10) return 'bg-red-900 text-white font-bold';
                        if(val <= 17) return 'bg-red-600 text-white font-bold';
                        if(val <= 30) return 'bg-green-100 text-green-800 font-bold';
                        if(val <= 45) return 'bg-yellow-100 text-yellow-800 font-bold';
                        return 'bg-purple-100 text-purple-800 font-bold';
                    }
                    if(c.key==='qEnviar') return 'font-bold text-purple-600';
                    if(c.key==='enviadoHist' && r.enviadoHist > 0) return 'font-bold text-blue-600';
                    if(c.key==='comprarU') return 'font-bold text-emerald-600';
                    if(c.key==='comprasEnCamino' && r.comprasEnCamino > 0) return 'text-blue-600 font-bold';
                    if(c.key==='inversion' || c.key==='deuda') return 'font-mono text-right';
                    if(c.key==='unidadesCargo') return 'text-center font-bold text-slate-700';
                    if(c.key==='stockComprometido') return 'font-bold text-slate-700 bg-yellow-50';
                    if(this.isEditable(c.key)) return 'bg-yellow-50 hover:bg-yellow-100 cursor-text border-b-2 border-dashed border-slate-300 font-bold text-blue-700';
                    if(c.key==='ss' || c.key==='stockMin' || c.key==='stockMax') return 'text-center text-slate-600 bg-slate-50 font-medium';
                    if(c.key==='stockValorizado' || c.key==='inmoVal') return 'font-mono font-bold text-red-700 bg-red-50';
                    if(c.key==='vtarIa') return 'bg-indigo-50 font-bold text-indigo-700';
                    if(c.key==='deposito') return 'text-center font-bold bg-purple-50 text-purple-800';
                    if(c.key === 'runOutDate' && r.runOutCritical) return 'bg-red-500 text-white font-bold text-center';
                    return '';
                },
                
                
                formatCell(c,r) {
                    // --- NUEVO: Visualizaci√≥n de Bultos en la Tabla ---
                    if (c.key === 'comprarU') {
                        if (r.comprarU > 0 && r.uxb > 1) {
                            return r.comprarU + ' u. (' + r.cantBultos + ' üì¶)';
                        }
                        return r.comprarU;
                    }
                    // --------------------------------------------------

                    // ... (aqu√≠ sigue el resto de tu c√≥digo existente: statusVisualML, etc.)

                    if(c.key === 'statusVisualML') {
                        const st = (r.statusML||'').toUpperCase();
                        if(st === 'PAUSADA') return '‚è∏Ô∏è PAUSADA';
                        if(st === 'INACTIVA') return '‚ùå INACTIVA';
                        if(st === 'ACTIVA') return '‚úÖ ACTIVA';
                        if(c.key === 'mlEsUrgente') return r.mlEsUrgente ? 'üî• URGENTE' : '-';
                        return st;
                    }
                    if(c.key === 'antiguedadStock') {
                         if(!r.antiguedadStock) return '-';
                         if(r.antiguedadStock.includes('2 and 4')) return '‚ö†Ô∏è 2-4 Meses';
                         if(r.antiguedadStock.includes('4 and 6')) return 'üü† 4-6 Meses';
                        if(r.antiguedadStock.includes('6 and 12')) return 'üî• 6-12 Meses';
                        if(r.antiguedadStock.includes('Over 12')) return 'üíÄ +12 Meses';
                        return r.antiguedadStock;
                   }


                   if(c.key === 'statusVisual') return r.statusVisual;
                   if(c.key === 'fechaCarga') return new Date().toLocaleDateString('es-AR');
                   let val = c.key.split('.').reduce((o,i)=>(o?o[i]:0), r);
                   if(c.key.includes('inversion') || c.key.includes('totalStockVal') || c.key.includes('inmoVal') || c.key.includes('valorizado') || c.key.includes('deuda') || c.key==='stockValorizado') return this.formatMoney(val);
                   if((c.key.includes('fecha') || c.key.includes('Ingreso') || c.key.includes('Vto')) && typeof val==='number') return new Date((val-25569)*86400000).toLocaleDateString('es-AR');
                   if(typeof val==='number') return c.key.includes('dias') ? val.toFixed(1) : (Number.isInteger(val) ? val : val.toFixed(2));
                   return val;
               },
               formatMoney(v) { return '$ '+(v||0).toLocaleString('es-AR',{maximumFractionDigits:0}); },
               openModal(r) {
                   const m = this.masterData.find(x => x.sku === r.sku);
                   this.selectedRow = m ? {...m, dep: r.dep} : r;

                   if (this.selectedRow && this.selectedRow.sku) {
                       this.selectedRowLotes = this.lotesData
                           .filter(l => l.sku === this.selectedRow.sku)
                           .sort((a,b) => a.dias - b.dias);
                   } else {
                       this.selectedRowLotes = [];
                   }

                   this.modalOpen = true;
               },
               sortBy(k) { if(this.sortCol===k) this.sortAsc=!this.sortAsc; else {this.sortCol=k; this.sortAsc=true;} },
               resetApp() { if(confirm('¬øBorrar base de datos local?')) DB.clear().then(()=>location.reload()); },
               nextPage() { if(this.currentPage < this.totalPages) this.currentPage++; },
               prevPage() { if(this.currentPage > 1) this.currentPage--; },
               get totalPages() { return Math.ceil(this.filteredData.length/this.pageSize)||1; },








               updateKPIs() {
                    // 1. Totales Generales (Compras, Env√≠os, etc.)
                    this.kpis.compra = this.masterData.reduce((a,b)=>a+b.inversion,0);
                    this.kpis.skusCompra = this.masterData.filter(b=>b.comprarU>0).length;
                    this.kpis.envios = this.masterData.reduce((a,b)=>a+b.qEnviar,0);
                    this.kpis.valorEnvios = this.masterData.reduce((a,b)=>a+b.valorizado,0);
                    this.kpis.cantImpulsar = this.masterData.filter(b=>b.impulsar).length;
                    this.kpis.enCamino = this.masterData.reduce((a,b)=>a+(b.comprasEnCamino||0),0);
                    this.kpis.inmovilizado = this.masterData.filter(i => i.diasStock > 45).reduce((a,b) => a + (b.stockGrafana * b.costo), 0);
                    
                    // Venta Perdida (Feature anterior)
                    this.kpis.ventaPerdidaTotal = this.masterData.reduce((a,b) => a + (b.ventaPerdida || 0), 0);

                    // --- NUEVO KPI: Total Arbitraje (Dinero a recuperar moviendo stock) ---
                    this.kpis.arbitrageTotal = this.masterData.reduce((a,b) => a + (b.arbitrageVal || 0), 0);
                    // ---------------------------------------------------------------------

                    // 2. L√≥gica de Cash Flow (Mantenemos lo que ya ten√≠as)
                    const cf = { w1: 0, w2: 0, w3: 0, w4: 0 };
                    this.masterData.forEach(item => {
                        if (item.comprarU > 0) {
                            const d = item.diasStock;
                            const plata = item.inversion;
                            if (d < 7) cf.w1 += plata;
                            else if (d < 14) cf.w2 += plata;
                            else if (d < 21) cf.w3 += plata;
                            else cf.w4 += plata;
                        }
                    });
                    this.metrics.cashFlow = cf;

                    // 3. L√≥gica de Aging (Mantenemos lo que ya ten√≠as)
                    const ag = { f0_30: 0, f31_60: 0, f61_90: 0, f91_180: 0, f180: 0 };
                    this.masterData.forEach(item => {
                        if (item.stockGrafana > 0) {
                            const val = item.stockValorizado;
                            const d = item.diasStock;
                            if (d <= 30) ag.f0_30 += val;
                            else if (d <= 60) ag.f31_60 += val;
                            else if (d <= 90) ag.f61_90 += val;
                            else if (d <= 180) ag.f91_180 += val;
                            else ag.f180 += val;
                        }
                    });
                    this.metrics.aging = ag;
                },

                renderCharts() {
                   // 1. Obtener contextos
                   const ctx1 = document.getElementById('chartAnalista');
                   const ctx2 = document.getElementById('chartHealth');
                   const ctx3 = document.getElementById('chartDeudaHistory');
                   const ctx4 = document.getElementById('chartBrands');
                   const ctx5 = document.getElementById('chartProfiles');
                   const ctx6 = document.getElementById('chartCashFlow');
                   const ctx7 = document.getElementById('chartAging');

                   // 2. Limpiar anteriores
                   if(this.chartInstances['ana']) this.chartInstances['ana'].destroy();
                   if(this.chartInstances['health']) this.chartInstances['health'].destroy();
                   if(this.chartInstances['debt']) this.chartInstances['debt'].destroy();
                   if(this.chartInstances['brand']) this.chartInstances['brand'].destroy();
                   if(this.chartInstances['prof']) this.chartInstances['prof'].destroy();
                   if(this.chartInstances['cf']) this.chartInstances['cf'].destroy();
                   if(this.chartInstances['ag']) this.chartInstances['ag'].destroy();

                   // 3. Gr√°ficos existentes...
                   const topAna = this.metrics.analistas;
                   if(ctx1) {
                       this.chartInstances['ana'] = new Chart(ctx1, {
                           type: 'bar',
                           data: { labels: topAna.map(x=>x.name), datasets: [{ label: 'Deuda Total ($)', data: topAna.map(x=>x.val), backgroundColor: '#dc2626' }] },
                           options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
                       });
                   }

                   if(ctx2) {
                       this.chartInstances['health'] = new Chart(ctx2, {
                           type: 'doughnut',
                           data: { labels: ['Quiebres', 'Por Quebrar', 'Saludable', 'Alerta', 'Sobrestock'], datasets: [{ data: [this.metrics.health.q, this.metrics.health.pq, this.metrics.health.s, this.metrics.health.a, this.metrics.health.o], backgroundColor: ['#7f1d1d', '#dc2626', '#16a34a', '#ca8a04', '#9333ea'] }] },
                           options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, onClick: (evt, elements) => { if(elements.length > 0) { const index = elements[0].index; const mapStatus = ['Quiebre', 'Por Quebrar', 'Saludable', 'Alerta', 'Sobrestock']; this.switchTab('matriz_det'); this.activeFilters['estadoSalud'] = [mapStatus[index]]; } } }
                       });
                   }

                   if(ctx3 && this.debtHistory.length > 0) {
                       const sortedDebt = this.debtHistory.sort((a,b) => new Date(a.date) - new Date(b.date));
                       this.chartInstances['debt'] = new Chart(ctx3, {
                           type: 'line',
                           data: { labels: sortedDebt.map(d => d.date), datasets: [{ label: 'Evoluci√≥n Deuda ($)', data: sortedDebt.map(d => d.val), borderColor: '#dc2626', backgroundColor: 'rgba(220, 38, 38, 0.1)', fill: true, tension: 0.3 }] },
                           options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
                       });
                   }

                   if(ctx4 && this.metrics.brands.length > 0) {
                       this.chartInstances['brand'] = new Chart(ctx4, {
                           type: 'bar',
                           data: { labels: this.metrics.brands.map(b => b.name), datasets: [{ label: 'Capital Invertido ($)', data: this.metrics.brands.map(b => b.val), backgroundColor: '#4f46e5' }] },
                           options: { responsive: true, maintainAspectRatio: false, onClick: (evt, elements) => { if(elements.length > 0) { const index = elements[0].index; const brand = this.metrics.brands[index].name; if(brand !== 'OTROS') { this.switchTab('consolidado'); this.activeFilters['marca'] = [brand]; } } } }
                       });
                   }

                   if(ctx5 && this.metrics.profiles && this.metrics.profiles.length > 0) {
                       this.chartInstances['prof'] = new Chart(ctx5, {
                           type: 'doughnut',
                           data: { labels: this.metrics.profiles.map(p => p.name), datasets: [{ data: this.metrics.profiles.map(p => p.money), backgroundColor: ['#ea580c', '#3b82f6', '#22c55e', '#94a3b8', '#eab308', '#a855f7'], borderWidth: 0 }] },
                           options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } }, tooltip: { callbacks: { label: function(context) { return (context.label||'') + ': $ ' + (context.raw ? context.raw.toLocaleString('es-AR') : '0'); } } } }, onClick: (evt, elements) => { if(elements.length > 0) { const index = elements[0].index; const perfilName = this.metrics.profiles[index].name; this.switchTab('consolidado'); this.activeFilters['perfil'] = [perfilName]; } } }
                       });
                   }

                   if(ctx6 && this.metrics.cashFlow) {
                        const cfData = this.metrics.cashFlow;
                        this.chartInstances['cf'] = new Chart(ctx6, {
                            type: 'bar',
                            data: { labels: ['Semana 1 (Urgente)', 'Semana 2', 'Semana 3', 'Semana 4+'], datasets: [{ label: 'Necesidad de Pago Estimada ($)', data: [cfData.w1, cfData.w2, cfData.w3, cfData.w4], backgroundColor: ['#dc2626', '#f97316', '#eab308', '#3b82f6'], borderRadius: 4 }] },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + (v/1000000).toFixed(1) + 'M' } } } }
                        });
                   }

                   // 9. GRAFICO AGING CON CLICK (ESTE ES EL CAMBIO IMPORTANTE)
                   if(ctx7 && this.metrics.aging) {
                        const ag = this.metrics.aging;
                        this.chartInstances['ag'] = new Chart(ctx7, {
                            type: 'bar',
                            data: {
                                labels: ['0-30d', '31-60d', '61-90d', '91-180d', '>180d'],
                                datasets: [{
                                    label: 'Stock Valorizado ($)',
                                    data: [ag.f0_30, ag.f31_60, ag.f61_90, ag.f91_180, ag.f180],
                                    backgroundColor: ['#22c55e', '#eab308', '#f97316', '#ef4444', '#475569'],
                                    borderRadius: 4
                                }]
                            },
                            options: {
                                indexAxis: 'y',
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: { x: { beginAtZero: true, ticks: { callback: v => '$' + (v/1000000).toFixed(1) + 'M' } } },
                                
                    
                                // CORRECCI√ìN DEFINITIVA DEL CLICK (Con retraso de seguridad)
                                onClick: (evt, elements) => {
                                    if (elements.length > 0) {
                                        const index = elements[0].index;
                                        const labels = ['0-30d', '31-60d', '61-90d', '91-180d', '>180d'];
                                        const selectedLabel = labels[index];
                                        
                                        // 1. Cambiamos de pesta√±a (esto limpia la pantalla)
                                        this.switchTab('consolidado');
                                        
                                        // 2. Esperamos 50ms para aplicar el filtro (asegura que no se borre)
                                        setTimeout(() => {
                                            this.filterAging = selectedLabel;
                                        }, 50); 
                                    }
                                }
                            }
                        });
                   }
               }
               
           }
       }
   </script>
</body>
</html>

